<!DOCTYPE html>
<html lang="ko_KR" itemscope itemtype="http://schema.org/Blog">
  <head>
    <meta charset="UTF-8">
    
    <title>CONNEXUS RECALL</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://weblog.youre.space/styles.css">
    <!--[if lt IE 9]>
    <link rel="stylesheet" href="https://weblog.youre.space/styles_ie.css">
    <script src="https://connexus.youre.space/mt-static/support/theme_static/rainier/js/html5shiv.js"></script>
    <![endif]-->
    
    <link rel="start" href="https://weblog.youre.space/">
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="https://weblog.youre.space/atom.xml" />
    <link rel="manifest" href="/webmanifest.json">
    <link rel="canonical" href="https://weblog.youre.space/" />
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-102177098-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


    <!-- Open Graph Protocol -->
    <meta property="og:type" content="article">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:title" content="CONNEXUS RECALL">
    <meta property="og:url" content="https://weblog.youre.space/">
    
    <meta property="og:site_name" content="CONNEXUS RECALL">
    <meta property="og:image" content="https://weblog.youre.space/assets_c/2017/11/weblog-youre-space_512x512-thumb-320x320-12.png">
    <!-- Microdata -->
    
    <meta itemprop="name" content="CONNEXUS RECALL">
    <link itemprop="url" href="https://weblog.youre.space/">
    <link itemprop="image" href="https://weblog.youre.space/assets_c/2017/11/weblog-youre-space_512x512-thumb-320x320-12.png">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "http://weblog.youre.space",
  "logo": "http://weblog.youre.space/assets_c/2017/11/weblog-youre-space_512x512-thumb-320x320-12.png"
}
</script>
  
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TCRBH6V');</script>
<!-- End Google Tag Manager -->
  </head>
  <body>
    <div id="container">
      <div id="container-inner">
        <header id="header" role="banner">
          <div id="header-inner">
            <div id="header-content">
              <h1>
                <a href="https://weblog.youre.space/">

                  CONNEXUS RECALL

                </a>
              </h1>
              
            </div>

            <nav role="navigation">
          <ul>
            <li><a href="https://weblog.youre.space/">Home</a></li>


          </ul>
        </nav>

          </div>
        </header>
        <div id="content">
          <div id="content-inner">
            <div id="index-main" class="main" role="main">

              <article id="entry-3907" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003907.html">IDDD 14장. 애플리케이션</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:26+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <ul>
  <li>사용자 인퍼페이스와 도메인 모델 사이에 위치
    <ul>
      <li>유스케이스 태스크를 조정</li>
    </ul>
  </li>
  <li>트랜잭션, 보안 권한 부여 담당</li>
</ul>

<blockquote>
  <p>애플리케이션을 핵심 도메인 모델과 상호 교류하며 이를 지원하기 위해 잘 조합된 컴포넌트의 집합을 의미하기 위해 사용하고 있다.
이는 일반적으로 도메인 모델 그 자체와 사용자 인터페이스, 내부적으로 사용되는 애플리케이션 서비스, 인프라적 컴포넌트를 뜻한다.
이 각각의 영역에 어떤 것들이 들어가는지는 애플리케이션마다 다르며, 사용하는 아키텍처가 무엇인지에 따라서도 달라진다.</p>
</blockquote>

<p><img src="/images/2018/06/IDDD-figure-14-1.png" alt="특정한 한 가지 아키텍처에 국한되지 않은 주요 애플리케이션 영역. 여전히 각기 다른 영역의 추상화에 의존적인 인프라의 DIP를 강조한다."></p>

<p>그림 14.1 <em>특정한 한 가지 아키텍처에 국한되지 않은 주요 애플리케이션 영역. 여전히 각기 다른 영역의 추상화에 의존적인 인프라의 DIP를 강조한다.</em></p>

<p>ui.Controller -구현-&gt; infra.TomcatController -위임-&gt; application.Service -구현-&gt; infra.TransactionalService -위임-&gt; domain.Repository -구현-&gt; infra.JpaRepository -의존-&gt; infra.Mysql</p>

<ul>
  <li>필자는 UI -&gt; Appcliation -&gt; Infra 순서로 설명해 나간다. (Top-Down 방식)</li>
</ul>

사용자 인터페이스

<p>UI 종류</p>

<ol>
  <li>Web 1.0 렌더링 되는 HTML</li>
  <li>Web 2.0 DHTML + Ajax</li>
  <li>데스크톱 애플리케이션 + HTTP 통신</li>
</ol>

도메인 객체의 렌더링

<p><img src="/images/2018/06/IDDD-figure-14-2.png" alt="사용자 인터페이스는 다수의 애그리게잇 인스턴스의 속성을 렌더링할 필요가 있지만 한 번에 하나의 인스턴스를 수정하도록 요청한다"></p>

<p>그림 14.2 조회 시에는 복수 의 애그리게잇. 명령 시에는 한 개의 애그리게잇</p>

애그리게잇 인스턴스로부터 데이터 전송 객체를 렌더링하기

<p>DTO + Assembler</p>

<blockquote>
  <p>개인적으로 가장 선호하는 방식</p>
</blockquote>

애그리게잇 내부 상태를 발행하기 위해 중재자를 사용하자

<p>중재자 패턴</p>

<blockquote>
  <p>개인적으로 비추 도메인 모델이 (약하긴 하지만) UI에 의존하게 됨</p>
</blockquote>

도메인 페이로드 객체로부터 애그리게잇 인스턴스를 렌더링하라

<p>도메인 객체를 내부에 담고 있는 DPO(Domain Payload Object)로 렌더링 하는 방식</p>

<ul>
  <li>지연로딩 이슈가 있기 때문에 OSIV와 같은 기술과 함께 쓰길 권장한다.</li>
</ul>

애그리게잇 인스턴스의 상태 표현

<p>View Model? Presentation Model?</p>

<blockquote>
  <p>DTO와 차이점을 모르겠다. 상태를 표현한다는 것으로 보아 불변이 가능한 정도 차이인 것인가?</p>
</blockquote>

유스케이스 최적 리파지토리 쿼리

<p>특정 유스케이스에 특화된 쿼리 메소드 제공.</p>

<p>CQRS와 구분하자.</p>

다수의 개별 클라이언트 처리하기

<p>이건 SKIP 하자. 최근의 MVC 프레임워크에서 지원하므로 Application의 책임이 아니라고 본다.</p>

변환 어댑터와 사용자 편집의 처리

<p>Adapter + Command (Or Presentation Model)</p>

<p>주로 명령(편집, 수정) 시에 사용하는 방식</p>

애플리케이션 서비스

<ul>
  <li><strong>애플리케이션 서비스를 얇게 유지(파사드)</strong></li>
  <li><strong>도메인 모델로 위임</strong></li>
</ul>

애플리케이션 서비스 예제

<p>원시타입의 나열 VS <strong>인자 (커맨드) 객체</strong></p>

<ul>
  <li><em>원시타입이 너무 많이 나열되면 그것은 안티패턴이라고 보고 가능하면 인자(Or 커맨드)로 캡슐화 하는 것이 좋아 보인다.</em></li>
</ul>

<blockquote>
  <p>단순 인자이며 명령을 캡슐화 하지 못하는데 커맨드 패턴이라고 부르는 것이 어색해 보인다.</p>
</blockquote>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>application</span><span>;</span>

<span>class</span> <span>TenantIdentityService</span> <span>{</span>
    <span>@Transactional</span>  <span>// 트랜잭션과 보안 처리</span>
    <span>@PreAuthorize</span><span>(</span><span>"hasRole('SubscriberRepresentative')"</span><span>)</span>
    <span>public</span> <span>void</span> <span>activeTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>// 도메인 모델로 위임</span>
        <span>this</span><span>.</span><span>nonNullTenant</span><span>(</span><span>tenant</span><span>).</span><span>activate</span><span>();</span>
    <span>}</span>

    <span>@Transactional</span><span>(</span><span>readOnly</span> <span>=</span> <span>true</span><span>)</span>
    <span>public</span> <span>Tenant</span> <span>nonNullTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Tenant</span> <span>tenant</span> <span>=</span> <span>this</span><span>.</span><span>tenant</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>tenant</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>IllegalArgumentException</span><span>(</span><span>"Tenant does not exists"</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>tenant</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

결합이 분리된 서비스 출력

<div><div><pre>    <span>@Override</span>
    <span>@Transactional</span><span>(</span><span>readOnly</span> <span>=</span> <span>true</span><span>)</span>
    <span>public</span> <span>void</span> <span>findTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Tenant</span> <span>teannt</span> <span>=</span> 
                <span>this</span><span>.</span><span>tenantRepository</span><span>.</span><span>tenantOfId</span><span>(</span><span>tenantId</span><span>)</span>
        <span>this</span><span>.</span><span>tenantIdentityOutputPort</span><span>().</span><span>write</span><span>(</span><span>tenant</span><span>);</span>
    <span>}</span>
</pre></div></div>

<p>최근 추세는 어쨋든 사용자에게 출력에 대한 책임은 가능한 UI가 하는 것이 좋다고 본다.
이는 애플리케이션의 책임이 아닌 것 같다.</p>

<blockquote>
  <p>그러한 것은 컴포넌트로 추상화 해서 UI 모듈에 있는 것이 더 어울리는 것 같다. 개인적으로 출력은 반환 값이 있는 것이 더 직관적으로 보인다.</p>
</blockquote>

여러 바운디드 컨텍스트 묶기

<p><img src="/images/2018/06/IDDD-figure-14-3.png" alt="UI에서 다수의 모델을 구성해야만 할 때가 있다. 이 그림에서는 하나의 애플리케이션 계층을 사용해서 세 개의 모델을 구성한다."></p>

<p>그림 14.3 UI에서 다수의 모델을 구성해야만 할 때가 있다. 이 그림에서는 하나의 애플리케이션 계층을 사용해서 세 개의 모델을 구성한다.</p>

<ul>
  <li>애플리케이션 계층이 <strong>유스케이스</strong>를 관리 - UI 계층이 아니다!!</li>
  <li>제품, 토론, 리뷰 컨텍스트가 분리 VS 하나의 컨텍스트로 통합 &gt; <strong>결론은 모델 정제!!</strong>
</li>
</ul>

<p>개인적으로 이러한 상황에서는 UI에서 각각 쿼리 해서 조합하던가, API-GW에서 조합하는 것이 좋다고 본다.</p>

<p>물론 특정 컨텍스트 내에서 조합해야 한다면 <em>애플리케이션 서비스</em>가 가장 어울리는 장소인 것 같다.</p>

인프라

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuIf8JCvEJ4zLU3DrmTifFQ-NhNcpf-7Dt2rlMcSeL7CfA2Jd91ONAuIavYNcbNYcfEQLP9PK1gSMbMKcfuBaWK0xCRaaioon91MYI4CJ8bg2uDLorSAjUTtVydhbb3TpTxnUjU9rxmwm6Pbv9Qb5QOd9gL1xWb8ByeipI_ABAa7I2CFyqpnJC0m46lLsIilhkNkGdEkHcPHQb0Tq4ePvcRa5EQcvG6yKOzW5D1ExDtNjCDJYKAcdPuVRRYw7rBmKO8W30000" alt="애플리케이션 서비스는 도메인 모델의 리파지토리 인터페이스에 의존적이지만, 인프라의 구현 클래스를 사용한다. 패키지는 넓은 범위의 책임을 캡슐화 한다"></p>

<p>그림 14.4 애플리케이션 서비스는 도메인 모델의 리파지토리 인터페이스에 의존적이지만, 인프라의 구현 클래스를 사용한다. 패키지는 넓은 범위의 책임을 캡슐화 한다</p>

엔터프라이즈 컴포넌트 컨테이너

<p>EJB VS Spring</p>

마무리

<ul>
  <li>도메인 모델 -&gt; UI 모델</li>
  <li>사용자 입력 -&gt; 도메인 모델</li>
  <li>애플리케이션 서비스의 책임</li>
  <li>DIP로 도메인 모델과 기술(인프라) 분리 및 유연성 확보</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsZ7YT7GlZSwFaLOZNMYEVMZULJXO0Qdy0OuWnEUod7Hw-3D-3DtHtI_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsP96XINBjrQgAxMcqimG-2Buu11EN5QAePJ4Rw8zWxFNnjMzDQiE1u9BlnfThclUa1nw0Z4YFZ7UiF-2BYGQkTh8B-2ByGBWSudlHCIPVAwL8HBQxFR-2BRMSbE4wg-2Bwdf-2FRlJkfU0KWsCs1VIc083ObmcaRcrHLVHC7oh0r487gHn5QDiYHJRRoy2zgQ-2FUL16e9uXxzZwYalcBbEhaqpRjK85-2BegP">IDDD 14장. 애플리케이션</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcU7ulV_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsP96XINBjrQgAxMcqimG-2Buu11EN5QAePJ4Rw8zWxFNnhhXSqSJMc1lY4ZGEc4HBsydiFjpfLD443LkE3JNgdvx7qI-2FoNrmHXw9Cgh3D6fJOUdE8RaNFJKGuz67URUdY3-2BTra5sFIKpEAALx6n82de-2BwDKIeRphjG8QWwpKlxAYG424kN-2FdIjSiPbdED1-2BYnDmzz7l31bt1x-2BcHxKE8so8-2F">DevOOOOOOOOP</a> on June 19, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNeNVd6tSaTu0o841AtvDOt1DnGuCderuS4ffBd35tylB29xyw-2FcygEygtOMUjbTtQdeE-2BWgM-2FZnSqlTUAdtmpTDllpRpWMIHS3rFRLSqsHJigLdCcSsqDrIpTVOTsjwq7Z7amtIQlmBhl7CYNIaxdACsLIJyuHTR3dcxx0xE5bVE9Rads-2BmiM7LdxS1pGnWV-2BB8RQrQa4sCz6ODDxJKkby" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003907.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3906" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003906.html">IDDD 13장. 바운디드 컨텍스트 통합</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:25+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    통합의 기본

<ol>
  <li>API &amp; RPC (RPC, SOAP, WEB/API) : 탄력성이 떨어짐(<em>Legacy</em>)</li>
  <li><strong>메시지</strong></li>
  <li>
<strong>RESTful API</strong>
    <ul>
      <li>1.과 유사하지 않은가? 하지만 필자는 HTTP Verbs 로 차이를 이야기하고 있다.</li>
    </ul>
  </li>
  <li>그 외</li>
</ol>

분산 시스템은 근본적으로 다르다

<p><em>분산 컴퓨팅의 원칙</em></p>

<ul>
  <li>네트워크는 신뢰할 수 없다.</li>
  <li>언제나 지연은 있다.</li>
  <li>대역폭은 무한하지 않다.</li>
  <li>정보와 정책은 다수의 관리자에 걸쳐 퍼져 있다.</li>
  <li>네트워크 전송은 비용이 든다.</li>
  <li>네트워크는 다양성을 갖고 있다.</li>
</ul>

<blockquote>
  <p><strong>왜 원칙인가?</strong></p>
  <ul>
    <li>반드시 해결해야하는 문제점</li>
    <li>계획해야하는 복잡성</li>
    <li>일반적으로 저지르는 <strong>실수가 아님</strong>
</li>
  </ul>
</blockquote>

시스템 경계에 걸친 정보의 교환

<p>결국은 발행된 언어Published Language에 의존해야한다.</p>

<ul>
  <li>정보에서는 인터페이스/클래스가 중요한 것이 아니라 말 그대로 데이터의 특성이 중요</li>
</ul>

<p><strong>예를 들어서</strong></p>

<p>BacklogItemCommitted 알림 이벤트를 발행한다고 하면 아래와 같은 <em>계약</em>을 의미할 것이다.</p>

<table>
  
    <tr>
      <th>정의/속성</th>
      <th>설명</th>
    </tr>
  
  
    <tr>
      <td>타입</td>
      <td>Notification</td>
    </tr>
    <tr>
      <td>포멧</td>
      <td>JSON</td>
    </tr>
    <tr>
      <td>notificationId</td>
      <td>식별자</td>
    </tr>
    <tr>
      <td>typeName</td>
      <td>알림의 타입(BacklogItemCommitted)</td>
    </tr>
    <tr>
      <td>version</td>
      <td>알림 버전</td>
    </tr>
    <tr>
      <td>occurredOn</td>
      <td>발생일시</td>
    </tr>
    <tr>
      <td>event</td>
      <td>본문(Payload)</td>
    </tr>
  
</table>

<p>직렬화 &amp; 역직렬화 자바 소스는 <strong>SKIP</strong></p>

<p><em>중요한 것</em></p>

<ul>
  <li>위와 같은 <em>계약</em>을 통해 컨슈머와 프로슈머가 서로 통신(정보의 교환)을 할 수 있다</li>
  <li>시스템 상호간 의존성이 줄어든다. <em>공유 커널</em>과 비교해보아라
    <ul>
      <li>버전을 통해서 호환성 이슈가 더 없어진다.</li>
    </ul>
  </li>
  <li>위 내용을 <strong>사용자 지정 미디어 타입 계약</strong> 이라 한다.</li>
</ul>

레스트풀 리소스를 사용한 통합

<p><strong>오픈 호스트</strong></p>

<blockquote>
  <p>서비스의 집합으로서 여러분의 서브시스템으로의 액세스를 허용하는 프로토콜을 정의하자.
여러분과 통합해야 하는 모든 사람들이 사용할 수 있도록 프로토콜을 공개하자.
프로토콜을 강화하고 확장해서 새 통합 요구사항을 처리하도록 하자. [Evans]</p>
</blockquote>

<ul>
  <li>결합도를 느슨하게 하기 위해서(자율성) retry와 같은 기법이 요구된다.</li>
</ul>

<p><em>RESTful API 예를 들면</em></p>

<p>특정 사용자의 권한을 조회 /tenants/{tenantId}/users/{username}/inRole/{role}</p>

<ul>
  <li>200 : 권한 있음</li>
  <li>204 : 권한 없음 (404도 괜찮지 않을까?)</li>
</ul>

레스트풀 리소스의 구현

<p>현업에서 우리는 <em>오픈 호스트</em>라고 생각했지만 실상은 <em>공유된 커널</em> 이거나 <em>순응주의자</em>인 경우가 많다.</p>

<p><em>오픈 호스트</em>라면 바운디드 컨텍스트가 의존성이 매우 낮지만 <em>공유된 커널</em>이나 <em>순응주의자</em>는 상당한 결합도를 가지게 되므로 자율성을 위해서 <strong>오픈 호스트</strong> 지향하는 것이 좋다고 본다.</p>

<p><em>UserResource.java</em></p>
<div><div><pre>    <span>@GET</span>
    <span>@Path</span><span>(</span><span>"{username}/inRole/{role}"</span><span>)</span>
    <span>@Produces</span><span>({</span> <span>OvationsMediaType</span><span>.</span><span>ID_OVATION_TYPE</span> <span>})</span>
    <span>public</span> <span>Response</span> <span>getUserInRole</span><span>(</span>
            <span>@PathParam</span><span>(</span><span>"tenantId"</span><span>)</span> <span>String</span> <span>aTenantId</span><span>,</span>
            <span>@PathParam</span><span>(</span><span>"username"</span><span>)</span> <span>String</span> <span>aUsername</span><span>,</span>
            <span>@PathParam</span><span>(</span><span>"role"</span><span>)</span> <span>String</span> <span>aRoleName</span><span>)</span> <span>{</span>

        <span>User</span> <span>user</span> <span>=</span> <span>this</span><span>.</span><span>accessApplicationService</span><span>()</span>
                       <span>.</span><span>userInRole</span><span>(</span>
                               <span>aTenantId</span><span>,</span>
                               <span>aUsername</span><span>,</span>
                               <span>aRoleName</span><span>);</span>

        <span>Response</span> <span>response</span> <span>=</span> <span>this</span><span>.</span><span>userInRoleResponse</span><span>(</span><span>user</span><span>,</span> <span>aRoleName</span><span>);</span>
        <span>return</span> <span>response</span><span>;</span>
    <span>}</span>
</pre></div></div>

<p><em>사용자의 권한을 조회하는 API 응답</em></p>

<div><div><pre>HTTP1.1 200 OK
Content-Type: application/vnd.saasovation.idovation+json
...
{
    "role": "Author",
    "username": "zoe",
    "tenantId": "A94A-...",
    "firstName": "Zoe",
    "lastName": "Doe",
    "emailAddress": "zoe@saasovation.com"
}
</pre></div></div>

부패 방지 게층을 통한 REST 클라이언트 구현

<p><img src="/images/2018/06/IDDD-figure-13-1.png" alt="ID와 액세스 컨텍스트와 협업 컨텍스트의 부패 방지 계층 사이의 통합을 위해 사용된 오픈 호스트 서비스"></p>

<p>그림 13-1 <em>ID와 액세스 컨텍스트와 협업 컨텍스트의 부패 방지 계층 사이의 통합을 위해 사용된 오픈 호스트 서비스</em></p>

<div><div><pre><span>interface</span> <span>CollaboratorService</span> <span>{</span>
    <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Creator</span> <span>creatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Moderator</span> <span>moderatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Owner</span> <span>ownerFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Participant</span> <span>participantFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><strong>Java Code</strong></p>
<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2Vo04C6nxhBo2EtVBz71OI9v7l3HS-2FFIGwMuIoFN6S9s-2BkLOmDx7-2BfGK1083Fp3Pb3ShF_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvs9Ev6zua5wi96V0YzbB-2FHepY8AfUYRWIBcONuYmZNWHreTeF6DmwiWrciA4HtpALRFJc1uGqiLyicW68-2F2-2Bg4UlSENogDEgE6p8RvS4rGWHDnr6QEYJG8txM0tcGbj0e87GcRiAgJ3h-2Bra6-2BGby-2FcJiuQad1oQBns5iRvoAtOAt">TranslatingCollaboratorService</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2kpiHvWVHiqKsxG7f8OFH-2BBWS6iEiBhtalK5hK7hlULY-3D2yQ-_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvrc9bBra2u9J3wuqs4Ngi9GGTXvvFbfH-2BfSISBJT0b-2FJ-2BLuWBsJtw2czeqF-2BZnA3F49-2F5D1WgRBNRnTaz3mAwXaXQefWogejlfZ68lBvwnGRa0QRSRtTXhEnFJLIXpIOBf9nGK-2FeyNtYvhei6dG6-2FcZJuKgLzZ91hSsZjLWTlEUm">UserInRoleAdapter</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2H4Ho8-2FOjMkDwW0QJNU1eQyZ1uJjzaNi-2FI8gDC3uSrofrVdc2A6I-2FWOGi3X6Y4eIXEauR_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvhmuVwuByWO31wjAg2n8XL4YlqndGJgwBmQEE5tRrwnpmB2XgS-2BOkAQo-2Bv4l9QSTXtQELKK6pH4x-2FlT6Pe5JGqBV8qH4nlbW2uTkPg6HQWItIPQ44p-2B2-2FvJ6Uls-2BeyOUal21bKdhfyDhJKIvzNIEDv-2BzHVegGpyGOPJlCI8HI1jK">CollaboratorTranslator</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbJXydgPI3oCd3QMs5suRkGiE3hN22GZM-2B3EnTejOTOKA0XLWxgATmvg03blZ3q9d1c-3DxDJe_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvvsE0LNhxedodHb8jZKsC7FCJSGOhqzYhDKE6z481k47nSGpg5SAR3pEMlEbhR1E3ai-2FZ6b9MXtXzYIIidfXzy5CF3mYBZtYjGSPUKBdSDh9XJNnJ-2BpLBkqr625LA67TScsYRk9van3Bu0YWVnw46SiWFta50ZtIPRIKVXnF34Gl">Author</a></li>
</ul>

<p>리파지토리를 사용할 수도 있었지만 Author는 엔터티가 아닌 값 객체이므로 부패 방지 계층이 더 어울리다.
반대로 부패 방지 계층에서 애그리게잇(가변성)을 생성한다면 리파지토리가 더 어울린다.</p>

메시징을 사용한 통합

<p>레스트풀 리소스를 이용한 방식보다 <strong>더 높은 수준의 자율성</strong>을 가짐.</p>

<p><strong>도메인 이벤트</strong>를 외부로 발행할 때 좋다.</p>

제품 소유자와 팀 맴버의 정보를 계속해서 제공받는 것

<p>사용자에게 권한을 할당</p>

<ol>
  <li>권한에 사용자를 추가
    <ul>
      <li>AccessService#asignUserToRole(AssignUserToRoleCommand)</li>
      <li>Role#assignUser(User)</li>
    </ul>
  </li>
  <li>사용자에게 권한 할당됨 이벤트 발행 : new UserAssignedToRole()
</li>
  <li>컨텍스트 외부로 이벤트 발행</li>
  <li>AgilePM 컨택스트에서 이벤트를 구독
    <ul>
      <li>TeamMemberEnablerListener#filteredDispatch</li>
      <li>TeamService#enabledProductOwner(EnableProductOwnerCommand)</li>
    </ul>
  </li>
</ol>

당신은 책임을 감당할 수 있는가

<p>외부 바운디드 컨텍스트에서 정보를 (이벤트를 통해서) 복제한 후 그것을 지속적으로 동기화한다. 즉, <strong>데이트를 복사하는 복잡한 책임이 생긴다.</strong></p>

<p>이벤트가 항상 순차적으로 구독자에게 온다는 보장이 없다. 고로 이벤트 처리 시 항상 <em>발생시각</em>을 확인해서 처리해야한다.</p>

<div><div><pre><span>class</span> <span>TeamService</span> <span>{</span>
    <span>@Transactional</span>  <span>// 구독 처리</span>
    <span>public</span> <span>void</span> <span>disableTeamMember</span><span>(</span><span>DisableTeamMemberCommand</span> <span>command</span><span>)</span> <span>{</span>
        <span>TenantId</span> <span>tenantId</span> <span>=</span> <span>new</span> <span>TenantId</span><span>(</span><span>command</span><span>.</span><span>getTenantId</span><span>);</span>
        <span>TeamMember</span> <span>teamMember</span> <span>=</span> 
                <span>teamMemberRepository</span><span>.</span><span>teamMemberOfIdentity</span><span>(</span>
                        <span>tenantId</span><span>,</span> <span>command</span><span>.</span><span>getUsername</span><span>());</span>
        <span>if</span> <span>(</span><span>teamMember</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span>
            <span>// 여기가 중요하다!!!</span>
            <span>teamMember</span><span>.</span><span>disable</span><span>(</span><span>command</span><span>.</span><span>getOccurredOn</span><span>());</span>
        <span>}</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>Member</span> <span>{</span>
    <span>// 위에 이어서 disable 메서드를 보면</span>
    <span>public</span> <span>void</span> <span>disable</span><span>(</span><span>Date</span> <span>asOfDate</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>canToggleEnabling</span><span>(</span><span>oaOfDate</span><span>))</span> <span>{</span>
            <span>this</span><span>.</span><span>setEnabled</span><span>(</span><span>false</span><span>);</span> <span>// enable() 라고 하지..</span>
            <span>this</span><span>.</span><span>setChangeTracker</span><span>(</span>
                <span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>enablingOn</span><span>(</span><span>asOfDate</span><span>));</span>
        <span>}</span>
    <span>}</span>
    <span>public</span> <span>void</span> <span>enable</span><span>(</span><span>Date</span> <span>asOfDate</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>canToggleEnablig</span><span>(</span><span>asOfDate</span><span>))</span> <span>{</span>
            <span>this</span><span>.</span><span>setEnabled</span><span>(</span><span>true</span><span>));</span> <span>// disable() 라고 하지..</span>
            <span>this</span><span>.</span><span>setChangeTracker</span><span>(</span>
                <span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>enablingOn</span><span>(</span><span>asOfDate</span><span>));</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>위 처리를 통해서 이벤트 순서가 뒤바껴도 처리에 문제가 없다.</li>
  <li>또한 멱등하게 만드는 역할도 한다.</li>
</ul>

<p>새로운 책임을 알아보자 : <strong>정보 복제는 사소한 책임이 아니다</strong></p>

<p>사용자 정보 복제 시 영향을 미치는 이벤트들</p>

<ul>
  <li>PersonContactInformationChanged</li>
  <li>PersonNameChanged</li>
  <li>UserAssignedToRole</li>
  <li>UserUnassignedFromRole</li>
</ul>

<p>하지만 이외에도</p>

<ul>
  <li>UserEnablementChanged</li>
  <li>TenantActivated</li>
  <li>TenantDeactivated</li>
</ul>

<p>위와 같은 이벤트들이 존재한다.</p>

<p>= <em>가능하면 바운디드 컨텍스트 전반에서 정보의 중복을 최소화하거나 완전히 제거하는 것이 최선이다</em></p>

<p>= 필요할 때 마다 오픈 호스트 서비스와 같은 것을 이용해서 정보를 조회하는 것이 나을수도 있다</p>

<blockquote>
  <p>어쩌란 건지 명확히 이해가 안된다.???
필요한 이벤트 발행을 막을 필요는 없지만 굳이 데이터 중복을 통해서 관리하지 말고 이벤트는 이벤트대로 사용하고, 데이터는 필요할 때 마다 조회하는 것이 낫다는 것인가?</p>
</blockquote>

장기 실행 프로세스와 책임의 회피

<p>다른 바운디드 컨텍스트에게 데이터 생성 책임을 지게 하고, 단순하게 레코드 시스템이 그 고유한 정보를 처리하게 할 것이다. 
즉, <strong>책임을 네트워크 건너로 차버린다.</strong></p>

<p><em>제품을 생성하는 유스케이스를</em> 살펴본다</p>

<ol>
  <li>사용자는 제품 설명 정보를 제공한다.</li>
  <li>사용자는 팀토론에 대한 의사를 표시한다.</li>
  <li>사용자는 정의된 제품을 만들도록 요청한다.</li>
  <li>시스템은 포럼과 <strong>토론</strong>이 들어간 제품을 만든다.</li>
</ol>

<p><strong>애자일 프로젝트 관리 컨텍스트에서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP7DIaGn38NtUOg-m7q15yF0k5JmP-4wqnwzWTfUcrJnxGrSos0HTDdpdPEVzAZ6pVfh9evMMpXbGJ7QN9Ge6nSBTwsc7kqHxLqYVaFa4R7FyJmri25HhCLQpKE-5erTLMfvm5k7kkL6r53GVXIzXIg_O4yvIsnyPiK0znqTj0yQbiCqNxWA1H_VsfFOUcbBa_EItKE3EvXMSRxrSnPTQGABU__Up_FFaWqDoLqRMrpf7wdbC1_32obAebbUXdMSv-Wk_zKl" alt="애자일 프로젝트 관리 컨텍스트에서 흐름도"></p>

<p>ProjectService#newProductWithDiscussion(NewProductCommand)</p>

<ul>
  <li>
Product와 ProductDiscussion을 생성</li>
  <li>
ProductCreated 이벤트 발행
    <ul>
      <li>
Discussion#availablity#isRequested(토론 가능 상태)가 참이면 <strong>장기 프로세스를 시작</strong> 한다.</li>
      <li>장기 실행 프로세스 == 상품 토론을 생성</li>
    </ul>
  </li>
  <li>추후에 구매를 통해서 토론을 생성할 수도 있다. Product#requestDiscussion(DiscussionAvailablity)
    <ul>
      <li>
ProductDiscussionRequested 이벤트 발행</li>
    </ul>
  </li>
</ul>

<p>그렇다면 사용 가능 상태가 REQUESTED가 아니라면 이 이벤트의 발행의 의미가 있는가?</p>

<p>&gt; 이것에 대한 책임은 이벤트 구독자가 갖는다.</p>

<p>ProductDiscussionRequestedListener#listensToEvents</p>

<ul>
  <li>
ProductCreated, ProductDiscussionRequested 이벤트를 수신한다.</li>
</ul>

<p>ProductDiscussionRequestedListener</p>

<div><div><pre>    <span>protected</span> <span>void</span> <span>filteredDispatch</span> <span>(</span><span>String</span> <span>type</span><span>,</span> <span>String</span> <span>textMessage</span><span>)</span> <span>{</span>
        <span>// 토론 사용 가능상태가 아니면 이벤트 처리 없음</span>
        <span>if</span> <span>(!</span><span>reater</span><span>.</span><span>eventBooleanValue</span><span>(</span><span>"requestingDiscussion"</span><span>))</span> <span>{</span>
            <span>return</span><span>;</span>
        <span>}</span>
        <span>...</span>
        <span>// CreateExclusiveDicussion 커맨드를 만들어 협업 컨텍스트에 메시징 인프라를 통해서 이벤트 발행</span>
        <span>this</span><span>.</span><span>messageProducer</span><span>().</span><span>send</span><span>(...);</span>
    <span>}</span>
</pre></div></div>

<p>여기서 잠깐</p>

<ul>
  <li>애자일 프로젝트 관리 컨텍스트에서 Product 애그리게잇에서 발행된 이벤트(ProductCreated)를 구독할 리스터를 만들 필요가 있을까?
    <ul>
      <li>차라리 협업 컨텍스트에서 ProductCreated 이벤트를 바로 구독하는 것이 낫지 않을까?</li>
      <li>그런데 ProductCreated는 협업 컨텍스트의 유비쿼터스 언어와 어울리지 않고, 이 이벤트가 Forum과 Discussion을 생성하게 한다는 것을 연결시키는 것이 힘들다.</li>
      <li>고로 협업 컨텍스트 입장에서 CreateExclusiveDicussion 명령을 이벤트로 받는 것이 어색하지 않다.</li>
    </ul>
  </li>
</ul>

<p><strong>협업 컨텍스트에서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP5DJaCn38JtFaKkq7S05gWIFojOe9uWBsy4bjBaAROBt1u72JNbWTHLf9dFav6z5urDxPXfYHhdA0ZF48clU34OADMYhURmy96o2Pzmpv9CX6kvQuZgxnEBeg3HwacSU8r5msDjTZoWdJXXQrmevqH2KTRFGJdqTbY8nb9Xjxkzfb2u2MApfCOpw1hUOyVUVRx_FqtJq74a_flurlucVv3VYHquQquLlDCWkBrPYrEhpPdbZRQUB-dob7kKnG_z1G00" alt="협업 컨텍스트에서 흐름도"></p>

<p>ExclusiveDiscussionCreationListener#filteredDispatch(String, String)</p>

<ul>
  <li>위에서 이어 애자일 프로젝트 관리 컨텍스트에서 발행한 CreateExclusiveDicussion를 구독</li>
  <li>
ForumService#startExclusiveForumWithDiscussion를 호출해서 Forum과 Discussion을 생성
    <ul>
      <li>생성과 동시에 DiscussionStarted 이벤트를 발행한다.</li>
    </ul>
  </li>
</ul>

<p><strong>다시 애자일 프로젝트 관리 컨텍스트로 돌아와서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/VP1D2i8m48NtSufSe1TmKRfm8oWeFK5-7ZfGavAP2DxU24gaj2uV-RwybmoYDckvJnIiMcS5vWGHUyMbe81yYfhJPFOileXmYkDRG3YoA28opJMovzb6DUUSGl4w8Z_OO-s849Nr-OtjsaDaPQi8HBy3JDVrs-LcPwGuyPaTQ9lg-iMowl6dhrcqO9hr5s_SsckgEXStiTneG0prery0" alt="다시 애자일 프로젝트 관리 컨텍스트에서 흐름도"></p>

<p>DiscussionStartedListener#filteredDispatch(String, String)</p>

<ul>
  <li>협업 컨텍스트에서 발행한 DiscussionStarted 이벤트를 구독한다.</li>
</ul>

<p>이어서 ProductService#initiateDiscussion(InitiateDiscussionCommand)</p>

<ul>
  <li>
Product#initiateDiscussion 를 실행해서 아까 생성한 Product에서 Discussion 생성 상태 변경
    <ul>
      <li>당연히 멱등하다. 이미 Discussion을 생성해서 READY 상태라면 아무일도 일어나지 않는다. 즉 REQUESTED 상태에서만 이하 작업이 실행된다.</li>
      <li>그리고 ProductDiscussionInitiated 이벤트를 발행한다.</li>
    </ul>
  </li>
</ul>

<p>여기서 잠깐</p>

<ul>
  <li>이 장기 실행 프로세스는 네트워크를 건너서 통신하고 메시징 인프라에 의존하는데 여기에 문제가 생기면 어떻게 될까?</li>
  <li>즉 프로세스가 끝까지 실행한다고 확신할 수 있을까?</li>
</ul>

프로세스 상태 머신과 타임아웃 트래커

<p>위 문제점 해결을 위해서 타임아웃 트래커가 필요하게 된다.</p>

<p><em>타입아웃 트래커</em></p>

<p>트래커는 완료까지 부여된 시간이 만료된 프로세스를 감시하는데. 이런 프로세스는 만료되기 전까지 몇번이고 재시도될 수 있다. 
트래커는 원하는 경우 고정된 시간 간격을 재시도하도록 설계할 수 있고, 재시도를 전혀 하지 않거나 정해진 횟수만큰을 재시도한 후에 타임아웃을 발생시키도록 할 수도 있다.
<em>기술적 서브도메인의 일부다</em></p>

<p><img src="http://www.plantuml.com/plantuml/svg/XP5HIiSm38VVUufUm0liGGRwCX2KkGkK9W_1BTa_IGLlRmiAhbHzAQ7zVUdNT3PFwkNOGnPsbJs-g439_aYMYna9htWhQ8xmH7Lbr71MX3ATYVqx_ehwJXdxeunccwRyXhhYAKOk-d49RNJWWx2v9cA4AnD7LuNmlsAyk-_CuXJRKtz02vDJybg5BbhXlxMcVaeiNmgDW-VYWvQ_ZQDsIm1ZeEqqSnnwBn1cPAY_zma0" alt="상품의 토론 생성 흐름도 with 타임아웃 트래커"></p>

<p>ProductService#startDiscussionInitiation</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>application</span><span>;</span>

<span>class</span> <span>ProductService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>startDiscussionInitiation</span><span>(</span>
            <span>StartDiscussionInitiationComman</span> <span>command</span><span>)</span> <span>{</span>
        <span>Product</span> <span>product</span> <span>=</span> <span>productRepository</span><span>.</span><span>findById</span><span>(...)</span>
        
        <span>TimeConstrainedProcessTracker</span> <span>tracker</span> <span>=</span> <span>new</span> <span>TimeConstrainedProcessTracker</span><span>(</span>
                <span>product</span><span>.</span><span>tenantId</span><span>().</span><span>id</span><span>,</span>
                <span>ProcessId</span><span>.</span><span>newProcessId</span><span>(),</span>
                <span>"Create discussion for product : "</span> <span>+</span> <span>product</span><span>.</span><span>name</span><span>(),</span>
                <span>new</span> <span>Date</span><span>(),</span>
                <span>5L</span> <span>*</span> <span>60L</span> <span>*</span> <span>1000L</span><span>,</span> <span>// 5분 마다 재시도</span>
                <span>3</span><span>,</span>                <span>// 총 3회 재시도한다.</span>
                <span>ProductDiscussionRequestTimedOut</span><span>.</span><span>class</span><span>);</span>

        <span>processTrackerRepository</span><span>.</span><span>add</span><span>(</span><span>tracker</span><span>);</span>  <span>// 타임아웃 트래커 등록</span>
        
        <span>product</span><span>.</span><span>setDiscussionInitiationId</span><span>(</span>
                <span>tracker</span><span>.</span><span>processId</span><span>().</span><span>id</span><span>());</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><strong>상품의 토론 타임아웃 or 재시도 흐름도</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/dOzTgi8m44RViufiuDu5-20jj8L2GL4t49EvC90Vd9aKkdldHG8g2lSb9EISR-RhM1n9JT6uA5OmGQbYh3rI2TNBWEmhCvPy0g5jGHR8GFPd_o3EG2jwiBidkNszXHbo69F3E1Mwg1WELHJomFmfGCq_bTfQSqP19tfhMkEbWMgsHxzgYBjYHDb-ftvUni50PB04sl9VzPlwlJp1hGBBon03EPXEZvhY7G00" alt="상품의 토론 타임아웃 or 재시도 흐름도 with 타임아웃 트래커"></p>

<p><strong>마지막에 상품과 토론이 정상적으로 생성되면 흐름도</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZOun3i8m34Ntd28Nu08Cg1AC34Zj1IBd3nQ94zaEvwTC5HKWHlk_x-V9FAcFMW8rSMqbNjXec76J-HKXNzaS0Wrz7Pcu9_5uqvO7-GnzCE5JzBPRkEBSn5mJ2_AA4CmMJNI7Xl3L6G-ddIeU8mix9yVM2ZjcQ_sB_tnmFKAjzW973XCaZrgU" alt="상품과 토론이 정상적으로 생성 시 흐름도"></p>

<ul>
  <li>애자일 프로젝트 관리 컨텍스트에서 마지막으로 상품의 토론이 정상적으로 생성되면 <strong>타임아웃 트래커를 완료</strong> 시켜야 한다.</li>
  <li>이것으로 프로세스는 끝난다.</li>
</ul>

<p><em>위 장기 실행 프로세스의 문제점과 해결책</em></p>

<ul>
  <li>동일한 CreateExclusiveDiscussion 커맨드가 여러 번 발송된다.
    <ul>
      <li>멱등성을 지켰기 때문에 문제가 없을 것 같다.</li>
      <li>하지만 애자일 프로젝트 관리 컨텍스트가 실패한다면 문제가 발생할 수 있다.</li>
      <li>결국 협업 컨텍스트의 ExclusiveDiscussionCreationListener가 멱등한 애플리케이션 서비스 메서드로 작업을 위임할 수 있다면 많은 문제점을 해결할 수 있다.</li>
    </ul>
  </li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP5DJaCn38JtFaKkq7S05gWIFojOe9uWBsy4bjBaAROBt1u72JNbWTHLf9dFav6z5urDxPXfYHhdA0ZF48clU34OADMYhURmy96o2Pzmpv9CX6kvQuZgxnEBeg3HwacSU8r5msDjTZoWdJXXQrmevqH2KTRFGJdqTbY8nb9Xjxkzfb2u2MApfCOpw1hUOyVUVRx_FqtJq74a_flurlucVv3VYHquQquLlDCWkBrPYrEhpPdbZRQUB-dob7kKnG_z1G00" alt="협업 컨텍스트에서 흐름도"></p>

<ul>
  <li>위 흐름도 기준에서 startForum, startDiscusssion 행위가 멱등하면 해결된다.</li>
</ul>

좀 더 복잡한 프로세스 설계하기

<p>복잡한 상황에서 다수의 완료 단계가 필요하게 된다면 <strong>상태 머신</strong>이 좋은 선택</p>

<div><div><pre><span>Proces</span> <span>process</span> <span>=</span> <span>new</span> <span>TestableTimeConstrainedProcess</span><span>(</span>
        <span>TENANT_ID</span><span>,</span>
        <span>ProcessId</span><span>.</span><span>newProcessId</span><span>(),</span>
        <span>"Testable Time Constrained Process"</span><span>,</span>
        <span>5000L</span><span>);</span> <span>// 재시도 없이 5초 내로 완료되야 한다.</span>

<span>TimeConstrainedProcessTracker</span> <span>tracker</span> <span>=</span> 
        <span>process</span><span>.</span><span>timeConstrainedProcessTracker</span><span>();</span>
    
<span>process</span><span>.</span><span>confirm1</span><span>();</span>

<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>isCompleted</span><span>());</span>
<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>didProcessingComplete</span><span>());</span>
<span>assertEquals</span><span>(</span><span>process</span><span>.</span><span>processCompletionType</span><span>(),</span> <span>ProcessCompletionType</span><span>.</span><span>NotCompleted</span><span>);</span>

<span>process</span><span>.</span><span>confirm2</span><span>();</span>

<span>assertTrue</span><span>(</span><span>process</span><span>.</span><span>isCompleted</span><span>());</span>
<span>assertTrue</span><span>(</span><span>process</span><span>.</span><span>didProcessingComplete</span><span>());</span>
<span>assertEquals</span><span>(</span><span>process</span><span>.</span><span>processCompletionType</span><span>(),</span> <span>ProcessCompletionType</span><span>.</span><span>CompletedNormally</span><span>);</span>
<span>assertNull</span><span>(</span><span>process</span><span>.</span><span>timedOutDate</span><span>());</span>

<span>tracker</span><span>.</span><span>informProcessTimedOut</span><span>();</span>    <span>// 어짜피 이미 완료되어 있으므로 아무처리가 없을 것</span>
<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>isTimedOut</span><span>());</span>  <span>// 즉 타임아웃 되지 않았으므로 언제나 false</span>
</pre></div></div>

<ul>
  <li>
TestableTimeConstrainedProcess는 재시도 없이 5초 내로 완료되야 한다.</li>
  <li>
confirm1(), confirm2()만 호출된다면 완전히 완료 상태로 표시된다.
    <ul>
      <li>내부적으로 2가지 상태를 속성으로 지니고 있다.</li>
      <li>즉, confirm1, confirm2 둘 다 true 여야지 완료 상태</li>
    </ul>
  </li>
</ul>

메시징이나 시스템을 활용할 수 없을 때

<ul>
  <li>
<strong>고가용성 확보</strong>가 최선이다.</li>
  <li>메시징인프라가 죽었다가 다시 살아났을때 <em>자동으로 리스너가 재활성화</em> 될 수록 해야한다.</li>
</ul>

마무리

<ul>
  <li>분산 컴퓨팅에서의 통합</li>
  <li>RESTful VS 메시징인프라</li>
  <li>장기 수행 프로세스
    <ul>
      <li>Retry와 타임아웃</li>
      <li><strong>멱등성</strong></li>
      <li>복잡한 상태를 해결해주는 <em>상태 머신</em>
</li>
    </ul>
  </li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuY5o8sPLUqcwUlwpl5XNl7Ye1WW5seiWfrTpztkwbflw-3D-3DaTnf_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvs1IPwSYly7DOdls8ZwW-2BNwqQNDKH4Ofckm8f3ETffEP82SE0GZE9oploxbK7PPgW5UcKPpfj5lv3LdC-2BTt0NOr2ivQOInJC3L2ZVPAB8Zbp6BeFCkzYWXwrwOQizYMSJ0Jqd5cz3Zwd30BeMOZtNxCvStkUlTcpReN9lSUOXzik">IDDD 13장. 바운디드 컨텍스트 통합</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUwXEq_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvmreKUgdKoC1UUUBUQ9uKcKpEIDWHU6pjCwigWsxMzgiAvZeM-2FISnwnU6bRNblMdREm4Ocohi8KIcxNZsInF2jcJbbZxWk7IBkxwvYSPC02TaJjQONC9iqI-2FL0uALXqHQJ57zK-2FkxHHi4Sj3gX1auUpo8KAeTDbYBVQ-2BX5s4NIsM">DevOOOOOOOOP</a> on June 16, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMPHUrvqy27s2W1GPFoCCYCenxBUWgk5LhrGB1Q9ISF0rb72mc-2BCHAj2CX9WHXObUhlt278zi0PAiaGDnhABd7LxbH8oG3D3pJ00agVFBacz9lYIPJXSrXxNHHMCh4yCq5scS2rZSpePBJnX7BZ0HPBvdY8mJZDvQ8ejWWIIilf-2FnNl-2FypA2Es08INq1m0QSOuu4fGeAaFRvGouMQojSrdJ" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003906.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3905" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003905.html">IDDD 12장. 리파지토리</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:24+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <blockquote>
  <p>전역(global) 액세스가 필요한 각 객체의 타입이다, 해당 타입의 모든 객체가 담긴 인메모리 컬렉션이란 허상을 제공하는 객체를 생성하자.
잘 알려진 전역의 인터페이스를 통한 액세스를 설정하자.
객체를 추가하거나 제거하는 메소드를 제공하자…
일정 조건에 부합되는 특성을 갖는 객체를 선택해 완전히 인스턴스화된 객체나 여러 객체의 컬렉션으로 반환하는 메소드를 제공하자…
애그리게잇에 대해서만 리파지토리를 제공하자.. [Evans]</p>
</blockquote>

<p>애그리게잇 : 리파지토리 = 1(..N):1</p>

컬렉션 지향 리파지토리

<div><div><pre><span>package</span> <span>java</span><span>.</span><span>util</span><span>;</span>

<span>public</span> <span>interface</span> <span>Collection</span> <span>{</span>
    <span>public</span> <span>boolean</span> <span>add</span><span>(</span><span>Object</span> <span>o</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>addAll</span><span>(</span><span>Collection</span> <span>c</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>remove</span><span>(</span><span>Object</span> <span>o</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>removeAll</span><span>(</span><span>Collection</span> <span>c</span><span>);</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>같은 인스턴스를 두번 추가되도록 허용해서는 안된다.</li>
  <li>
<em>재저장</em>을 할 필요가 없다.
    <ul>
      <li>그저 객체의 상태를 변경시키면 자동으로 저장될 뿐이다.</li>
    </ul>
  </li>
  <li>결국 Set처럼 행동해야 한다.</li>
</ul>

<p><em>재저장</em>할 필요가 없다면 객체의 상태를 추적해야한다.</p>

<p><em>영속성 매커니즘의 암시적 변경 추적 기법</em></p>

<ul>
  <li>암시적 읽기 시 복사(Copy-on-Read) : 읽을 때 복사본을 만들어 두고 복사본과 비교해서 변경된 것이 있으면 Commit 시킨다.</li>
  <li>암시적 쓰기 시 복사(Copy-on-Write) : 프록시로 감싸두고 Dirty(상태 변경이 되면)인 경우 Commit 시킨다.</li>
</ul>

하이버네이트 구현

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>calendar</span><span>;</span>    <span>//!!</span>

<span>interface</span> <span>CalendarEntryRepository</span> <span>{</span>
    <span>void</span> <span>add</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>);</span>
    <span>void</span> <span>addAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>);</span>
    <span>void</span> <span>remove</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>);</span>
    <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>);</span>

    <span>CalendarEntry</span> <span>calendarEntryOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarEntriyId</span> <span>id</span><span>);</span>
    <span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntriesOfCalendar</span><span>(</span>
        <span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarId</span> <span>calendarId</span><span>);</span>
    <span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>overlappingCalendarEntries</span><span>(</span>
        <span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarId</span> <span>calendarId</span><span>,</span> <span>TimeSpan</span> <span>timeSpan</span><span>);</span>

    <span>CalendarEntryId</span> <span>nextIdentity</span><span>();</span>
<span>}</span>
</pre></div></div>
<ul>
  <li>
package는 도메인 모델과 함께한다.</li>
  <li>물리적 삭제 VS <strong>논리적 삭제</strong>
</li>
</ul>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>public</span> <span>class</span> <span>HibernateCalendarEntryRepository</span> 
        <span>implements</span> <span>CalendarEntryRepository</span> <span>{</span>
    
    <span>private</span> <span>final</span> <span>SpringHibernateSessionProvider</span> <span>sessionProvider</span><span>;</span>

    <span>public</span> <span>HibernateCalendarEntryRepository</span><span>(</span>
            <span>SpringHibernateSessionProvider</span> <span>sessionProvider</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>sessionProvider</span> <span>=</span> <span>sessionProvider</span><span>;</span>
    <span>}</span>

    <span>private</span> <span>org</span><span>.</span><span>hibernate</span><span>.</span><span>Session</span> <span>session</span><span>()</span> <span>{</span>
        <span>return</span> <span>this</span><span>.</span><span>sessionProvider</span><span>.</span><span>session</span><span>();</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>add</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>saveOrUpdate</span><span>(</span><span>calendarEntry</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>addAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>CalendarEntry</span> <span>each</span> <span>:</span> <span>calendarEntries</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>session</span><span>().</span><span>saveOrUpdate</span><span>(</span><span>each</span><span>);</span>
        <span>}</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>remove</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>delete</span><span>(</span><span>calendarEntry</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>CalendarEntry</span> <span>each</span> <span>:</span> <span>calendarEntries</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>session</span><span>().</span><span>delete</span><span>(</span><span>each</span><span>);</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>package : infrastructure.persistence
</li>
  <li>
Set과 유사한 행위 제공</li>
  <li>
Cascade를 통한 연관된 엔터티를 같이 변경하는 기능도 있음</li>
  <li>복잡한 조회의 경우 HQL을 이용
    <ul>
      <li>하지만 JPA를 사용한다면 JPQL을 사용하나, 현재까지는 querydsl 과 같은 기술이 좋은 것 같다.</li>
    </ul>
  </li>
</ul>

탑링크 구현에 대한 고려

<p>탑링크는 명시적으로 <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3jvomhKARsqEFt5OzuMEla3OxFq7N8A2S9XgKdEV6E3vgwYgi4nZFLPZR0EX6t7X2A-3D-3DwMW5_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMrFCtRE0iiXICK85SGiKLO3e-2BizR1hG7yPdCCPJxvqRzA9LXigtOhL5iC0INcvtl0I-2BwhFkZLPx93KoArmnh0ycfUhuN-2FCTmHx9tvIXRZGj73o1Owu0kNsAw49pu8pt0-2FSJ-2FGDym59Qb7s9gAO19hAp8gaHn2eEHJu-2F44M1GCEqv">작업단위(Unit of work)</a>를 지정할 수 있다.</p>

<ul>
  <li>일종의 트랜잭션의 범위를 추상화 시킨 것</li>
</ul>

<div><div><pre><span>Calendar</span> <span>calendar</span> <span>=</span> <span>session</span><span>.</span><span>readObject</span><span>(...);</span>
<span>UnitOfWork</span> <span>work</span> <span>=</span> <span>session</span><span>.</span><span>acquireUnitOfWork</span><span>();</span>
<span>Calendar</span> <span>calendarToRename</span> <span>=</span> <span>work</span><span>.</span><span>registerObject</span><span>(</span><span>calendar</span><span>);</span>
<span>calendarToRename</span><span>.</span><span>rename</span><span>(</span><span>"CollabOvation Project Calendar"</span><span>);</span>
<span>work</span><span>.</span><span>commit</span><span>();</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>public</span> <span>class</span> <span>ToplinkCalendarEntryRepository</span> 
        <span>implements</span> <span>CalendarEntryRepository</span> <span>{</span>
    <span>@Override</span>
    <span>public</span> <span>void</span> <span>add</span><span>(</span><span>Calendar</span> <span>calendar</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>unitOfWork</span><span>().</span><span>registerNewObject</span><span>(</span><span>calendar</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>editingCopy</span><span>(</span><span>Calendar</span> <span>calendar</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Calendar</span><span>)</span> <span>this</span><span>.</span><span>unitOfWork</span><span>().</span><span>registerObject</span><span>(</span><span>calendar</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

영속성 지향의 리파지토리

<ul>
  <li>컬렉션 지향 리파지토리 : Set
</li>
  <li>영속성 지향 리파지토리 : HashMap
    <ul>
      <li>하지만 꼭 put를 해야한다. - 원자적 쓰기를 통제할 수 없음(트랜잭션 없음)</li>
    </ul>
  </li>
</ul>

<p>No-Sql 종류가 많다.</p>

<ul>
  <li>잼파이어</li>
  <li>코히어런스</li>
  <li>몽고DB</li>
  <li>리악</li>
</ul>

코히어런스 구현

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>product</span><span>;</span>

<span>interface</span> <span>ProductRepository</span> <span>{</span>
    <span>ProductId</span> <span>nextIdentity</span><span>();</span>
    <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span><span>Tenant</span> <span>tenant</span><span>);</span>
    <span>Product</span> <span>productOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>ProductId</span> <span>productId</span><span>);</span>
    <span>void</span> <span>remove</span><span>(</span><span>Product</span> <span>product</span><span>);</span>
    <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>);</span>
    <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>);</span>
    <span>void</span> <span>saveAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>);</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>class</span> <span>CoherenceProductRepository</span> 
        <span>implements</span> <span>ProductRepository</span> <span>{</span>
    <span>private</span> <span>Map</span><span>&lt;</span><span>Tenant</span><span>,</span> <span>NamedCache</span><span>&gt;</span> <span>caches</span><span>;</span>

    <span>public</span> <span>CoherenceProductRepository</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>caches</span> <span>=</span> <span>new</span> <span>HashMap</span><span>&lt;&gt;();</span>
    <span>}</span>

    <span>private</span> <span>synchronized</span> <span>NamedCache</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>NamedCache</span> <span>cache</span> <span>=</span> <span>this</span><span>.</span><span>caches</span><span>.</span><span>get</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>cache</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
            <span>// ageilepm:Product:TenantId</span>
            <span>// 1단계 : 2단계 : 3단계</span>
            <span>cache</span> <span>=</span> <span>CacheFactory</span><span>.</span><span>getCache</span><span>(</span>
                <span>"agilepm.Product."</span> <span>+</span> <span>tenantId</span><span>.</span><span>id</span><span>(),</span>
                <span>Product</span><span>.</span><span>class</span><span>.</span><span>getClassLoader</span><span>());</span>
            <span>this</span><span>.</span><span>caches</span><span>.</span><span>put</span><span>(</span><span>tenantId</span><span>,</span> <span>cache</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>cache</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>())</span>
            <span>.</span><span>put</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>),</span> <span>product</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>saveAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>)</span> <span>{</span>
        <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;</span> <span>productsMap</span> <span>=</span> 
            <span>new</span> <span>HashMap</span><span>&lt;&gt;(</span><span>products</span><span>.</span><span>size</span><span>());</span>
        <span>for</span> <span>(</span><span>Product</span> <span>each</span> <span>:</span> <span>products</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>tenantId</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
                <span>tenantId</span> <span>=</span> <span>product</span><span>.</span><span>tenantId</span><span>();</span>
            <span>}</span>
            <span>productsMap</span><span>.</span><span>put</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>),</span> <span>each</span><span>);</span>
        <span>}</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenantId</span><span>).</span><span>putAll</span><span>(</span><span>productsMap</span><span>);</span>
    <span>}</span>

    <span>private</span> <span>String</span> <span>idOf</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>return</span> <span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>.</span><span>productId</span><span>());</span>
    <span>}</span>
    <span>private</span> <span>String</span> <span>idOf</span><span>(</span><span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>return</span> <span>productId</span><span>.</span><span>id</span><span>();</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>remove</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>()).</span><span>remove</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>));</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>Product</span> <span>each</span> <span>:</span> <span>products</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>remove</span><span>(</span><span>product</span><span>);</span>
        <span>}</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span><span>Tenant</span> <span>tenant</span><span>)</span> <span>{</span>
        <span>Set</span><span>&lt;</span><span>Map</span><span>.</span><span>Entry</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;&gt;</span> <span>entries</span> <span>=</span> 
            <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenant</span><span>).</span><span>entrySet</span><span>();</span>
        <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span> <span>=</span> 
            <span>new</span> <span>HashSet</span><span>&lt;</span><span>Product</span><span>&gt;(</span><span>entries</span><span>.</span><span>size</span><span>());</span>
        <span>for</span> <span>(</span><span>Map</span><span>.</span><span>Entry</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;</span> <span>entry</span> <span>:</span> <span>entries</span><span>)</span> <span>{</span>
            <span>products</span><span>.</span><span>add</span><span>(</span><span>entry</span><span>.</span><span>getValue</span><span>());</span>
        <span>}</span>
        <span>return</span> <span>products</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Product</span> <span>productOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Product</span><span>)</span> <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenant</span><span>).</span><span>get</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>productId</span><span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

몽고DB 구현

<ol>
  <li>애그리게잇을 -&gt; 몽고DB포맷(직렬화), 몽고DB포맷 -&gt; 애그리게잇(역직렬화)</li>
  <li>몽고DB 문서의 고유 식별자(_id)</li>
  <li>몽고DB 노드/클러스터 참조</li>
</ol>

<div><div><pre><span>class</span> <span>MongoProductRepository</span> 
        <span>extends</span> <span>MongoRepository</span><span>&lt;</span><span>Product</span><span>&gt;</span>
        <span>implements</span> <span>ProductRepository</span> <span>{</span>
    
    <span>public</span> <span>MongoProductRepository</span><span>()</span> <span>{</span>
        <span>super</span><span>();</span>
        <span>this</span><span>.</span><span>serializer</span><span>(</span><span>new</span> <span>BSONSerializer</span><span>&lt;</span><span>Product</span><span>&gt;(</span><span>Product</span><span>.</span><span>class</span><span>));</span>
    <span>}</span>

    <span>public</span> <span>ProductId</span> <span>nextIdentity</span><span>()</span> <span>{</span>
        <span>// 몽고DB에서 제공하는 식별자. _id 필드에 매핑시킬수 있음</span>
        <span>return</span> <span>new</span> <span>ProductId</span><span>(</span><span>new</span> <span>ObjectId</span><span>().</span><span>toString</span><span>());</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>()))</span>
            <span>.</span><span>save</span><span>(</span><span>this</span><span>.</span><span>serialize</span><span>(</span><span>product</span><span>));</span>
    <span>}</span>

    <span>protected</span> <span>String</span> <span>collectionName</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>return</span> <span>"product"</span> <span>+</span> <span>tenantId</span><span>.</span><span>id</span><span>();</span>
    <span>}</span>

    <span>protected</span> <span>String</span> <span>databaseName</span><span>()</span> <span>{</span>
        <span>return</span> <span>"agilepm"</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span>
            <span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span> <span>=</span> <span>new</span> <span>ArrayList</span><span>&lt;&gt;();</span>
        <span>DBCursor</span> <span>cursor</span> <span>=</span> 
            <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>databaseName</span><span>(),</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>tenantId</span><span>)).</span><span>find</span><span>();</span>
        <span>while</span> <span>(</span><span>curosr</span><span>.</span><span>hasNext</span><span>())</span> <span>{</span>
            <span>DBObject</span> <span>dbObject</span> <span>=</span> <span>cursor</span><span>.</span><span>next</span><span>();</span>
            <span>Product</span> <span>product</span> <span>=</span> <span>this</span><span>.</span><span>deserialize</span><span>(</span><span>dbObject</span><span>);</span>
            <span>products</span><span>.</span><span>add</span><span>(</span><span>product</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>products</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Product</span> <span>productOfId</span><span>(</span>
            <span>TenantId</span> <span>tenantId</span><span>,</span> <span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>Product</span> <span>product</span> <span>=</span> <span>null</span><span>;</span>
        <span>BasicDBObject</span> <span>query</span> <span>=</span> <span>new</span> <span>BasicDBObject</span><span>();</span>
        <span>query</span><span>.</span><span>put</span><span>(</span><span>"producetId"</span><span>,</span> 
            <span>new</span> <span>BasicDBObject</span><span>(</span><span>"id"</span><span>,</span> <span>productId</span><span>.</span><span>id</span><span>()));</span>
        <span>DBCursor</span> <span>cursor</span> <span>=</span> 
            <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>databaseName</span><span>(),</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>tenantId</span><span>)).</span><span>find</span><span>(</span><span>query</span><span>);</span>
        <span>if</span> <span>(</span><span>cursor</span><span>.</span><span>hasNext</span><span>())</span> <span>{</span>
            <span>product</span> <span>=</span> <span>this</span><span>.</span><span>deserialize</span><span>(</span><span>cursor</span><span>.</span><span>next</span><span>());</span>
        <span>}</span>
        <span>return</span> <span>product</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>BSONSerializer</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>{</span>
    <span>DBObject</span> <span>serialize</span><span>(</span><span>String</span> <span>key</span><span>,</span> <span>T</span> <span>object</span><span>)</span> <span>{</span>
        <span>DBObject</span> <span>serialization</span> <span>=</span> <span>this</span><span>.</span><span>serialize</span><span>(</span><span>object</span><span>);</span>
        <span>serialization</span><span>.</span><span>put</span><span>(</span><span>"_id"</span><span>,</span> <span>new</span> <span>ObjectId</span><span>(</span><span>key</span><span>));</span>
        <span>return</span> <span>serialization</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>abstract</span> <span>class</span> <span>MongoRepository</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>{</span>

    <span>protected</span> <span>DBCollection</span> <span>databaseCollection</span><span>(</span>
            <span>String</span> <span>databaseName</span><span>,</span> <span>String</span> <span>collectionName</span><span>)</span> <span>{</span>
        <span>return</span> <span>MongoDatabaseProvider</span>
                <span>.</span><span>database</span><span>(</span><span>databaseName</span><span>)</span>
                <span>.</span><span>getCollection</span><span>(</span><span>collectionName</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
BSONSerializer 때문에 Setter를 제공할 필요가 없음</li>
</ul>

추가적인 행동

<ul>
  <li>예를 들면 count() or size()
</li>
  <li>또는 리파지토리에서 애그리게잇 파트를 쿼리하는 것 (성능상 잇점)
    <ul>
      <li>하지만 이건 안티패턴이기 때문에 가능한 사용하지 않는 것이 좋다 (애그리게잇 법칙 위배)</li>
      <li>만약 그게 당연시 하다고 느껴지면 애그리게잇을 분리하는 것도 한 방법</li>
    </ul>
  </li>
  <li>일반적으로 도메인 서비스 제어하가 어울린다.</li>
</ul>

<p>하지만 너무 유스케이스에 최적화된 조회 메서드를 많이 제공한다면 악취일 수도 있다</p>

<ul>
  <li>그런 경우 <strong>CQRS</strong>를 고려해보자</li>
</ul>

트랜잭션의 관리

<p>트랜잭션 관리는 애플리케이션 계층의 책임이다. = 애플리케이션 서비스</p>

<p><em>트랜잭션 관리 방법</em></p>

<div><div><pre><span>class</span> <span>ApplicationServiceFacade</span> <span>{</span>
    <span>// 명식적인 트랜잭션</span>
    <span>public</span> <span>void</span> <span>doSomeUseCaseTask1</span><span>()</span> <span>{</span>
        <span>Transaction</span> <span>transaction</span> <span>=</span> <span>null</span><span>;</span>
        <span>try</span> <span>{</span>
            <span>transaction</span> <span>=</span> <span>this</span><span>.</span><span>session</span><span>().</span><span>beginTransaction</span><span>();</span>
            <span>// 도메인 모델을 사용한다.</span>
            <span>transaction</span><span>.</span><span>commit</span><span>();</span>
        <span>}</span> <span>catch</span> <span>(</span><span>Exception</span> <span>e</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>transaction</span> <span>!</span> <span>null</span><span>)</span> <span>{</span>
                <span>transaction</span><span>.</span><span>rollback</span><span>();</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>

    <span>// 선언적인 트랜잭션</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>doSomeUseCaseTask2</span><span>()</span> <span>{</span>
        <span>// 도메인 모델을 사용한다.</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>선언적인 방식이 더 낫다. 순수하게 도메인 로직에 위임하는 것에 집중할 수 있다.
    <ul>
      <li>관심사 분리!!</li>
    </ul>
  </li>
</ul>

경고

<p>단일 트랜잭션에서 여러 애그리게잇을 수정을 커밋하는 기능을 과도하게 사용하지 않도록 주의하라.</p>

타입 계층구조

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWXEBIhBJ4uDACeloqn9BLAevb9GAAaiIEMgXIe8JonAoab5LvPQKPAQbuAX7QOdFo-RU3qEG56WWm00" alt="Type Hierarchy"></p>

<div><div><pre><span>// 도메인 모델의 클라이언트</span>
<span>serviceProviderRepository</span><span>.</span><span>providerOf</span><span>(</span><span>id</span><span>)</span>
        <span>.</span><span>scheduleService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
</pre></div></div>

<ul>
  <li>상위 타입(ServiceProvider)으로 처리</li>
</ul>

<div><div><pre><span>// 도메인 모델의 클라이언트</span>
<span>if</span> <span>(</span><span>id</span><span>.</span><span>identifiesWarble</span><span>())</span> <span>{</span>
    <span>serviceProviderRepository</span><span>.</span><span>warbleOf</span><span>(</span><span>id</span><span>)</span>
            <span>.</span><span>scheduleWarbleService</span><span>(</span><span>date</span><span>,</span> <span>warbleDescription</span><span>);</span>
<span>}</span> <span>else</span> <span>if</span> <span>(</span><span>id</span><span>.</span><span>identifiesWonkle</span><span>())</span> <span>{</span>
    <span>serviceProviderRepository</span><span>.</span><span>wonkleOf</span><span>(</span><span>id</span><span>)</span>
            <span>.</span><span>scheduleWonkleService</span><span>(</span><span>date</span><span>,</span> <span>wonkleDescription</span><span>);</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>하위 타입을 클라이언트에서 알고 분기 처리 해야하는 책임이 늘어난다.</li>
  <li>위 코드는 전형적인 악취이다.</li>
</ul>

<p><strong>그러므로 상위타입은 하위타입에 대한 구분정보(type 속성)를 알고 있어야 한다.</strong></p>

<ul>
  <li>그렇게 된다면 Repository 계층에서 캡슐화 시켜서 하위 타입 별 분기 처리를 할 수 있을 것이다.</li>
</ul>

<div><div><pre><span>@Entity</span>
<span>class</span> <span>ServiceProvider</span> <span>{</span>
    <span>...</span>
    <span>private</span> <span>ServiceType</span> <span>type</span><span>;</span>

    <span>public</span> <span>void</span> <span>scheduleService</span><span>(</span><span>Date</span> <span>date</span><span>,</span> <span>ServiceDescription</span> <span>description</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>type</span><span>.</span><span>isWarble</span><span>())</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleWarbleSevice</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>type</span><span>.</span><span>isWonkle</span><span>())</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleWonkleService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span> <span>else</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleCommonService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>나라면 위의 경우에서도 ServiceType으로 위임해서 if문을 제거했을 것 같다.</li>
</ul>

리파지토리 대 데이터 액세스 객체

<p>Repository != DAO</p>

<ul>
  <li>리파지토리 : 객체 지향 &gt; with 도메인 모델 패턴</li>
  <li>DAO : 데이터 지향 &gt; with 트랜잭션 스크립트 패턴</li>
</ul>

<p>SMART DAO는 DDD 입장에서는 안티패턴</p>

<ul>
  <li>SMART DAO는 도메인 로직이 DB 쿼리나 DB의 프로시저에 존재하는 경우를 말함</li>
</ul>

<p><strong>중요한 것은 데이터 액세스 지향보다는 컬렉션 지향으로 설계하려고 노력해야하는 점</strong></p>

리파지토리의 테스트

<ul>
  <li>실제 인프라와 연동하는 테스트 (실제 DB와 통신)</li>
  <li>인메모리로 연동하는 테스트</li>
</ul>

<blockquote>
  <p>개인적으로 실제 인프라와 연동하는 것이 중요하다고 봄.</p>
</blockquote>

인메모리 구현으로 테스트하기

<p>Skip</p>

마무리

<ul>
  <li>컬랙션 지향 VS 영속성 지향</li>
  <li>리파지토리의 추가적인 행동 (count())</li>
  <li>트랜잭션 처리</li>
  <li>타입 계층과 리파지토리</li>
  <li>Repository vs DAO</li>
  <li>테스트</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtzOkwB8cVmXGClSUdbrej3V-2F8tyT8YzlsGR48HkVBDGQ-3D-3DUStA_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMiHjV-2Bfh4Ii1zv3np3sSiJzi8zN3GKN3pg-2FT4p01-2F3WSZeNHq8xjKgLqCtmZkV795eKX0Pem6ISKZ0UIQa4cBl6GzoQAoK8hue3qgtJLzpOPklGiFMo3a-2BXLbKcQPxAQWwH66a0PS0IQULKMADJaOP4nEt7I3Z6cy42OlUFS2AMt">IDDD 12장. 리파지토리</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUmGGG_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMiKlCIsncf6KjasP2SJrGbmVrSv2C-2B3pShsA98Cm-2Bo-2FpZxF3iCA0fCJfD-2Fa-2B-2BADKlcfKqPn3ehIwi6kfm8UYQgyLyJFwo-2BFXBG-2FnuJ6ERbElONGT-2BnDBDMXXTzccFnlk11V0JKuwjDYpyzFjL-2BGgq-2F5FYJDTWRWvWDPy9bOoWcCs">DevOOOOOOOOP</a> on June 10, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMPh1EwBFJtaMpKlkf5Qk9n1hTYSIrEZy321pHofeJ-2F9wq0-2BxstCKFfJqwwiWyKAcSIr9KzqcKwn-2F0RwshFaorWVNHJ4PnJrATMFJ-2BTpxGxSFqo6PFqWmoMjgqg59RWGVrGhRN81G-2FzKQlVmSILJn3atshNAEOwrb3TmOf3h7B3xt71tD2Pb3lAgCH7DvBBjgZ8R1ircHmyxMuD7JU-2F51lF8" alt="" width="1" height="1" />


  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003905.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3904" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003904.html">IDDD 11장. 팩토리</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:23+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <p>애그리게잇을 생성하는 책임을 가지는 메소드나 객체를 말한다.</p>

<ul>
  <li>애그리게잇 생성을 캡슐화</li>
</ul>

도메인 모델 내의 팩토리

<blockquote>
  <p>복잡한 객체와 애그리게잇 인스턴스를 생성하는 책임을 별도의 객체로 이동시키자. 여기서의 책임은 도메인 모델과 관련이 있지 않지만, 여전히 <em>도메인 설계를 구성하는 한 요소</em>다. 모든 복잡한 조립 과정을 캡슐화하고, 클라이언트가 인스턴스화된 객체의 구체적 클래스를 참조할 필요가 없도록 인터페이스를 제공하자. 전체 애그리게잇을 하나의 조각(원자성)으로 생성하고 고정자(Invariant)를 지정하자 [Evans]</p>
</blockquote>

<ul>
  <li>팩토리 메소드 : 이 책은 주로 여기만 나옴</li>
  <li>팩토리 객체(클래스)
    <ul>
      <li>애그리게잇 생성이 매우 복잡하고 다른 객체의 도움이 필요하면 클래스 분리를 하는 것이 좋은 것 같다.</li>
    </ul>
  </li>
</ul>

<p><em>가능한 팩토리 위치</em></p>

<ul>
  <li>애그리게잇 루트
    <ul>
      <li>정정 생성자를 통해서 도메인 의도가 나오면 더 좋다. static Task#forDraft()
</li>
      <li>아니면 상위 루트에서 하위 엔터리 생성도 가능 Project#createTask()
</li>
    </ul>
  </li>
  <li>도메인 서비스 : 서비스 기반 팩토리
    <ul>
      <li>ProjectService#createProject()</li>
    </ul>
  </li>
  <li>팩토리 : 이 책은 다루지 않음
    <ul>
      <li>ProjectFactory#create()</li>
    </ul>
  </li>
</ul>

애그리게잇 루트상의 팩토리 메소드

<table>
  
    <tr>
      <th>바운디드 컨텍스트</th>
      <th>애그리게잇</th>
      <th>팩토리 메소드</th>
    </tr>
  
  
    <tr>
      <td>식별자와 액세스 컨텍스트</td>
      <td>Tenant</td>
      <td>offerRegisterationInvitation()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>provisionGroup()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>provisionRole()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>registerUser()</td>
    </tr>
    <tr>
      <td>협업 컨텍스트</td>
      <td>Calendar</td>
      <td>scheduleCalendarEntry()</td>
    </tr>
    <tr>
      <td> </td>
      <td>Forun</td>
      <td>startDiscussion()</td>
    </tr>
    <tr>
      <td> </td>
      <td>Discussion</td>
      <td>post()</td>
    </tr>
    <tr>
      <td>애자일 PM 컨텍스트</td>
      <td>Product</td>
      <td>planBacklogItem()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>scheduleRelease()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>scheduleSprint()</td>
    </tr>
  
</table>


CalendarEntry 인스턴스 생성하기

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Calendar</span> <span>extends</span> <span>AbstractAggregateRoot</span> <span>{</span>
    <span>CalendarEntry</span> <span>scheduleCalendarEntry</span><span>(...)</span> <span>{</span>
        <span>CalendarEntry</span> <span>calendarEntry</span> <span>=</span> <span>new</span> <span>CalendarEntry</span><span>(...);</span>
        <span>this</span><span>.</span><span>registerEvent</span><span>(</span><span>new</span> <span>CalendarEntryScheduled</span><span>(...));</span>
        <span>return</span> <span>calendarEntry</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>유비쿼터스 언어에 부합되는 도메인이 표현됨 : scheduleCalendarEntry
</li>
  <li>보호절이 없다 : 어짜피 new CalendarEntry(...)가 책임짐</li>
  <li>
Setter를 사용하지 않는다. &gt; <strong>원자성</strong> + <strong>부수효과 줄어듬</strong> + <strong>불변식 강제</strong>가 쉬움</li>
  <li>이벤트 발행 : CalendarEntryScheduled
</li>
  <li>인자의 갯수가 줄어든다.
    <ul>
      <li>
scheduleCalendarEntry(...)에서는 11개가 요구되지만, new CalendarEntryScheduled(...)에서는 9개로 줄어든다.</li>
      <li>개인적으로는 이것도 인자를 캡슐화 시켜서 객체로 말아버리는 것이 좋은 것 같다. 9개의 인자라도 너무 많은 것 같음.</li>
    </ul>
  </li>
</ul>

<p><strong>하지만</strong></p>

<ul>
  <li>
CalendarEntry를 생성하기 위해서는 꼭 <strong>Calendar 인스턴스</strong>가 요구됨
    <ul>
      <li>이는 DB 조회라는 부하가 추가됨</li>
    </ul>
  </li>
</ul>


Discussion 인스턴스 생성하기

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Forum</span> <span>extends</span> <span>AbstractAggregateRoot</span> <span>{</span>
    <span>Discussion</span> <span>startDiscussion</span><span>(</span>
        <span>DiscussionId</span> <span>discussionId</span><span>,</span>
        <span>Author</span> <span>author</span><span>,</span>
        <span>String</span> <span>subject</span><span>)</span> <span>{</span>

        <span>if</span> <span>(</span><span>this</span><span>.</span><span>isClosed</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>IllegalStateException</span><span>(</span><span>"Forum is closed"</span><span>);</span>
        <span>}</span>
        <span>Discussion</span> <span>discussion</span> <span>=</span> <span>new</span> <span>Discussion</span><span>(</span>
            <span>this</span><span>.</span><span>tenant</span><span>(),</span>
            <span>this</span><span>.</span><span>forumId</span><span>(),</span>
            <span>discussionId</span><span>,</span>
            <span>author</span><span>,</span>
            <span>subject</span><span>);</span>
        <span>registerEvent</span><span>(</span><span>new</span> <span>DiscussionStarted</span><span>(...));</span>
        <span>return</span> <span>discussion</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>포럼이 열린 경우에만 토론을 시작할 수 있다. : this.isClosed()
</li>
  <li>인자 5개 중 3개만 있으면 된다. : 나머지 2개는 포럼에서 제공</li>
  <li>역시나 유비쿼터스 언어가 표현된다. : startDiscussion
</li>
</ul>

서비스의 팩토리

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>collaborator</span><span>;</span>

<span>interface</span> <span>CollaboratorSerice</span> <span>{</span>
    <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Creator</span> <span>creatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Moderator</span> <span>moderatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Owner</span> <span>ownerFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Participant</span> <span>participantFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>// infrastructure.services !!!</span>
<span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>UserRoleToCollaborationService</span> <span>implements</span> <span>CollaboratorSerice</span> <span>{</span>
    <span>@Override</span>
    <span>public</span> <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Author</span><span>)</span> <span>userInRoleAdapter</span><span>.</span><span>toCollaborator</span><span>(</span>
            <span>tenant</span><span>,</span> <span>identity</span><span>,</span> <span>"Author"</span><span>,</span> <span>Author</span><span>.</span><span>class</span><span>);</span>
        <span>)</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>collaborator</span><span>;</span>

<span>class</span> <span>Author</span> <span>extends</span> <span>Collaborator</span> <span>{</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>기술적 구현이므로 <em>인프라 계층</em>의 모듈에 위치한다.</li>
  <li>어댑터에 의존한다.
    <ul>
      <li>
UserInRoleAdapter는 외래 컨텍스트와 의사소통 책임만 갖는다.</li>
      <li>
CollaboratorTranslator는 바운디드 컨텍스트 내 도메인 객체로 변환 책임만 갖는다.</li>
    </ul>
  </li>
  <li>협업에서는 identity 식별자와 액세스에서는 username
</li>
</ul>

마무리

<ul>
  <li>유비쿼터스 언어로 애그리게잇을 생성</li>
  <li>애그리게잇의 팩토리 메서드 VS 서비스의 팩토리 메서드</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsVt-2B5Dea2ggRewqKW79z9vnuot2YEHShIKrraUDTSMOQ-3D-3Dvcqf_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXt-2BLgwZBVEvK18z-2BrcP4Hyzs-2FPLyY9B4293SCh8N2T9SB6-2FxsIBo-2BUchD90gsh4G41DtVjyRD80OiC-2F6GnPlWSKNhkyo2F8FCwqz3-2FW7xZhlY47GRFN3ImnuS2JBNT2ykiO9KUyXUzQVmEsyTpkvoUu-2FRQVB9QZbyLQ5R-2FycKGMzhGGilf-2BZ-2F-2BYzbk6koba8duP-2BpLQNzJY9ckntGxdOTTzZOajQd5HNF-2FRJoQIi8wf-2BA-3D-3D">IDDD 11장. 팩토리</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUoG8H_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXt-2BLgwZBVEvK18z-2BrcP4Hyzs-2FPLyY9B4293SCh8N2T9SEMjLDM2JWNxS5fggA5aPnk7PdvOMBdVomspJ6vkGmsdqCHZHF6DFhE8k3LC37Es4H1CVnIyVwaIcAQU-2FquWF9weSMeh1Dbx5ZHa3sHjRS-2BbqMft-2FGo-2BGv4njSCa7r4PecUMaUUzcXAJ2YOQ5NiYsW4N0sN-2FN7l3RPwtH6DRJnal8rAipt3fZeDPh5ZzoQISOA-3D-3D">DevOOOOOOOOP</a> on June 07, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMenKSVTuFvS50phTwwSPPYuXnVRIe9nTgDbRWrb2XmHm6XUKKY7dY19Ru5t49mpKJzmlyZUnfXeUq9s5caWVBkHDXBd5gLnT4bvFONyQCZa-2Fzjb5oVYWN0Hg0aQLpaK3X5y1dAV-2Fk95E83WPH-2FqcZXnLQ5ebj87INav2Xd9yXD1FR83Y5FHwSrd5CpRkKE4pSNJyRtXR2d85V8z-2FEbl33ACJAUPwsIX2JnQ8yWPMKy6w-3D-3D" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003904.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3903" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003903.html">IDDD 10장. 애그리게잇</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:23+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <p><strong>일관성 경계</strong> 내에서 엔터티와 값 객체의 묶음</p>

<ul>
  <li>
<strong>일관성 경계</strong>의 기준은 같은 트랜잭션인가로 검증된다.</li>
  <li>애그리게잇 내의 불변식(invariant)?</li>
</ul>

스크럼 핵심 도메인에서 애그리게잇 사용하기

<p><em>기능 목록</em></p>

<ul>
  <li>제품은 백로그 아이템과 릴리스, 스프린트를 포함한다.</li>
  <li>새로운 제품 백로그 아이템을 계획했다.</li>
  <li>새로운 제품 릴리스를 계획했다.</li>
  <li>새로운 제품 스프린트 일정을 수립했다.</li>
  <li>계획된 백로그 아이템에 관한 릴리스 일정을 수립할 수 있다.</li>
  <li>일정이 잡힌 백로그 아이템은 스프린트로 커밋할 수 있다.</li>
</ul>

첫 번째 시도: 큰 클러스터의 애그리게잇

<blockquote>
  <p>제품이 ~를 포함한다.</p>
</blockquote>

<p>컴포지션 VS 객체 그래프
포함 VS (상호) 연결</p>

<p><em>도메인 로직</em></p>

<ul>
  <li>백로그 항목을 스프린트로 커밋하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>스프린트가 백로그 항목을 커밋하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>릴리스가 백로그 항목의 일정을 수립하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>백로그 항목의 릴리스 일정을 수립하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
</ul>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>backlogItems</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>private</span> <span>ProductId</span> <span>productId</span><span>;</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>Release</span><span>&gt;</span> <span>releases</span><span>;</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>Spring</span><span>&gt;</span> <span>sprints</span><span>;</span>
    <span>private</span> <span>TenantId</span> <span>tenantId</span><span>;</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWWeoayfJIvHiB5nJ4ylIarCBqbL2ChFBx6pWofmIapEpibFzon9pGKgSiqhoIofX4i6fUQa9XQdOae45nHbvfKWYyCiKZ9KKj3IrRLJK3BGqzDIGZOVbngODRZaeRPnEQJcfG1z1W00" alt="아주 큰 애그리게잇으로 모델링된 Product"></p>

<p><em>아주 큰 애그리게잇으로 모델링된 Product</em></p>

<p><img src="http://www.plantuml.com/plantuml/svg/TOv12i8m54JtFKKka1kKKDrrfLHm_qs6Z_hJIF9pVmKjhK6tCu-PDnIbh3LAvuLACSUSGlLg-dx7d46iC5DAwjmtC8ONSYQfC8VB3Nu5zkJladXKn6M5gLsP8A22_y3faQ-p_keNG-jMbsvZPUrMeMa-lqtwFki6pA56UG80" alt="Product와는 별도의 애그리게잇 타입으로 모델린된 연관된 개념들"></p>

<p><em>Product와는 별도의 애그리게잇 타입으로 모델린된 연관된 개념들</em></p>

<p>큰 애그리게잇으로 모델링하다보면 변경에 취약해져서 업데이트 상황에서 버전 충돌이 발생할 가능성이 커진다. 위를 예시로 두면 한 명이 backlogItem을 변경하고 다른 한 명이 Spring를 변경할 시 직적접 연관이 없음에도 불구하고 버전 충돌이 발생해서 업데이트가 실패할 확률이 커진다. (애그리게잇의 크기가 커짐에 따라서 충돌 확률도 더 커짐)</p>

두 번째 시도: 다수의 애그리게잇

<p><em>하나의 큰 애그리게잇 상 Product.java</em></p>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>public</span> <span>void</span> <span>planBacklogItem</span><span>(</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span><span>,</span> <span>BacklogItemType</span> <span>type</span><span>,</span> <span>StoryPorints</span> <span>storyPoints</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>void</span> <span>scheduleRelease</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>description</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>void</span> <span>scheduleSprint</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>goals</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p><em>여러 개로 분리된 애그리게잇 상 Product.java</em></p>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>public</span> <span>BacklogItem</span> <span>planBacklogItem</span><span>(</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span><span>,</span> <span>BacklogItemType</span> <span>type</span><span>,</span> <span>StoryPorints</span> <span>storyPoints</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>Release</span> <span>scheduleRelease</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>description</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>Sprint</span> <span>scheduleSprint</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>goals</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>일종의 factory 메서드로써 동작한다.</li>
</ul>

<p><em>Product</em><em>*Srvice 예시</em></p>

<div><div><pre><span>@Service</span>
<span>class</span> <span>ProductBacklogItemService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>planProductBacklogItem</span><span>(</span>
        <span>String</span> <span>tenantId</span><span>,</span> <span>String</span> <span>productId</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span>
        <span>String</span> <span>backlogItemType</span><span>,</span> <span>String</span> <span>storyPoints</span><span>)</span> <span>{</span>

        <span>Product</span> <span>product</span> <span>=</span> 
            <span>productRepository</span><span>.</span><span>producetOfId</span><span>(</span>
                <span>new</span> <span>TenantId</span><span>(</span><span>tenantId</span><span>),</span>
                <span>new</span> <span>ProductId</span><span>(</span><span>productId</span><span>));</span>
        <span>BacklogItem</span> <span>plannedBacklogItem</span> <span>=</span> 
            <span>product</span><span>.</span><span>planBacklogItem</span><span>(</span>
                <span>summary</span><span>,</span> <span>category</span><span>,</span>
                <span>BacklogItemType</span><span>.</span><span>valueOf</span><span>(</span><span>aBacklogItemType</span><span>),</span>
                <span>StoryPoints</span><span>.</span><span>valueOf</span><span>(</span><span>stroyPoints</span><span>));</span>
        <span>backlogItemRepository</span><span>.</span><span>add</span><span>(</span><span>plannedBacklogItem</span><span>);</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p>이와 같이 우린 밖으로 빼서 모델링함으로써(Modeling it away) 트랜잭션 실패 문제를 해결했다. 이제 BacklogItem, Release, Sprint등의 인스턴스가 사용자의 요청에 따라 얼마든지 동시적으로 안전하게 생성될 수 있다.</p>

<p>그러나 큰 애그리게잇을 조금 다듬어서 동시성 문제를 해결할 수도 있을지도 모른다. 하이버네이트 매핑에서 optmistic-lock 옵셥을 false로 설정해 트랜잭션 실패가 도미노 처럼 전달되는 상황을 피할 수 있다.</p>

규칙: 진짜 고장자(invariant)를 일관성 경계 안에 모델링하라

<p><em>*중요한 것은 진짜 고정자를 이해하는 것이다.</em></p>

<p>고장자(invariant) : <strong>일관성(트랜잭션 일관성)을 유지해야만 한다는 비즈니스 규칙</strong></p>

<ul>
  <li>트랜잭션 일관성 : 동기적, 원자적</li>
  <li>결과적 일관성 : 비동기적</li>
</ul>

<p><strong>한 트랜잭션에 한 애그리게잇만 인스턴스만 포함</strong> : 이는 너무 가혹한 것 같다.</p>

규칙: 작은 애그리게잇으로 설계하라

<p><img src="http://www.plantuml.com/plantuml/svg/VP1DIiOm443tEKNeij3Y0KgfIXU2eFGJzsConDZyI39PzFQs4YNGq4qNynwTl9aYGQ1a3HC6OkIlmSiaY0_3lL81GH7onNiQnomyW5YDLq-4TfTcHvgsVxYWGOXu1hVle1sTvsyGruejFb4cWvUx7hsrcWZbfJL7qXP8U_VirSx2jZllO1Bobuyl54VONtFRTIDlxlg-RShCAi-bDPPZMV6B4lysi-DJJYiFPNb7gTLEm_9nIwrs73QXaycQ7m00" alt="큰 클러스터 `Product` 애그리게잇"></p>

<p><em>이 Product 모델에선 다양한 기본 오퍼레이션이 수행될 동안 큰 컬랙션을 여럿 가져오게 된다.</em></p>

<ul>
  <li>이 큰 클러스터 애그리게잇은 성능이나 확장성이 절대로 좋을 수 없다. 이는 실패로 이어지는 악몽이 될 뿐이다. 거짓 고정자와 컴포지션적 편의성이 설계를 주도했기 때문에 시작부터 문제가 있었으며, 트랜잭션의 종료, 성능, 확장성의 측면에서 안 좋은 영향을 미쳤다.</li>
</ul>

<p>작은 애그리게잇은? 다른 대상과 일관성을 유지</p>

<ul>
  <li>변경이 되면 엔터티</li>
  <li>대치가 되면 값 객체 : 생각보다 상당히 많은 개념이 값 객체로 대치된다.</li>
</ul>

<blockquote>
  <p>파생 금융상품 부문에서 약 70% 애그리게잇이 단 하나의 루트 엔터티로 구성된다.</p>
</blockquote>

<p><strong>작은 애그리게잇은</strong></p>

<ul>
  <li>성능이 좋음</li>
  <li>확장성이 좋음</li>
  <li>트랜잭션이 성공할 가능성이 크다</li>
</ul>

유스케이스를 전부 믿지는 말라

<ul>
  <li>하나의 유스케이스가 여러 트랜잭션을 발생 시킨다면 의심해 보자
    <ul>
      <li>
<strong>이런 경우에서 결과적 일관성을 통해서 문제를 해결할 수 있다.</strong> + 지연 업데이트</li>
    </ul>
  </li>
  <li>물론 하나의 유스케이스가 하나의 트랜잭션일 필요는 없다.</li>
</ul>

규칙: ID로 다른 애그리게잇을 참조하라

<p>객체 그래프가 연결되어 있다고 해서 같은 애그리게잇은 아니다. 그저 다른 애그리게잇을 연결했을 뿐이다.</p>

<p>여기도 결국 <strong>결과적 일관성</strong>으로 이어진다.</p>

애그리게잇 ID 참조를 통해 서로 함께 동작하도록 해보자

<p><img src="http://www.plantuml.com/plantuml/svg/dP11ImCn48Nl-HMXHw757r125VPG42ohU1ztXnYRp9JCH5Z4_su8MwijUl0qoNkF3zxRY4BMag8P8eZOMnZsaVrMCTdr-iRxZ1uKRS-ipjbtOwqeQ97su3mTxuu3QLDBIj1qdGveFcRm8yY-4ZlIeDDC6b6670uQcEhlXKkM7XC42kIhG92mdZUEXHGnVx5scSSow7Qim2U81UtzyoiEwjmSw34Y2FuUU3ZaG7y0Ej6GG0FJ7VkED4zdoNyt-3xmSkdiudgrkbgqUNvwxbJpt9ZhNHh7MgQjVQ9VrZ4RfB6a-0a0" alt="ID참조모델"></p>

<p><em>ID를 통해 경계 밖과 연결을 추론할 수 있는 BacklogItem 애그리게잇</em></p>

<div><div><pre><span>class</span> <span>BacklogItem</span> <span>{</span>
    <span>private</span> <span>ProductId</span> <span>productId</span><span>;</span>
<span>}</span>
</pre></div></div>

모델 탐색

<p>객체 그래프 탐색과는 다르지만 <em>리파지토르</em>와 <em>ID</em>가 있으면 연관 모델을 탐색할 수 있다. : <em>단전될 도메인 모델(Disconnected Domain Model)</em></p>

<div><div><pre><span>@Service</span>
<span>class</span> <span>ProductBacklogItemService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>assignTeaMemberToTask</span><span>(</span>
        <span>String</span> <span>aTenantId</span><span>,</span>
        <span>String</span> <span>aBacklogItemId</span><span>,</span>
        <span>String</span> <span>aTaskId</span><span>,</span>
        <span>String</span> <span>aTeamMemberId</span><span>)</span> <span>{</span>

        <span>BacklogItem</span> <span>backlogItem</span> <span>=</span> 
            <span>backlogItemRepository</span><span>.</span><span>findById</span><span>(</span>
                <span>new</span> <span>TenantId</span><span>(</span><span>aTenantId</span><span>),</span> <span>new</span> <span>BacklogItemId</span><span>(</span><span>aBacklogItemId</span><span>));</span>
        <span>Team</span> <span>ofTeam</span> <span>=</span> 
            <span>teamRepository</span><span>.</span><span>findById</span><span>(</span>
                <span>backlogItem</span><span>.</span><span>tenantId</span><span>(),</span> <span>backlogItem</span><span>.</span><span>teamId</span><span>());</span>
        <span>backlogItem</span><span>.</span><span>assignTeamMemberToTask</span><span>(</span>
            <span>new</span> <span>TeamMemberId</span><span>(</span><span>aTeamMemberId</span><span>),</span> <span>ofTeam</span><span>,</span> <span>new</span> <span>TaskId</span><span>(</span><span>aTaskId</span><span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

확장성과 분산

<p>ID 참조를 이용하게 되면 같은 영속화 플랫폼을 사용하지 않고 샤딩과 같은 확장을 통해서 일부 애그리게잇을 손쉽게 확장할 수 있다.
<em>예를 들면 어떤 애그리게잇은 DB를 사용하고 연관되는 다른 애그리게잇은 NoSql을 사용할 수 있다.</em></p>

<p>도메인 이벤트를 통해서 외부 바운디드 컨텍스트로 분산처리를 더 가속화할 수 있다.</p>

<p>역시나 중요한 것은 <strong>결과적 일관성</strong>이다.</p>

규칙: 경계의 밖에서 결과적 일관성을 사용하라

<p>결과적 일관성과 지연 시간 = 도메인 이벤트 발행</p>

<ul>
  <li>동시성 이슈로 인해서 발행된 이벤트 구독이 실패하면? 메시징 매커니즘을 통해서 Retry! &gt; 이것은 쉽지가 않은 것 같다.</li>
</ul>

누가 해야 하는 일인지 확인하자

<blockquote>
  <p>데이터의 일관성을 보장하는 주체가 유스케이스를 수행하는 사용자의 일인지를 질문해보자.
만약 그렇다면, 다른 애그리게잇의 규칙들은 고수하는 가운데 트랜잭션을 통해 일관성을 보장하도록 하자.
만약, 다른 사용자나 시스템이 해야 할 일이라면 결과적 일관성을 선택하자.</p>
</blockquote>

규칙을 어겨야하는 이유

첫 번째 이유: 사용자 인터페이스의 편의

두 번째 이유: 기술적 매커니즘의 부족

세 번째 이유: 글로벌 트랜잭션

<p>개인적으로 안티패턴. 결과적 일관성을 사용하자</p>

네 번째 이유: 쿼리 성능

<p>캐싱을 통해서 어느정도 해결할 수 있다.</p>

발견을 통해 통찰 얻기

<p>Skip</p>

구현

고유 ID와 루트 엔터티를 생성하라

값 객체 파트를 선호하라

‘데메테르 법칙’과 ‘묻지 말고 시켜라’를 사용하기

<ul>
  <li>데메테르 법칙 : 정보은닉</li>
  <li>묻지 말고 시켜라 : 정보은닉 + 응집력</li>
</ul>

낙관적 동시성

<p>애그리게잇 루트에 버전을 통한 낙관적 락 기법</p>

<p>@Version : JPA를 이용하면 이 선언만으로도 낙관적 락 기법을 사용할 수 있다.</p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"orders"</span><span>)</span>
<span>public</span> <span>class</span> <span>Order</span> <span>{</span>
    <span>@Id</span>
    <span>private</span> <span>Long</span> <span>id</span><span>;</span>
    <span>@Version</span>
    <span>private</span> <span>int</span> <span>version</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
<span>}</span>
</pre></div></div>

의존성 주입을 피하라

<p>애그리게잇에 서비스나 리파지토리를 주입하지 마라</p>

마무리

<ul>
  <li>가능하면 작은 애그리게잇으로 설계하자</li>
  <li>일관성 경계, 트랜잭션, 고정자가 중요</li>
  <li>객체 그래프 참조 VS ID 참조</li>
  <li>경계 외부에서는 <strong>결과적 일관성</strong>
</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsb4HeB1ASg5Emah-2FfhAnWebReYF7rvPYokqNmMMGvp7w-3D-3DVTJe_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXv-2B8usZdy7b6JU99MWsge-2Bd6JBIuekD-2F-2BqfDwIiyKDz4pgqYnksTIaKY0CC6JmCAcWl1r4jCZp8m0cCFgbzvQQsrqEMmetmotRu1KUqUFaEpLe-2BVPY-2BtLp1J-2BeTBuNA2PQdc5Npxn8kRX3dKpoQhLupNcyp4Icpo6T1Vma5wORlN37nnn1VdICmTRUo-2BSamUSUCVR6FGzE-2FT477xYlpekHb">IDDD 10장. 애그리게잇</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUeum5_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXv-2B8usZdy7b6JU99MWsge-2Bd6JBIuekD-2F-2BqfDwIiyKDz4rR2OobYnukDVQBBhSO1JwRhz1VbJfmFWOIfb3-2B88J6FIprVoUsaoJNrNL5FNSTJeCnkJvlbpBi2Y6-2BGlqwqd3LmhDkSMcJYOYtA434wBkPqvZj8g5-2FJJOaodCHLbWRpXoYULW7ehKRdNnhCIbQ2jzSUFr4U9Q7fNQCqlbgO-2B4MS">DevOOOOOOOOP</a> on June 05, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNhIhX-2FjGX4SaM5LcunUoqGvD-2B9Sjrp3LjbKA1Kvc6Yzz36oe2b-2BeUR-2F4Vm1wlRr-2FY4ya7HXJh5knZDp-2B2lqgNgBydQjR-2BNJO9mxH-2FbZjmof17jOGVfPoZpHDAgH-2BPR9mYG2q9HwQFzwNMGTYm6mBPFvDEmv4hjtVkJDPJDGuLjo3fFOAMSprIuFMN0w-2BgoU6u9oNnrfenmj8FwDR7eYBB0" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003903.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3902" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003902.html">JPA에서 Value Object Collection 3가지 구현</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:22+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    동기

<p>팀 내에서 IDDD(Implementing Domain-Driven Design) 스터디 중 <strong>값 객체 Collection을 ORM(hibernate)을 이용하여 구현하는 예제</strong>를 확인했습니다.
그러던 중 이게 아주 과거 hibernate xml 구성 기준이어서 현재 <em>JPA(Sprin Data JPA)에서는 어떻게 구현되는지 궁금</em>해 하던 @동묘가 저에게 직접 구현을 보고 싶다고 해서 포스팅 하게 되었습니다.</p>

구현

<p>3가지 구현 방법</p>

<ol>
  <li>Single Column</li>
  <li><strong>Entity</strong></li>
  <li>Join Table</li>
</ol>

<p><strong>예시 도메인</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/LO_12i8m38RlUugmex8Na57cIJo8uC5xreOoxThIfWSHtzreqR5Jal_F_v4CcJ5ncLqJKT_H4XnIA75lRIABJF1ijCESgmnzlpYN45WfMG3OsezxDD9wd4cAeQpJ57aANgRkwvze7YdbvhKWVwA0h-WAmNcyaQxOFuiVaIHKB-Ww1UscNOLtiE8Fv8ryz0O0" alt="Group과 GroupMember"></p>

<ul>
  <li>그룹은 애그리게잇 루트(엔터티)입니다.</li>
  <li>그룹맴버는 값 객체입니다.</li>
  <li>한 그룹에는 여러 그룹맴버가 있습니다. (Group#groupMembers)</li>
  <li>그룹과 그룹맴버는 한 애그리게잇으로 묶입니다.</li>
</ul>

Many Values Serialized into a Single Column

<p>groups.group_members에 그룹맴버들 객체를 직렬화해서 저장합니다. 여기에서는 varchar(4000) 데이터타입으로써 JSON으로 직렬화 하겠습니다.</p>

Java

<p><em>GroupMember.java</em></p>

<div><div><pre><span>@Embeddable</span>
<span>@Value</span>
<span>public</span> <span>class</span> <span>GroupMember</span> <span>{</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>@Enumerated</span><span>(</span><span>EnumType</span><span>.</span><span>STRING</span><span>)</span>
    <span>private</span> <span>GroupMemberType</span> <span>type</span><span>;</span>

    <span>// For JPA</span>
    <span>GroupMember</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>null</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>null</span><span>;</span>
    <span>}</span>

    <span>// For Jackson</span>
    <span>@JsonCreator</span>
    <span>public</span> <span>GroupMember</span><span>(</span><span>@JsonProperty</span><span>(</span><span>"name"</span><span>)</span> <span>String</span> <span>name</span><span>,</span> 
                       <span>@JsonProperty</span><span>(</span><span>"type"</span><span>)</span> <span>GroupMemberType</span> <span>type</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>name</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>type</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><em>Group.java</em></p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"GROUPS"</span><span>)</span>
<span>@Getter</span>
<span>@EqualsAndHashCode</span>
<span>@ToString</span>
<span>@NoArgsConstructor</span><span>(</span><span>access</span> <span>=</span> <span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
<span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>private</span> <span>Long</span> <span>groupId</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>

    <span>/**
     * ORM과 한 열로 직렬화되는 여러 값 : ORM and Many Values Serialized into a Single Column
     */</span>
    <span>@Convert</span><span>(</span><span>converter</span> <span>=</span> <span>GroupMembersConverter</span><span>.</span><span>class</span><span>)</span>
    <span>@Column</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>length</span> <span>=</span> <span>4000</span><span>)</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>group1Members</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p><em>GroupMembersConverter.java</em></p>

<div><div><pre><span>@Converter</span>
<span>public</span> <span>class</span> <span>GroupMembersConverter</span> <span>implements</span> <span>AttributeConverter</span><span>&lt;</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;,</span> <span>String</span><span>&gt;</span> <span>{</span>
    <span>private</span> <span>ObjectMapper</span> <span>om</span> <span>=</span> <span>new</span> <span>ObjectMapper</span><span>();</span>

    <span>@Override</span>
    <span>public</span> <span>String</span> <span>convertToDatabaseColumn</span><span>(</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>attribute</span><span>)</span> <span>{</span>
        <span>return</span> <span>om</span><span>.</span><span>writeValueAsString</span><span>(</span><span>attribute</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>convertToEntityAttribute</span><span>(</span><span>String</span> <span>dbData</span><span>)</span> <span>{</span>
        <span>return</span> <span>om</span><span>.</span><span>readValue</span><span>(</span><span>dbData</span><span>,</span> <span>new</span> <span>TypeReference</span><span>&lt;</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;&gt;()</span> <span>{</span> <span>});</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>group_members</span> <span>varchar</span><span>(</span><span>4000</span><span>),</span> <span>/* !!! */</span>
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span>
    <span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>group_members</span><span>,</span> <span>name</span>
<span>)</span> <span>values</span> <span>(</span>
    <span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span>
<span>);</span>
</pre></div></div>

<p><em>저장 후 테이블 조회 예시</em></p>

<table>
  
    <tr>
      <th>GROUP_ID</th>
      <th>DESCRIPTION</th>
      <th>GROUP_MEMBERS</th>
      <th>NAME</th>
    </tr>
  
  
    <tr>
      <td>1</td>
      <td>설명</td>
      <td>[{"name":"하위그룹","type":"GROUP"},{"name":"회원1","type":"MEMBER"}]</td>
      <td>이름</td>
    </tr>
  
</table>

Many Values Backed by a Database Entity

<p>실질적으로는 <em>Entity처럼 DB 스키마를 구성</em>하나 실제 객체지향세계(ex:Java Application)에서는 <strong>값 객체로 보이게 구현</strong></p>

<ul>
  <li>이를 위해서 상속을 이용해서 <strong>식별자 속성을 은닉</strong>시키는 것이 구현의 핵심</li>
</ul>

Java

<p><em>IdentifiedValueObject.java</em></p>

<div><div><pre><span>@MappedSuperclass</span>
<span>@NoArgsConstructor</span><span>(</span><span>access</span> <span>=</span> <span>AccessLevel</span><span>.</span><span>PROTECTED</span><span>)</span>
<span>public</span> <span>abstract</span> <span>class</span> <span>IdentifiedValueObject</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>@Getter</span><span>(</span><span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
    <span>@Setter</span><span>(</span><span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
    <span>private</span> <span>Long</span> <span>id</span><span>;</span>    <span>// 패키지 접근제어를 통해서 식별자 은닉. 단, hibernate는 접근 가능</span>
<span>}</span>
</pre></div></div>

<p><em>GroupMember.java</em></p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>)</span>
<span>@Value</span>
<span>@EqualsAndHashCode</span><span>(</span><span>callSuper</span> <span>=</span> <span>false</span><span>)</span>
<span>public</span> <span>class</span> <span>GroupMember</span> <span>extends</span> <span>IdentifiedValueObject</span> <span>{</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>@Enumerated</span><span>(</span><span>EnumType</span><span>.</span><span>STRING</span><span>)</span>
    <span>private</span> <span>GroupMemberType</span> <span>type</span><span>;</span>

    <span>// For JPA</span>
    <span>GroupMember</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>null</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>null</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><em>Group.java</em></p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>...</span>
    <span>/**
     * ORM과 데이터베이스 엔터티로 지원되는 여러 값 : ORM and Many Values Backed by a Database Entity
     */</span>
    <span>@OneToMany</span><span>(</span><span>cascade</span> <span>=</span> <span>CascadeType</span><span>.</span><span>ALL</span><span>,</span> <span>orphanRemoval</span> <span>=</span> <span>true</span><span>)</span> <span>// Aggregate Root 를 위한 일관성 설정</span>
    <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>)</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
<span>create</span> <span>table</span> <span>group_members</span> <span>(</span>
    <span>id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span>     <span>//</span> <span>PK</span><span>!!</span>
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>type</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>group_id</span> <span>bigint</span><span>,</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>id</span><span>)</span>
<span>)</span>
<span>alter</span> <span>table</span> <span>group_members</span> 
    <span>add</span> <span>constraint</span> <span>fk_groups_group_members</span>
    <span>foreign</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span> <span>references</span> <span>groups</span><span>;</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span><span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>name</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>name</span><span>,</span> <span>type</span><span>,</span> <span>id</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>name</span><span>,</span> <span>type</span><span>,</span> <span>id</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>update</span> <span>group_members</span> <span>set</span> <span>group_id</span><span>=?</span> <span>where</span> <span>id</span><span>=?</span>  <span>/* Update ?! */</span>
<span>update</span> <span>group_members</span> <span>set</span> <span>group_id</span><span>=?</span> <span>where</span> <span>id</span><span>=?</span>
</pre></div></div>

<ul>
  <li>일반적으로 가장 무난하며, IDDD 책에서는 저자가 가장 추천한 방식</li>
</ul>

Many Values Backed by a Join Table

<p>group_members을 테이블로 분리하는데 이 테이블은 PK가 없이 groups의 PK를 FK로 가지는 Join Table로 구현</p>

Java

<p><em>Group.java</em></p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>private</span> <span>Long</span> <span>groupId</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>/**
     * ORM과 조인 테이블로 지원되는 여러 값 : ORM and Many Values Backed by a Join Table
     */</span>
    <span>@ElementCollection</span>
    <span>@CollectionTable</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>joinColumns</span> <span>=</span> <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>))</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
<span>create</span> <span>table</span> <span>group_members</span> <span>(</span>    <span>/* No PK */</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>type</span> <span>varchar</span><span>(</span><span>255</span><span>)</span>
<span>);</span>
<span>alter</span> <span>table</span> <span>group_members</span> 
    <span>add</span> <span>constraint</span> <span>fk_groups_group_members</span> 
    <span>foreign</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span> <span>references</span> <span>groups</span><span>;</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span><span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>name</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>group_id</span><span>,</span> <span>name</span><span>,</span> <span>type</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>group_id</span><span>,</span> <span>name</span><span>,</span> <span>type</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
</pre></div></div>

이슈

값 객체 Collection에 새로운 값이 추가되거나 기존 값이 변경될 시 All Delete and Re-insert

<p>@ElementCollection을 통해 변경이 발생할 시, 전체를 지우고 다시 입력하는 이슈가 있음.
이를 완화시키기 위해서 @OrderColumn을 추가하는 방법이 있긴하나 완벽하지는 않음</p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>...</span>
    <span>@ElementCollection</span>
    <span>@CollectionTable</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>joinColumns</span> <span>=</span> <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>))</span>
    <span>@OrderColumn</span>    <span>// !!!</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

Summary

<p><img src="https://github.com/redutan/ddd-values/raw/master/ddd-value-db-schema.png" alt="Total DB schema"></p>

<ol>
  <li>Single Column</li>
  <li>Entity</li>
  <li>Join Table</li>
</ol>

Reference

<ul>
  <li>소스코드 : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRTGojT0wnIHffG1exc6x76o_cIp_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laMmZWrrjeg-2Fb-2BYnS6260HMTUy7ZcN-2Be9XnTmqw4hettYBOu7TPqPJ0t-2B6gtRDPM-2BwRlBVJt4hP3Z-2FgFrd-2BlvWCfed8Z6ztGJkJY2Av1ME-2BlofGOr7Hnz8g7eDtbWLuD6qye91ob8fmWaX6v2plUhIrcbTxu9MWvOvk2L9WSYZpaOO-2B7-2Bw7AmWl1PHC6URbJECA-3D-3D">https://github.com/redutan/ddd-values</a>
</li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=wC3KXI14r-2BhtUZYhlxRDF-2B2v7mVoTWsc70JdRKQC027wpcqQcReOHQGgY7yCySsJc9o5T-2BqHeydHI4vZMXQNKg-3D-3D8Ufv_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laJK-2BE3KHBKz0alRqP-2FN-2FlInbK0kG65R6sK1qbDqLVAxqNMJ3UX4DVXTkkjBz-2FdX35a3uhY2mNPrvc-2F1mHVdF42ohD85ADnXrl5RRd44B0ZlDNIzoDrh7TpF6b0GrgITXFEd6kFseEPv4Ofzy-2F-2FAOx-2FIkgQ8RMuk6c5nU-2Ft9g65ZYsnsMZuqGX-2BL2tlVmdjhChQ-3D-3D">Implementing Domain-Driven Design. Vaughn Vernon</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=U6xaqgbOMRdETgYGP-2Bln2OoLibx0-2BsRL1jhEa2GxVmsD5h8l6-2BskJZ16VLPnP6uHXrihuvy-2BuveSCh0UjICquQ-3D-3DIPzJ_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laOFbUkPtjqLSf2aRS5EINI4RUzzQHpSYMyJL7bCp15Fe7bHOLdTsLUDUhJH4ok8ZynneNj-2FCKWyF4YhZ-2FnWPRnjRR41w-2F5btDZLQKJgnLFh-2BmUWrIoiE3NL6Gexj2VLQTtsSFTbpTzCk920fGgNJFml7fH5SvTyVsJybQE7Cx-2F-2Bo7TWQj3XsbxVBrnUpJw4lmg-3D-3D">자바 ORM 표준 JPA 프로그래밍. 김영한</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=IJsfzn0VfpB8bgLJSLrPinMZjuqVj8RLL3zmjpIgFp0f39kxp9xCjFYOOS8-2BAV3AxWiQKio6bY-2BOxCrVrZo0PA-3D-3DyddA_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laNfTPS4rE4L-2Fws5DwYlEhmoG0V9NqyLovKHM2Md8fpS7PbYPO4miaplXfw6Uxm6bF7u3BHF1I-2Flj1ILpGW95v3k4b-2BYnqfNnCtU4G8-2B8H2hhZL7-2FiVa-2B3EdO-2FPgY6kW84v7XVuAoSdSbYe8EN7aSh-2B4jqB620abTNOstrTU9wFwqAwzhOGKObIiTW9R7enTTvw-3D-3D">http://kwonnam.pe.kr/wiki/java/jpa/elementcollection</a></li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtD-2FWEd9qR-2BgJYv-2FcH-2B65P9JD4MOmF2LKxBfd30hn0MvA-3D-3D-S4L_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laJQHZujc9GOdtk3RWM8ieazbHkvj-2BYSDuVGkq2WGjnZOQMmbf7kpNSgmEqhEE5rzsFmRXgaOjIJpccuErtmKwU8E9jLaH6VYMincXqpytUPjUnGsS-2FXx56M7Dl99kJXmAoJgYitWJNdpN1akXyY9mbN3mhnfum5OXMNB6RoyQOe8PFXlTqP0K-2Ff4sPqnblbLhA-3D-3D">JPA에서 Value Object Collection 3가지 구현</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUfzsI_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laAEgoVsuu7ejdowB1-2FwO8PMHB9Tyq2x-2FfJ49xCD-2FQlvD8ZIm-2BB3G75I3Bcf8uMeAvGeY6ThVXABQi4JLPO-2FKBKzoxVFrVVfha8rv5QB5hnrsmz-2BX5DIkQRoHwCfYSyapmUqW8wqPsD9i9ybNmhD6H3jq3XZKU3c5wAnSg1ZmPyqXZHofKze6AYKhC66kUZ0fSw-3D-3D">DevOOOOOOOOP</a> on May 29, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNPYZ0TfcKi9eTqjHd8-2FcFh72Up2ns8B1PLrsrSUG5JNNrnKmtpWwO8FF-2BOto6J0eTDh6vqD9uCf4eTFdgf8caSFbFB4CD2-2FCFyNzpCuhHB26lIkoN8GWglBJY-2FAoRN-2F94KgfgZf-2F1dB15FTdSohBErmosraAFi841kBs-2BHgO3Y4A3npUPdCuC4Ru0QK4MOxX6Cs5zG1HtSGRSDxPdOYDbtsRGtNkl-2FUipOuMWiYiwqkw-3D-3D" alt="" width="1" height="1" />


  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003902.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3901" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003901.html">IDDD 9장. 모듈</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:21+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <ul>
  <li>Java: 패키지</li>
  <li>C#: 네임스페이스</li>
  <li>Ruby: 모듈</li>
</ul>

모듈로 설계하기

<ul>
  <li>모듈 : 도메인 객체의 컨테이너</li>
</ul>

<p><strong>규칙</strong></p>

<ul>
  <li>모델링의 개념에 맞춰 모듈을 설계하자</li>
  <li>유비쿼터스 언어에 맞춰 모듈을 명명하자</li>
  <li>모델에서 사용하는 일반적인 컴포넌트 타입이나 패턴에 따라서 기계적으로 모듈을 생성하지 말자</li>
  <li>느슨하게 결합된 모듈을 설계하자.</li>
  <li>결합이 필요하다면 짝이 되는 모듈 사이에서 비순환적 의존성이 형성되도록 노력하자</li>
  <li>자식 모듈과 부모 모듈 사이에 규칙은 느슨하게 하자</li>
  <li>모듈을 모델의 정적인 개념에 따라 만들지 말고, 모듈이 담고 있는 객체에 맞추도록 하자</li>
</ul>

<blockquote>
  <p>주방의 서랍에 식기류가 포크와 나이프와 스푼별로 잘 정리돼 있음</p>
</blockquote>

기본 모듈 명명 규칙

<p>Java: com.saasovation
C#: SaaSOvation</p>

모델을 위한 모듈 명명 규칙

<p><strong>바운디드 컨텍스트</strong></p>

<ul>
  <li>com.saasovation.identityaccess</li>
  <li>com.saasovation.collovoration</li>
  <li>com.saasovation.agilepm</li>
</ul>

<p><strong>모듈 구성 예시</strong></p>

<ul>
  <li>
com.saasovation.identityaccess
    <ul>
      <li>domain.model</li>
    </ul>
  </li>
</ul>

<p>결론은 여러분 팀의 몫이다.</p>

애자일 프로젝트 관리 컨텍스트의 모듈

<ul>
  <li>
com.saasovation.agilepm
    <ul>
      <li>
domain
        <ul>
          <li>
model
            <ul>
              <li>
product
                <ul>
                  <li>backlogitem</li>
                  <li>release</li>
                  <li>sprint</li>
                </ul>
              </li>
              <li>tenant</li>
              <li>team</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>이 팀은 모듈 사이의 결합도 문제보다 <em>정리</em>에 중점을 뒀다.</p>

다른 계층 속의 모듈

<table>
  
    <tr>
      <th>계층</th>
      <th>모듈</th>
      <th>비고</th>
    </tr>
  
  
    <tr>
      <td>사용자 인터페이스</td>
      <td>com.saasovation.agilepm.resources</td>
      <td>ui</td>
    </tr>
    <tr>
      <td>애플리케이션</td>
      <td>com.saasovation.agilepm.application</td>
      <td> </td>
    </tr>
    <tr>
      <td>도메인</td>
      <td>com.saasovation.agilepm.domain</td>
      <td> </td>
    </tr>
    <tr>
      <td>인프라</td>
      <td>com.saasovation.agilepm.infrastructure</td>
      <td>adapter</td>
    </tr>
  
</table>

바운디드 컨텍스트보다 모듈

<p>모듈은 응집력이 낮은 경우 분리하기 위한 컨테이너이고, 바운디드 컨텍스트는 그저 경계일 뿐이다.</p>

<p>어짜피 모듈은 상향식(bottom-up)으로 설계하게된다. 
모듈 내의 컴포넌트들에 따라서 나눠질 수도 합쳐질 수도 있다. 중요한 것은 도메인 로직과 유비쿼터스 언어에 따르는 것이다.</p>

마무리

<ul>
  <li>유비쿼터스 언어를 표현한다.</li>
  <li>모듈 설계의 예시!!</li>
  <li>기계적인 모듈 설계는 창의성을 방해한다.</li>
  <li>바운디드 컨텍스트 분리보다 모듈 사용이 먼저다.</li>
</ul>


    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtm3NqOtydeFnrb09xQSvsPe3wC21MUOwAvDuMNN2LpgA-3D-3D9OUl_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtrLDOEzZ2Daawpe1aAsqcvdCvJ-2FG9jaz-2FSTSCF1VVOSZJgOnY7lAhZ8bu-2FSGmMTlRPTKV-2Fhfdo82CUuAldFPUTlICL-2FPdqPdxZjr1xe9TVn1xmsO0Mr6zBVKJ2zy6ctTN1w5YWqe7Tt1TjWMSj-2BjnFIjvCPOl6ujyLEzDwSWz8tgwAs54rg-2FqwiM4pdjOyQPVROP9nLGs8OXdOTt5c954DgakbZgTFrsNwVGvrZ-2BBbKA-3D-3D">IDDD 9장. 모듈</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUxwJK_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtrLDOEzZ2Daawpe1aAsqcvdCvJ-2FG9jaz-2FSTSCF1VVOSbpTbloS1M9Iag8myDqaxug1gcW5kwzSLgcAdsJt9VOEZ4MRotRFkuPMdz8AJfOMSghQNR4AlPp52rg4dMzQKgtJKYu19VtbDf6FgsIhRUA1nmhg7SzSNzR2zHvppHZyDWK9ZPF9RT2E-2BPapl5C8cXAFXE3hcAedYdHMyfTWsvmc3B-2FKNVMd3uc0MrFZv1U4Tg-3D-3D">DevOOOOOOOOP</a> on May 28, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMPME9M3NrSWTl3I4WW4WGEIyIydBv5I7-2FArd-2BtYqh7D5-2B0OTCKIfRiosIRcuAWfGMLpW2fe45-2BtL-2Fbq6Ho7uKIv-2F4HjcCks6KZ0hlJtiNR3YaRoe4HAy62mYuUz7HEB-2BQf7CAkw9pqFEXzGhEYDoezpGtz9pL9I0t6XtJSC9xWLi8sIPt4Nl8pZuQzLn57McCyaMFw0mUVQp-2BjyjOn4Y9MOhirsjjnWiUcwQ3do96hshQ-3D-3D" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003901.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3900" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003900.html">IDDD 8장. 도메인 이벤트</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:20+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <p>Publish-Subscribe</p>

언제 그리고 왜 도메인 이벤트를 사용할까?

<ul>
  <li>도메인 내 어떤 사건이 발생했을 때</li>
  <li>한 트랜잭션에는 한 애그리게잇만 커밋</li>
</ul>

이벤트의 모델링

<p>어떤 명령에서 어떤 사건이 발생했었음</p>

<ul>
  <li>Command : BacklogItem#commitTo(Spring)
</li>
  <li>Event : BacklogItemCommitted
</li>
  <li>백로그 항목이 커밋됐다.(과거형)</li>
</ul>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>product</span><span>;</span>

<span>@Value</span>
<span>class</span> <span>BacklogItemCommitted</span> <span>implements</span> <span>DomainEvent</span> <span>{</span>
    <span>Date</span> <span>occurredOn</span><span>;</span>
    <span>BacklogItemId</span> <span>backlogItemId</span><span>;</span>
    <span>SpringId</span> <span>committedToSprintId</span><span>;</span>
    <span>TenantId</span> <span>tenantId</span><span>;</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>;</span>

<span>interface</span> <span>DomainEvent</span> <span>{</span>
    <span>Date</span> <span>occurredOn</span><span>();</span>
<span>}</span>
</pre></div></div>

<p><em>추가사항</em></p>

<ul>
  <li>멱등성</li>
  <li>더 풍부한 상태 전달 (이벤트 소싱!)</li>
</ul>

애그리게잇의 특성과 함께하기

<p>이벤트를 애그리게잇을 통해서 영속화</p>

식별자

<ul>
  <li>이벤트를 애그리게잇으로 모델링하면 식별자가 필요하다.</li>
  <li>도메인 이벤트를 바운디드 컨텍스트 외부로 발행 시 식별자가 필요(With rabbitmq)
    <ul>
      <li>외부 구독자 입장에서는 멱등성 관리를 위해서 식별자를 할당할 수 있음</li>
      <li>
equals로 일정 부분 해결할 수도 있다 (in 로컬 바운디드 컨텍스트)</li>
    </ul>
  </li>
</ul>

도메인 모델에서 이벤트 발행하기

<p>Light-Weight Publish-Subscribe</p>

<p><img src="https://camo.githubusercontent.com/afd4f6f7085bc7bdc1db8595fd4e3e62fccb12d6/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f7376672f5a4c31393369386d33427074354a643238482d654b307a4b74393575475039514f3937344c50654b7a56556141774b42756331506358644673315231616d723657616b34796b484f685836694a734158527a584c4536795a4c79514532616a5846486c31696f5272584539496a746635725a6c49387a55316a6f30687652337278627276446a3266523653466e704f4a512d35583258687748726347344d5950665a6b67354a6a5638524e6d4d6c627a784a585739787635356c334642392d59356e556350503051676d55334a6878714d6c765a362d50504a59522d6b38644432356a344d7143727a323132444e5f4f4b68625a55553868755570494e7a704576636c35366d3030" alt="발행자"></p>

<ul>
  <li>Reference : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRRCPtej3pJV8krULol3SCes4OcLyMrunwpkXV-2Fwd61OBu0qxlSEstR-2FpTZ1cq1-2FBhOUHK-2B7Pb9lUV8sQWbfgp0rlKZi_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwT5fYInER6d9GE-2BmPH6p9dUYhU3HqvPRTrHRY25wjOaJYluiZsdTyUoX9Pc2-2BkU98kioXVMIudJoYSL8JAQjIPoNmhkIZ2GYrY1DBlz7znk81t2pJv-2BQNjPi0Z7dIdbJ7NgxI-2BceGd0-2F4vf5yGqS-2BQcsVmNJDRpxOa-2FU2owJiOXXNaBBoAyAmVYzK4nzC7ANbg-3D-3D">https://github.com/redutan/redutan.github.io/wiki/Domain-Event-on-Springframework</a>
</li>
</ul>

발행자

<div><div><pre><span>class</span> <span>BacklogItem</span> <span>extends</span> <span>AbstractAggregateRoot</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>{</span>
    <span>void</span> <span>commitTo</span><span>(</span><span>Sprint</span> <span>spint</span><span>)</span> <span>{</span>
        <span>// Some domain logic</span>
        <span>super</span><span>.</span><span>registerEvent</span><span>(</span><span>new</span> <span>BacklogItemCommitted</span><span>(</span>
                <span>this</span><span>.</span><span>tenantId</span><span>(),</span>
                <span>this</span><span>.</span><span>backlogItemId</span><span>(),</span>
                <span>this</span><span>.</span><span>sprintId</span><span>()</span>
        <span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>BacklogItemService</span> <span>{</span>  <span>// Application Service</span>
     <span>@TransactionalEventListener</span>
    <span>void</span> <span>commitBacklogItem</span><span>(...)</span> <span>{</span>
        <span>backlogItem</span><span>.</span><span>commitTo</span><span>(</span><span>sprint</span><span>);</span>   <span>// Publish BacklogItemCommitted event</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

구독자

<div><div><pre><span>class</span> <span>BacklogItemService</span> <span>{</span>  <span>// Application Service</span>
     <span>@TransactionalEventListener</span>
    <span>void</span> <span>handleBacklogItemCommitted</span><span>(</span><span>BacklogItemCommitted</span> <span>event</span><span>)</span> <span>{</span>
        <span>// BacklogItemCommitted 구독 후 처리</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p>중요한 것은 <strong>결과적 일관성</strong></p>

뉴스를 원격 바운디드 컨텍스트로 전파하기

<p><em>시스템 간</em> 결과적 일관성 확보</p>

메시징 인프라의 일관성

<p><em>구현방법</em></p>

<ol>
  <li>도메인 모델과 메시지 인프라 저장소 공유</li>
  <li>원격 DB with XA</li>
  <li>이벤트 저장소</li>
</ol>

자치 서비스와 시스템

<p>자치 서비스 : 이벤트를 통해서 시스템 간 결합도(독립성!)를 줄이는 기법 (No-RPC)</p>

<p>자치 서비스의 단위는 바운디드 컨텍스트가 되면 좋은 것 같다.</p>

지연 시간 허용

<p><em>결과적 일관성</em>을 위해서</p>

<p>도메인 별로 그 때 그 때 달라요.</p>

<p>시스템의 허용치를 만족시키면서도 잘 수행되도록 아키텍처 품질을 높여야 한다.</p>

이벤트 저장소

<p>이벤트의 상태를 유지하기 위해서 저장하는 것이 요구되는 경우가 많다.</p>

<p><img src="http://www.plantuml.com/plantuml/svg/bP7FIWGn3CRlVOeUzT0Na4LMq8Cd1_O9-YSmaKuxDEcAFhsrmx0Pg8Atv4k-xqVQCx4jN9UeNWCaHlvyyXw8Ngwjcqh-gNFHvb4_vyLYwlgbEl857HJze1Dy_CSxLHUHvcwbFUVkNbdFUBKCmrqrXf_CRycpJI52brjsWB_J1rE16SBxMPl4kK13sdM558OqwHGuuLSYgWM_kNVmV862DkBNzbPxqmZ7vLw4hctVSGE8aJITZ3cC0WmTDn68CASZTrU5MqYZ6y-GGbtYDm00" alt="IdentityAccessEventProcessor"></p>

<div><div><pre><span>@Aspect</span>
<span>class</span> <span>IdentityAccessEventProcessor</span> <span>{</span>
    <span>@Before</span><span>(</span><span>"execution(* com.saasovation.identityaccess.application.*.**..))"</span><span>)</span>
    <span>public</span> <span>void</span> <span>listen</span><span>()</span> <span>{</span>
        <span>DomainEventPublisher</span><span>.</span><span>instance</span><span>()</span>
            <span>.</span><span>subscribe</span><span>(</span><span>new</span> <span>DomainEventSubscriber</span><span>&lt;</span><span>DomainEvent</span><span>&gt;()</span> <span>{</span>
                <span>public</span> <span>void</span> <span>handleEvent</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
                    <span>store</span><span>(</span><span>aDomainEvent</span><span>);</span>
                <span>}</span>

                <span>public</span> <span>Class</span><span>&lt;</span><span>DomainEvent</span><span>&gt;</span> <span>subscribedToEventType</span><span>()</span> <span>{</span>
                    <span>return</span> <span>DomainEvent</span><span>.</span><span>class</span><span>;</span>   <span>// 모든 도메인 이벤트</span>
                <span>}</span>
            <span>});</span>
    <span>}</span>
    <span>private</span> <span>void</span> <span>store</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
        <span>EventStore</span><span>.</span><span>instance</span><span>().</span><span>append</span><span>(</span><span>aDomainEvent</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>StoreEvent</span> <span>{</span>
    <span>void</span> <span>append</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
        <span>String</span> <span>eventSerializatoin</span> <span>=</span> 
            <span>EventStore</span><span>.</span><span>objectSerializer</span><span>().</span><span>serialize</span><span>(</span><span>aDomainEvent</span><span>);</span>
        <span>StoredEvent</span> <span>storedEvent</span> <span>=</span> 
            <span>new</span> <span>StoredEvent</span><span>(</span>
                <span>aDomainEvent</span><span>.</span><span>getClass</span><span>().</span><span>getName</span><span>(),</span>
                <span>aDomainEvent</span><span>.</span><span>occuredOn</span><span>(),</span>
                <span>eventSerialization</span><span>);</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>save</span><span>(</span><span>storedEvent</span><span>);</span>
        <span>this</span><span>.</span><span>setStoredEvent</span><span>(</span><span>storedEvent</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>CREATE</span> <span>TABLE</span> <span>tbl_stored_event</span> <span>(</span>
    <span>event_id</span> <span>int</span><span>(</span><span>11</span><span>)</span> <span>NOT</span> <span>NULL</span> <span>auto_increment</span><span>,</span>
    <span>event_body</span> <span>varchar</span><span>(</span><span>65000</span><span>)</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>occurred_on</span> <span>datetime</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>type_name</span> <span>varchar</span><span>(</span><span>100</span><span>)</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>PRIMARY</span> <span>KEY</span> <span>(</span><span>event_id</span><span>)</span>
<span>)</span>
</pre></div></div>

저장된 이벤트의 전달을 위한 아키텍처 스타일

레스트품 리소스로서 알림 발행하기

<ol>
  <li>이벤트를 REST/WEB API로 발행한다. (이벤트 아이디나 애그리게잇 아이디를 전달)
    <ul>
      <li>이벤트 저장소를 통해서 조회하거나, 애그리게잇을 직접 조회한다.</li>
    </ul>
  </li>
  <li>구독 측에서 발행측에 다시 상세 이벤트 정보를 조회한 후 처리한다.</li>
</ol>

메시징 미들웨어를 통한 알림 발행

<ol>
  <li>메시징 미들웨어를 통해서 이벤트를 발행한다.</li>
  <li>메시징 미들웨어를 구독한 구독 측에서 발행 측의 상세 이벤트 정보를 조회한 후 처리 한다.</li>
</ol>

<p>발행과 구독은 exchange나 queue 개념으로 연결된다.</p>

구현

<p>Skip</p>

<ul>
  <li>멱등 수신자 처리가 중요하다 : At least once</li>
</ul>

<blockquote>
  <p>멱등성 : 오퍼레이션이 두 번 이상 수행되어도, 한 번만 수행했을 때와 같은 결과에 이르는 동작을 의미</p>
</blockquote>

<p>궁극적으로 이벤트를 추적해야하는 경우가 생기기 때문에 이벤트 저장 기능이 거의 필수적으로 요구된다.
그리고 추적 일관성을 위해서 이벤트 저장은 도메인 로직과 트랜잭션으로 묶이는 것이 중요하다.</p>

마무리

<ul>
  <li>이벤트 만의 고유 식별자가 요구된다.
    <ul>
      <li>이벤트 저장소도 필요</li>
    </ul>
  </li>
  <li>어짜피 발행-구독!</li>
  <li>멱등성 또는 중복 발행 or 수신 제거 확보</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvte7IJ83T9i7ctQC-2FR9Jhkiiganli0CE93CcAILpEzlCw-3D-3Dh2q0_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwVeCIxi-2FocaJix02HAB3yQ0k3Dch-2BIQthOH3hKsUBS6HFHS4EFucpuRvDfOLcdNHwHDe0fW7pQh-2B4-2B-2BUEsiB0hrAob-2FOvb8F353Oub-2B0jIzaP5k7Kax15cieddJOtuAb9WWFlQ9DcOPfH8XlAhTj8rLjlhjKsZu-2F4PXlpHu3D4gYpgCPHhHvE0dcYoE6Nc6Bhg-3D-3D">IDDD 8장. 도메인 이벤트</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUj7HV_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwZI1459FqrtpLG7hCO0mC5aES3JMcqjvRhOnTh3eenGzk-2FjaPq9Xr6tJppEJzjSX-2FTLCdZh30y8XAf1meaTPA7FtdrnX8H-2BZwkIKBJBGnnwnQsWdPxgKs8EhDkVuABrrdGtxegY0zy-2FYwUtP2tzaR-2FwcUV7j51Z-2FCOHFjYhwkaIeG1jeXutcRK1et-2FTNQLQGow-3D-3D">DevOOOOOOOOP</a> on May 24, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMOOBDmtyh57YUkp9-2Fv7xyFkkAcl-2BRClFC2uQcNfj9Ofa76FTzflGZJxRjb7Ge-2F-2FVbYZv6HIl3FbYWabaJsUVkDblv1DbErTDxxLNpHz3Hfcpvlv12AY5n-2B4MFKipUSul12EIt0iDHDL5-2B0nYPesbQTabkgeoHPFKAdYw-2FNBL9bDgJst8nXTN0nwB3NVK7vQCAp0X12F0BpEZZFuk4-2FEe-2FMDOqr3PiZBE9qurThZ9AtUmg-3D-3D" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003900.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3899" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003899.html">IDDD 7장. 서비스</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:20+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <p><strong>도메인 서비스</strong> : 도메인 모델 내 무상태 오퍼레이션 제공</p>

<ul>
  <li>애그리게잇이나 값 객체의 행위로써 어울리지 않는 것</li>
</ul>

<p><em>before</em></p>
<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>backlogItems</span><span>;</span>

    <span>BusinessPriorityTotals</span> <span>businessPriorityTotals</span><span>()</span> <span>{</span>
        <span>//...</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>모델 정제를 통해 Set&lt;BacklogItem&gt; backlogItems를 분리</li>
  <li>그렇다면 businessPriorityTotals() 메서드는 어떻게 되는가?</li>
</ul>

<p><em>after</em></p>
<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>static</span> <span>BusinessPriorityTotals</span> <span>businessPriorityTotals</span><span>(</span>
            <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>aBacklogItems</span><span>)</span> <span>{</span>
        <span>// ...</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>정적 메소드로 변경 - 하지만 과연 이것은 옳은가?</li>
</ul>

<p><strong>도메인 서비스</strong> 가 필요한 시점이다!</p>

도메인 서비스란 무엇인가

<blockquote>
  <p>하지만 그보다 먼저 도메인 서비스가 아닌 것은 무엇인가?</p>
</blockquote>

<ul>
  <li>도메인 서비스 : 도메인 로직이 있다.</li>
  <li>애플리케이션 서비스 : 도메인 로직이 없다. (보안, 트랜잭션 등)</li>
</ul>

<p><em>정의</em></p>

<ul>
  <li>엔터티나 값객체의 책임이 아닌 (도메인적) 행위</li>
  <li>유비쿼터스 언어로써 표현</li>
  <li>무상태!</li>
</ul>

<p><em>예시</em></p>

<ul>
  <li>
<em>중요</em> 비즈니스 프로세스
    <ul>
      <li>
<em>복수 개</em>의 도메인 객체에서 필요로 하는 계산</li>
    </ul>
  </li>
  <li>한 조합에서 다른 조합으로 도메인 객체를 <em>변형</em>할 때</li>
</ul>

서비스가 필요할지 확인하자

<p>도메인 특화 지식은 클라이언트로 절대 유촐돼선 안된다.(클라이언트가 애플리케이션 서비스일지라도)
도메인 객체에 위치 시키기 애매하면 <em>도메인 서비스</em>에 담는다.</p>

<p>주의: 도메인 서비스를 남용하면 빈약한(Anemic) 도메인 모델이 된다.</p>

도메인에서 서비스를 모델링하기

<p><em>AuthenticationService</em></p>
<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>identity</span><span>;</span>   <span>// !!</span>

<span>interface</span> <span>AuthenticationService</span> <span>{</span>
    <span>UserDescriptor</span> <span>authenticate</span><span>(</span>
        <span>TenantId</span> <span>tenantId</span><span>,</span>
        <span>String</span> <span>username</span><span>,</span>
        <span>Strin</span> <span>password</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><em>EncryptionAuthenticationService</em></p>
<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>   <span>// !!</span>

<span>class</span> <span>EncryptionAuthenticationService</span> <span>implements</span> <span>AuthenticationService</span> <span>{</span>
    <span>@Override</span>
    <span>UserDescriptor</span> <span>authenticate</span><span>(</span>
            <span>@NonNull</span> <span>TenantId</span> <span>tenantId</span><span>,</span>
            <span>@NonNull</span> <span>String</span> <span>username</span><span>,</span>
            <span>@NonNull</span> <span>Strin</span> <span>password</span><span>)</span> <span>{</span>

        <span>Tenant</span> <span>tenant</span> <span>=</span> <span>tenantRepository</span><span>.</span><span>findById</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>tenant</span> <span>==</span> <span>null</span> <span>||</span> <span>!</span><span>tenant</span><span>.</span><span>isActive</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>TenantNotFoundException</span><span>(</span><span>tenantId</span><span>);</span>
        <span>}</span>
        <span>String</span> <span>encryptedPassword</span> <span>=</span> 
                <span>encryptService</span><span>.</span><span>encryptedValue</span><span>(</span><span>passwod</span><span>);</span> <span>// 암호화 책임도 도메인 서비스?</span>
        <span>User</span> <span>user</span> <span>=</span> <span>userRepository</span><span>.</span><span>findByTenantAndUsernameAndPassword</span><span>(</span>
            <span>tenant</span><span>,</span> <span>username</span><span>,</span> <span>encryptedPassword</span><span>);</span>
        <span>if</span> <span>(</span><span>user</span> <span>==</span> <span>null</span> <span>||</span> <span>!</span><span>user</span><span>.</span><span>isEnabled</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>UserNotFoundException</span><span>(</span><span>username</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>user</span><span>.</span><span>userDescriptor</span><span>();</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

분리된 인터페이스가 꼭 필요할까

<p>다형성이 요구되지 않는다면 굳이 분리된 인터페이스는 필요하지 않다고 본다.
다형성 등으로 인한 추상화가 요구될 때 분리된 인터페이스로 리팩토링 하자</p>

<p>생각 : 구현클래스에 Impl 접미사를 붙이는 것은 가능하면 피하는 것이 좋다고 본다.</p>

<p>DI 프레임워크(ex:Spring)를 사용하면 분리된 인터페이스를 사용하기 더 편하다.</p>

계산 프로세스

<p>생각: 계산(연산)은 변하지 않는 행동이므로 <em>분리된 인터페이스</em>는 필요하지 않다.</p>

<p>대부분 경우 계산 프로세스를 <strong>정적 메서드</strong>로 해결하는 경향이 많다.
이는 잘못된 행동이며 계산이 도메인 로직을 표현한다면 당연히 도메인 모델 내에 <strong>도메인 서비스로써 존재</strong>해야 한다.</p>

<p>참고: p.369 ~ 371 소스코드</p>

변환 서비스

<p>타 서비스와 통합을 위해 사용</p>
<ul>
  <li>이것도 <em>도메인 서비스</em>였다니</li>
</ul>

<p>Adapter</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>UserInRoleAdapter</span> <span>{</span>
    <span>&lt;</span><span>T</span> <span>extends</span> <span>Collaborator</span><span>&gt;</span> <span>T</span> <span>toCollaborator</span><span>(</span>
            <span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>,</span> <span>String</span> <span>role</span><span>,</span> 
            <span>Class</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>collaboratorClass</span><span>);</span>
<span>}</span>
</pre></div></div>

<p>Translator</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>sasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>CollbaratorTransaltor</span> <span>{</span>
    <span>&lt;</span><span>T</span> <span>extends</span> <span>Collaborator</span><span>&gt;</span> <span>T</span> <span>toCollaboratorFrom</span><span>(</span>
            <span>String</span> <span>json</span><span>,</span> <span>Class</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>collaboratorClass</span><span>);</span>
<span>}</span>
</pre></div></div>

<p>생각: translator도 도메인 서비스 인가?</p>

도메인 서비스의 미니 계층 사용하기

<p>가능하면 미니 계층은 사용하지 말자 - 안티패턴!</p>

<ul>
  <li>하지만 필요하다면 특정 도메인만 제한적으로 사용하는 것도 좋다.</li>
</ul>

마무리

<ul>
  <li>도메인 서비스는 필요할 때 사용
    <ul>
      <li>남용하면 빈약한 도메인 모델화</li>
    </ul>
  </li>
  <li>무상태</li>
  <li>VS 애플리케이션 서비스</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvluAbWcG-2BU3j-2FPxQHfsN0S3uz-2Bt6VhJ35WV6suoMgZkQ-3D-3Dzter_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXu-2FouefCEgnkD7PSw4-2FTKpokxVLmkzYWDLUZoDFVKadL0jYK4DSH1Yn2VNnhcTQEft7ak6193QuE3SDitDT5Dwj4RxJgsOyqXkTo8S9UvQxF76dcQojevjGWhbpfgaC5SGMqxD7Ihu0ML4YD7OJ15wsqYmQYnYu2nj4yeM87jMaAssGa0k0C-2BuOlhQHORXH-2BVXmXA7mw5Uu77VLCIg4l3vw">IDDD 7장. 서비스</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUXBmc_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXu-2FouefCEgnkD7PSw4-2FTKpokxVLmkzYWDLUZoDFVKadL59XgR5FNMBxB4ccZ2j0nBzEx-2F-2Bf5MBfQLJzxBCtn-2B8iLjtnJRVxETreWp1NW5fmgpeeYt3KsKB0GklCRNrB3yk2gN3TSWcvlRh7b2IJI1IFtDMEXxte57qIrLyTtTtX5I2kPYmDXW7RDKcw5ER-2BO5841NL5dumDNGsspsiV8XnI">DevOOOOOOOOP</a> on May 18, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMOFOQvjQs-2BQKxQWqAf0URUTTjz5r2Gpm8oEWLexbdkJGiB-2BXmwoNJogZ0s2hu6wtA04YUsMLBZAyURf04MuxLWs6fDqboONdJ7cE1oksEPTtFBp8yhAyKQGtD3URPjyS99i-2Bg7paj-2BkOWdEP6jrbpgm0ax94QrohuZDtYYj6ZZUzam2inZ4PJwKThQGoIZozHC4MTSZG0PMiag9zLiOmLc4" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003899.html" itemprop="url">Continue reading</a>
  </div>
</article>


              <article id="entry-3898" class="entry-asset entry asset hentry" itemscope itemType="http://schema.org/BlogPosting">
  <div class="asset-header">
    <h2 class="asset-name entry-title" itemprop="name"><a href="https://weblog.youre.space/imyaman/2020/05/003898.html">IDDD 6장. 값 객체</a></h2>
    <footer class="asset-meta">
      <ul class="asset-meta-list">
        <li class="asset-meta-list-item">Posted on <time datetime="2020-05-11T01:25:19+09:00" itemprop="datePublished">May 11, 2020</time></li>
        <li class="asset-meta-list-item">by <span class="author entry-author vcard">hal9000</span></li>

  

      </ul>
    </footer>
  </div>
  <div class="asset-content entry-content" itemprop="articleBody">
    

  
    
  
  
      
    <p>가능한 엔터티 대신 값 객체를 사용해 모델링하도록 노력해야 한다.</p>

<blockquote>
  <p>특성만 신경 쓴다면 이를 값 객체로 분리하라. 특성의 의미를 표현하고 기능도 부여하자. 불변성. 식별자는 필요 없고, 설계의 복잡성을 줄여준다.</p>
</blockquote>

값의 특징

<p><strong>개념을 값으로</strong></p>

<ul>
  <li>측정, 수량화, 설명</li>
  <li>불변성(no side-effect)</li>
  <li>개념적 전체</li>
  <li>변경 대신 대치</li>
  <li>등가성(value equality:동등성)</li>
</ul>

<p><strong>유비쿼터스 언어로써 표현하는 값이어야함</strong></p>

측정, 수량화, 설명

<p>날짜와 시간, 나이, 통화, 주소, 도형, …</p>

불변성

<ul>
  <li>No Setter
    <ul>
      <li>하지만 완벽하진 않다. 방어 복사가 필요할 수 있음 (final일지라도 불변은 깨질 수 있다.)</li>
    </ul>
  </li>
</ul>

개념적 전체

<ul>
  <li>주소 = 우편번호 + 기본주소 + 상세주소</li>
  <li>돈 = 500(수량) + 달러(통화)</li>
</ul>

<p><em>Bad Case</em></p>

<div><div><pre><span>class</span> <span>ThingOfWorth</span> <span>{</span>    <span>// 가치 있는 것</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>private</span> <span>BigDecimal</span> <span>amount</span><span>;</span>
    <span>private</span> <span>String</span> <span>currency</span><span>;</span>
<span>}</span>
</pre></div></div>

<p><em>Good Case</em></p>

<div><div><pre><span>class</span> <span>ThingOfWorth</span> <span>{</span>    <span>// 가치 있는 것</span>
    <span>private</span> <span>ThingName</span> <span>name</span><span>;</span>         <span>// !!</span>
    <span>private</span> <span>MonetaryValue</span> <span>worth</span><span>;</span>    <span>// 가치</span>
<span>}</span>
<span>@Value</span>
<span>class</span> <span>MonetraryValue</span> <span>{</span>
    <span>private</span> <span>BigDecimal</span> <span>amount</span><span>;</span>
    <span>private</span> <span>Currency</span> <span>currency</span><span>;</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
ThingName으로 값 객체로 만들어서 name의 기능을 중앙화 시킬 수 있다. (도메인 로직을 안으로 품을 수 있음)</li>
</ul>

대체성

<p>값은 변경이 불가능하므로 값 참조를 다른 값으로 바꾸는 것을 말함</p>

<div><div><pre><span>FullName</span> <span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Myeongju"</span><span>,</span> <span>"Jung"</span><span>);</span>
<span>// ...</span>
<span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Jiwon"</span><span>,</span> <span>"M"</span><span>,</span> <span>"Jung"</span><span>);</span>
</pre></div></div>

값 등가성

<p>equals(), hasoCode()</p>

<p>엔터티로 설계된 개념이 식별자가 필요하지 않다면 <em>값 객체</em>로 모델링하자.</p>

부작용이 없는 행동

<blockquote>
  <p>만약 값객체에 행위가 없다면, 좋은 설계인지 의심하라</p>
</blockquote>

<ul>
  <li>Getter : No side-effect</li>
  <li>Setter : With side-effect</li>
</ul>

<div><div><pre><span>FullName</span> <span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Myeongju"</span><span>,</span> <span>"Jung"</span><span>);</span>
<span>// ...</span>
<span>name</span> <span>=</span> <span>name</span><span>.</span><span>withMiddleInitial</span><span>(</span><span>"M"</span><span>);</span>
</pre></div></div>

<div><div><pre><span>FullName</span> <span>withMiddleInitial</span><span>(</span><span>String</span> <span>middleName</span><span>)</span> <span>{</span>
    <span>return</span> <span>new</span> <span>FullName</span><span>(</span><span>this</span><span>.</span><span>firstName</span><span>,</span> <span>middleName</span><span>,</span> <span>this</span><span>.</span><span>lastName</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><strong>값 객체의 매개변수로 값만 전달하자.</strong></p>

<ul>
  <li>만약 엔터티와 같은 가변성을 가지는 인자를 받는다면 <em>부작용이 발생할 가능성</em>이 생긴다.</li>
  <li>아니면 Getter만 제공하는 추상화된 인자를 받는 것도 좋은 방법이다. &gt; Entity에 Getter만 있는 인터페이스를 Mixin</li>
</ul>

<p><em>기본 언어 값 타입에는 도메인에 맞춘 부작용이 없는 함수를 할당할 수 없다</em></p>

<ul>
  <li>도메인적인 표현이 기본 언어 함수에서 제공할 수 있을리가 없다.</li>
</ul>

미니멀리즘으로 통합하기

<p><img src="http://www.plantuml.com/plantuml/svg/ROv12i8m44NtEKN8FZSeeQ482eeBqVsO35fC4qac2z7UNSqYjjBTCEy__cyJGQGyE7O7SuCByer5JpqzjBVQ64o9Fnddni7dEYQCl6bM9Q0K6wjbWdDm3X6e3tvYTFKVlkO9N4QbIc2i8PtfEiK_EoBG8ja5Y_6FZQpi4_lrGV16IYvqjnMp2Mo-voLbALy4fNoHr7BMehTvS6y0" alt="미니멀리즘으로 통합하기"></p>

<ul>
  <li>ACL 내에서는 조회용으로써 일부 특성과 행위가 요구된다.</li>
  <li>즉 Entity 전체가 필요한(순응자나 공유모델) 것이 아니라, 해당 컨택스트 내에서 어울리는 타입으로써 값 객체가 좋은 선택</li>
</ul>

값으로 표현되는 표준 타입

<p>표준 타입에는 Enum을 쓰는 것이 좋다</p>

<blockquote>
  <p>잘 이해가 안된다 ㅠㅠ</p>
</blockquote>

값 객체의 테스트

<ul>
  <li>클라이언트 관점에서 값 객체를 보는 것은 중요하다.</li>
  <li>불변성을 테스트 해야 한다.</li>
  <li>테스트를 통해서 도메인적 표현을 확인할 수 있어야 한다.</li>
</ul>

구현

<ul>
  <li>불변, 불변, 불변 (No Setter)</li>
  <li>
equals(), hashCode(), toString()
</li>
  <li>JPA를 위해서 빈 생성자는 필수 (PACKAGE 접근제어로 생성)</li>
  <li>보호절을 통한 불변식 강제</li>
</ul>

값 객체의 저장

데이터 모델 누수의 부정적 영향을 거부하라

<p>도메인 모델을 위해서 데이터 모델을 설계해야한다.</p>

ORM 구현

<p>오래된 내용이라서 SKIP. 이젠 <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3gfEAJrVvyA4EU8l4rY-2BcWYZ-2Bhx7sVw2u9iXRyDLXlRNLUGM1MO9MI34oh6a1bdt1g-3D-3DC8-6_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqFZg-2B38V7OzTYsM62FdA9SdrxIlw-2Bx-2B9wpS3eU-2F8SrooU8bDKiC5tP3PaVZPbqHzsVGkygErmM3pvia0YpRKMb3zYndd1cjpoR1wLLee176B9TQFPvUG9BlEfF-2FkUnyrbmvvnl3kISRNjKjZfp4SoKZoPU38wpliAoVbvawP1M0b">Spring Data Jpa</a>를 사용하자.</p>

마무리

<ul>
  <li>값 객체 특징, 사용, 구현</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtwi9S9agaFQ6nZo9-2FOUI2IPJESJuybbAi7MQr7h5nz8w-3D-3DHYYT_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqA8y58Bm8SFGyCLojTzjg5CPSvc7zDgC8p7M-2FGnMz4ocmhIO2MNWTs3uFMEuG35QbJfAHfuD3QCgCBQWfeOKZ0vR-2BPUWZaLjjcMhG-2BmsmMaUsdyo41c06m0Esjzyv1YDWafaQMBl541sTV6DxPpl6xXVkgbhmrm9jiZfZ42TixpA">IDDD 6장. 값 객체</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUWS0r_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqAKsLqz6eyKYcRQty6M5l032vFge6iLFYxkKKpd-2FOFCNdhznujFmqddFHfBElM5Zc5Ors4TCd7jG9MJJSLFTaE9kWbT6286DYLUaUKmU9fu8PvlwF-2FGI-2BiEyawWWzfHEkVV9XebfoT6lHrxtn2pQ1vp-2B-2FIsFp-2BouQ8BQBtt-2Fn-2BJb">DevOOOOOOOOP</a> on May 15, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNuuRo8n5xSnCbndQ3Vtvazz-2B558F-2FKqA4l6AzY6eTC-2FtA7uk2zs-2BB4s2FhabAkcJsY34Mx0TUCm4a6wjxxlqbsVOiossAASUE7y-2FonNEyndZ3-2BNF5Skwm-2BPGGCSvfe0CPozaDHycliaGGywn7rXdO696Y5c5Ii4m1sESVV0Drzf08X85Dmn-2F-2B77BDYzXXkW7nIAwmXwi82YJ-2FPI2erIoU4" alt="" width="1" height="1" />

  </div>
  <div class="entry-more-link">
    <a href="https://weblog.youre.space/imyaman/2020/05/003898.html" itemprop="url">Continue reading</a>
  </div>
</article>


              
            </div>
            <aside class="widgets related" role="complementary">
              <nav class="widget-search widget">
  <div class="widget-content">
    <form method="get" id="search" action="https://connexus.youre.space/mt6/mt-search.cgi">
      <div>
        <input type="text" name="search" value="" placeholder="Search...">

        <input type="hidden" name="IncludeBlogs" value="1">

        <input type="hidden" name="limit" value="20">
        <button type="submit" name="button">
          <img alt="Search" src="https://connexus.youre.space/mt-static/support/theme_static/rainier/img/search-icon.png">
        </button>
      </div>
    </form>
  </div>
</nav>
<nav class="widget-archive-dropdown widget">
  <h3 class="widget-header">Archives</h3>
  <div class="widget-content">
    <select>
      <option>Select a Month...</option>
    
      <option value="https://weblog.youre.space/2002/07/">July 2002</option>
    
    </select>
  </div>
</nav>
    
  

<div class="widget-syndication widget section">
  <div class="widget-content">
    <p><img src="https://connexus.youre.space/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="https://weblog.youre.space/atom.xml">Subscribe to this blog's feed</a></p>

  </div>
</div>

            </aside>
          </div>
        </div>
        <footer id="footer" role="contentinfo">
          <div id="footer-inner">
            <div id="footer-content">
  <nav role="navigation">
          <ul>
            <li><a href="https://weblog.youre.space/">Home</a></li>


          </ul>
        </nav>

  <p class="license">&copy; Copyright 2020.</p>
  <p class="poweredby">Powered by <a href="http://www.movabletype.org/">Movable Type</a> and <a href="http://youre.space/">youre.space</a></p>
</div>

<!-- ad starts -->
<center>
<div class="main_banner" id="main_banner1">
  <script type="text/javascript"> var tad_conf = { targetId : 'main_banner1', clientId : 'MX00048A1', slotNo : 2 }; </script>
  <script type="text/javascript" src="http://adddn.adotsolution.com/contents/sdk/js/tad.min.js"></script>
</div>
</center>

<center>
<div id="realssp_imyaman00001_7916" class="realssp_dv" data-mcode="aW15YW1hbjAwMDAxXzc5MTY="></div>
<script src="//nw.realssp.co.kr/realclickssp.js?v=1.0&m=imyaman00001_7916&t=j" async></script>
</center>

<center>
<div id="admixer_display"></div>
</center>
<script type="text/javascript" src="//scr.nsmartad.com/admixer/admixer.js"></script>
<script type="text/javascript">
    new admixer_ad({
    admixer_key:"zp1v4th5",
    display_id:"admixer_display",
    adsense_publisher_key:"ca-mb-pub-0000000000000000", //AdSense 사용시에만 필요
    ad_change:true,  //default : true
    test : false,//default : false
    test_display_id : "log"
});
</script>
<!-- ad ends -->
          </div>
        </footer>
      </div>
    </div>
    <script src="https://connexus.youre.space/mt-static/jquery/jquery.min.js"></script>
    <script src="https://weblog.youre.space/mt-theme-scale2.js"></script>

<!-- ad starts -->                                                                 <center>
  <div id="admixer_display"></div>
</center>
<script type="text/javascript" src="//scr.nsmartad.com/admixer/admixer.js"></script>
<script type="text/javascript">
new admixer_ad({
  admixer_key:"zp1v4th5",
  display_id:"admixer_display",
  adsense_publisher_key:"ca-mb-pub-0000000000000000", //AdSense 사용시에만 필요
  ad_change:true,  //default : true
  test : false,//default : false
  test_display_id : "log"
});
</script>
<!-- ad ends -->

</body>
</html>
