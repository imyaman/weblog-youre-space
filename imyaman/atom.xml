<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>imyaman</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/" />
    <link rel="self" type="application/atom+xml" href="https://weblog.youre.space/imyaman/atom.xml" />
    <id>tag:weblog.youre.space,2017-07-10:/imyaman/12</id>
    <updated>2020-05-10T16:25:26Z</updated>
    
    <generator uri="http://www.sixapart.com/movabletype/">Movable Type 6.3.6</generator>

<entry>
    <title>IDDD 14장. 애플리케이션</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003907.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3907</id>

    <published>2020-05-10T16:25:26Z</published>
    <updated>2020-05-10T16:25:26Z</updated>

    <summary> 사용자 인퍼페이스와 도메인 모델 사이에 위치 유스케이스 태스크를 조정 트랜잭션, 보안 권한 부여 담당 애플리케이션을 핵심 도메인 모델과 상호 교류하며 이를 지원하기 위해 잘 조합된 컴포넌트의 집합을 의미하기 위해 사용하고 있다. 이는 일반적으로 도메인 모델 그 자체와 사용자 인터페이스,...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <ul>
  <li>사용자 인퍼페이스와 도메인 모델 사이에 위치
    <ul>
      <li>유스케이스 태스크를 조정</li>
    </ul>
  </li>
  <li>트랜잭션, 보안 권한 부여 담당</li>
</ul>

<blockquote>
  <p>애플리케이션을 핵심 도메인 모델과 상호 교류하며 이를 지원하기 위해 잘 조합된 컴포넌트의 집합을 의미하기 위해 사용하고 있다.
이는 일반적으로 도메인 모델 그 자체와 사용자 인터페이스, 내부적으로 사용되는 애플리케이션 서비스, 인프라적 컴포넌트를 뜻한다.
이 각각의 영역에 어떤 것들이 들어가는지는 애플리케이션마다 다르며, 사용하는 아키텍처가 무엇인지에 따라서도 달라진다.</p>
</blockquote>

<p><img src="/images/2018/06/IDDD-figure-14-1.png" alt="특정한 한 가지 아키텍처에 국한되지 않은 주요 애플리케이션 영역. 여전히 각기 다른 영역의 추상화에 의존적인 인프라의 DIP를 강조한다."></p>

<p>그림 14.1 <em>특정한 한 가지 아키텍처에 국한되지 않은 주요 애플리케이션 영역. 여전히 각기 다른 영역의 추상화에 의존적인 인프라의 DIP를 강조한다.</em></p>

<p>ui.Controller -구현-&gt; infra.TomcatController -위임-&gt; application.Service -구현-&gt; infra.TransactionalService -위임-&gt; domain.Repository -구현-&gt; infra.JpaRepository -의존-&gt; infra.Mysql</p>

<ul>
  <li>필자는 UI -&gt; Appcliation -&gt; Infra 순서로 설명해 나간다. (Top-Down 방식)</li>
</ul>

사용자 인터페이스

<p>UI 종류</p>

<ol>
  <li>Web 1.0 렌더링 되는 HTML</li>
  <li>Web 2.0 DHTML + Ajax</li>
  <li>데스크톱 애플리케이션 + HTTP 통신</li>
</ol>

도메인 객체의 렌더링

<p><img src="/images/2018/06/IDDD-figure-14-2.png" alt="사용자 인터페이스는 다수의 애그리게잇 인스턴스의 속성을 렌더링할 필요가 있지만 한 번에 하나의 인스턴스를 수정하도록 요청한다"></p>

<p>그림 14.2 조회 시에는 복수 의 애그리게잇. 명령 시에는 한 개의 애그리게잇</p>

애그리게잇 인스턴스로부터 데이터 전송 객체를 렌더링하기

<p>DTO + Assembler</p>

<blockquote>
  <p>개인적으로 가장 선호하는 방식</p>
</blockquote>

애그리게잇 내부 상태를 발행하기 위해 중재자를 사용하자

<p>중재자 패턴</p>

<blockquote>
  <p>개인적으로 비추 도메인 모델이 (약하긴 하지만) UI에 의존하게 됨</p>
</blockquote>

도메인 페이로드 객체로부터 애그리게잇 인스턴스를 렌더링하라

<p>도메인 객체를 내부에 담고 있는 DPO(Domain Payload Object)로 렌더링 하는 방식</p>

<ul>
  <li>지연로딩 이슈가 있기 때문에 OSIV와 같은 기술과 함께 쓰길 권장한다.</li>
</ul>

애그리게잇 인스턴스의 상태 표현

<p>View Model? Presentation Model?</p>

<blockquote>
  <p>DTO와 차이점을 모르겠다. 상태를 표현한다는 것으로 보아 불변이 가능한 정도 차이인 것인가?</p>
</blockquote>

유스케이스 최적 리파지토리 쿼리

<p>특정 유스케이스에 특화된 쿼리 메소드 제공.</p>

<p>CQRS와 구분하자.</p>

다수의 개별 클라이언트 처리하기

<p>이건 SKIP 하자. 최근의 MVC 프레임워크에서 지원하므로 Application의 책임이 아니라고 본다.</p>

변환 어댑터와 사용자 편집의 처리

<p>Adapter + Command (Or Presentation Model)</p>

<p>주로 명령(편집, 수정) 시에 사용하는 방식</p>

애플리케이션 서비스

<ul>
  <li><strong>애플리케이션 서비스를 얇게 유지(파사드)</strong></li>
  <li><strong>도메인 모델로 위임</strong></li>
</ul>

애플리케이션 서비스 예제

<p>원시타입의 나열 VS <strong>인자 (커맨드) 객체</strong></p>

<ul>
  <li><em>원시타입이 너무 많이 나열되면 그것은 안티패턴이라고 보고 가능하면 인자(Or 커맨드)로 캡슐화 하는 것이 좋아 보인다.</em></li>
</ul>

<blockquote>
  <p>단순 인자이며 명령을 캡슐화 하지 못하는데 커맨드 패턴이라고 부르는 것이 어색해 보인다.</p>
</blockquote>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>application</span><span>;</span>

<span>class</span> <span>TenantIdentityService</span> <span>{</span>
    <span>@Transactional</span>  <span>// 트랜잭션과 보안 처리</span>
    <span>@PreAuthorize</span><span>(</span><span>"hasRole('SubscriberRepresentative')"</span><span>)</span>
    <span>public</span> <span>void</span> <span>activeTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>// 도메인 모델로 위임</span>
        <span>this</span><span>.</span><span>nonNullTenant</span><span>(</span><span>tenant</span><span>).</span><span>activate</span><span>();</span>
    <span>}</span>

    <span>@Transactional</span><span>(</span><span>readOnly</span> <span>=</span> <span>true</span><span>)</span>
    <span>public</span> <span>Tenant</span> <span>nonNullTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Tenant</span> <span>tenant</span> <span>=</span> <span>this</span><span>.</span><span>tenant</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>tenant</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>IllegalArgumentException</span><span>(</span><span>"Tenant does not exists"</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>tenant</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

결합이 분리된 서비스 출력

<div><div><pre>    <span>@Override</span>
    <span>@Transactional</span><span>(</span><span>readOnly</span> <span>=</span> <span>true</span><span>)</span>
    <span>public</span> <span>void</span> <span>findTenant</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Tenant</span> <span>teannt</span> <span>=</span> 
                <span>this</span><span>.</span><span>tenantRepository</span><span>.</span><span>tenantOfId</span><span>(</span><span>tenantId</span><span>)</span>
        <span>this</span><span>.</span><span>tenantIdentityOutputPort</span><span>().</span><span>write</span><span>(</span><span>tenant</span><span>);</span>
    <span>}</span>
</pre></div></div>

<p>최근 추세는 어쨋든 사용자에게 출력에 대한 책임은 가능한 UI가 하는 것이 좋다고 본다.
이는 애플리케이션의 책임이 아닌 것 같다.</p>

<blockquote>
  <p>그러한 것은 컴포넌트로 추상화 해서 UI 모듈에 있는 것이 더 어울리는 것 같다. 개인적으로 출력은 반환 값이 있는 것이 더 직관적으로 보인다.</p>
</blockquote>

여러 바운디드 컨텍스트 묶기

<p><img src="/images/2018/06/IDDD-figure-14-3.png" alt="UI에서 다수의 모델을 구성해야만 할 때가 있다. 이 그림에서는 하나의 애플리케이션 계층을 사용해서 세 개의 모델을 구성한다."></p>

<p>그림 14.3 UI에서 다수의 모델을 구성해야만 할 때가 있다. 이 그림에서는 하나의 애플리케이션 계층을 사용해서 세 개의 모델을 구성한다.</p>

<ul>
  <li>애플리케이션 계층이 <strong>유스케이스</strong>를 관리 - UI 계층이 아니다!!</li>
  <li>제품, 토론, 리뷰 컨텍스트가 분리 VS 하나의 컨텍스트로 통합 &gt; <strong>결론은 모델 정제!!</strong>
</li>
</ul>

<p>개인적으로 이러한 상황에서는 UI에서 각각 쿼리 해서 조합하던가, API-GW에서 조합하는 것이 좋다고 본다.</p>

<p>물론 특정 컨텍스트 내에서 조합해야 한다면 <em>애플리케이션 서비스</em>가 가장 어울리는 장소인 것 같다.</p>

인프라

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuIf8JCvEJ4zLU3DrmTifFQ-NhNcpf-7Dt2rlMcSeL7CfA2Jd91ONAuIavYNcbNYcfEQLP9PK1gSMbMKcfuBaWK0xCRaaioon91MYI4CJ8bg2uDLorSAjUTtVydhbb3TpTxnUjU9rxmwm6Pbv9Qb5QOd9gL1xWb8ByeipI_ABAa7I2CFyqpnJC0m46lLsIilhkNkGdEkHcPHQb0Tq4ePvcRa5EQcvG6yKOzW5D1ExDtNjCDJYKAcdPuVRRYw7rBmKO8W30000" alt="애플리케이션 서비스는 도메인 모델의 리파지토리 인터페이스에 의존적이지만, 인프라의 구현 클래스를 사용한다. 패키지는 넓은 범위의 책임을 캡슐화 한다"></p>

<p>그림 14.4 애플리케이션 서비스는 도메인 모델의 리파지토리 인터페이스에 의존적이지만, 인프라의 구현 클래스를 사용한다. 패키지는 넓은 범위의 책임을 캡슐화 한다</p>

엔터프라이즈 컴포넌트 컨테이너

<p>EJB VS Spring</p>

마무리

<ul>
  <li>도메인 모델 -&gt; UI 모델</li>
  <li>사용자 입력 -&gt; 도메인 모델</li>
  <li>애플리케이션 서비스의 책임</li>
  <li>DIP로 도메인 모델과 기술(인프라) 분리 및 유연성 확보</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsZ7YT7GlZSwFaLOZNMYEVMZULJXO0Qdy0OuWnEUod7Hw-3D-3DtHtI_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsP96XINBjrQgAxMcqimG-2Buu11EN5QAePJ4Rw8zWxFNnjMzDQiE1u9BlnfThclUa1nw0Z4YFZ7UiF-2BYGQkTh8B-2ByGBWSudlHCIPVAwL8HBQxFR-2BRMSbE4wg-2Bwdf-2FRlJkfU0KWsCs1VIc083ObmcaRcrHLVHC7oh0r487gHn5QDiYHJRRoy2zgQ-2FUL16e9uXxzZwYalcBbEhaqpRjK85-2BegP">IDDD 14장. 애플리케이션</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcU7ulV_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsP96XINBjrQgAxMcqimG-2Buu11EN5QAePJ4Rw8zWxFNnhhXSqSJMc1lY4ZGEc4HBsydiFjpfLD443LkE3JNgdvx7qI-2FoNrmHXw9Cgh3D6fJOUdE8RaNFJKGuz67URUdY3-2BTra5sFIKpEAALx6n82de-2BwDKIeRphjG8QWwpKlxAYG424kN-2FdIjSiPbdED1-2BYnDmzz7l31bt1x-2BcHxKE8so8-2F">DevOOOOOOOOP</a> on June 19, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNeNVd6tSaTu0o841AtvDOt1DnGuCderuS4ffBd35tylB29xyw-2FcygEygtOMUjbTtQdeE-2BWgM-2FZnSqlTUAdtmpTDllpRpWMIHS3rFRLSqsHJigLdCcSsqDrIpTVOTsjwq7Z7amtIQlmBhl7CYNIaxdACsLIJyuHTR3dcxx0xE5bVE9Rads-2BmiM7LdxS1pGnWV-2BB8RQrQa4sCz6ODDxJKkby" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 13장. 바운디드 컨텍스트 통합</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003906.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3906</id>

    <published>2020-05-10T16:25:25Z</published>
    <updated>2020-05-10T16:25:25Z</updated>

    <summary><![CDATA[ 통합의 기본 API &amp; RPC (RPC, SOAP, WEB/API) : 탄력성이 떨어짐(Legacy) 메시지 RESTful API 1.과 유사하지 않은가? 하지만 필자는 HTTP Verbs 로 차이를 이야기하고 있다. 그 외 분산 시스템은 근본적으로 다르다 분산 컴퓨팅의 원칙 네트워크는 신뢰할 수 없다. 언제나...]]></summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    통합의 기본

<ol>
  <li>API &amp; RPC (RPC, SOAP, WEB/API) : 탄력성이 떨어짐(<em>Legacy</em>)</li>
  <li><strong>메시지</strong></li>
  <li>
<strong>RESTful API</strong>
    <ul>
      <li>1.과 유사하지 않은가? 하지만 필자는 HTTP Verbs 로 차이를 이야기하고 있다.</li>
    </ul>
  </li>
  <li>그 외</li>
</ol>

분산 시스템은 근본적으로 다르다

<p><em>분산 컴퓨팅의 원칙</em></p>

<ul>
  <li>네트워크는 신뢰할 수 없다.</li>
  <li>언제나 지연은 있다.</li>
  <li>대역폭은 무한하지 않다.</li>
  <li>정보와 정책은 다수의 관리자에 걸쳐 퍼져 있다.</li>
  <li>네트워크 전송은 비용이 든다.</li>
  <li>네트워크는 다양성을 갖고 있다.</li>
</ul>

<blockquote>
  <p><strong>왜 원칙인가?</strong></p>
  <ul>
    <li>반드시 해결해야하는 문제점</li>
    <li>계획해야하는 복잡성</li>
    <li>일반적으로 저지르는 <strong>실수가 아님</strong>
</li>
  </ul>
</blockquote>

시스템 경계에 걸친 정보의 교환

<p>결국은 발행된 언어Published Language에 의존해야한다.</p>

<ul>
  <li>정보에서는 인터페이스/클래스가 중요한 것이 아니라 말 그대로 데이터의 특성이 중요</li>
</ul>

<p><strong>예를 들어서</strong></p>

<p>BacklogItemCommitted 알림 이벤트를 발행한다고 하면 아래와 같은 <em>계약</em>을 의미할 것이다.</p>

<table>
  
    <tr>
      <th>정의/속성</th>
      <th>설명</th>
    </tr>
  
  
    <tr>
      <td>타입</td>
      <td>Notification</td>
    </tr>
    <tr>
      <td>포멧</td>
      <td>JSON</td>
    </tr>
    <tr>
      <td>notificationId</td>
      <td>식별자</td>
    </tr>
    <tr>
      <td>typeName</td>
      <td>알림의 타입(BacklogItemCommitted)</td>
    </tr>
    <tr>
      <td>version</td>
      <td>알림 버전</td>
    </tr>
    <tr>
      <td>occurredOn</td>
      <td>발생일시</td>
    </tr>
    <tr>
      <td>event</td>
      <td>본문(Payload)</td>
    </tr>
  
</table>

<p>직렬화 &amp; 역직렬화 자바 소스는 <strong>SKIP</strong></p>

<p><em>중요한 것</em></p>

<ul>
  <li>위와 같은 <em>계약</em>을 통해 컨슈머와 프로슈머가 서로 통신(정보의 교환)을 할 수 있다</li>
  <li>시스템 상호간 의존성이 줄어든다. <em>공유 커널</em>과 비교해보아라
    <ul>
      <li>버전을 통해서 호환성 이슈가 더 없어진다.</li>
    </ul>
  </li>
  <li>위 내용을 <strong>사용자 지정 미디어 타입 계약</strong> 이라 한다.</li>
</ul>

레스트풀 리소스를 사용한 통합

<p><strong>오픈 호스트</strong></p>

<blockquote>
  <p>서비스의 집합으로서 여러분의 서브시스템으로의 액세스를 허용하는 프로토콜을 정의하자.
여러분과 통합해야 하는 모든 사람들이 사용할 수 있도록 프로토콜을 공개하자.
프로토콜을 강화하고 확장해서 새 통합 요구사항을 처리하도록 하자. [Evans]</p>
</blockquote>

<ul>
  <li>결합도를 느슨하게 하기 위해서(자율성) retry와 같은 기법이 요구된다.</li>
</ul>

<p><em>RESTful API 예를 들면</em></p>

<p>특정 사용자의 권한을 조회 /tenants/{tenantId}/users/{username}/inRole/{role}</p>

<ul>
  <li>200 : 권한 있음</li>
  <li>204 : 권한 없음 (404도 괜찮지 않을까?)</li>
</ul>

레스트풀 리소스의 구현

<p>현업에서 우리는 <em>오픈 호스트</em>라고 생각했지만 실상은 <em>공유된 커널</em> 이거나 <em>순응주의자</em>인 경우가 많다.</p>

<p><em>오픈 호스트</em>라면 바운디드 컨텍스트가 의존성이 매우 낮지만 <em>공유된 커널</em>이나 <em>순응주의자</em>는 상당한 결합도를 가지게 되므로 자율성을 위해서 <strong>오픈 호스트</strong> 지향하는 것이 좋다고 본다.</p>

<p><em>UserResource.java</em></p>
<div><div><pre>    <span>@GET</span>
    <span>@Path</span><span>(</span><span>"{username}/inRole/{role}"</span><span>)</span>
    <span>@Produces</span><span>({</span> <span>OvationsMediaType</span><span>.</span><span>ID_OVATION_TYPE</span> <span>})</span>
    <span>public</span> <span>Response</span> <span>getUserInRole</span><span>(</span>
            <span>@PathParam</span><span>(</span><span>"tenantId"</span><span>)</span> <span>String</span> <span>aTenantId</span><span>,</span>
            <span>@PathParam</span><span>(</span><span>"username"</span><span>)</span> <span>String</span> <span>aUsername</span><span>,</span>
            <span>@PathParam</span><span>(</span><span>"role"</span><span>)</span> <span>String</span> <span>aRoleName</span><span>)</span> <span>{</span>

        <span>User</span> <span>user</span> <span>=</span> <span>this</span><span>.</span><span>accessApplicationService</span><span>()</span>
                       <span>.</span><span>userInRole</span><span>(</span>
                               <span>aTenantId</span><span>,</span>
                               <span>aUsername</span><span>,</span>
                               <span>aRoleName</span><span>);</span>

        <span>Response</span> <span>response</span> <span>=</span> <span>this</span><span>.</span><span>userInRoleResponse</span><span>(</span><span>user</span><span>,</span> <span>aRoleName</span><span>);</span>
        <span>return</span> <span>response</span><span>;</span>
    <span>}</span>
</pre></div></div>

<p><em>사용자의 권한을 조회하는 API 응답</em></p>

<div><div><pre>HTTP1.1 200 OK
Content-Type: application/vnd.saasovation.idovation+json
...
{
    "role": "Author",
    "username": "zoe",
    "tenantId": "A94A-...",
    "firstName": "Zoe",
    "lastName": "Doe",
    "emailAddress": "zoe@saasovation.com"
}
</pre></div></div>

부패 방지 게층을 통한 REST 클라이언트 구현

<p><img src="/images/2018/06/IDDD-figure-13-1.png" alt="ID와 액세스 컨텍스트와 협업 컨텍스트의 부패 방지 계층 사이의 통합을 위해 사용된 오픈 호스트 서비스"></p>

<p>그림 13-1 <em>ID와 액세스 컨텍스트와 협업 컨텍스트의 부패 방지 계층 사이의 통합을 위해 사용된 오픈 호스트 서비스</em></p>

<div><div><pre><span>interface</span> <span>CollaboratorService</span> <span>{</span>
    <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Creator</span> <span>creatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Moderator</span> <span>moderatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Owner</span> <span>ownerFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
    <span>Participant</span> <span>participantFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><strong>Java Code</strong></p>
<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2Vo04C6nxhBo2EtVBz71OI9v7l3HS-2FFIGwMuIoFN6S9s-2BkLOmDx7-2BfGK1083Fp3Pb3ShF_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvs9Ev6zua5wi96V0YzbB-2FHepY8AfUYRWIBcONuYmZNWHreTeF6DmwiWrciA4HtpALRFJc1uGqiLyicW68-2F2-2Bg4UlSENogDEgE6p8RvS4rGWHDnr6QEYJG8txM0tcGbj0e87GcRiAgJ3h-2Bra6-2BGby-2FcJiuQad1oQBns5iRvoAtOAt">TranslatingCollaboratorService</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2kpiHvWVHiqKsxG7f8OFH-2BBWS6iEiBhtalK5hK7hlULY-3D2yQ-_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvrc9bBra2u9J3wuqs4Ngi9GGTXvvFbfH-2BfSISBJT0b-2FJ-2BLuWBsJtw2czeqF-2BZnA3F49-2F5D1WgRBNRnTaz3mAwXaXQefWogejlfZ68lBvwnGRa0QRSRtTXhEnFJLIXpIOBf9nGK-2FeyNtYvhei6dG6-2FcZJuKgLzZ91hSsZjLWTlEUm">UserInRoleAdapter</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbIIm412-2Bv6Fs1Ov9dq-2FN0F2H4Ho8-2FOjMkDwW0QJNU1eQyZ1uJjzaNi-2FI8gDC3uSrofrVdc2A6I-2FWOGi3X6Y4eIXEauR_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvhmuVwuByWO31wjAg2n8XL4YlqndGJgwBmQEE5tRrwnpmB2XgS-2BOkAQo-2Bv4l9QSTXtQELKK6pH4x-2FlT6Pe5JGqBV8qH4nlbW2uTkPg6HQWItIPQ44p-2B2-2FvJ6Uls-2BeyOUal21bKdhfyDhJKIvzNIEDv-2BzHVegGpyGOPJlCI8HI1jK">CollaboratorTranslator</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rNIBQn-2BUMNFIoH1bXWmoo33-2FMUBGC5xDjgevP-2FyijSg-2BWFUjwH2kuZWhmWva9dgDBlGca81HEM2l0wcNOpI73abUqBPCZmzT8H-2FMMrHbEEnOnTu9dP5DiErBT3Cr2xEAuK80jHKLy3RARrYO3sgcbJXydgPI3oCd3QMs5suRkGiE3hN22GZM-2B3EnTejOTOKA0XLWxgATmvg03blZ3q9d1c-3DxDJe_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvvsE0LNhxedodHb8jZKsC7FCJSGOhqzYhDKE6z481k47nSGpg5SAR3pEMlEbhR1E3ai-2FZ6b9MXtXzYIIidfXzy5CF3mYBZtYjGSPUKBdSDh9XJNnJ-2BpLBkqr625LA67TScsYRk9van3Bu0YWVnw46SiWFta50ZtIPRIKVXnF34Gl">Author</a></li>
</ul>

<p>리파지토리를 사용할 수도 있었지만 Author는 엔터티가 아닌 값 객체이므로 부패 방지 계층이 더 어울리다.
반대로 부패 방지 계층에서 애그리게잇(가변성)을 생성한다면 리파지토리가 더 어울린다.</p>

메시징을 사용한 통합

<p>레스트풀 리소스를 이용한 방식보다 <strong>더 높은 수준의 자율성</strong>을 가짐.</p>

<p><strong>도메인 이벤트</strong>를 외부로 발행할 때 좋다.</p>

제품 소유자와 팀 맴버의 정보를 계속해서 제공받는 것

<p>사용자에게 권한을 할당</p>

<ol>
  <li>권한에 사용자를 추가
    <ul>
      <li>AccessService#asignUserToRole(AssignUserToRoleCommand)</li>
      <li>Role#assignUser(User)</li>
    </ul>
  </li>
  <li>사용자에게 권한 할당됨 이벤트 발행 : new UserAssignedToRole()
</li>
  <li>컨텍스트 외부로 이벤트 발행</li>
  <li>AgilePM 컨택스트에서 이벤트를 구독
    <ul>
      <li>TeamMemberEnablerListener#filteredDispatch</li>
      <li>TeamService#enabledProductOwner(EnableProductOwnerCommand)</li>
    </ul>
  </li>
</ol>

당신은 책임을 감당할 수 있는가

<p>외부 바운디드 컨텍스트에서 정보를 (이벤트를 통해서) 복제한 후 그것을 지속적으로 동기화한다. 즉, <strong>데이트를 복사하는 복잡한 책임이 생긴다.</strong></p>

<p>이벤트가 항상 순차적으로 구독자에게 온다는 보장이 없다. 고로 이벤트 처리 시 항상 <em>발생시각</em>을 확인해서 처리해야한다.</p>

<div><div><pre><span>class</span> <span>TeamService</span> <span>{</span>
    <span>@Transactional</span>  <span>// 구독 처리</span>
    <span>public</span> <span>void</span> <span>disableTeamMember</span><span>(</span><span>DisableTeamMemberCommand</span> <span>command</span><span>)</span> <span>{</span>
        <span>TenantId</span> <span>tenantId</span> <span>=</span> <span>new</span> <span>TenantId</span><span>(</span><span>command</span><span>.</span><span>getTenantId</span><span>);</span>
        <span>TeamMember</span> <span>teamMember</span> <span>=</span> 
                <span>teamMemberRepository</span><span>.</span><span>teamMemberOfIdentity</span><span>(</span>
                        <span>tenantId</span><span>,</span> <span>command</span><span>.</span><span>getUsername</span><span>());</span>
        <span>if</span> <span>(</span><span>teamMember</span> <span>!=</span> <span>null</span><span>)</span> <span>{</span>
            <span>// 여기가 중요하다!!!</span>
            <span>teamMember</span><span>.</span><span>disable</span><span>(</span><span>command</span><span>.</span><span>getOccurredOn</span><span>());</span>
        <span>}</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>Member</span> <span>{</span>
    <span>// 위에 이어서 disable 메서드를 보면</span>
    <span>public</span> <span>void</span> <span>disable</span><span>(</span><span>Date</span> <span>asOfDate</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>canToggleEnabling</span><span>(</span><span>oaOfDate</span><span>))</span> <span>{</span>
            <span>this</span><span>.</span><span>setEnabled</span><span>(</span><span>false</span><span>);</span> <span>// enable() 라고 하지..</span>
            <span>this</span><span>.</span><span>setChangeTracker</span><span>(</span>
                <span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>enablingOn</span><span>(</span><span>asOfDate</span><span>));</span>
        <span>}</span>
    <span>}</span>
    <span>public</span> <span>void</span> <span>enable</span><span>(</span><span>Date</span> <span>asOfDate</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>canToggleEnablig</span><span>(</span><span>asOfDate</span><span>))</span> <span>{</span>
            <span>this</span><span>.</span><span>setEnabled</span><span>(</span><span>true</span><span>));</span> <span>// disable() 라고 하지..</span>
            <span>this</span><span>.</span><span>setChangeTracker</span><span>(</span>
                <span>this</span><span>.</span><span>changeTracker</span><span>().</span><span>enablingOn</span><span>(</span><span>asOfDate</span><span>));</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>위 처리를 통해서 이벤트 순서가 뒤바껴도 처리에 문제가 없다.</li>
  <li>또한 멱등하게 만드는 역할도 한다.</li>
</ul>

<p>새로운 책임을 알아보자 : <strong>정보 복제는 사소한 책임이 아니다</strong></p>

<p>사용자 정보 복제 시 영향을 미치는 이벤트들</p>

<ul>
  <li>PersonContactInformationChanged</li>
  <li>PersonNameChanged</li>
  <li>UserAssignedToRole</li>
  <li>UserUnassignedFromRole</li>
</ul>

<p>하지만 이외에도</p>

<ul>
  <li>UserEnablementChanged</li>
  <li>TenantActivated</li>
  <li>TenantDeactivated</li>
</ul>

<p>위와 같은 이벤트들이 존재한다.</p>

<p>= <em>가능하면 바운디드 컨텍스트 전반에서 정보의 중복을 최소화하거나 완전히 제거하는 것이 최선이다</em></p>

<p>= 필요할 때 마다 오픈 호스트 서비스와 같은 것을 이용해서 정보를 조회하는 것이 나을수도 있다</p>

<blockquote>
  <p>어쩌란 건지 명확히 이해가 안된다.???
필요한 이벤트 발행을 막을 필요는 없지만 굳이 데이터 중복을 통해서 관리하지 말고 이벤트는 이벤트대로 사용하고, 데이터는 필요할 때 마다 조회하는 것이 낫다는 것인가?</p>
</blockquote>

장기 실행 프로세스와 책임의 회피

<p>다른 바운디드 컨텍스트에게 데이터 생성 책임을 지게 하고, 단순하게 레코드 시스템이 그 고유한 정보를 처리하게 할 것이다. 
즉, <strong>책임을 네트워크 건너로 차버린다.</strong></p>

<p><em>제품을 생성하는 유스케이스를</em> 살펴본다</p>

<ol>
  <li>사용자는 제품 설명 정보를 제공한다.</li>
  <li>사용자는 팀토론에 대한 의사를 표시한다.</li>
  <li>사용자는 정의된 제품을 만들도록 요청한다.</li>
  <li>시스템은 포럼과 <strong>토론</strong>이 들어간 제품을 만든다.</li>
</ol>

<p><strong>애자일 프로젝트 관리 컨텍스트에서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP7DIaGn38NtUOg-m7q15yF0k5JmP-4wqnwzWTfUcrJnxGrSos0HTDdpdPEVzAZ6pVfh9evMMpXbGJ7QN9Ge6nSBTwsc7kqHxLqYVaFa4R7FyJmri25HhCLQpKE-5erTLMfvm5k7kkL6r53GVXIzXIg_O4yvIsnyPiK0znqTj0yQbiCqNxWA1H_VsfFOUcbBa_EItKE3EvXMSRxrSnPTQGABU__Up_FFaWqDoLqRMrpf7wdbC1_32obAebbUXdMSv-Wk_zKl" alt="애자일 프로젝트 관리 컨텍스트에서 흐름도"></p>

<p>ProjectService#newProductWithDiscussion(NewProductCommand)</p>

<ul>
  <li>
Product와 ProductDiscussion을 생성</li>
  <li>
ProductCreated 이벤트 발행
    <ul>
      <li>
Discussion#availablity#isRequested(토론 가능 상태)가 참이면 <strong>장기 프로세스를 시작</strong> 한다.</li>
      <li>장기 실행 프로세스 == 상품 토론을 생성</li>
    </ul>
  </li>
  <li>추후에 구매를 통해서 토론을 생성할 수도 있다. Product#requestDiscussion(DiscussionAvailablity)
    <ul>
      <li>
ProductDiscussionRequested 이벤트 발행</li>
    </ul>
  </li>
</ul>

<p>그렇다면 사용 가능 상태가 REQUESTED가 아니라면 이 이벤트의 발행의 의미가 있는가?</p>

<p>&gt; 이것에 대한 책임은 이벤트 구독자가 갖는다.</p>

<p>ProductDiscussionRequestedListener#listensToEvents</p>

<ul>
  <li>
ProductCreated, ProductDiscussionRequested 이벤트를 수신한다.</li>
</ul>

<p>ProductDiscussionRequestedListener</p>

<div><div><pre>    <span>protected</span> <span>void</span> <span>filteredDispatch</span> <span>(</span><span>String</span> <span>type</span><span>,</span> <span>String</span> <span>textMessage</span><span>)</span> <span>{</span>
        <span>// 토론 사용 가능상태가 아니면 이벤트 처리 없음</span>
        <span>if</span> <span>(!</span><span>reater</span><span>.</span><span>eventBooleanValue</span><span>(</span><span>"requestingDiscussion"</span><span>))</span> <span>{</span>
            <span>return</span><span>;</span>
        <span>}</span>
        <span>...</span>
        <span>// CreateExclusiveDicussion 커맨드를 만들어 협업 컨텍스트에 메시징 인프라를 통해서 이벤트 발행</span>
        <span>this</span><span>.</span><span>messageProducer</span><span>().</span><span>send</span><span>(...);</span>
    <span>}</span>
</pre></div></div>

<p>여기서 잠깐</p>

<ul>
  <li>애자일 프로젝트 관리 컨텍스트에서 Product 애그리게잇에서 발행된 이벤트(ProductCreated)를 구독할 리스터를 만들 필요가 있을까?
    <ul>
      <li>차라리 협업 컨텍스트에서 ProductCreated 이벤트를 바로 구독하는 것이 낫지 않을까?</li>
      <li>그런데 ProductCreated는 협업 컨텍스트의 유비쿼터스 언어와 어울리지 않고, 이 이벤트가 Forum과 Discussion을 생성하게 한다는 것을 연결시키는 것이 힘들다.</li>
      <li>고로 협업 컨텍스트 입장에서 CreateExclusiveDicussion 명령을 이벤트로 받는 것이 어색하지 않다.</li>
    </ul>
  </li>
</ul>

<p><strong>협업 컨텍스트에서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP5DJaCn38JtFaKkq7S05gWIFojOe9uWBsy4bjBaAROBt1u72JNbWTHLf9dFav6z5urDxPXfYHhdA0ZF48clU34OADMYhURmy96o2Pzmpv9CX6kvQuZgxnEBeg3HwacSU8r5msDjTZoWdJXXQrmevqH2KTRFGJdqTbY8nb9Xjxkzfb2u2MApfCOpw1hUOyVUVRx_FqtJq74a_flurlucVv3VYHquQquLlDCWkBrPYrEhpPdbZRQUB-dob7kKnG_z1G00" alt="협업 컨텍스트에서 흐름도"></p>

<p>ExclusiveDiscussionCreationListener#filteredDispatch(String, String)</p>

<ul>
  <li>위에서 이어 애자일 프로젝트 관리 컨텍스트에서 발행한 CreateExclusiveDicussion를 구독</li>
  <li>
ForumService#startExclusiveForumWithDiscussion를 호출해서 Forum과 Discussion을 생성
    <ul>
      <li>생성과 동시에 DiscussionStarted 이벤트를 발행한다.</li>
    </ul>
  </li>
</ul>

<p><strong>다시 애자일 프로젝트 관리 컨텍스트로 돌아와서</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/VP1D2i8m48NtSufSe1TmKRfm8oWeFK5-7ZfGavAP2DxU24gaj2uV-RwybmoYDckvJnIiMcS5vWGHUyMbe81yYfhJPFOileXmYkDRG3YoA28opJMovzb6DUUSGl4w8Z_OO-s849Nr-OtjsaDaPQi8HBy3JDVrs-LcPwGuyPaTQ9lg-iMowl6dhrcqO9hr5s_SsckgEXStiTneG0prery0" alt="다시 애자일 프로젝트 관리 컨텍스트에서 흐름도"></p>

<p>DiscussionStartedListener#filteredDispatch(String, String)</p>

<ul>
  <li>협업 컨텍스트에서 발행한 DiscussionStarted 이벤트를 구독한다.</li>
</ul>

<p>이어서 ProductService#initiateDiscussion(InitiateDiscussionCommand)</p>

<ul>
  <li>
Product#initiateDiscussion 를 실행해서 아까 생성한 Product에서 Discussion 생성 상태 변경
    <ul>
      <li>당연히 멱등하다. 이미 Discussion을 생성해서 READY 상태라면 아무일도 일어나지 않는다. 즉 REQUESTED 상태에서만 이하 작업이 실행된다.</li>
      <li>그리고 ProductDiscussionInitiated 이벤트를 발행한다.</li>
    </ul>
  </li>
</ul>

<p>여기서 잠깐</p>

<ul>
  <li>이 장기 실행 프로세스는 네트워크를 건너서 통신하고 메시징 인프라에 의존하는데 여기에 문제가 생기면 어떻게 될까?</li>
  <li>즉 프로세스가 끝까지 실행한다고 확신할 수 있을까?</li>
</ul>

프로세스 상태 머신과 타임아웃 트래커

<p>위 문제점 해결을 위해서 타임아웃 트래커가 필요하게 된다.</p>

<p><em>타입아웃 트래커</em></p>

<p>트래커는 완료까지 부여된 시간이 만료된 프로세스를 감시하는데. 이런 프로세스는 만료되기 전까지 몇번이고 재시도될 수 있다. 
트래커는 원하는 경우 고정된 시간 간격을 재시도하도록 설계할 수 있고, 재시도를 전혀 하지 않거나 정해진 횟수만큰을 재시도한 후에 타임아웃을 발생시키도록 할 수도 있다.
<em>기술적 서브도메인의 일부다</em></p>

<p><img src="http://www.plantuml.com/plantuml/svg/XP5HIiSm38VVUufUm0liGGRwCX2KkGkK9W_1BTa_IGLlRmiAhbHzAQ7zVUdNT3PFwkNOGnPsbJs-g439_aYMYna9htWhQ8xmH7Lbr71MX3ATYVqx_ehwJXdxeunccwRyXhhYAKOk-d49RNJWWx2v9cA4AnD7LuNmlsAyk-_CuXJRKtz02vDJybg5BbhXlxMcVaeiNmgDW-VYWvQ_ZQDsIm1ZeEqqSnnwBn1cPAY_zma0" alt="상품의 토론 생성 흐름도 with 타임아웃 트래커"></p>

<p>ProductService#startDiscussionInitiation</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>application</span><span>;</span>

<span>class</span> <span>ProductService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>startDiscussionInitiation</span><span>(</span>
            <span>StartDiscussionInitiationComman</span> <span>command</span><span>)</span> <span>{</span>
        <span>Product</span> <span>product</span> <span>=</span> <span>productRepository</span><span>.</span><span>findById</span><span>(...)</span>
        
        <span>TimeConstrainedProcessTracker</span> <span>tracker</span> <span>=</span> <span>new</span> <span>TimeConstrainedProcessTracker</span><span>(</span>
                <span>product</span><span>.</span><span>tenantId</span><span>().</span><span>id</span><span>,</span>
                <span>ProcessId</span><span>.</span><span>newProcessId</span><span>(),</span>
                <span>"Create discussion for product : "</span> <span>+</span> <span>product</span><span>.</span><span>name</span><span>(),</span>
                <span>new</span> <span>Date</span><span>(),</span>
                <span>5L</span> <span>*</span> <span>60L</span> <span>*</span> <span>1000L</span><span>,</span> <span>// 5분 마다 재시도</span>
                <span>3</span><span>,</span>                <span>// 총 3회 재시도한다.</span>
                <span>ProductDiscussionRequestTimedOut</span><span>.</span><span>class</span><span>);</span>

        <span>processTrackerRepository</span><span>.</span><span>add</span><span>(</span><span>tracker</span><span>);</span>  <span>// 타임아웃 트래커 등록</span>
        
        <span>product</span><span>.</span><span>setDiscussionInitiationId</span><span>(</span>
                <span>tracker</span><span>.</span><span>processId</span><span>().</span><span>id</span><span>());</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><strong>상품의 토론 타임아웃 or 재시도 흐름도</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/dOzTgi8m44RViufiuDu5-20jj8L2GL4t49EvC90Vd9aKkdldHG8g2lSb9EISR-RhM1n9JT6uA5OmGQbYh3rI2TNBWEmhCvPy0g5jGHR8GFPd_o3EG2jwiBidkNszXHbo69F3E1Mwg1WELHJomFmfGCq_bTfQSqP19tfhMkEbWMgsHxzgYBjYHDb-ftvUni50PB04sl9VzPlwlJp1hGBBon03EPXEZvhY7G00" alt="상품의 토론 타임아웃 or 재시도 흐름도 with 타임아웃 트래커"></p>

<p><strong>마지막에 상품과 토론이 정상적으로 생성되면 흐름도</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/ZOun3i8m34Ntd28Nu08Cg1AC34Zj1IBd3nQ94zaEvwTC5HKWHlk_x-V9FAcFMW8rSMqbNjXec76J-HKXNzaS0Wrz7Pcu9_5uqvO7-GnzCE5JzBPRkEBSn5mJ2_AA4CmMJNI7Xl3L6G-ddIeU8mix9yVM2ZjcQ_sB_tnmFKAjzW973XCaZrgU" alt="상품과 토론이 정상적으로 생성 시 흐름도"></p>

<ul>
  <li>애자일 프로젝트 관리 컨텍스트에서 마지막으로 상품의 토론이 정상적으로 생성되면 <strong>타임아웃 트래커를 완료</strong> 시켜야 한다.</li>
  <li>이것으로 프로세스는 끝난다.</li>
</ul>

<p><em>위 장기 실행 프로세스의 문제점과 해결책</em></p>

<ul>
  <li>동일한 CreateExclusiveDiscussion 커맨드가 여러 번 발송된다.
    <ul>
      <li>멱등성을 지켰기 때문에 문제가 없을 것 같다.</li>
      <li>하지만 애자일 프로젝트 관리 컨텍스트가 실패한다면 문제가 발생할 수 있다.</li>
      <li>결국 협업 컨텍스트의 ExclusiveDiscussionCreationListener가 멱등한 애플리케이션 서비스 메서드로 작업을 위임할 수 있다면 많은 문제점을 해결할 수 있다.</li>
    </ul>
  </li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/ZP5DJaCn38JtFaKkq7S05gWIFojOe9uWBsy4bjBaAROBt1u72JNbWTHLf9dFav6z5urDxPXfYHhdA0ZF48clU34OADMYhURmy96o2Pzmpv9CX6kvQuZgxnEBeg3HwacSU8r5msDjTZoWdJXXQrmevqH2KTRFGJdqTbY8nb9Xjxkzfb2u2MApfCOpw1hUOyVUVRx_FqtJq74a_flurlucVv3VYHquQquLlDCWkBrPYrEhpPdbZRQUB-dob7kKnG_z1G00" alt="협업 컨텍스트에서 흐름도"></p>

<ul>
  <li>위 흐름도 기준에서 startForum, startDiscusssion 행위가 멱등하면 해결된다.</li>
</ul>

좀 더 복잡한 프로세스 설계하기

<p>복잡한 상황에서 다수의 완료 단계가 필요하게 된다면 <strong>상태 머신</strong>이 좋은 선택</p>

<div><div><pre><span>Proces</span> <span>process</span> <span>=</span> <span>new</span> <span>TestableTimeConstrainedProcess</span><span>(</span>
        <span>TENANT_ID</span><span>,</span>
        <span>ProcessId</span><span>.</span><span>newProcessId</span><span>(),</span>
        <span>"Testable Time Constrained Process"</span><span>,</span>
        <span>5000L</span><span>);</span> <span>// 재시도 없이 5초 내로 완료되야 한다.</span>

<span>TimeConstrainedProcessTracker</span> <span>tracker</span> <span>=</span> 
        <span>process</span><span>.</span><span>timeConstrainedProcessTracker</span><span>();</span>
    
<span>process</span><span>.</span><span>confirm1</span><span>();</span>

<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>isCompleted</span><span>());</span>
<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>didProcessingComplete</span><span>());</span>
<span>assertEquals</span><span>(</span><span>process</span><span>.</span><span>processCompletionType</span><span>(),</span> <span>ProcessCompletionType</span><span>.</span><span>NotCompleted</span><span>);</span>

<span>process</span><span>.</span><span>confirm2</span><span>();</span>

<span>assertTrue</span><span>(</span><span>process</span><span>.</span><span>isCompleted</span><span>());</span>
<span>assertTrue</span><span>(</span><span>process</span><span>.</span><span>didProcessingComplete</span><span>());</span>
<span>assertEquals</span><span>(</span><span>process</span><span>.</span><span>processCompletionType</span><span>(),</span> <span>ProcessCompletionType</span><span>.</span><span>CompletedNormally</span><span>);</span>
<span>assertNull</span><span>(</span><span>process</span><span>.</span><span>timedOutDate</span><span>());</span>

<span>tracker</span><span>.</span><span>informProcessTimedOut</span><span>();</span>    <span>// 어짜피 이미 완료되어 있으므로 아무처리가 없을 것</span>
<span>assertFalse</span><span>(</span><span>process</span><span>.</span><span>isTimedOut</span><span>());</span>  <span>// 즉 타임아웃 되지 않았으므로 언제나 false</span>
</pre></div></div>

<ul>
  <li>
TestableTimeConstrainedProcess는 재시도 없이 5초 내로 완료되야 한다.</li>
  <li>
confirm1(), confirm2()만 호출된다면 완전히 완료 상태로 표시된다.
    <ul>
      <li>내부적으로 2가지 상태를 속성으로 지니고 있다.</li>
      <li>즉, confirm1, confirm2 둘 다 true 여야지 완료 상태</li>
    </ul>
  </li>
</ul>

메시징이나 시스템을 활용할 수 없을 때

<ul>
  <li>
<strong>고가용성 확보</strong>가 최선이다.</li>
  <li>메시징인프라가 죽었다가 다시 살아났을때 <em>자동으로 리스너가 재활성화</em> 될 수록 해야한다.</li>
</ul>

마무리

<ul>
  <li>분산 컴퓨팅에서의 통합</li>
  <li>RESTful VS 메시징인프라</li>
  <li>장기 수행 프로세스
    <ul>
      <li>Retry와 타임아웃</li>
      <li><strong>멱등성</strong></li>
      <li>복잡한 상태를 해결해주는 <em>상태 머신</em>
</li>
    </ul>
  </li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuY5o8sPLUqcwUlwpl5XNl7Ye1WW5seiWfrTpztkwbflw-3D-3DaTnf_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvs1IPwSYly7DOdls8ZwW-2BNwqQNDKH4Ofckm8f3ETffEP82SE0GZE9oploxbK7PPgW5UcKPpfj5lv3LdC-2BTt0NOr2ivQOInJC3L2ZVPAB8Zbp6BeFCkzYWXwrwOQizYMSJ0Jqd5cz3Zwd30BeMOZtNxCvStkUlTcpReN9lSUOXzik">IDDD 13장. 바운디드 컨텍스트 통합</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUwXEq_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuNwQPuy17A47h4566AyxWXOwHFnGuK5DxeJvABBoRqvmreKUgdKoC1UUUBUQ9uKcKpEIDWHU6pjCwigWsxMzgiAvZeM-2FISnwnU6bRNblMdREm4Ocohi8KIcxNZsInF2jcJbbZxWk7IBkxwvYSPC02TaJjQONC9iqI-2FL0uALXqHQJ57zK-2FkxHHi4Sj3gX1auUpo8KAeTDbYBVQ-2BX5s4NIsM">DevOOOOOOOOP</a> on June 16, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMPHUrvqy27s2W1GPFoCCYCenxBUWgk5LhrGB1Q9ISF0rb72mc-2BCHAj2CX9WHXObUhlt278zi0PAiaGDnhABd7LxbH8oG3D3pJ00agVFBacz9lYIPJXSrXxNHHMCh4yCq5scS2rZSpePBJnX7BZ0HPBvdY8mJZDvQ8ejWWIIilf-2FnNl-2FypA2Es08INq1m0QSOuu4fGeAaFRvGouMQojSrdJ" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 12장. 리파지토리</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003905.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3905</id>

    <published>2020-05-10T16:25:24Z</published>
    <updated>2020-05-10T16:25:24Z</updated>

    <summary> 전역(global) 액세스가 필요한 각 객체의 타입이다, 해당 타입의 모든 객체가 담긴 인메모리 컬렉션이란 허상을 제공하는 객체를 생성하자. 잘 알려진 전역의 인터페이스를 통한 액세스를 설정하자. 객체를 추가하거나 제거하는 메소드를 제공하자… 일정 조건에 부합되는 특성을 갖는 객체를 선택해 완전히 인스턴스화된 객체나...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <blockquote>
  <p>전역(global) 액세스가 필요한 각 객체의 타입이다, 해당 타입의 모든 객체가 담긴 인메모리 컬렉션이란 허상을 제공하는 객체를 생성하자.
잘 알려진 전역의 인터페이스를 통한 액세스를 설정하자.
객체를 추가하거나 제거하는 메소드를 제공하자…
일정 조건에 부합되는 특성을 갖는 객체를 선택해 완전히 인스턴스화된 객체나 여러 객체의 컬렉션으로 반환하는 메소드를 제공하자…
애그리게잇에 대해서만 리파지토리를 제공하자.. [Evans]</p>
</blockquote>

<p>애그리게잇 : 리파지토리 = 1(..N):1</p>

컬렉션 지향 리파지토리

<div><div><pre><span>package</span> <span>java</span><span>.</span><span>util</span><span>;</span>

<span>public</span> <span>interface</span> <span>Collection</span> <span>{</span>
    <span>public</span> <span>boolean</span> <span>add</span><span>(</span><span>Object</span> <span>o</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>addAll</span><span>(</span><span>Collection</span> <span>c</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>remove</span><span>(</span><span>Object</span> <span>o</span><span>);</span>
    <span>public</span> <span>boolean</span> <span>removeAll</span><span>(</span><span>Collection</span> <span>c</span><span>);</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>같은 인스턴스를 두번 추가되도록 허용해서는 안된다.</li>
  <li>
<em>재저장</em>을 할 필요가 없다.
    <ul>
      <li>그저 객체의 상태를 변경시키면 자동으로 저장될 뿐이다.</li>
    </ul>
  </li>
  <li>결국 Set처럼 행동해야 한다.</li>
</ul>

<p><em>재저장</em>할 필요가 없다면 객체의 상태를 추적해야한다.</p>

<p><em>영속성 매커니즘의 암시적 변경 추적 기법</em></p>

<ul>
  <li>암시적 읽기 시 복사(Copy-on-Read) : 읽을 때 복사본을 만들어 두고 복사본과 비교해서 변경된 것이 있으면 Commit 시킨다.</li>
  <li>암시적 쓰기 시 복사(Copy-on-Write) : 프록시로 감싸두고 Dirty(상태 변경이 되면)인 경우 Commit 시킨다.</li>
</ul>

하이버네이트 구현

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>calendar</span><span>;</span>    <span>//!!</span>

<span>interface</span> <span>CalendarEntryRepository</span> <span>{</span>
    <span>void</span> <span>add</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>);</span>
    <span>void</span> <span>addAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>);</span>
    <span>void</span> <span>remove</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>);</span>
    <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>);</span>

    <span>CalendarEntry</span> <span>calendarEntryOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarEntriyId</span> <span>id</span><span>);</span>
    <span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntriesOfCalendar</span><span>(</span>
        <span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarId</span> <span>calendarId</span><span>);</span>
    <span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>overlappingCalendarEntries</span><span>(</span>
        <span>Tenant</span> <span>tenant</span><span>,</span> <span>CalendarId</span> <span>calendarId</span><span>,</span> <span>TimeSpan</span> <span>timeSpan</span><span>);</span>

    <span>CalendarEntryId</span> <span>nextIdentity</span><span>();</span>
<span>}</span>
</pre></div></div>
<ul>
  <li>
package는 도메인 모델과 함께한다.</li>
  <li>물리적 삭제 VS <strong>논리적 삭제</strong>
</li>
</ul>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>public</span> <span>class</span> <span>HibernateCalendarEntryRepository</span> 
        <span>implements</span> <span>CalendarEntryRepository</span> <span>{</span>
    
    <span>private</span> <span>final</span> <span>SpringHibernateSessionProvider</span> <span>sessionProvider</span><span>;</span>

    <span>public</span> <span>HibernateCalendarEntryRepository</span><span>(</span>
            <span>SpringHibernateSessionProvider</span> <span>sessionProvider</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>sessionProvider</span> <span>=</span> <span>sessionProvider</span><span>;</span>
    <span>}</span>

    <span>private</span> <span>org</span><span>.</span><span>hibernate</span><span>.</span><span>Session</span> <span>session</span><span>()</span> <span>{</span>
        <span>return</span> <span>this</span><span>.</span><span>sessionProvider</span><span>.</span><span>session</span><span>();</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>add</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>saveOrUpdate</span><span>(</span><span>calendarEntry</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>addAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>CalendarEntry</span> <span>each</span> <span>:</span> <span>calendarEntries</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>session</span><span>().</span><span>saveOrUpdate</span><span>(</span><span>each</span><span>);</span>
        <span>}</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>remove</span><span>(</span><span>CalendarEntry</span> <span>calendarEntry</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>delete</span><span>(</span><span>calendarEntry</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>CalendarEntry</span><span>&gt;</span> <span>calendarEntries</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>CalendarEntry</span> <span>each</span> <span>:</span> <span>calendarEntries</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>session</span><span>().</span><span>delete</span><span>(</span><span>each</span><span>);</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>package : infrastructure.persistence
</li>
  <li>
Set과 유사한 행위 제공</li>
  <li>
Cascade를 통한 연관된 엔터티를 같이 변경하는 기능도 있음</li>
  <li>복잡한 조회의 경우 HQL을 이용
    <ul>
      <li>하지만 JPA를 사용한다면 JPQL을 사용하나, 현재까지는 querydsl 과 같은 기술이 좋은 것 같다.</li>
    </ul>
  </li>
</ul>

탑링크 구현에 대한 고려

<p>탑링크는 명시적으로 <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3jvomhKARsqEFt5OzuMEla3OxFq7N8A2S9XgKdEV6E3vgwYgi4nZFLPZR0EX6t7X2A-3D-3DwMW5_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMrFCtRE0iiXICK85SGiKLO3e-2BizR1hG7yPdCCPJxvqRzA9LXigtOhL5iC0INcvtl0I-2BwhFkZLPx93KoArmnh0ycfUhuN-2FCTmHx9tvIXRZGj73o1Owu0kNsAw49pu8pt0-2FSJ-2FGDym59Qb7s9gAO19hAp8gaHn2eEHJu-2F44M1GCEqv">작업단위(Unit of work)</a>를 지정할 수 있다.</p>

<ul>
  <li>일종의 트랜잭션의 범위를 추상화 시킨 것</li>
</ul>

<div><div><pre><span>Calendar</span> <span>calendar</span> <span>=</span> <span>session</span><span>.</span><span>readObject</span><span>(...);</span>
<span>UnitOfWork</span> <span>work</span> <span>=</span> <span>session</span><span>.</span><span>acquireUnitOfWork</span><span>();</span>
<span>Calendar</span> <span>calendarToRename</span> <span>=</span> <span>work</span><span>.</span><span>registerObject</span><span>(</span><span>calendar</span><span>);</span>
<span>calendarToRename</span><span>.</span><span>rename</span><span>(</span><span>"CollabOvation Project Calendar"</span><span>);</span>
<span>work</span><span>.</span><span>commit</span><span>();</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>public</span> <span>class</span> <span>ToplinkCalendarEntryRepository</span> 
        <span>implements</span> <span>CalendarEntryRepository</span> <span>{</span>
    <span>@Override</span>
    <span>public</span> <span>void</span> <span>add</span><span>(</span><span>Calendar</span> <span>calendar</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>unitOfWork</span><span>().</span><span>registerNewObject</span><span>(</span><span>calendar</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>editingCopy</span><span>(</span><span>Calendar</span> <span>calendar</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Calendar</span><span>)</span> <span>this</span><span>.</span><span>unitOfWork</span><span>().</span><span>registerObject</span><span>(</span><span>calendar</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

영속성 지향의 리파지토리

<ul>
  <li>컬렉션 지향 리파지토리 : Set
</li>
  <li>영속성 지향 리파지토리 : HashMap
    <ul>
      <li>하지만 꼭 put를 해야한다. - 원자적 쓰기를 통제할 수 없음(트랜잭션 없음)</li>
    </ul>
  </li>
</ul>

<p>No-Sql 종류가 많다.</p>

<ul>
  <li>잼파이어</li>
  <li>코히어런스</li>
  <li>몽고DB</li>
  <li>리악</li>
</ul>

코히어런스 구현

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>product</span><span>;</span>

<span>interface</span> <span>ProductRepository</span> <span>{</span>
    <span>ProductId</span> <span>nextIdentity</span><span>();</span>
    <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span><span>Tenant</span> <span>tenant</span><span>);</span>
    <span>Product</span> <span>productOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>ProductId</span> <span>productId</span><span>);</span>
    <span>void</span> <span>remove</span><span>(</span><span>Product</span> <span>product</span><span>);</span>
    <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>);</span>
    <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>);</span>
    <span>void</span> <span>saveAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>);</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>infrastructure</span><span>.</span><span>persistence</span><span>;</span>

<span>class</span> <span>CoherenceProductRepository</span> 
        <span>implements</span> <span>ProductRepository</span> <span>{</span>
    <span>private</span> <span>Map</span><span>&lt;</span><span>Tenant</span><span>,</span> <span>NamedCache</span><span>&gt;</span> <span>caches</span><span>;</span>

    <span>public</span> <span>CoherenceProductRepository</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>caches</span> <span>=</span> <span>new</span> <span>HashMap</span><span>&lt;&gt;();</span>
    <span>}</span>

    <span>private</span> <span>synchronized</span> <span>NamedCache</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>NamedCache</span> <span>cache</span> <span>=</span> <span>this</span><span>.</span><span>caches</span><span>.</span><span>get</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>cache</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
            <span>// ageilepm:Product:TenantId</span>
            <span>// 1단계 : 2단계 : 3단계</span>
            <span>cache</span> <span>=</span> <span>CacheFactory</span><span>.</span><span>getCache</span><span>(</span>
                <span>"agilepm.Product."</span> <span>+</span> <span>tenantId</span><span>.</span><span>id</span><span>(),</span>
                <span>Product</span><span>.</span><span>class</span><span>.</span><span>getClassLoader</span><span>());</span>
            <span>this</span><span>.</span><span>caches</span><span>.</span><span>put</span><span>(</span><span>tenantId</span><span>,</span> <span>cache</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>cache</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>())</span>
            <span>.</span><span>put</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>),</span> <span>product</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>saveAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>)</span> <span>{</span>
        <span>Map</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;</span> <span>productsMap</span> <span>=</span> 
            <span>new</span> <span>HashMap</span><span>&lt;&gt;(</span><span>products</span><span>.</span><span>size</span><span>());</span>
        <span>for</span> <span>(</span><span>Product</span> <span>each</span> <span>:</span> <span>products</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>tenantId</span> <span>==</span> <span>null</span><span>)</span> <span>{</span>
                <span>tenantId</span> <span>=</span> <span>product</span><span>.</span><span>tenantId</span><span>();</span>
            <span>}</span>
            <span>productsMap</span><span>.</span><span>put</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>),</span> <span>each</span><span>);</span>
        <span>}</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenantId</span><span>).</span><span>putAll</span><span>(</span><span>productsMap</span><span>);</span>
    <span>}</span>

    <span>private</span> <span>String</span> <span>idOf</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>return</span> <span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>.</span><span>productId</span><span>());</span>
    <span>}</span>
    <span>private</span> <span>String</span> <span>idOf</span><span>(</span><span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>return</span> <span>productId</span><span>.</span><span>id</span><span>();</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>remove</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>cache</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>()).</span><span>remove</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>product</span><span>));</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>removeAll</span><span>(</span><span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span><span>)</span> <span>{</span>
        <span>for</span> <span>(</span><span>Product</span> <span>each</span> <span>:</span> <span>products</span><span>)</span> <span>{</span>
            <span>this</span><span>.</span><span>remove</span><span>(</span><span>product</span><span>);</span>
        <span>}</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span><span>Tenant</span> <span>tenant</span><span>)</span> <span>{</span>
        <span>Set</span><span>&lt;</span><span>Map</span><span>.</span><span>Entry</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;&gt;</span> <span>entries</span> <span>=</span> 
            <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenant</span><span>).</span><span>entrySet</span><span>();</span>
        <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span> <span>=</span> 
            <span>new</span> <span>HashSet</span><span>&lt;</span><span>Product</span><span>&gt;(</span><span>entries</span><span>.</span><span>size</span><span>());</span>
        <span>for</span> <span>(</span><span>Map</span><span>.</span><span>Entry</span><span>&lt;</span><span>String</span><span>,</span> <span>Product</span><span>&gt;</span> <span>entry</span> <span>:</span> <span>entries</span><span>)</span> <span>{</span>
            <span>products</span><span>.</span><span>add</span><span>(</span><span>entry</span><span>.</span><span>getValue</span><span>());</span>
        <span>}</span>
        <span>return</span> <span>products</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Product</span> <span>productOfId</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Product</span><span>)</span> <span>this</span><span>.</span><span>cache</span><span>(</span><span>tenant</span><span>).</span><span>get</span><span>(</span><span>this</span><span>.</span><span>idOf</span><span>(</span><span>productId</span><span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

몽고DB 구현

<ol>
  <li>애그리게잇을 -&gt; 몽고DB포맷(직렬화), 몽고DB포맷 -&gt; 애그리게잇(역직렬화)</li>
  <li>몽고DB 문서의 고유 식별자(_id)</li>
  <li>몽고DB 노드/클러스터 참조</li>
</ol>

<div><div><pre><span>class</span> <span>MongoProductRepository</span> 
        <span>extends</span> <span>MongoRepository</span><span>&lt;</span><span>Product</span><span>&gt;</span>
        <span>implements</span> <span>ProductRepository</span> <span>{</span>
    
    <span>public</span> <span>MongoProductRepository</span><span>()</span> <span>{</span>
        <span>super</span><span>();</span>
        <span>this</span><span>.</span><span>serializer</span><span>(</span><span>new</span> <span>BSONSerializer</span><span>&lt;</span><span>Product</span><span>&gt;(</span><span>Product</span><span>.</span><span>class</span><span>));</span>
    <span>}</span>

    <span>public</span> <span>ProductId</span> <span>nextIdentity</span><span>()</span> <span>{</span>
        <span>// 몽고DB에서 제공하는 식별자. _id 필드에 매핑시킬수 있음</span>
        <span>return</span> <span>new</span> <span>ProductId</span><span>(</span><span>new</span> <span>ObjectId</span><span>().</span><span>toString</span><span>());</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>save</span><span>(</span><span>Product</span> <span>product</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>product</span><span>.</span><span>tenantId</span><span>()))</span>
            <span>.</span><span>save</span><span>(</span><span>this</span><span>.</span><span>serialize</span><span>(</span><span>product</span><span>));</span>
    <span>}</span>

    <span>protected</span> <span>String</span> <span>collectionName</span><span>(</span><span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>return</span> <span>"product"</span> <span>+</span> <span>tenantId</span><span>.</span><span>id</span><span>();</span>
    <span>}</span>

    <span>protected</span> <span>String</span> <span>databaseName</span><span>()</span> <span>{</span>
        <span>return</span> <span>"agilepm"</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>allProductsOfTenant</span><span>(</span>
            <span>TenantId</span> <span>tenantId</span><span>)</span> <span>{</span>
        <span>Collection</span><span>&lt;</span><span>Product</span><span>&gt;</span> <span>products</span> <span>=</span> <span>new</span> <span>ArrayList</span><span>&lt;&gt;();</span>
        <span>DBCursor</span> <span>cursor</span> <span>=</span> 
            <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>databaseName</span><span>(),</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>tenantId</span><span>)).</span><span>find</span><span>();</span>
        <span>while</span> <span>(</span><span>curosr</span><span>.</span><span>hasNext</span><span>())</span> <span>{</span>
            <span>DBObject</span> <span>dbObject</span> <span>=</span> <span>cursor</span><span>.</span><span>next</span><span>();</span>
            <span>Product</span> <span>product</span> <span>=</span> <span>this</span><span>.</span><span>deserialize</span><span>(</span><span>dbObject</span><span>);</span>
            <span>products</span><span>.</span><span>add</span><span>(</span><span>product</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>products</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Product</span> <span>productOfId</span><span>(</span>
            <span>TenantId</span> <span>tenantId</span><span>,</span> <span>ProductId</span> <span>productId</span><span>)</span> <span>{</span>
        <span>Product</span> <span>product</span> <span>=</span> <span>null</span><span>;</span>
        <span>BasicDBObject</span> <span>query</span> <span>=</span> <span>new</span> <span>BasicDBObject</span><span>();</span>
        <span>query</span><span>.</span><span>put</span><span>(</span><span>"producetId"</span><span>,</span> 
            <span>new</span> <span>BasicDBObject</span><span>(</span><span>"id"</span><span>,</span> <span>productId</span><span>.</span><span>id</span><span>()));</span>
        <span>DBCursor</span> <span>cursor</span> <span>=</span> 
            <span>this</span><span>.</span><span>databaseCollection</span><span>(</span>
                <span>this</span><span>.</span><span>databaseName</span><span>(),</span>
                <span>this</span><span>.</span><span>collectionName</span><span>(</span><span>tenantId</span><span>)).</span><span>find</span><span>(</span><span>query</span><span>);</span>
        <span>if</span> <span>(</span><span>cursor</span><span>.</span><span>hasNext</span><span>())</span> <span>{</span>
            <span>product</span> <span>=</span> <span>this</span><span>.</span><span>deserialize</span><span>(</span><span>cursor</span><span>.</span><span>next</span><span>());</span>
        <span>}</span>
        <span>return</span> <span>product</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>BSONSerializer</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>{</span>
    <span>DBObject</span> <span>serialize</span><span>(</span><span>String</span> <span>key</span><span>,</span> <span>T</span> <span>object</span><span>)</span> <span>{</span>
        <span>DBObject</span> <span>serialization</span> <span>=</span> <span>this</span><span>.</span><span>serialize</span><span>(</span><span>object</span><span>);</span>
        <span>serialization</span><span>.</span><span>put</span><span>(</span><span>"_id"</span><span>,</span> <span>new</span> <span>ObjectId</span><span>(</span><span>key</span><span>));</span>
        <span>return</span> <span>serialization</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>abstract</span> <span>class</span> <span>MongoRepository</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>{</span>

    <span>protected</span> <span>DBCollection</span> <span>databaseCollection</span><span>(</span>
            <span>String</span> <span>databaseName</span><span>,</span> <span>String</span> <span>collectionName</span><span>)</span> <span>{</span>
        <span>return</span> <span>MongoDatabaseProvider</span>
                <span>.</span><span>database</span><span>(</span><span>databaseName</span><span>)</span>
                <span>.</span><span>getCollection</span><span>(</span><span>collectionName</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
BSONSerializer 때문에 Setter를 제공할 필요가 없음</li>
</ul>

추가적인 행동

<ul>
  <li>예를 들면 count() or size()
</li>
  <li>또는 리파지토리에서 애그리게잇 파트를 쿼리하는 것 (성능상 잇점)
    <ul>
      <li>하지만 이건 안티패턴이기 때문에 가능한 사용하지 않는 것이 좋다 (애그리게잇 법칙 위배)</li>
      <li>만약 그게 당연시 하다고 느껴지면 애그리게잇을 분리하는 것도 한 방법</li>
    </ul>
  </li>
  <li>일반적으로 도메인 서비스 제어하가 어울린다.</li>
</ul>

<p>하지만 너무 유스케이스에 최적화된 조회 메서드를 많이 제공한다면 악취일 수도 있다</p>

<ul>
  <li>그런 경우 <strong>CQRS</strong>를 고려해보자</li>
</ul>

트랜잭션의 관리

<p>트랜잭션 관리는 애플리케이션 계층의 책임이다. = 애플리케이션 서비스</p>

<p><em>트랜잭션 관리 방법</em></p>

<div><div><pre><span>class</span> <span>ApplicationServiceFacade</span> <span>{</span>
    <span>// 명식적인 트랜잭션</span>
    <span>public</span> <span>void</span> <span>doSomeUseCaseTask1</span><span>()</span> <span>{</span>
        <span>Transaction</span> <span>transaction</span> <span>=</span> <span>null</span><span>;</span>
        <span>try</span> <span>{</span>
            <span>transaction</span> <span>=</span> <span>this</span><span>.</span><span>session</span><span>().</span><span>beginTransaction</span><span>();</span>
            <span>// 도메인 모델을 사용한다.</span>
            <span>transaction</span><span>.</span><span>commit</span><span>();</span>
        <span>}</span> <span>catch</span> <span>(</span><span>Exception</span> <span>e</span><span>)</span> <span>{</span>
            <span>if</span> <span>(</span><span>transaction</span> <span>!</span> <span>null</span><span>)</span> <span>{</span>
                <span>transaction</span><span>.</span><span>rollback</span><span>();</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>

    <span>// 선언적인 트랜잭션</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>doSomeUseCaseTask2</span><span>()</span> <span>{</span>
        <span>// 도메인 모델을 사용한다.</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>선언적인 방식이 더 낫다. 순수하게 도메인 로직에 위임하는 것에 집중할 수 있다.
    <ul>
      <li>관심사 분리!!</li>
    </ul>
  </li>
</ul>

경고

<p>단일 트랜잭션에서 여러 애그리게잇을 수정을 커밋하는 기능을 과도하게 사용하지 않도록 주의하라.</p>

타입 계층구조

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWXEBIhBJ4uDACeloqn9BLAevb9GAAaiIEMgXIe8JonAoab5LvPQKPAQbuAX7QOdFo-RU3qEG56WWm00" alt="Type Hierarchy"></p>

<div><div><pre><span>// 도메인 모델의 클라이언트</span>
<span>serviceProviderRepository</span><span>.</span><span>providerOf</span><span>(</span><span>id</span><span>)</span>
        <span>.</span><span>scheduleService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
</pre></div></div>

<ul>
  <li>상위 타입(ServiceProvider)으로 처리</li>
</ul>

<div><div><pre><span>// 도메인 모델의 클라이언트</span>
<span>if</span> <span>(</span><span>id</span><span>.</span><span>identifiesWarble</span><span>())</span> <span>{</span>
    <span>serviceProviderRepository</span><span>.</span><span>warbleOf</span><span>(</span><span>id</span><span>)</span>
            <span>.</span><span>scheduleWarbleService</span><span>(</span><span>date</span><span>,</span> <span>warbleDescription</span><span>);</span>
<span>}</span> <span>else</span> <span>if</span> <span>(</span><span>id</span><span>.</span><span>identifiesWonkle</span><span>())</span> <span>{</span>
    <span>serviceProviderRepository</span><span>.</span><span>wonkleOf</span><span>(</span><span>id</span><span>)</span>
            <span>.</span><span>scheduleWonkleService</span><span>(</span><span>date</span><span>,</span> <span>wonkleDescription</span><span>);</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>하위 타입을 클라이언트에서 알고 분기 처리 해야하는 책임이 늘어난다.</li>
  <li>위 코드는 전형적인 악취이다.</li>
</ul>

<p><strong>그러므로 상위타입은 하위타입에 대한 구분정보(type 속성)를 알고 있어야 한다.</strong></p>

<ul>
  <li>그렇게 된다면 Repository 계층에서 캡슐화 시켜서 하위 타입 별 분기 처리를 할 수 있을 것이다.</li>
</ul>

<div><div><pre><span>@Entity</span>
<span>class</span> <span>ServiceProvider</span> <span>{</span>
    <span>...</span>
    <span>private</span> <span>ServiceType</span> <span>type</span><span>;</span>

    <span>public</span> <span>void</span> <span>scheduleService</span><span>(</span><span>Date</span> <span>date</span><span>,</span> <span>ServiceDescription</span> <span>description</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>type</span><span>.</span><span>isWarble</span><span>())</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleWarbleSevice</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>type</span><span>.</span><span>isWonkle</span><span>())</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleWonkleService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span> <span>else</span> <span>{</span>
            <span>this</span><span>.</span><span>scheduleCommonService</span><span>(</span><span>date</span><span>,</span> <span>description</span><span>);</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>나라면 위의 경우에서도 ServiceType으로 위임해서 if문을 제거했을 것 같다.</li>
</ul>

리파지토리 대 데이터 액세스 객체

<p>Repository != DAO</p>

<ul>
  <li>리파지토리 : 객체 지향 &gt; with 도메인 모델 패턴</li>
  <li>DAO : 데이터 지향 &gt; with 트랜잭션 스크립트 패턴</li>
</ul>

<p>SMART DAO는 DDD 입장에서는 안티패턴</p>

<ul>
  <li>SMART DAO는 도메인 로직이 DB 쿼리나 DB의 프로시저에 존재하는 경우를 말함</li>
</ul>

<p><strong>중요한 것은 데이터 액세스 지향보다는 컬렉션 지향으로 설계하려고 노력해야하는 점</strong></p>

리파지토리의 테스트

<ul>
  <li>실제 인프라와 연동하는 테스트 (실제 DB와 통신)</li>
  <li>인메모리로 연동하는 테스트</li>
</ul>

<blockquote>
  <p>개인적으로 실제 인프라와 연동하는 것이 중요하다고 봄.</p>
</blockquote>

인메모리 구현으로 테스트하기

<p>Skip</p>

마무리

<ul>
  <li>컬랙션 지향 VS 영속성 지향</li>
  <li>리파지토리의 추가적인 행동 (count())</li>
  <li>트랜잭션 처리</li>
  <li>타입 계층과 리파지토리</li>
  <li>Repository vs DAO</li>
  <li>테스트</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtzOkwB8cVmXGClSUdbrej3V-2F8tyT8YzlsGR48HkVBDGQ-3D-3DUStA_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMiHjV-2Bfh4Ii1zv3np3sSiJzi8zN3GKN3pg-2FT4p01-2F3WSZeNHq8xjKgLqCtmZkV795eKX0Pem6ISKZ0UIQa4cBl6GzoQAoK8hue3qgtJLzpOPklGiFMo3a-2BXLbKcQPxAQWwH66a0PS0IQULKMADJaOP4nEt7I3Z6cy42OlUFS2AMt">IDDD 12장. 리파지토리</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUmGGG_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXvwW4pdWHXONtD5tHoCXDUmj1qJCikhDwd8NNdKKxbaMiKlCIsncf6KjasP2SJrGbmVrSv2C-2B3pShsA98Cm-2Bo-2FpZxF3iCA0fCJfD-2Fa-2B-2BADKlcfKqPn3ehIwi6kfm8UYQgyLyJFwo-2BFXBG-2FnuJ6ERbElONGT-2BnDBDMXXTzccFnlk11V0JKuwjDYpyzFjL-2BGgq-2F5FYJDTWRWvWDPy9bOoWcCs">DevOOOOOOOOP</a> on June 10, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMPh1EwBFJtaMpKlkf5Qk9n1hTYSIrEZy321pHofeJ-2F9wq0-2BxstCKFfJqwwiWyKAcSIr9KzqcKwn-2F0RwshFaorWVNHJ4PnJrATMFJ-2BTpxGxSFqo6PFqWmoMjgqg59RWGVrGhRN81G-2FzKQlVmSILJn3atshNAEOwrb3TmOf3h7B3xt71tD2Pb3lAgCH7DvBBjgZ8R1ircHmyxMuD7JU-2F51lF8" alt="" width="1" height="1" />

]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 11장. 팩토리</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003904.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3904</id>

    <published>2020-05-10T16:25:23Z</published>
    <updated>2020-05-10T16:25:23Z</updated>

    <summary> 애그리게잇을 생성하는 책임을 가지는 메소드나 객체를 말한다. 애그리게잇 생성을 캡슐화 도메인 모델 내의 팩토리 복잡한 객체와 애그리게잇 인스턴스를 생성하는 책임을 별도의 객체로 이동시키자. 여기서의 책임은 도메인 모델과 관련이 있지 않지만, 여전히 도메인 설계를 구성하는 한 요소다. 모든 복잡한 조립...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p>애그리게잇을 생성하는 책임을 가지는 메소드나 객체를 말한다.</p>

<ul>
  <li>애그리게잇 생성을 캡슐화</li>
</ul>

도메인 모델 내의 팩토리

<blockquote>
  <p>복잡한 객체와 애그리게잇 인스턴스를 생성하는 책임을 별도의 객체로 이동시키자. 여기서의 책임은 도메인 모델과 관련이 있지 않지만, 여전히 <em>도메인 설계를 구성하는 한 요소</em>다. 모든 복잡한 조립 과정을 캡슐화하고, 클라이언트가 인스턴스화된 객체의 구체적 클래스를 참조할 필요가 없도록 인터페이스를 제공하자. 전체 애그리게잇을 하나의 조각(원자성)으로 생성하고 고정자(Invariant)를 지정하자 [Evans]</p>
</blockquote>

<ul>
  <li>팩토리 메소드 : 이 책은 주로 여기만 나옴</li>
  <li>팩토리 객체(클래스)
    <ul>
      <li>애그리게잇 생성이 매우 복잡하고 다른 객체의 도움이 필요하면 클래스 분리를 하는 것이 좋은 것 같다.</li>
    </ul>
  </li>
</ul>

<p><em>가능한 팩토리 위치</em></p>

<ul>
  <li>애그리게잇 루트
    <ul>
      <li>정정 생성자를 통해서 도메인 의도가 나오면 더 좋다. static Task#forDraft()
</li>
      <li>아니면 상위 루트에서 하위 엔터리 생성도 가능 Project#createTask()
</li>
    </ul>
  </li>
  <li>도메인 서비스 : 서비스 기반 팩토리
    <ul>
      <li>ProjectService#createProject()</li>
    </ul>
  </li>
  <li>팩토리 : 이 책은 다루지 않음
    <ul>
      <li>ProjectFactory#create()</li>
    </ul>
  </li>
</ul>

애그리게잇 루트상의 팩토리 메소드

<table>
  
    <tr>
      <th>바운디드 컨텍스트</th>
      <th>애그리게잇</th>
      <th>팩토리 메소드</th>
    </tr>
  
  
    <tr>
      <td>식별자와 액세스 컨텍스트</td>
      <td>Tenant</td>
      <td>offerRegisterationInvitation()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>provisionGroup()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>provisionRole()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>registerUser()</td>
    </tr>
    <tr>
      <td>협업 컨텍스트</td>
      <td>Calendar</td>
      <td>scheduleCalendarEntry()</td>
    </tr>
    <tr>
      <td> </td>
      <td>Forun</td>
      <td>startDiscussion()</td>
    </tr>
    <tr>
      <td> </td>
      <td>Discussion</td>
      <td>post()</td>
    </tr>
    <tr>
      <td>애자일 PM 컨텍스트</td>
      <td>Product</td>
      <td>planBacklogItem()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>scheduleRelease()</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>scheduleSprint()</td>
    </tr>
  
</table>


CalendarEntry 인스턴스 생성하기

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Calendar</span> <span>extends</span> <span>AbstractAggregateRoot</span> <span>{</span>
    <span>CalendarEntry</span> <span>scheduleCalendarEntry</span><span>(...)</span> <span>{</span>
        <span>CalendarEntry</span> <span>calendarEntry</span> <span>=</span> <span>new</span> <span>CalendarEntry</span><span>(...);</span>
        <span>this</span><span>.</span><span>registerEvent</span><span>(</span><span>new</span> <span>CalendarEntryScheduled</span><span>(...));</span>
        <span>return</span> <span>calendarEntry</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>유비쿼터스 언어에 부합되는 도메인이 표현됨 : scheduleCalendarEntry
</li>
  <li>보호절이 없다 : 어짜피 new CalendarEntry(...)가 책임짐</li>
  <li>
Setter를 사용하지 않는다. &gt; <strong>원자성</strong> + <strong>부수효과 줄어듬</strong> + <strong>불변식 강제</strong>가 쉬움</li>
  <li>이벤트 발행 : CalendarEntryScheduled
</li>
  <li>인자의 갯수가 줄어든다.
    <ul>
      <li>
scheduleCalendarEntry(...)에서는 11개가 요구되지만, new CalendarEntryScheduled(...)에서는 9개로 줄어든다.</li>
      <li>개인적으로는 이것도 인자를 캡슐화 시켜서 객체로 말아버리는 것이 좋은 것 같다. 9개의 인자라도 너무 많은 것 같음.</li>
    </ul>
  </li>
</ul>

<p><strong>하지만</strong></p>

<ul>
  <li>
CalendarEntry를 생성하기 위해서는 꼭 <strong>Calendar 인스턴스</strong>가 요구됨
    <ul>
      <li>이는 DB 조회라는 부하가 추가됨</li>
    </ul>
  </li>
</ul>


Discussion 인스턴스 생성하기

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Forum</span> <span>extends</span> <span>AbstractAggregateRoot</span> <span>{</span>
    <span>Discussion</span> <span>startDiscussion</span><span>(</span>
        <span>DiscussionId</span> <span>discussionId</span><span>,</span>
        <span>Author</span> <span>author</span><span>,</span>
        <span>String</span> <span>subject</span><span>)</span> <span>{</span>

        <span>if</span> <span>(</span><span>this</span><span>.</span><span>isClosed</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>IllegalStateException</span><span>(</span><span>"Forum is closed"</span><span>);</span>
        <span>}</span>
        <span>Discussion</span> <span>discussion</span> <span>=</span> <span>new</span> <span>Discussion</span><span>(</span>
            <span>this</span><span>.</span><span>tenant</span><span>(),</span>
            <span>this</span><span>.</span><span>forumId</span><span>(),</span>
            <span>discussionId</span><span>,</span>
            <span>author</span><span>,</span>
            <span>subject</span><span>);</span>
        <span>registerEvent</span><span>(</span><span>new</span> <span>DiscussionStarted</span><span>(...));</span>
        <span>return</span> <span>discussion</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>포럼이 열린 경우에만 토론을 시작할 수 있다. : this.isClosed()
</li>
  <li>인자 5개 중 3개만 있으면 된다. : 나머지 2개는 포럼에서 제공</li>
  <li>역시나 유비쿼터스 언어가 표현된다. : startDiscussion
</li>
</ul>

서비스의 팩토리

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>collaborator</span><span>;</span>

<span>interface</span> <span>CollaboratorSerice</span> <span>{</span>
    <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Creator</span> <span>creatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Moderator</span> <span>moderatorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Owner</span> <span>ownerFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>

    <span>Participant</span> <span>participantFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>);</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>// infrastructure.services !!!</span>
<span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infrastructure</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>UserRoleToCollaborationService</span> <span>implements</span> <span>CollaboratorSerice</span> <span>{</span>
    <span>@Override</span>
    <span>public</span> <span>Author</span> <span>authorFrom</span><span>(</span><span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>)</span> <span>{</span>
        <span>return</span> <span>(</span><span>Author</span><span>)</span> <span>userInRoleAdapter</span><span>.</span><span>toCollaborator</span><span>(</span>
            <span>tenant</span><span>,</span> <span>identity</span><span>,</span> <span>"Author"</span><span>,</span> <span>Author</span><span>.</span><span>class</span><span>);</span>
        <span>)</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>collaborator</span><span>;</span>

<span>class</span> <span>Author</span> <span>extends</span> <span>Collaborator</span> <span>{</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>기술적 구현이므로 <em>인프라 계층</em>의 모듈에 위치한다.</li>
  <li>어댑터에 의존한다.
    <ul>
      <li>
UserInRoleAdapter는 외래 컨텍스트와 의사소통 책임만 갖는다.</li>
      <li>
CollaboratorTranslator는 바운디드 컨텍스트 내 도메인 객체로 변환 책임만 갖는다.</li>
    </ul>
  </li>
  <li>협업에서는 identity 식별자와 액세스에서는 username
</li>
</ul>

마무리

<ul>
  <li>유비쿼터스 언어로 애그리게잇을 생성</li>
  <li>애그리게잇의 팩토리 메서드 VS 서비스의 팩토리 메서드</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsVt-2B5Dea2ggRewqKW79z9vnuot2YEHShIKrraUDTSMOQ-3D-3Dvcqf_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXt-2BLgwZBVEvK18z-2BrcP4Hyzs-2FPLyY9B4293SCh8N2T9SB6-2FxsIBo-2BUchD90gsh4G41DtVjyRD80OiC-2F6GnPlWSKNhkyo2F8FCwqz3-2FW7xZhlY47GRFN3ImnuS2JBNT2ykiO9KUyXUzQVmEsyTpkvoUu-2FRQVB9QZbyLQ5R-2FycKGMzhGGilf-2BZ-2F-2BYzbk6koba8duP-2BpLQNzJY9ckntGxdOTTzZOajQd5HNF-2FRJoQIi8wf-2BA-3D-3D">IDDD 11장. 팩토리</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUoG8H_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXt-2BLgwZBVEvK18z-2BrcP4Hyzs-2FPLyY9B4293SCh8N2T9SEMjLDM2JWNxS5fggA5aPnk7PdvOMBdVomspJ6vkGmsdqCHZHF6DFhE8k3LC37Es4H1CVnIyVwaIcAQU-2FquWF9weSMeh1Dbx5ZHa3sHjRS-2BbqMft-2FGo-2BGv4njSCa7r4PecUMaUUzcXAJ2YOQ5NiYsW4N0sN-2FN7l3RPwtH6DRJnal8rAipt3fZeDPh5ZzoQISOA-3D-3D">DevOOOOOOOOP</a> on June 07, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMenKSVTuFvS50phTwwSPPYuXnVRIe9nTgDbRWrb2XmHm6XUKKY7dY19Ru5t49mpKJzmlyZUnfXeUq9s5caWVBkHDXBd5gLnT4bvFONyQCZa-2Fzjb5oVYWN0Hg0aQLpaK3X5y1dAV-2Fk95E83WPH-2FqcZXnLQ5ebj87INav2Xd9yXD1FR83Y5FHwSrd5CpRkKE4pSNJyRtXR2d85V8z-2FEbl33ACJAUPwsIX2JnQ8yWPMKy6w-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 10장. 애그리게잇</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003903.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3903</id>

    <published>2020-05-10T16:25:23Z</published>
    <updated>2020-05-10T16:25:23Z</updated>

    <summary> 일관성 경계 내에서 엔터티와 값 객체의 묶음 일관성 경계의 기준은 같은 트랜잭션인가로 검증된다. 애그리게잇 내의 불변식(invariant)? 스크럼 핵심 도메인에서 애그리게잇 사용하기 기능 목록 제품은 백로그 아이템과 릴리스, 스프린트를 포함한다. 새로운 제품 백로그 아이템을 계획했다. 새로운 제품 릴리스를 계획했다. 새로운...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p><strong>일관성 경계</strong> 내에서 엔터티와 값 객체의 묶음</p>

<ul>
  <li>
<strong>일관성 경계</strong>의 기준은 같은 트랜잭션인가로 검증된다.</li>
  <li>애그리게잇 내의 불변식(invariant)?</li>
</ul>

스크럼 핵심 도메인에서 애그리게잇 사용하기

<p><em>기능 목록</em></p>

<ul>
  <li>제품은 백로그 아이템과 릴리스, 스프린트를 포함한다.</li>
  <li>새로운 제품 백로그 아이템을 계획했다.</li>
  <li>새로운 제품 릴리스를 계획했다.</li>
  <li>새로운 제품 스프린트 일정을 수립했다.</li>
  <li>계획된 백로그 아이템에 관한 릴리스 일정을 수립할 수 있다.</li>
  <li>일정이 잡힌 백로그 아이템은 스프린트로 커밋할 수 있다.</li>
</ul>

첫 번째 시도: 큰 클러스터의 애그리게잇

<blockquote>
  <p>제품이 ~를 포함한다.</p>
</blockquote>

<p>컴포지션 VS 객체 그래프
포함 VS (상호) 연결</p>

<p><em>도메인 로직</em></p>

<ul>
  <li>백로그 항목을 스프린트로 커밋하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>스프린트가 백로그 항목을 커밋하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>릴리스가 백로그 항목의 일정을 수립하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
  <li>백로그 항목의 릴리스 일정을 수립하면, 이를 시스템에서 제거하도록 허용해선 안 된다.</li>
</ul>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>backlogItems</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>private</span> <span>ProductId</span> <span>productId</span><span>;</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>Release</span><span>&gt;</span> <span>releases</span><span>;</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>Spring</span><span>&gt;</span> <span>sprints</span><span>;</span>
    <span>private</span> <span>TenantId</span> <span>tenantId</span><span>;</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWWeoayfJIvHiB5nJ4ylIarCBqbL2ChFBx6pWofmIapEpibFzon9pGKgSiqhoIofX4i6fUQa9XQdOae45nHbvfKWYyCiKZ9KKj3IrRLJK3BGqzDIGZOVbngODRZaeRPnEQJcfG1z1W00" alt="아주 큰 애그리게잇으로 모델링된 Product"></p>

<p><em>아주 큰 애그리게잇으로 모델링된 Product</em></p>

<p><img src="http://www.plantuml.com/plantuml/svg/TOv12i8m54JtFKKka1kKKDrrfLHm_qs6Z_hJIF9pVmKjhK6tCu-PDnIbh3LAvuLACSUSGlLg-dx7d46iC5DAwjmtC8ONSYQfC8VB3Nu5zkJladXKn6M5gLsP8A22_y3faQ-p_keNG-jMbsvZPUrMeMa-lqtwFki6pA56UG80" alt="Product와는 별도의 애그리게잇 타입으로 모델린된 연관된 개념들"></p>

<p><em>Product와는 별도의 애그리게잇 타입으로 모델린된 연관된 개념들</em></p>

<p>큰 애그리게잇으로 모델링하다보면 변경에 취약해져서 업데이트 상황에서 버전 충돌이 발생할 가능성이 커진다. 위를 예시로 두면 한 명이 backlogItem을 변경하고 다른 한 명이 Spring를 변경할 시 직적접 연관이 없음에도 불구하고 버전 충돌이 발생해서 업데이트가 실패할 확률이 커진다. (애그리게잇의 크기가 커짐에 따라서 충돌 확률도 더 커짐)</p>

두 번째 시도: 다수의 애그리게잇

<p><em>하나의 큰 애그리게잇 상 Product.java</em></p>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>public</span> <span>void</span> <span>planBacklogItem</span><span>(</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span><span>,</span> <span>BacklogItemType</span> <span>type</span><span>,</span> <span>StoryPorints</span> <span>storyPoints</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>void</span> <span>scheduleRelease</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>description</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>void</span> <span>scheduleSprint</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>goals</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p><em>여러 개로 분리된 애그리게잇 상 Product.java</em></p>

<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>public</span> <span>BacklogItem</span> <span>planBacklogItem</span><span>(</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span><span>,</span> <span>BacklogItemType</span> <span>type</span><span>,</span> <span>StoryPorints</span> <span>storyPoints</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>Release</span> <span>scheduleRelease</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>description</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
    <span>public</span> <span>Sprint</span> <span>scheduleSprint</span><span>(</span>
        <span>String</span> <span>name</span><span>,</span> <span>String</span> <span>goals</span><span>,</span> <span>Date</span> <span>begins</span><span>,</span> <span>Date</span> <span>ends</span><span>)</span> <span>{</span>
        <span>...</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>일종의 factory 메서드로써 동작한다.</li>
</ul>

<p><em>Product</em><em>*Srvice 예시</em></p>

<div><div><pre><span>@Service</span>
<span>class</span> <span>ProductBacklogItemService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>planProductBacklogItem</span><span>(</span>
        <span>String</span> <span>tenantId</span><span>,</span> <span>String</span> <span>productId</span>
        <span>String</span> <span>summary</span><span>,</span> <span>String</span> <span>category</span>
        <span>String</span> <span>backlogItemType</span><span>,</span> <span>String</span> <span>storyPoints</span><span>)</span> <span>{</span>

        <span>Product</span> <span>product</span> <span>=</span> 
            <span>productRepository</span><span>.</span><span>producetOfId</span><span>(</span>
                <span>new</span> <span>TenantId</span><span>(</span><span>tenantId</span><span>),</span>
                <span>new</span> <span>ProductId</span><span>(</span><span>productId</span><span>));</span>
        <span>BacklogItem</span> <span>plannedBacklogItem</span> <span>=</span> 
            <span>product</span><span>.</span><span>planBacklogItem</span><span>(</span>
                <span>summary</span><span>,</span> <span>category</span><span>,</span>
                <span>BacklogItemType</span><span>.</span><span>valueOf</span><span>(</span><span>aBacklogItemType</span><span>),</span>
                <span>StoryPoints</span><span>.</span><span>valueOf</span><span>(</span><span>stroyPoints</span><span>));</span>
        <span>backlogItemRepository</span><span>.</span><span>add</span><span>(</span><span>plannedBacklogItem</span><span>);</span>
    <span>}</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p>이와 같이 우린 밖으로 빼서 모델링함으로써(Modeling it away) 트랜잭션 실패 문제를 해결했다. 이제 BacklogItem, Release, Sprint등의 인스턴스가 사용자의 요청에 따라 얼마든지 동시적으로 안전하게 생성될 수 있다.</p>

<p>그러나 큰 애그리게잇을 조금 다듬어서 동시성 문제를 해결할 수도 있을지도 모른다. 하이버네이트 매핑에서 optmistic-lock 옵셥을 false로 설정해 트랜잭션 실패가 도미노 처럼 전달되는 상황을 피할 수 있다.</p>

규칙: 진짜 고장자(invariant)를 일관성 경계 안에 모델링하라

<p><em>*중요한 것은 진짜 고정자를 이해하는 것이다.</em></p>

<p>고장자(invariant) : <strong>일관성(트랜잭션 일관성)을 유지해야만 한다는 비즈니스 규칙</strong></p>

<ul>
  <li>트랜잭션 일관성 : 동기적, 원자적</li>
  <li>결과적 일관성 : 비동기적</li>
</ul>

<p><strong>한 트랜잭션에 한 애그리게잇만 인스턴스만 포함</strong> : 이는 너무 가혹한 것 같다.</p>

규칙: 작은 애그리게잇으로 설계하라

<p><img src="http://www.plantuml.com/plantuml/svg/VP1DIiOm443tEKNeij3Y0KgfIXU2eFGJzsConDZyI39PzFQs4YNGq4qNynwTl9aYGQ1a3HC6OkIlmSiaY0_3lL81GH7onNiQnomyW5YDLq-4TfTcHvgsVxYWGOXu1hVle1sTvsyGruejFb4cWvUx7hsrcWZbfJL7qXP8U_VirSx2jZllO1Bobuyl54VONtFRTIDlxlg-RShCAi-bDPPZMV6B4lysi-DJJYiFPNb7gTLEm_9nIwrs73QXaycQ7m00" alt="큰 클러스터 `Product` 애그리게잇"></p>

<p><em>이 Product 모델에선 다양한 기본 오퍼레이션이 수행될 동안 큰 컬랙션을 여럿 가져오게 된다.</em></p>

<ul>
  <li>이 큰 클러스터 애그리게잇은 성능이나 확장성이 절대로 좋을 수 없다. 이는 실패로 이어지는 악몽이 될 뿐이다. 거짓 고정자와 컴포지션적 편의성이 설계를 주도했기 때문에 시작부터 문제가 있었으며, 트랜잭션의 종료, 성능, 확장성의 측면에서 안 좋은 영향을 미쳤다.</li>
</ul>

<p>작은 애그리게잇은? 다른 대상과 일관성을 유지</p>

<ul>
  <li>변경이 되면 엔터티</li>
  <li>대치가 되면 값 객체 : 생각보다 상당히 많은 개념이 값 객체로 대치된다.</li>
</ul>

<blockquote>
  <p>파생 금융상품 부문에서 약 70% 애그리게잇이 단 하나의 루트 엔터티로 구성된다.</p>
</blockquote>

<p><strong>작은 애그리게잇은</strong></p>

<ul>
  <li>성능이 좋음</li>
  <li>확장성이 좋음</li>
  <li>트랜잭션이 성공할 가능성이 크다</li>
</ul>

유스케이스를 전부 믿지는 말라

<ul>
  <li>하나의 유스케이스가 여러 트랜잭션을 발생 시킨다면 의심해 보자
    <ul>
      <li>
<strong>이런 경우에서 결과적 일관성을 통해서 문제를 해결할 수 있다.</strong> + 지연 업데이트</li>
    </ul>
  </li>
  <li>물론 하나의 유스케이스가 하나의 트랜잭션일 필요는 없다.</li>
</ul>

규칙: ID로 다른 애그리게잇을 참조하라

<p>객체 그래프가 연결되어 있다고 해서 같은 애그리게잇은 아니다. 그저 다른 애그리게잇을 연결했을 뿐이다.</p>

<p>여기도 결국 <strong>결과적 일관성</strong>으로 이어진다.</p>

애그리게잇 ID 참조를 통해 서로 함께 동작하도록 해보자

<p><img src="http://www.plantuml.com/plantuml/svg/dP11ImCn48Nl-HMXHw757r125VPG42ohU1ztXnYRp9JCH5Z4_su8MwijUl0qoNkF3zxRY4BMag8P8eZOMnZsaVrMCTdr-iRxZ1uKRS-ipjbtOwqeQ97su3mTxuu3QLDBIj1qdGveFcRm8yY-4ZlIeDDC6b6670uQcEhlXKkM7XC42kIhG92mdZUEXHGnVx5scSSow7Qim2U81UtzyoiEwjmSw34Y2FuUU3ZaG7y0Ej6GG0FJ7VkED4zdoNyt-3xmSkdiudgrkbgqUNvwxbJpt9ZhNHh7MgQjVQ9VrZ4RfB6a-0a0" alt="ID참조모델"></p>

<p><em>ID를 통해 경계 밖과 연결을 추론할 수 있는 BacklogItem 애그리게잇</em></p>

<div><div><pre><span>class</span> <span>BacklogItem</span> <span>{</span>
    <span>private</span> <span>ProductId</span> <span>productId</span><span>;</span>
<span>}</span>
</pre></div></div>

모델 탐색

<p>객체 그래프 탐색과는 다르지만 <em>리파지토르</em>와 <em>ID</em>가 있으면 연관 모델을 탐색할 수 있다. : <em>단전될 도메인 모델(Disconnected Domain Model)</em></p>

<div><div><pre><span>@Service</span>
<span>class</span> <span>ProductBacklogItemService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>void</span> <span>assignTeaMemberToTask</span><span>(</span>
        <span>String</span> <span>aTenantId</span><span>,</span>
        <span>String</span> <span>aBacklogItemId</span><span>,</span>
        <span>String</span> <span>aTaskId</span><span>,</span>
        <span>String</span> <span>aTeamMemberId</span><span>)</span> <span>{</span>

        <span>BacklogItem</span> <span>backlogItem</span> <span>=</span> 
            <span>backlogItemRepository</span><span>.</span><span>findById</span><span>(</span>
                <span>new</span> <span>TenantId</span><span>(</span><span>aTenantId</span><span>),</span> <span>new</span> <span>BacklogItemId</span><span>(</span><span>aBacklogItemId</span><span>));</span>
        <span>Team</span> <span>ofTeam</span> <span>=</span> 
            <span>teamRepository</span><span>.</span><span>findById</span><span>(</span>
                <span>backlogItem</span><span>.</span><span>tenantId</span><span>(),</span> <span>backlogItem</span><span>.</span><span>teamId</span><span>());</span>
        <span>backlogItem</span><span>.</span><span>assignTeamMemberToTask</span><span>(</span>
            <span>new</span> <span>TeamMemberId</span><span>(</span><span>aTeamMemberId</span><span>),</span> <span>ofTeam</span><span>,</span> <span>new</span> <span>TaskId</span><span>(</span><span>aTaskId</span><span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

확장성과 분산

<p>ID 참조를 이용하게 되면 같은 영속화 플랫폼을 사용하지 않고 샤딩과 같은 확장을 통해서 일부 애그리게잇을 손쉽게 확장할 수 있다.
<em>예를 들면 어떤 애그리게잇은 DB를 사용하고 연관되는 다른 애그리게잇은 NoSql을 사용할 수 있다.</em></p>

<p>도메인 이벤트를 통해서 외부 바운디드 컨텍스트로 분산처리를 더 가속화할 수 있다.</p>

<p>역시나 중요한 것은 <strong>결과적 일관성</strong>이다.</p>

규칙: 경계의 밖에서 결과적 일관성을 사용하라

<p>결과적 일관성과 지연 시간 = 도메인 이벤트 발행</p>

<ul>
  <li>동시성 이슈로 인해서 발행된 이벤트 구독이 실패하면? 메시징 매커니즘을 통해서 Retry! &gt; 이것은 쉽지가 않은 것 같다.</li>
</ul>

누가 해야 하는 일인지 확인하자

<blockquote>
  <p>데이터의 일관성을 보장하는 주체가 유스케이스를 수행하는 사용자의 일인지를 질문해보자.
만약 그렇다면, 다른 애그리게잇의 규칙들은 고수하는 가운데 트랜잭션을 통해 일관성을 보장하도록 하자.
만약, 다른 사용자나 시스템이 해야 할 일이라면 결과적 일관성을 선택하자.</p>
</blockquote>

규칙을 어겨야하는 이유

첫 번째 이유: 사용자 인터페이스의 편의

두 번째 이유: 기술적 매커니즘의 부족

세 번째 이유: 글로벌 트랜잭션

<p>개인적으로 안티패턴. 결과적 일관성을 사용하자</p>

네 번째 이유: 쿼리 성능

<p>캐싱을 통해서 어느정도 해결할 수 있다.</p>

발견을 통해 통찰 얻기

<p>Skip</p>

구현

고유 ID와 루트 엔터티를 생성하라

값 객체 파트를 선호하라

‘데메테르 법칙’과 ‘묻지 말고 시켜라’를 사용하기

<ul>
  <li>데메테르 법칙 : 정보은닉</li>
  <li>묻지 말고 시켜라 : 정보은닉 + 응집력</li>
</ul>

낙관적 동시성

<p>애그리게잇 루트에 버전을 통한 낙관적 락 기법</p>

<p>@Version : JPA를 이용하면 이 선언만으로도 낙관적 락 기법을 사용할 수 있다.</p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"orders"</span><span>)</span>
<span>public</span> <span>class</span> <span>Order</span> <span>{</span>
    <span>@Id</span>
    <span>private</span> <span>Long</span> <span>id</span><span>;</span>
    <span>@Version</span>
    <span>private</span> <span>int</span> <span>version</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
<span>}</span>
</pre></div></div>

의존성 주입을 피하라

<p>애그리게잇에 서비스나 리파지토리를 주입하지 마라</p>

마무리

<ul>
  <li>가능하면 작은 애그리게잇으로 설계하자</li>
  <li>일관성 경계, 트랜잭션, 고정자가 중요</li>
  <li>객체 그래프 참조 VS ID 참조</li>
  <li>경계 외부에서는 <strong>결과적 일관성</strong>
</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvsb4HeB1ASg5Emah-2FfhAnWebReYF7rvPYokqNmMMGvp7w-3D-3DVTJe_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXv-2B8usZdy7b6JU99MWsge-2Bd6JBIuekD-2F-2BqfDwIiyKDz4pgqYnksTIaKY0CC6JmCAcWl1r4jCZp8m0cCFgbzvQQsrqEMmetmotRu1KUqUFaEpLe-2BVPY-2BtLp1J-2BeTBuNA2PQdc5Npxn8kRX3dKpoQhLupNcyp4Icpo6T1Vma5wORlN37nnn1VdICmTRUo-2BSamUSUCVR6FGzE-2FT477xYlpekHb">IDDD 10장. 애그리게잇</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUeum5_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXv-2B8usZdy7b6JU99MWsge-2Bd6JBIuekD-2F-2BqfDwIiyKDz4rR2OobYnukDVQBBhSO1JwRhz1VbJfmFWOIfb3-2B88J6FIprVoUsaoJNrNL5FNSTJeCnkJvlbpBi2Y6-2BGlqwqd3LmhDkSMcJYOYtA434wBkPqvZj8g5-2FJJOaodCHLbWRpXoYULW7ehKRdNnhCIbQ2jzSUFr4U9Q7fNQCqlbgO-2B4MS">DevOOOOOOOOP</a> on June 05, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNhIhX-2FjGX4SaM5LcunUoqGvD-2B9Sjrp3LjbKA1Kvc6Yzz36oe2b-2BeUR-2F4Vm1wlRr-2FY4ya7HXJh5knZDp-2B2lqgNgBydQjR-2BNJO9mxH-2FbZjmof17jOGVfPoZpHDAgH-2BPR9mYG2q9HwQFzwNMGTYm6mBPFvDEmv4hjtVkJDPJDGuLjo3fFOAMSprIuFMN0w-2BgoU6u9oNnrfenmj8FwDR7eYBB0" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>JPA에서 Value Object Collection 3가지 구현</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003902.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3902</id>

    <published>2020-05-10T16:25:22Z</published>
    <updated>2020-05-10T16:25:22Z</updated>

    <summary> 동기 팀 내에서 IDDD(Implementing Domain-Driven Design) 스터디 중 값 객체 Collection을 ORM(hibernate)을 이용하여 구현하는 예제를 확인했습니다. 그러던 중 이게 아주 과거 hibernate xml 구성 기준이어서 현재 JPA(Sprin Data JPA)에서는 어떻게 구현되는지 궁금해 하던 @동묘가 저에게 직접 구현을 보고 싶다고...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    동기

<p>팀 내에서 IDDD(Implementing Domain-Driven Design) 스터디 중 <strong>값 객체 Collection을 ORM(hibernate)을 이용하여 구현하는 예제</strong>를 확인했습니다.
그러던 중 이게 아주 과거 hibernate xml 구성 기준이어서 현재 <em>JPA(Sprin Data JPA)에서는 어떻게 구현되는지 궁금</em>해 하던 @동묘가 저에게 직접 구현을 보고 싶다고 해서 포스팅 하게 되었습니다.</p>

구현

<p>3가지 구현 방법</p>

<ol>
  <li>Single Column</li>
  <li><strong>Entity</strong></li>
  <li>Join Table</li>
</ol>

<p><strong>예시 도메인</strong></p>

<p><img src="http://www.plantuml.com/plantuml/svg/LO_12i8m38RlUugmex8Na57cIJo8uC5xreOoxThIfWSHtzreqR5Jal_F_v4CcJ5ncLqJKT_H4XnIA75lRIABJF1ijCESgmnzlpYN45WfMG3OsezxDD9wd4cAeQpJ57aANgRkwvze7YdbvhKWVwA0h-WAmNcyaQxOFuiVaIHKB-Ww1UscNOLtiE8Fv8ryz0O0" alt="Group과 GroupMember"></p>

<ul>
  <li>그룹은 애그리게잇 루트(엔터티)입니다.</li>
  <li>그룹맴버는 값 객체입니다.</li>
  <li>한 그룹에는 여러 그룹맴버가 있습니다. (Group#groupMembers)</li>
  <li>그룹과 그룹맴버는 한 애그리게잇으로 묶입니다.</li>
</ul>

Many Values Serialized into a Single Column

<p>groups.group_members에 그룹맴버들 객체를 직렬화해서 저장합니다. 여기에서는 varchar(4000) 데이터타입으로써 JSON으로 직렬화 하겠습니다.</p>

Java

<p><em>GroupMember.java</em></p>

<div><div><pre><span>@Embeddable</span>
<span>@Value</span>
<span>public</span> <span>class</span> <span>GroupMember</span> <span>{</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>@Enumerated</span><span>(</span><span>EnumType</span><span>.</span><span>STRING</span><span>)</span>
    <span>private</span> <span>GroupMemberType</span> <span>type</span><span>;</span>

    <span>// For JPA</span>
    <span>GroupMember</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>null</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>null</span><span>;</span>
    <span>}</span>

    <span>// For Jackson</span>
    <span>@JsonCreator</span>
    <span>public</span> <span>GroupMember</span><span>(</span><span>@JsonProperty</span><span>(</span><span>"name"</span><span>)</span> <span>String</span> <span>name</span><span>,</span> 
                       <span>@JsonProperty</span><span>(</span><span>"type"</span><span>)</span> <span>GroupMemberType</span> <span>type</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>name</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>type</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><em>Group.java</em></p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"GROUPS"</span><span>)</span>
<span>@Getter</span>
<span>@EqualsAndHashCode</span>
<span>@ToString</span>
<span>@NoArgsConstructor</span><span>(</span><span>access</span> <span>=</span> <span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
<span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>private</span> <span>Long</span> <span>groupId</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>

    <span>/**
     * ORM과 한 열로 직렬화되는 여러 값 : ORM and Many Values Serialized into a Single Column
     */</span>
    <span>@Convert</span><span>(</span><span>converter</span> <span>=</span> <span>GroupMembersConverter</span><span>.</span><span>class</span><span>)</span>
    <span>@Column</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>length</span> <span>=</span> <span>4000</span><span>)</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>group1Members</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

<p><em>GroupMembersConverter.java</em></p>

<div><div><pre><span>@Converter</span>
<span>public</span> <span>class</span> <span>GroupMembersConverter</span> <span>implements</span> <span>AttributeConverter</span><span>&lt;</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;,</span> <span>String</span><span>&gt;</span> <span>{</span>
    <span>private</span> <span>ObjectMapper</span> <span>om</span> <span>=</span> <span>new</span> <span>ObjectMapper</span><span>();</span>

    <span>@Override</span>
    <span>public</span> <span>String</span> <span>convertToDatabaseColumn</span><span>(</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>attribute</span><span>)</span> <span>{</span>
        <span>return</span> <span>om</span><span>.</span><span>writeValueAsString</span><span>(</span><span>attribute</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>convertToEntityAttribute</span><span>(</span><span>String</span> <span>dbData</span><span>)</span> <span>{</span>
        <span>return</span> <span>om</span><span>.</span><span>readValue</span><span>(</span><span>dbData</span><span>,</span> <span>new</span> <span>TypeReference</span><span>&lt;</span><span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;&gt;()</span> <span>{</span> <span>});</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>group_members</span> <span>varchar</span><span>(</span><span>4000</span><span>),</span> <span>/* !!! */</span>
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span>
    <span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>group_members</span><span>,</span> <span>name</span>
<span>)</span> <span>values</span> <span>(</span>
    <span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span>
<span>);</span>
</pre></div></div>

<p><em>저장 후 테이블 조회 예시</em></p>

<table>
  
    <tr>
      <th>GROUP_ID</th>
      <th>DESCRIPTION</th>
      <th>GROUP_MEMBERS</th>
      <th>NAME</th>
    </tr>
  
  
    <tr>
      <td>1</td>
      <td>설명</td>
      <td>[{"name":"하위그룹","type":"GROUP"},{"name":"회원1","type":"MEMBER"}]</td>
      <td>이름</td>
    </tr>
  
</table>

Many Values Backed by a Database Entity

<p>실질적으로는 <em>Entity처럼 DB 스키마를 구성</em>하나 실제 객체지향세계(ex:Java Application)에서는 <strong>값 객체로 보이게 구현</strong></p>

<ul>
  <li>이를 위해서 상속을 이용해서 <strong>식별자 속성을 은닉</strong>시키는 것이 구현의 핵심</li>
</ul>

Java

<p><em>IdentifiedValueObject.java</em></p>

<div><div><pre><span>@MappedSuperclass</span>
<span>@NoArgsConstructor</span><span>(</span><span>access</span> <span>=</span> <span>AccessLevel</span><span>.</span><span>PROTECTED</span><span>)</span>
<span>public</span> <span>abstract</span> <span>class</span> <span>IdentifiedValueObject</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>@Getter</span><span>(</span><span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
    <span>@Setter</span><span>(</span><span>AccessLevel</span><span>.</span><span>PACKAGE</span><span>)</span>
    <span>private</span> <span>Long</span> <span>id</span><span>;</span>    <span>// 패키지 접근제어를 통해서 식별자 은닉. 단, hibernate는 접근 가능</span>
<span>}</span>
</pre></div></div>

<p><em>GroupMember.java</em></p>

<div><div><pre><span>@Entity</span>
<span>@Table</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>)</span>
<span>@Value</span>
<span>@EqualsAndHashCode</span><span>(</span><span>callSuper</span> <span>=</span> <span>false</span><span>)</span>
<span>public</span> <span>class</span> <span>GroupMember</span> <span>extends</span> <span>IdentifiedValueObject</span> <span>{</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>@Enumerated</span><span>(</span><span>EnumType</span><span>.</span><span>STRING</span><span>)</span>
    <span>private</span> <span>GroupMemberType</span> <span>type</span><span>;</span>

    <span>// For JPA</span>
    <span>GroupMember</span><span>()</span> <span>{</span>
        <span>this</span><span>.</span><span>name</span> <span>=</span> <span>null</span><span>;</span>
        <span>this</span><span>.</span><span>type</span> <span>=</span> <span>null</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><em>Group.java</em></p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>...</span>
    <span>/**
     * ORM과 데이터베이스 엔터티로 지원되는 여러 값 : ORM and Many Values Backed by a Database Entity
     */</span>
    <span>@OneToMany</span><span>(</span><span>cascade</span> <span>=</span> <span>CascadeType</span><span>.</span><span>ALL</span><span>,</span> <span>orphanRemoval</span> <span>=</span> <span>true</span><span>)</span> <span>// Aggregate Root 를 위한 일관성 설정</span>
    <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>)</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
<span>create</span> <span>table</span> <span>group_members</span> <span>(</span>
    <span>id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span>     <span>//</span> <span>PK</span><span>!!</span>
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>type</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>group_id</span> <span>bigint</span><span>,</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>id</span><span>)</span>
<span>)</span>
<span>alter</span> <span>table</span> <span>group_members</span> 
    <span>add</span> <span>constraint</span> <span>fk_groups_group_members</span>
    <span>foreign</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span> <span>references</span> <span>groups</span><span>;</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span><span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>name</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>name</span><span>,</span> <span>type</span><span>,</span> <span>id</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>name</span><span>,</span> <span>type</span><span>,</span> <span>id</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>)</span>
<span>update</span> <span>group_members</span> <span>set</span> <span>group_id</span><span>=?</span> <span>where</span> <span>id</span><span>=?</span>  <span>/* Update ?! */</span>
<span>update</span> <span>group_members</span> <span>set</span> <span>group_id</span><span>=?</span> <span>where</span> <span>id</span><span>=?</span>
</pre></div></div>

<ul>
  <li>일반적으로 가장 무난하며, IDDD 책에서는 저자가 가장 추천한 방식</li>
</ul>

Many Values Backed by a Join Table

<p>group_members을 테이블로 분리하는데 이 테이블은 PK가 없이 groups의 PK를 FK로 가지는 Join Table로 구현</p>

Java

<p><em>Group.java</em></p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>@Id</span>
    <span>@GeneratedValue</span>
    <span>private</span> <span>Long</span> <span>groupId</span><span>;</span>
    <span>private</span> <span>String</span> <span>description</span><span>;</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>/**
     * ORM과 조인 테이블로 지원되는 여러 값 : ORM and Many Values Backed by a Join Table
     */</span>
    <span>@ElementCollection</span>
    <span>@CollectionTable</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>joinColumns</span> <span>=</span> <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>))</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

SQL

<p><em>Schema</em></p>

<div><div><pre><span>create</span> <span>table</span> <span>groups</span> <span>(</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>description</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>primary</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span>
<span>);</span>
<span>create</span> <span>table</span> <span>group_members</span> <span>(</span>    <span>/* No PK */</span>
    <span>group_id</span> <span>bigint</span> <span>not</span> <span>null</span><span>,</span> 
    <span>name</span> <span>varchar</span><span>(</span><span>255</span><span>),</span> 
    <span>type</span> <span>varchar</span><span>(</span><span>255</span><span>)</span>
<span>);</span>
<span>alter</span> <span>table</span> <span>group_members</span> 
    <span>add</span> <span>constraint</span> <span>fk_groups_group_members</span> 
    <span>foreign</span> <span>key</span> <span>(</span><span>group_id</span><span>)</span> <span>references</span> <span>groups</span><span>;</span>
</pre></div></div>

<p><em>Insert</em></p>

<div><div><pre><span>insert</span> <span>into</span> <span>groups</span> <span>(</span><span>group_id</span><span>,</span> <span>description</span><span>,</span> <span>name</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>group_id</span><span>,</span> <span>name</span><span>,</span> <span>type</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
<span>insert</span> <span>into</span> <span>group_members</span> <span>(</span><span>group_id</span><span>,</span> <span>name</span><span>,</span> <span>type</span><span>)</span> <span>values</span> <span>(</span><span>?</span><span>,</span> <span>?</span><span>,</span> <span>?</span><span>);</span>
</pre></div></div>

이슈

값 객체 Collection에 새로운 값이 추가되거나 기존 값이 변경될 시 All Delete and Re-insert

<p>@ElementCollection을 통해 변경이 발생할 시, 전체를 지우고 다시 입력하는 이슈가 있음.
이를 완화시키기 위해서 @OrderColumn을 추가하는 방법이 있긴하나 완벽하지는 않음</p>

<div><div><pre><span>public</span> <span>class</span> <span>Group</span> <span>{</span>
    <span>...</span>
    <span>@ElementCollection</span>
    <span>@CollectionTable</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_MEMBERS"</span><span>,</span> <span>joinColumns</span> <span>=</span> <span>@JoinColumn</span><span>(</span><span>name</span> <span>=</span> <span>"GROUP_ID"</span><span>))</span>
    <span>@OrderColumn</span>    <span>// !!!</span>
    <span>private</span> <span>Set</span><span>&lt;</span><span>GroupMember</span><span>&gt;</span> <span>groupMembers</span> <span>=</span> <span>new</span> <span>HashSet</span><span>&lt;&gt;();</span>
    <span>...</span>
<span>}</span>
</pre></div></div>

Summary

<p><img src="https://github.com/redutan/ddd-values/raw/master/ddd-value-db-schema.png" alt="Total DB schema"></p>

<ol>
  <li>Single Column</li>
  <li>Entity</li>
  <li>Join Table</li>
</ol>

Reference

<ul>
  <li>소스코드 : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRTGojT0wnIHffG1exc6x76o_cIp_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laMmZWrrjeg-2Fb-2BYnS6260HMTUy7ZcN-2Be9XnTmqw4hettYBOu7TPqPJ0t-2B6gtRDPM-2BwRlBVJt4hP3Z-2FgFrd-2BlvWCfed8Z6ztGJkJY2Av1ME-2BlofGOr7Hnz8g7eDtbWLuD6qye91ob8fmWaX6v2plUhIrcbTxu9MWvOvk2L9WSYZpaOO-2B7-2Bw7AmWl1PHC6URbJECA-3D-3D">https://github.com/redutan/ddd-values</a>
</li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=wC3KXI14r-2BhtUZYhlxRDF-2B2v7mVoTWsc70JdRKQC027wpcqQcReOHQGgY7yCySsJc9o5T-2BqHeydHI4vZMXQNKg-3D-3D8Ufv_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laJK-2BE3KHBKz0alRqP-2FN-2FlInbK0kG65R6sK1qbDqLVAxqNMJ3UX4DVXTkkjBz-2FdX35a3uhY2mNPrvc-2F1mHVdF42ohD85ADnXrl5RRd44B0ZlDNIzoDrh7TpF6b0GrgITXFEd6kFseEPv4Ofzy-2F-2FAOx-2FIkgQ8RMuk6c5nU-2Ft9g65ZYsnsMZuqGX-2BL2tlVmdjhChQ-3D-3D">Implementing Domain-Driven Design. Vaughn Vernon</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=U6xaqgbOMRdETgYGP-2Bln2OoLibx0-2BsRL1jhEa2GxVmsD5h8l6-2BskJZ16VLPnP6uHXrihuvy-2BuveSCh0UjICquQ-3D-3DIPzJ_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laOFbUkPtjqLSf2aRS5EINI4RUzzQHpSYMyJL7bCp15Fe7bHOLdTsLUDUhJH4ok8ZynneNj-2FCKWyF4YhZ-2FnWPRnjRR41w-2F5btDZLQKJgnLFh-2BmUWrIoiE3NL6Gexj2VLQTtsSFTbpTzCk920fGgNJFml7fH5SvTyVsJybQE7Cx-2F-2Bo7TWQj3XsbxVBrnUpJw4lmg-3D-3D">자바 ORM 표준 JPA 프로그래밍. 김영한</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=IJsfzn0VfpB8bgLJSLrPinMZjuqVj8RLL3zmjpIgFp0f39kxp9xCjFYOOS8-2BAV3AxWiQKio6bY-2BOxCrVrZo0PA-3D-3DyddA_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laNfTPS4rE4L-2Fws5DwYlEhmoG0V9NqyLovKHM2Md8fpS7PbYPO4miaplXfw6Uxm6bF7u3BHF1I-2Flj1ILpGW95v3k4b-2BYnqfNnCtU4G8-2B8H2hhZL7-2FiVa-2B3EdO-2FPgY6kW84v7XVuAoSdSbYe8EN7aSh-2B4jqB620abTNOstrTU9wFwqAwzhOGKObIiTW9R7enTTvw-3D-3D">http://kwonnam.pe.kr/wiki/java/jpa/elementcollection</a></li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtD-2FWEd9qR-2BgJYv-2FcH-2B65P9JD4MOmF2LKxBfd30hn0MvA-3D-3D-S4L_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laJQHZujc9GOdtk3RWM8ieazbHkvj-2BYSDuVGkq2WGjnZOQMmbf7kpNSgmEqhEE5rzsFmRXgaOjIJpccuErtmKwU8E9jLaH6VYMincXqpytUPjUnGsS-2FXx56M7Dl99kJXmAoJgYitWJNdpN1akXyY9mbN3mhnfum5OXMNB6RoyQOe8PFXlTqP0K-2Ff4sPqnblbLhA-3D-3D">JPA에서 Value Object Collection 3가지 구현</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUfzsI_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtt3iZ8jZBalVPNVA9xt-2F-2FSOWngv0gfPDpIS6jnEa6laAEgoVsuu7ejdowB1-2FwO8PMHB9Tyq2x-2FfJ49xCD-2FQlvD8ZIm-2BB3G75I3Bcf8uMeAvGeY6ThVXABQi4JLPO-2FKBKzoxVFrVVfha8rv5QB5hnrsmz-2BX5DIkQRoHwCfYSyapmUqW8wqPsD9i9ybNmhD6H3jq3XZKU3c5wAnSg1ZmPyqXZHofKze6AYKhC66kUZ0fSw-3D-3D">DevOOOOOOOOP</a> on May 29, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNPYZ0TfcKi9eTqjHd8-2FcFh72Up2ns8B1PLrsrSUG5JNNrnKmtpWwO8FF-2BOto6J0eTDh6vqD9uCf4eTFdgf8caSFbFB4CD2-2FCFyNzpCuhHB26lIkoN8GWglBJY-2FAoRN-2F94KgfgZf-2F1dB15FTdSohBErmosraAFi841kBs-2BHgO3Y4A3npUPdCuC4Ru0QK4MOxX6Cs5zG1HtSGRSDxPdOYDbtsRGtNkl-2FUipOuMWiYiwqkw-3D-3D" alt="" width="1" height="1" />

]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 9장. 모듈</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003901.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3901</id>

    <published>2020-05-10T16:25:21Z</published>
    <updated>2020-05-10T16:25:21Z</updated>

    <summary> Java: 패키지 C#: 네임스페이스 Ruby: 모듈 모듈로 설계하기 모듈 : 도메인 객체의 컨테이너 규칙 모델링의 개념에 맞춰 모듈을 설계하자 유비쿼터스 언어에 맞춰 모듈을 명명하자 모델에서 사용하는 일반적인 컴포넌트 타입이나 패턴에 따라서 기계적으로 모듈을 생성하지 말자 느슨하게 결합된 모듈을 설계하자....</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <ul>
  <li>Java: 패키지</li>
  <li>C#: 네임스페이스</li>
  <li>Ruby: 모듈</li>
</ul>

모듈로 설계하기

<ul>
  <li>모듈 : 도메인 객체의 컨테이너</li>
</ul>

<p><strong>규칙</strong></p>

<ul>
  <li>모델링의 개념에 맞춰 모듈을 설계하자</li>
  <li>유비쿼터스 언어에 맞춰 모듈을 명명하자</li>
  <li>모델에서 사용하는 일반적인 컴포넌트 타입이나 패턴에 따라서 기계적으로 모듈을 생성하지 말자</li>
  <li>느슨하게 결합된 모듈을 설계하자.</li>
  <li>결합이 필요하다면 짝이 되는 모듈 사이에서 비순환적 의존성이 형성되도록 노력하자</li>
  <li>자식 모듈과 부모 모듈 사이에 규칙은 느슨하게 하자</li>
  <li>모듈을 모델의 정적인 개념에 따라 만들지 말고, 모듈이 담고 있는 객체에 맞추도록 하자</li>
</ul>

<blockquote>
  <p>주방의 서랍에 식기류가 포크와 나이프와 스푼별로 잘 정리돼 있음</p>
</blockquote>

기본 모듈 명명 규칙

<p>Java: com.saasovation
C#: SaaSOvation</p>

모델을 위한 모듈 명명 규칙

<p><strong>바운디드 컨텍스트</strong></p>

<ul>
  <li>com.saasovation.identityaccess</li>
  <li>com.saasovation.collovoration</li>
  <li>com.saasovation.agilepm</li>
</ul>

<p><strong>모듈 구성 예시</strong></p>

<ul>
  <li>
com.saasovation.identityaccess
    <ul>
      <li>domain.model</li>
    </ul>
  </li>
</ul>

<p>결론은 여러분 팀의 몫이다.</p>

애자일 프로젝트 관리 컨텍스트의 모듈

<ul>
  <li>
com.saasovation.agilepm
    <ul>
      <li>
domain
        <ul>
          <li>
model
            <ul>
              <li>
product
                <ul>
                  <li>backlogitem</li>
                  <li>release</li>
                  <li>sprint</li>
                </ul>
              </li>
              <li>tenant</li>
              <li>team</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>이 팀은 모듈 사이의 결합도 문제보다 <em>정리</em>에 중점을 뒀다.</p>

다른 계층 속의 모듈

<table>
  
    <tr>
      <th>계층</th>
      <th>모듈</th>
      <th>비고</th>
    </tr>
  
  
    <tr>
      <td>사용자 인터페이스</td>
      <td>com.saasovation.agilepm.resources</td>
      <td>ui</td>
    </tr>
    <tr>
      <td>애플리케이션</td>
      <td>com.saasovation.agilepm.application</td>
      <td> </td>
    </tr>
    <tr>
      <td>도메인</td>
      <td>com.saasovation.agilepm.domain</td>
      <td> </td>
    </tr>
    <tr>
      <td>인프라</td>
      <td>com.saasovation.agilepm.infrastructure</td>
      <td>adapter</td>
    </tr>
  
</table>

바운디드 컨텍스트보다 모듈

<p>모듈은 응집력이 낮은 경우 분리하기 위한 컨테이너이고, 바운디드 컨텍스트는 그저 경계일 뿐이다.</p>

<p>어짜피 모듈은 상향식(bottom-up)으로 설계하게된다. 
모듈 내의 컴포넌트들에 따라서 나눠질 수도 합쳐질 수도 있다. 중요한 것은 도메인 로직과 유비쿼터스 언어에 따르는 것이다.</p>

마무리

<ul>
  <li>유비쿼터스 언어를 표현한다.</li>
  <li>모듈 설계의 예시!!</li>
  <li>기계적인 모듈 설계는 창의성을 방해한다.</li>
  <li>바운디드 컨텍스트 분리보다 모듈 사용이 먼저다.</li>
</ul>


    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtm3NqOtydeFnrb09xQSvsPe3wC21MUOwAvDuMNN2LpgA-3D-3D9OUl_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtrLDOEzZ2Daawpe1aAsqcvdCvJ-2FG9jaz-2FSTSCF1VVOSZJgOnY7lAhZ8bu-2FSGmMTlRPTKV-2Fhfdo82CUuAldFPUTlICL-2FPdqPdxZjr1xe9TVn1xmsO0Mr6zBVKJ2zy6ctTN1w5YWqe7Tt1TjWMSj-2BjnFIjvCPOl6ujyLEzDwSWz8tgwAs54rg-2FqwiM4pdjOyQPVROP9nLGs8OXdOTt5c954DgakbZgTFrsNwVGvrZ-2BBbKA-3D-3D">IDDD 9장. 모듈</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUxwJK_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtrLDOEzZ2Daawpe1aAsqcvdCvJ-2FG9jaz-2FSTSCF1VVOSbpTbloS1M9Iag8myDqaxug1gcW5kwzSLgcAdsJt9VOEZ4MRotRFkuPMdz8AJfOMSghQNR4AlPp52rg4dMzQKgtJKYu19VtbDf6FgsIhRUA1nmhg7SzSNzR2zHvppHZyDWK9ZPF9RT2E-2BPapl5C8cXAFXE3hcAedYdHMyfTWsvmc3B-2FKNVMd3uc0MrFZv1U4Tg-3D-3D">DevOOOOOOOOP</a> on May 28, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMPME9M3NrSWTl3I4WW4WGEIyIydBv5I7-2FArd-2BtYqh7D5-2B0OTCKIfRiosIRcuAWfGMLpW2fe45-2BtL-2Fbq6Ho7uKIv-2F4HjcCks6KZ0hlJtiNR3YaRoe4HAy62mYuUz7HEB-2BQf7CAkw9pqFEXzGhEYDoezpGtz9pL9I0t6XtJSC9xWLi8sIPt4Nl8pZuQzLn57McCyaMFw0mUVQp-2BjyjOn4Y9MOhirsjjnWiUcwQ3do96hshQ-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 8장. 도메인 이벤트</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003900.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3900</id>

    <published>2020-05-10T16:25:20Z</published>
    <updated>2020-05-10T16:25:20Z</updated>

    <summary> Publish-Subscribe 언제 그리고 왜 도메인 이벤트를 사용할까? 도메인 내 어떤 사건이 발생했을 때 한 트랜잭션에는 한 애그리게잇만 커밋 이벤트의 모델링 어떤 명령에서 어떤 사건이 발생했었음 Command : BacklogItem#commitTo(Spring) Event : BacklogItemCommitted 백로그 항목이 커밋됐다.(과거형) package com.saasovation.agilepm.domain.model.product; @Value class BacklogItemCommitted...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p>Publish-Subscribe</p>

언제 그리고 왜 도메인 이벤트를 사용할까?

<ul>
  <li>도메인 내 어떤 사건이 발생했을 때</li>
  <li>한 트랜잭션에는 한 애그리게잇만 커밋</li>
</ul>

이벤트의 모델링

<p>어떤 명령에서 어떤 사건이 발생했었음</p>

<ul>
  <li>Command : BacklogItem#commitTo(Spring)
</li>
  <li>Event : BacklogItemCommitted
</li>
  <li>백로그 항목이 커밋됐다.(과거형)</li>
</ul>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>product</span><span>;</span>

<span>@Value</span>
<span>class</span> <span>BacklogItemCommitted</span> <span>implements</span> <span>DomainEvent</span> <span>{</span>
    <span>Date</span> <span>occurredOn</span><span>;</span>
    <span>BacklogItemId</span> <span>backlogItemId</span><span>;</span>
    <span>SpringId</span> <span>committedToSprintId</span><span>;</span>
    <span>TenantId</span> <span>tenantId</span><span>;</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>agilepm</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>;</span>

<span>interface</span> <span>DomainEvent</span> <span>{</span>
    <span>Date</span> <span>occurredOn</span><span>();</span>
<span>}</span>
</pre></div></div>

<p><em>추가사항</em></p>

<ul>
  <li>멱등성</li>
  <li>더 풍부한 상태 전달 (이벤트 소싱!)</li>
</ul>

애그리게잇의 특성과 함께하기

<p>이벤트를 애그리게잇을 통해서 영속화</p>

식별자

<ul>
  <li>이벤트를 애그리게잇으로 모델링하면 식별자가 필요하다.</li>
  <li>도메인 이벤트를 바운디드 컨텍스트 외부로 발행 시 식별자가 필요(With rabbitmq)
    <ul>
      <li>외부 구독자 입장에서는 멱등성 관리를 위해서 식별자를 할당할 수 있음</li>
      <li>
equals로 일정 부분 해결할 수도 있다 (in 로컬 바운디드 컨텍스트)</li>
    </ul>
  </li>
</ul>

도메인 모델에서 이벤트 발행하기

<p>Light-Weight Publish-Subscribe</p>

<p><img src="https://camo.githubusercontent.com/afd4f6f7085bc7bdc1db8595fd4e3e62fccb12d6/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f7376672f5a4c31393369386d33427074354a643238482d654b307a4b74393575475039514f3937344c50654b7a56556141774b42756331506358644673315231616d723657616b34796b484f685836694a734158527a584c4536795a4c79514532616a5846486c31696f5272584539496a746635725a6c49387a55316a6f30687652337278627276446a3266523653466e704f4a512d35583258687748726347344d5950665a6b67354a6a5638524e6d4d6c627a784a585739787635356c334642392d59356e556350503051676d55334a6878714d6c765a362d50504a59522d6b38644432356a344d7143727a323132444e5f4f4b68625a55553868755570494e7a704576636c35366d3030" alt="발행자"></p>

<ul>
  <li>Reference : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRRCPtej3pJV8krULol3SCes4OcLyMrunwpkXV-2Fwd61OBu0qxlSEstR-2FpTZ1cq1-2FBhOUHK-2B7Pb9lUV8sQWbfgp0rlKZi_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwT5fYInER6d9GE-2BmPH6p9dUYhU3HqvPRTrHRY25wjOaJYluiZsdTyUoX9Pc2-2BkU98kioXVMIudJoYSL8JAQjIPoNmhkIZ2GYrY1DBlz7znk81t2pJv-2BQNjPi0Z7dIdbJ7NgxI-2BceGd0-2F4vf5yGqS-2BQcsVmNJDRpxOa-2FU2owJiOXXNaBBoAyAmVYzK4nzC7ANbg-3D-3D">https://github.com/redutan/redutan.github.io/wiki/Domain-Event-on-Springframework</a>
</li>
</ul>

발행자

<div><div><pre><span>class</span> <span>BacklogItem</span> <span>extends</span> <span>AbstractAggregateRoot</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>{</span>
    <span>void</span> <span>commitTo</span><span>(</span><span>Sprint</span> <span>spint</span><span>)</span> <span>{</span>
        <span>// Some domain logic</span>
        <span>super</span><span>.</span><span>registerEvent</span><span>(</span><span>new</span> <span>BacklogItemCommitted</span><span>(</span>
                <span>this</span><span>.</span><span>tenantId</span><span>(),</span>
                <span>this</span><span>.</span><span>backlogItemId</span><span>(),</span>
                <span>this</span><span>.</span><span>sprintId</span><span>()</span>
        <span>));</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>BacklogItemService</span> <span>{</span>  <span>// Application Service</span>
     <span>@TransactionalEventListener</span>
    <span>void</span> <span>commitBacklogItem</span><span>(...)</span> <span>{</span>
        <span>backlogItem</span><span>.</span><span>commitTo</span><span>(</span><span>sprint</span><span>);</span>   <span>// Publish BacklogItemCommitted event</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

구독자

<div><div><pre><span>class</span> <span>BacklogItemService</span> <span>{</span>  <span>// Application Service</span>
     <span>@TransactionalEventListener</span>
    <span>void</span> <span>handleBacklogItemCommitted</span><span>(</span><span>BacklogItemCommitted</span> <span>event</span><span>)</span> <span>{</span>
        <span>// BacklogItemCommitted 구독 후 처리</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p>중요한 것은 <strong>결과적 일관성</strong></p>

뉴스를 원격 바운디드 컨텍스트로 전파하기

<p><em>시스템 간</em> 결과적 일관성 확보</p>

메시징 인프라의 일관성

<p><em>구현방법</em></p>

<ol>
  <li>도메인 모델과 메시지 인프라 저장소 공유</li>
  <li>원격 DB with XA</li>
  <li>이벤트 저장소</li>
</ol>

자치 서비스와 시스템

<p>자치 서비스 : 이벤트를 통해서 시스템 간 결합도(독립성!)를 줄이는 기법 (No-RPC)</p>

<p>자치 서비스의 단위는 바운디드 컨텍스트가 되면 좋은 것 같다.</p>

지연 시간 허용

<p><em>결과적 일관성</em>을 위해서</p>

<p>도메인 별로 그 때 그 때 달라요.</p>

<p>시스템의 허용치를 만족시키면서도 잘 수행되도록 아키텍처 품질을 높여야 한다.</p>

이벤트 저장소

<p>이벤트의 상태를 유지하기 위해서 저장하는 것이 요구되는 경우가 많다.</p>

<p><img src="http://www.plantuml.com/plantuml/svg/bP7FIWGn3CRlVOeUzT0Na4LMq8Cd1_O9-YSmaKuxDEcAFhsrmx0Pg8Atv4k-xqVQCx4jN9UeNWCaHlvyyXw8Ngwjcqh-gNFHvb4_vyLYwlgbEl857HJze1Dy_CSxLHUHvcwbFUVkNbdFUBKCmrqrXf_CRycpJI52brjsWB_J1rE16SBxMPl4kK13sdM558OqwHGuuLSYgWM_kNVmV862DkBNzbPxqmZ7vLw4hctVSGE8aJITZ3cC0WmTDn68CASZTrU5MqYZ6y-GGbtYDm00" alt="IdentityAccessEventProcessor"></p>

<div><div><pre><span>@Aspect</span>
<span>class</span> <span>IdentityAccessEventProcessor</span> <span>{</span>
    <span>@Before</span><span>(</span><span>"execution(* com.saasovation.identityaccess.application.*.**..))"</span><span>)</span>
    <span>public</span> <span>void</span> <span>listen</span><span>()</span> <span>{</span>
        <span>DomainEventPublisher</span><span>.</span><span>instance</span><span>()</span>
            <span>.</span><span>subscribe</span><span>(</span><span>new</span> <span>DomainEventSubscriber</span><span>&lt;</span><span>DomainEvent</span><span>&gt;()</span> <span>{</span>
                <span>public</span> <span>void</span> <span>handleEvent</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
                    <span>store</span><span>(</span><span>aDomainEvent</span><span>);</span>
                <span>}</span>

                <span>public</span> <span>Class</span><span>&lt;</span><span>DomainEvent</span><span>&gt;</span> <span>subscribedToEventType</span><span>()</span> <span>{</span>
                    <span>return</span> <span>DomainEvent</span><span>.</span><span>class</span><span>;</span>   <span>// 모든 도메인 이벤트</span>
                <span>}</span>
            <span>});</span>
    <span>}</span>
    <span>private</span> <span>void</span> <span>store</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
        <span>EventStore</span><span>.</span><span>instance</span><span>().</span><span>append</span><span>(</span><span>aDomainEvent</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>class</span> <span>StoreEvent</span> <span>{</span>
    <span>void</span> <span>append</span><span>(</span><span>DomainEvent</span> <span>aDomainEvent</span><span>)</span> <span>{</span>
        <span>String</span> <span>eventSerializatoin</span> <span>=</span> 
            <span>EventStore</span><span>.</span><span>objectSerializer</span><span>().</span><span>serialize</span><span>(</span><span>aDomainEvent</span><span>);</span>
        <span>StoredEvent</span> <span>storedEvent</span> <span>=</span> 
            <span>new</span> <span>StoredEvent</span><span>(</span>
                <span>aDomainEvent</span><span>.</span><span>getClass</span><span>().</span><span>getName</span><span>(),</span>
                <span>aDomainEvent</span><span>.</span><span>occuredOn</span><span>(),</span>
                <span>eventSerialization</span><span>);</span>
        <span>this</span><span>.</span><span>session</span><span>().</span><span>save</span><span>(</span><span>storedEvent</span><span>);</span>
        <span>this</span><span>.</span><span>setStoredEvent</span><span>(</span><span>storedEvent</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<div><div><pre><span>CREATE</span> <span>TABLE</span> <span>tbl_stored_event</span> <span>(</span>
    <span>event_id</span> <span>int</span><span>(</span><span>11</span><span>)</span> <span>NOT</span> <span>NULL</span> <span>auto_increment</span><span>,</span>
    <span>event_body</span> <span>varchar</span><span>(</span><span>65000</span><span>)</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>occurred_on</span> <span>datetime</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>type_name</span> <span>varchar</span><span>(</span><span>100</span><span>)</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>PRIMARY</span> <span>KEY</span> <span>(</span><span>event_id</span><span>)</span>
<span>)</span>
</pre></div></div>

저장된 이벤트의 전달을 위한 아키텍처 스타일

레스트품 리소스로서 알림 발행하기

<ol>
  <li>이벤트를 REST/WEB API로 발행한다. (이벤트 아이디나 애그리게잇 아이디를 전달)
    <ul>
      <li>이벤트 저장소를 통해서 조회하거나, 애그리게잇을 직접 조회한다.</li>
    </ul>
  </li>
  <li>구독 측에서 발행측에 다시 상세 이벤트 정보를 조회한 후 처리한다.</li>
</ol>

메시징 미들웨어를 통한 알림 발행

<ol>
  <li>메시징 미들웨어를 통해서 이벤트를 발행한다.</li>
  <li>메시징 미들웨어를 구독한 구독 측에서 발행 측의 상세 이벤트 정보를 조회한 후 처리 한다.</li>
</ol>

<p>발행과 구독은 exchange나 queue 개념으로 연결된다.</p>

구현

<p>Skip</p>

<ul>
  <li>멱등 수신자 처리가 중요하다 : At least once</li>
</ul>

<blockquote>
  <p>멱등성 : 오퍼레이션이 두 번 이상 수행되어도, 한 번만 수행했을 때와 같은 결과에 이르는 동작을 의미</p>
</blockquote>

<p>궁극적으로 이벤트를 추적해야하는 경우가 생기기 때문에 이벤트 저장 기능이 거의 필수적으로 요구된다.
그리고 추적 일관성을 위해서 이벤트 저장은 도메인 로직과 트랜잭션으로 묶이는 것이 중요하다.</p>

마무리

<ul>
  <li>이벤트 만의 고유 식별자가 요구된다.
    <ul>
      <li>이벤트 저장소도 필요</li>
    </ul>
  </li>
  <li>어짜피 발행-구독!</li>
  <li>멱등성 또는 중복 발행 or 수신 제거 확보</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvte7IJ83T9i7ctQC-2FR9Jhkiiganli0CE93CcAILpEzlCw-3D-3Dh2q0_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwVeCIxi-2FocaJix02HAB3yQ0k3Dch-2BIQthOH3hKsUBS6HFHS4EFucpuRvDfOLcdNHwHDe0fW7pQh-2B4-2B-2BUEsiB0hrAob-2FOvb8F353Oub-2B0jIzaP5k7Kax15cieddJOtuAb9WWFlQ9DcOPfH8XlAhTj8rLjlhjKsZu-2F4PXlpHu3D4gYpgCPHhHvE0dcYoE6Nc6Bhg-3D-3D">IDDD 8장. 도메인 이벤트</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUj7HV_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXtHZnd86CIFBbPCbYvmoXq37ZP4J9PmGZsrKXk6EiilwZI1459FqrtpLG7hCO0mC5aES3JMcqjvRhOnTh3eenGzk-2FjaPq9Xr6tJppEJzjSX-2FTLCdZh30y8XAf1meaTPA7FtdrnX8H-2BZwkIKBJBGnnwnQsWdPxgKs8EhDkVuABrrdGtxegY0zy-2FYwUtP2tzaR-2FwcUV7j51Z-2FCOHFjYhwkaIeG1jeXutcRK1et-2FTNQLQGow-3D-3D">DevOOOOOOOOP</a> on May 24, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMOOBDmtyh57YUkp9-2Fv7xyFkkAcl-2BRClFC2uQcNfj9Ofa76FTzflGZJxRjb7Ge-2F-2FVbYZv6HIl3FbYWabaJsUVkDblv1DbErTDxxLNpHz3Hfcpvlv12AY5n-2B4MFKipUSul12EIt0iDHDL5-2B0nYPesbQTabkgeoHPFKAdYw-2FNBL9bDgJst8nXTN0nwB3NVK7vQCAp0X12F0BpEZZFuk4-2FEe-2FMDOqr3PiZBE9qurThZ9AtUmg-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 7장. 서비스</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003899.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3899</id>

    <published>2020-05-10T16:25:20Z</published>
    <updated>2020-05-10T16:25:20Z</updated>

    <summary><![CDATA[ 도메인 서비스 : 도메인 모델 내 무상태 오퍼레이션 제공 애그리게잇이나 값 객체의 행위로써 어울리지 않는 것 before class Product { Set&lt;BacklogItem&gt; backlogItems; BusinessPriorityTotals businessPriorityTotals() { //... } } 모델 정제를 통해 Set&lt;BacklogItem&gt; backlogItems를 분리 그렇다면 businessPriorityTotals() 메서드는 어떻게 되는가?...]]></summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p><strong>도메인 서비스</strong> : 도메인 모델 내 무상태 오퍼레이션 제공</p>

<ul>
  <li>애그리게잇이나 값 객체의 행위로써 어울리지 않는 것</li>
</ul>

<p><em>before</em></p>
<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>backlogItems</span><span>;</span>

    <span>BusinessPriorityTotals</span> <span>businessPriorityTotals</span><span>()</span> <span>{</span>
        <span>//...</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>모델 정제를 통해 Set&lt;BacklogItem&gt; backlogItems를 분리</li>
  <li>그렇다면 businessPriorityTotals() 메서드는 어떻게 되는가?</li>
</ul>

<p><em>after</em></p>
<div><div><pre><span>class</span> <span>Product</span> <span>{</span>
    <span>static</span> <span>BusinessPriorityTotals</span> <span>businessPriorityTotals</span><span>(</span>
            <span>Set</span><span>&lt;</span><span>BacklogItem</span><span>&gt;</span> <span>aBacklogItems</span><span>)</span> <span>{</span>
        <span>// ...</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>정적 메소드로 변경 - 하지만 과연 이것은 옳은가?</li>
</ul>

<p><strong>도메인 서비스</strong> 가 필요한 시점이다!</p>

도메인 서비스란 무엇인가

<blockquote>
  <p>하지만 그보다 먼저 도메인 서비스가 아닌 것은 무엇인가?</p>
</blockquote>

<ul>
  <li>도메인 서비스 : 도메인 로직이 있다.</li>
  <li>애플리케이션 서비스 : 도메인 로직이 없다. (보안, 트랜잭션 등)</li>
</ul>

<p><em>정의</em></p>

<ul>
  <li>엔터티나 값객체의 책임이 아닌 (도메인적) 행위</li>
  <li>유비쿼터스 언어로써 표현</li>
  <li>무상태!</li>
</ul>

<p><em>예시</em></p>

<ul>
  <li>
<em>중요</em> 비즈니스 프로세스
    <ul>
      <li>
<em>복수 개</em>의 도메인 객체에서 필요로 하는 계산</li>
    </ul>
  </li>
  <li>한 조합에서 다른 조합으로 도메인 객체를 <em>변형</em>할 때</li>
</ul>

서비스가 필요할지 확인하자

<p>도메인 특화 지식은 클라이언트로 절대 유촐돼선 안된다.(클라이언트가 애플리케이션 서비스일지라도)
도메인 객체에 위치 시키기 애매하면 <em>도메인 서비스</em>에 담는다.</p>

<p>주의: 도메인 서비스를 남용하면 빈약한(Anemic) 도메인 모델이 된다.</p>

도메인에서 서비스를 모델링하기

<p><em>AuthenticationService</em></p>
<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>domain</span><span>.</span><span>model</span><span>.</span><span>identity</span><span>;</span>   <span>// !!</span>

<span>interface</span> <span>AuthenticationService</span> <span>{</span>
    <span>UserDescriptor</span> <span>authenticate</span><span>(</span>
        <span>TenantId</span> <span>tenantId</span><span>,</span>
        <span>String</span> <span>username</span><span>,</span>
        <span>Strin</span> <span>password</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><em>EncryptionAuthenticationService</em></p>
<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>identityaccess</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>   <span>// !!</span>

<span>class</span> <span>EncryptionAuthenticationService</span> <span>implements</span> <span>AuthenticationService</span> <span>{</span>
    <span>@Override</span>
    <span>UserDescriptor</span> <span>authenticate</span><span>(</span>
            <span>@NonNull</span> <span>TenantId</span> <span>tenantId</span><span>,</span>
            <span>@NonNull</span> <span>String</span> <span>username</span><span>,</span>
            <span>@NonNull</span> <span>Strin</span> <span>password</span><span>)</span> <span>{</span>

        <span>Tenant</span> <span>tenant</span> <span>=</span> <span>tenantRepository</span><span>.</span><span>findById</span><span>(</span><span>tenantId</span><span>);</span>
        <span>if</span> <span>(</span><span>tenant</span> <span>==</span> <span>null</span> <span>||</span> <span>!</span><span>tenant</span><span>.</span><span>isActive</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>TenantNotFoundException</span><span>(</span><span>tenantId</span><span>);</span>
        <span>}</span>
        <span>String</span> <span>encryptedPassword</span> <span>=</span> 
                <span>encryptService</span><span>.</span><span>encryptedValue</span><span>(</span><span>passwod</span><span>);</span> <span>// 암호화 책임도 도메인 서비스?</span>
        <span>User</span> <span>user</span> <span>=</span> <span>userRepository</span><span>.</span><span>findByTenantAndUsernameAndPassword</span><span>(</span>
            <span>tenant</span><span>,</span> <span>username</span><span>,</span> <span>encryptedPassword</span><span>);</span>
        <span>if</span> <span>(</span><span>user</span> <span>==</span> <span>null</span> <span>||</span> <span>!</span><span>user</span><span>.</span><span>isEnabled</span><span>())</span> <span>{</span>
            <span>throw</span> <span>new</span> <span>UserNotFoundException</span><span>(</span><span>username</span><span>);</span>
        <span>}</span>
        <span>return</span> <span>user</span><span>.</span><span>userDescriptor</span><span>();</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

분리된 인터페이스가 꼭 필요할까

<p>다형성이 요구되지 않는다면 굳이 분리된 인터페이스는 필요하지 않다고 본다.
다형성 등으로 인한 추상화가 요구될 때 분리된 인터페이스로 리팩토링 하자</p>

<p>생각 : 구현클래스에 Impl 접미사를 붙이는 것은 가능하면 피하는 것이 좋다고 본다.</p>

<p>DI 프레임워크(ex:Spring)를 사용하면 분리된 인터페이스를 사용하기 더 편하다.</p>

계산 프로세스

<p>생각: 계산(연산)은 변하지 않는 행동이므로 <em>분리된 인터페이스</em>는 필요하지 않다.</p>

<p>대부분 경우 계산 프로세스를 <strong>정적 메서드</strong>로 해결하는 경향이 많다.
이는 잘못된 행동이며 계산이 도메인 로직을 표현한다면 당연히 도메인 모델 내에 <strong>도메인 서비스로써 존재</strong>해야 한다.</p>

<p>참고: p.369 ~ 371 소스코드</p>

변환 서비스

<p>타 서비스와 통합을 위해 사용</p>
<ul>
  <li>이것도 <em>도메인 서비스</em>였다니</li>
</ul>

<p>Adapter</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>saasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>UserInRoleAdapter</span> <span>{</span>
    <span>&lt;</span><span>T</span> <span>extends</span> <span>Collaborator</span><span>&gt;</span> <span>T</span> <span>toCollaborator</span><span>(</span>
            <span>Tenant</span> <span>tenant</span><span>,</span> <span>String</span> <span>identity</span><span>,</span> <span>String</span> <span>role</span><span>,</span> 
            <span>Class</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>collaboratorClass</span><span>);</span>
<span>}</span>
</pre></div></div>

<p>Translator</p>

<div><div><pre><span>package</span> <span>com</span><span>.</span><span>sasovation</span><span>.</span><span>collaboration</span><span>.</span><span>infra</span><span>.</span><span>services</span><span>;</span>

<span>class</span> <span>CollbaratorTransaltor</span> <span>{</span>
    <span>&lt;</span><span>T</span> <span>extends</span> <span>Collaborator</span><span>&gt;</span> <span>T</span> <span>toCollaboratorFrom</span><span>(</span>
            <span>String</span> <span>json</span><span>,</span> <span>Class</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>collaboratorClass</span><span>);</span>
<span>}</span>
</pre></div></div>

<p>생각: translator도 도메인 서비스 인가?</p>

도메인 서비스의 미니 계층 사용하기

<p>가능하면 미니 계층은 사용하지 말자 - 안티패턴!</p>

<ul>
  <li>하지만 필요하다면 특정 도메인만 제한적으로 사용하는 것도 좋다.</li>
</ul>

마무리

<ul>
  <li>도메인 서비스는 필요할 때 사용
    <ul>
      <li>남용하면 빈약한 도메인 모델화</li>
    </ul>
  </li>
  <li>무상태</li>
  <li>VS 애플리케이션 서비스</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvluAbWcG-2BU3j-2FPxQHfsN0S3uz-2Bt6VhJ35WV6suoMgZkQ-3D-3Dzter_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXu-2FouefCEgnkD7PSw4-2FTKpokxVLmkzYWDLUZoDFVKadL0jYK4DSH1Yn2VNnhcTQEft7ak6193QuE3SDitDT5Dwj4RxJgsOyqXkTo8S9UvQxF76dcQojevjGWhbpfgaC5SGMqxD7Ihu0ML4YD7OJ15wsqYmQYnYu2nj4yeM87jMaAssGa0k0C-2BuOlhQHORXH-2BVXmXA7mw5Uu77VLCIg4l3vw">IDDD 7장. 서비스</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUXBmc_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXu-2FouefCEgnkD7PSw4-2FTKpokxVLmkzYWDLUZoDFVKadL59XgR5FNMBxB4ccZ2j0nBzEx-2F-2Bf5MBfQLJzxBCtn-2B8iLjtnJRVxETreWp1NW5fmgpeeYt3KsKB0GklCRNrB3yk2gN3TSWcvlRh7b2IJI1IFtDMEXxte57qIrLyTtTtX5I2kPYmDXW7RDKcw5ER-2BO5841NL5dumDNGsspsiV8XnI">DevOOOOOOOOP</a> on May 18, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMOFOQvjQs-2BQKxQWqAf0URUTTjz5r2Gpm8oEWLexbdkJGiB-2BXmwoNJogZ0s2hu6wtA04YUsMLBZAyURf04MuxLWs6fDqboONdJ7cE1oksEPTtFBp8yhAyKQGtD3URPjyS99i-2Bg7paj-2BkOWdEP6jrbpgm0ax94QrohuZDtYYj6ZZUzam2inZ4PJwKThQGoIZozHC4MTSZG0PMiag9zLiOmLc4" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 6장. 값 객체</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003898.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3898</id>

    <published>2020-05-10T16:25:19Z</published>
    <updated>2020-05-10T16:25:19Z</updated>

    <summary> 가능한 엔터티 대신 값 객체를 사용해 모델링하도록 노력해야 한다. 특성만 신경 쓴다면 이를 값 객체로 분리하라. 특성의 의미를 표현하고 기능도 부여하자. 불변성. 식별자는 필요 없고, 설계의 복잡성을 줄여준다. 값의 특징 개념을 값으로 측정, 수량화, 설명 불변성(no side-effect) 개념적 전체...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p>가능한 엔터티 대신 값 객체를 사용해 모델링하도록 노력해야 한다.</p>

<blockquote>
  <p>특성만 신경 쓴다면 이를 값 객체로 분리하라. 특성의 의미를 표현하고 기능도 부여하자. 불변성. 식별자는 필요 없고, 설계의 복잡성을 줄여준다.</p>
</blockquote>

값의 특징

<p><strong>개념을 값으로</strong></p>

<ul>
  <li>측정, 수량화, 설명</li>
  <li>불변성(no side-effect)</li>
  <li>개념적 전체</li>
  <li>변경 대신 대치</li>
  <li>등가성(value equality:동등성)</li>
</ul>

<p><strong>유비쿼터스 언어로써 표현하는 값이어야함</strong></p>

측정, 수량화, 설명

<p>날짜와 시간, 나이, 통화, 주소, 도형, …</p>

불변성

<ul>
  <li>No Setter
    <ul>
      <li>하지만 완벽하진 않다. 방어 복사가 필요할 수 있음 (final일지라도 불변은 깨질 수 있다.)</li>
    </ul>
  </li>
</ul>

개념적 전체

<ul>
  <li>주소 = 우편번호 + 기본주소 + 상세주소</li>
  <li>돈 = 500(수량) + 달러(통화)</li>
</ul>

<p><em>Bad Case</em></p>

<div><div><pre><span>class</span> <span>ThingOfWorth</span> <span>{</span>    <span>// 가치 있는 것</span>
    <span>private</span> <span>String</span> <span>name</span><span>;</span>
    <span>private</span> <span>BigDecimal</span> <span>amount</span><span>;</span>
    <span>private</span> <span>String</span> <span>currency</span><span>;</span>
<span>}</span>
</pre></div></div>

<p><em>Good Case</em></p>

<div><div><pre><span>class</span> <span>ThingOfWorth</span> <span>{</span>    <span>// 가치 있는 것</span>
    <span>private</span> <span>ThingName</span> <span>name</span><span>;</span>         <span>// !!</span>
    <span>private</span> <span>MonetaryValue</span> <span>worth</span><span>;</span>    <span>// 가치</span>
<span>}</span>
<span>@Value</span>
<span>class</span> <span>MonetraryValue</span> <span>{</span>
    <span>private</span> <span>BigDecimal</span> <span>amount</span><span>;</span>
    <span>private</span> <span>Currency</span> <span>currency</span><span>;</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
ThingName으로 값 객체로 만들어서 name의 기능을 중앙화 시킬 수 있다. (도메인 로직을 안으로 품을 수 있음)</li>
</ul>

대체성

<p>값은 변경이 불가능하므로 값 참조를 다른 값으로 바꾸는 것을 말함</p>

<div><div><pre><span>FullName</span> <span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Myeongju"</span><span>,</span> <span>"Jung"</span><span>);</span>
<span>// ...</span>
<span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Jiwon"</span><span>,</span> <span>"M"</span><span>,</span> <span>"Jung"</span><span>);</span>
</pre></div></div>

값 등가성

<p>equals(), hasoCode()</p>

<p>엔터티로 설계된 개념이 식별자가 필요하지 않다면 <em>값 객체</em>로 모델링하자.</p>

부작용이 없는 행동

<blockquote>
  <p>만약 값객체에 행위가 없다면, 좋은 설계인지 의심하라</p>
</blockquote>

<ul>
  <li>Getter : No side-effect</li>
  <li>Setter : With side-effect</li>
</ul>

<div><div><pre><span>FullName</span> <span>name</span> <span>=</span> <span>new</span> <span>FullName</span><span>(</span><span>"Myeongju"</span><span>,</span> <span>"Jung"</span><span>);</span>
<span>// ...</span>
<span>name</span> <span>=</span> <span>name</span><span>.</span><span>withMiddleInitial</span><span>(</span><span>"M"</span><span>);</span>
</pre></div></div>

<div><div><pre><span>FullName</span> <span>withMiddleInitial</span><span>(</span><span>String</span> <span>middleName</span><span>)</span> <span>{</span>
    <span>return</span> <span>new</span> <span>FullName</span><span>(</span><span>this</span><span>.</span><span>firstName</span><span>,</span> <span>middleName</span><span>,</span> <span>this</span><span>.</span><span>lastName</span><span>);</span>
<span>}</span>
</pre></div></div>

<p><strong>값 객체의 매개변수로 값만 전달하자.</strong></p>

<ul>
  <li>만약 엔터티와 같은 가변성을 가지는 인자를 받는다면 <em>부작용이 발생할 가능성</em>이 생긴다.</li>
  <li>아니면 Getter만 제공하는 추상화된 인자를 받는 것도 좋은 방법이다. &gt; Entity에 Getter만 있는 인터페이스를 Mixin</li>
</ul>

<p><em>기본 언어 값 타입에는 도메인에 맞춘 부작용이 없는 함수를 할당할 수 없다</em></p>

<ul>
  <li>도메인적인 표현이 기본 언어 함수에서 제공할 수 있을리가 없다.</li>
</ul>

미니멀리즘으로 통합하기

<p><img src="http://www.plantuml.com/plantuml/svg/ROv12i8m44NtEKN8FZSeeQ482eeBqVsO35fC4qac2z7UNSqYjjBTCEy__cyJGQGyE7O7SuCByer5JpqzjBVQ64o9Fnddni7dEYQCl6bM9Q0K6wjbWdDm3X6e3tvYTFKVlkO9N4QbIc2i8PtfEiK_EoBG8ja5Y_6FZQpi4_lrGV16IYvqjnMp2Mo-voLbALy4fNoHr7BMehTvS6y0" alt="미니멀리즘으로 통합하기"></p>

<ul>
  <li>ACL 내에서는 조회용으로써 일부 특성과 행위가 요구된다.</li>
  <li>즉 Entity 전체가 필요한(순응자나 공유모델) 것이 아니라, 해당 컨택스트 내에서 어울리는 타입으로써 값 객체가 좋은 선택</li>
</ul>

값으로 표현되는 표준 타입

<p>표준 타입에는 Enum을 쓰는 것이 좋다</p>

<blockquote>
  <p>잘 이해가 안된다 ㅠㅠ</p>
</blockquote>

값 객체의 테스트

<ul>
  <li>클라이언트 관점에서 값 객체를 보는 것은 중요하다.</li>
  <li>불변성을 테스트 해야 한다.</li>
  <li>테스트를 통해서 도메인적 표현을 확인할 수 있어야 한다.</li>
</ul>

구현

<ul>
  <li>불변, 불변, 불변 (No Setter)</li>
  <li>
equals(), hashCode(), toString()
</li>
  <li>JPA를 위해서 빈 생성자는 필수 (PACKAGE 접근제어로 생성)</li>
  <li>보호절을 통한 불변식 강제</li>
</ul>

값 객체의 저장

데이터 모델 누수의 부정적 영향을 거부하라

<p>도메인 모델을 위해서 데이터 모델을 설계해야한다.</p>

ORM 구현

<p>오래된 내용이라서 SKIP. 이젠 <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3gfEAJrVvyA4EU8l4rY-2BcWYZ-2Bhx7sVw2u9iXRyDLXlRNLUGM1MO9MI34oh6a1bdt1g-3D-3DC8-6_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqFZg-2B38V7OzTYsM62FdA9SdrxIlw-2Bx-2B9wpS3eU-2F8SrooU8bDKiC5tP3PaVZPbqHzsVGkygErmM3pvia0YpRKMb3zYndd1cjpoR1wLLee176B9TQFPvUG9BlEfF-2FkUnyrbmvvnl3kISRNjKjZfp4SoKZoPU38wpliAoVbvawP1M0b">Spring Data Jpa</a>를 사용하자.</p>

마무리

<ul>
  <li>값 객체 특징, 사용, 구현</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvtwi9S9agaFQ6nZo9-2FOUI2IPJESJuybbAi7MQr7h5nz8w-3D-3DHYYT_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqA8y58Bm8SFGyCLojTzjg5CPSvc7zDgC8p7M-2FGnMz4ocmhIO2MNWTs3uFMEuG35QbJfAHfuD3QCgCBQWfeOKZ0vR-2BPUWZaLjjcMhG-2BmsmMaUsdyo41c06m0Esjzyv1YDWafaQMBl541sTV6DxPpl6xXVkgbhmrm9jiZfZ42TixpA">IDDD 6장. 값 객체</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUWS0r_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXsH1esry6YbRxoL4GdbMRmul1M5OnsyuhhipEDdvG7vqAKsLqz6eyKYcRQty6M5l032vFge6iLFYxkKKpd-2FOFCNdhznujFmqddFHfBElM5Zc5Ors4TCd7jG9MJJSLFTaE9kWbT6286DYLUaUKmU9fu8PvlwF-2FGI-2BiEyawWWzfHEkVV9XebfoT6lHrxtn2pQ1vp-2B-2FIsFp-2BouQ8BQBtt-2Fn-2BJb">DevOOOOOOOOP</a> on May 15, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMNuuRo8n5xSnCbndQ3Vtvazz-2B558F-2FKqA4l6AzY6eTC-2FtA7uk2zs-2BB4s2FhabAkcJsY34Mx0TUCm4a6wjxxlqbsVOiossAASUE7y-2FonNEyndZ3-2BNF5Skwm-2BPGGCSvfe0CPozaDHycliaGGywn7rXdO696Y5c5Ii4m1sESVV0Drzf08X85Dmn-2F-2B77BDYzXXkW7nIAwmXwi82YJ-2FPI2erIoU4" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 5장. 엔터티</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003897.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3897</id>

    <published>2020-05-10T16:25:18Z</published>
    <updated>2020-05-10T16:25:18Z</updated>

    <summary> 개발자는 도메인보다 데이터에 초점을 맞추려는 경향이 있다. 속성만 있고 행위는 없는 데이터홀더 엔터티를 사용하는 이유 Object + Identity = Entity + Life Cycle(Mutable:가변성) 비즈니스 관계자는 보통 근사한 데이터베이스 테이블 편집기를 개발하는 데만 너무 많은 노력을 들인다. 올바른 도구를 선택하지...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <blockquote>
  <p>개발자는 도메인보다 <strong>데이터</strong>에 초점을 맞추려는 경향이 있다.</p>
</blockquote>

<p>속성만 있고 행위는 없는 데이터홀더</p>

엔터티를 사용하는 이유

<p>Object + Identity = Entity + Life Cycle(Mutable:가변성)</p>

<p>비즈니스 관계자는 보통 근사한 데이터베이스 테이블 편집기를 개발하는 데만 너무 많은 노력을 들인다.
올바른 도구를 선택하지 않았다면 공들여 다룬 CRUD 기반 솔루션의 비용은 너무 커진다.
CRUD가 타당한 선택일 때가 Django, RoR등과 같은 언어 및 프레임워크가 비로소 합리적일 수 있는 순간이다.</p>

<p><strong>하지만 대부분의 엔터프라이즈 애플리케이션에서는 Entity가 좋은 선택이다.</strong></p>

고유 식별자

사용자가 식별자를 제공한다.

<p>자연키</p>

<ul>
  <li>변경될 가능성이 크고, 사용자를 신뢰하기 힘들다.</li>
</ul>

애플리케이션이 식별자를 생성한다.

<p>UUID, Random, Timestamp NanoSeconds, …</p>

<p><strong>읽을 수 있는 식별자</strong></p>

<p>APM-P-08-14-2012-F36AB21C : 2012년 08월 14일에 생성된 애자일프로젝트관리(APM)의 Product(P)</p>

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Product</span> <span>{</span>
    <span>private</span> <span>ProductId</span> <span>productId</span><span>;</span>

    <span>public</span> <span>Date</span> <span>creationDate</span><span>()</span> <span>{</span>
        <span>return</span> <span>productId</span><span>.</span><span>creationDate</span><span>();</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>개인적으로 위 패턴을 선호하지 않는다.</li>
  <li>대리키를 사용하고 표현이 필요한 코드는 따로 Unique 값으로 하는 것이 좋은 것 같다.</li>
</ul>

영속성 메커니즘이 식별자를 생성한다.

<p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3queSeKG5Hy0VdOGIxyiEWOAWL10pbjxohLnfkDae35D-2FqAm7bv8VV4j0J65lF-2FTjK8qrXkzuEY3A-2FMxafofgStAeQDxC5QqAh6pjOoiCaXtHnhw_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXux7mY3kcEdufXCFVoES8roufYm-2FjP3JVZ4rqHGSSylkMcO5S7zXMgFnPVSWeocJvNTv7aXQR8rHl1tV974d73vBpDFTEKjbpoAIZsT3z6LYAAAWfbty-2BIpnos8BamDq9wquBAYl-2BEFN89eLinJVDKK0PhqMTLwPSqcjGMJI7zkct6WBL1GJ-2Fd88vCcrdTX8ZSaBK3gHGInooumbvzM2UetyxsEz4EHuhaW1R0-2Fbufq-2BA-3D-3D">JPA @GenerationType</a></p>
<ul>
  <li>AUTO, IDENTITY, SEQUENCE, TABLE</li>
</ul>

또 하나의 바운디드 컨텍스트가 식별자를 할당한다.

<p>SKIP : 비추천</p>

식별자 생성의 시점이 문제가 될 때

<p><strong>식별자 생성 시점</strong></p>
<ol>
  <li>
Repository에 <strong>저장 후</strong> 식별자가 생성</li>
  <li>
Repository에 <strong>저장 전</strong> 식별자가 생성</li>
</ol>

<p><strong>저장 후 식별자 생성 시 부작용</strong></p>
<ol>
  <li>
<strong>도메인 이벤트</strong>를 발행하는 경우 식별자가 있어야지 정확히 발행 가능 : <em>문제 없음 - 아래 코드 참조</em>
</li>
  <li>
Set에 추가할 시 다른 식별자와 같아질 수 있음 : <em>문제 없음 - 충돌가능성 없음</em>
</li>
</ol>

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Product</span> <span>{</span>
    <span>@Id</span> <span>@GeneratedValue</span>
    <span>Long</span> <span>id</span><span>;</span>
    <span>String</span> <span>name</span><span>;</span>

    <span>Product</span><span>(</span><span>String</span> <span>name</span><span>)</span> <span>{</span>
        <span>...</span>
        <span>this</span><span>.</span><span>registerEvent</span><span>(</span><span>new</span> <span>ProductCreatedEvent</span><span>(</span><span>this</span><span>))</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>위 코드 처럼 이벤트를 발행해도 구독 시점에는 id속성이 할당되어 있어서 문제없이 이벤트 처리됨</li>
</ul>

<blockquote>
  <p>저자는 빠른 식별자 할당을 선호한다고 했지만, 현재 기술 상으로 <strong>지연 할당도 전혀 문제 없다.</strong></p>
</blockquote>

대리 식별자

<p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3queSeKG5Hy0VdOGIxyiEWOAWL10pbjxohLnfkDae35D-2FqAm7bv8VV4j0J65lF-2FTjK8qrXkzuEY3A-2FMxafofgStAeQDxC5QqAh6pjOoiCaXtEQVR_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXux7mY3kcEdufXCFVoES8roufYm-2FjP3JVZ4rqHGSSylkD1IAsGzN3o5dhkfIGFC57EcN3glT-2F27xrpo8NRH8m3WF9zIkcVPIvZHnnQ-2BXbGylNKiROfXVTQaEXvYMwHjMILin6BZ5NTXVX2jYqWMWwMk8TVaFKWyWcFakqg27PS-2FoZLwPm8Wo9IkoWevzr4TRbLthEykSDOudfu9bs-2FZB7L9wLL6xnEPnFSYklHo57bT4g-3D-3D">JPA @GenerationType</a></p>
<ul>
  <li>AUTO, IDENTITY, SEQUENCE, TABLE</li>
</ul>

<p>== 영속성 메커니즘이 식별자</p>

식별자 안정성

<p>수정 불가(값 객체), 엔터티 수명주기 동안 안정적으로 유지</p>

<ul>
  <li>식별자 Setter를 제거한다.</li>
  <li>식별자 Setter가 존재하면 유효성 체크를 강화한다. &gt; 하지만 대리키를 사용해서 Setter가 존재하지 않는 것이 나은 것 같음
</li>
</ul>

<p><strong>나는???</strong></p>
<ul>
  <li>왠만하면 단일 대리키를 사용한다. = 식별자 생성 지연</li>
  <li>식별자는 Getter만 사용한다.</li>
  <li>다른 접근이 요구되면 Unique 키로 보조한다.</li>
</ul>

엔터티 발견과 그들의 내부적인 특성

<p>데이터 중심 모델 &gt; Getter + Setter &gt; 무기력한 도메인 모델</p>

<p><strong>엔터티 발견</strong></p>

<p>유비쿼터스 언어로 도메인 전문가와 대화하면서 나오는 개념들</p>

<p>하지만</p>
<ul>
  <li>명사(이름) : 엔터티</li>
  <li>동사(행위) : 메서드</li>
</ul>

<p>위처럼 단순하게 뽑아낸다고 생각하면 <strong>실수하는 것이다.</strong></p>

<p>결국에는 도메인에 대한 토론을 통해 <strong>지식 탐구</strong>와 <strong>정제</strong>를 거쳐야지 깊은 도메인 모델을 얻을 수 있다.</p>

엔터티와 속성을 알아내기

<p><em>Example : User</em></p>

<ul>
  <li>사용자는 테넌시와 관련이 있고 테넌시의 제어를 받는다.</li>
  <li>시스템의 사용자는 반드시 인증돼야 한다. : Need 검색</li>
  <li>사용자는 이름과 연락처를 비롯한 개인정보를 갖고 있다.</li>
  <li>사용자의 개인정보는 사용자나 관라자에 의해 변경될 수 있다. : 값 객체?</li>
  <li>사용자의 보안 인증(비밀번호)은 변경될 수 있다.</li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWX9pKlCAr6miN7DAyaigRIpWug75gSM8OiwfEQb07K10000" alt="앞선 발견에 따른 Tenant와 User라는 두 개의 엔터티"></p>

<p>그림 5.5 앞선 발견에 따른 Tenant와 User라는 두 개의 엔터티</p>

<p><em>추가 스팩</em></p>

<ul>
  <li>테넌트는 초대를 통한 많은 사용자의 등록을 허용한다.</li>
  <li>테넌트는 활성화될 수 있고, 비활성화될 수도 있다.</li>
  <li>시스템의 사용자는 반드시 인증돼야 하지만, 테넌트가 활성화되니 경우에만 인증이 가능하다.</li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEIImkLWX9pKlCA_5CKR2n2KlCAKsriqEH00gxvfLabbJQsIbKSoaev2Ncfbef19SKPUQbSzL2bOOMfnQXAom5YY4h1WeL0DMMvnUb8EdFooz9LKZABod9pxLIUBspvVM6XjUREjxEsF6wQuh2cwbJWAotCwUydZ3dTVSIBeHJTNMXpaCH0xk3oo4rBmNeFG00" alt="엔터티가 발견해서 이름 지은 후에는 이를 고유하게 식별하고 찾을 수 있도록 해주는 속성을 알아내자"></p>

<p>그림 5.6 엔터티가 발견해서 이름 지은 후에는 이를 고유하게 식별하고 찾을 수 있도록 해주는 속성을 알아내자</p>

<p><em>확인 스팩</em></p>

<ul>
  <li>테넌트 : 식별자와 엑세스 서비스와 그 밖에 다른 온라인 서비스의 명명된 조직적 구독자, 초대를 통해 사용자를 등록</li>
  <li>사용자 : 테넌티 내에 보안 주체. 고유 사용자명과 암호화된 비밀번호를 가진다.
    <ul>
      <li>
SecurityPricipal : 인증 주체 값 객체 - 추후에 알아보자</li>
    </ul>
  </li>
  <li>암호화 서비스 : 암호화, 복호화</li>
</ul>

필수 행동 파헤치기

<p><em>Tenant의 스팩</em></p>

<ul>
  <li>테넌트는 활성화되거나 비활성화될 수 있다.</li>
</ul>

<div><div><pre><span>@Entity</span>
<span>class</span> <span>Tenant</span> <span>{</span>
    <span>void</span> <span>activate</span><span>()</span> <span>{</span>
        <span>// TODO 구현</span>
    <span>}</span>
    <span>void</span> <span>deactivate</span><span>()</span> <span>{</span>
        <span>// TODO 구현</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/svg/LSw_2i903CVn_PuYemvz0Ib77HoS_RE7NgY1QuRaLq74T_T4GJf-VXc-6GBiMEQQnieHT1PZmx5Gtr-vBfBpwj3cWq7no9cUYSXubXsTu6fJ8u_GEqCssuOYAshiF_p2PTA0-2N4s_1A_sxdEjtG_O9f42ljlJS0" alt="테넌트에 필수적인 행동 추가"></p>

<p>그림 5.7 테넌트에 필수적인 행동 추가</p>

<ul>
  <li>
activate() : 테넌트 활성화</li>
  <li>
deactivate() : 테넌트 비활성화</li>
  <li>
isActive() : 사용자는 <em>테넌트가 활성화된 경우</em>에만 인증이 가능하다.
    <ul>
      <li>인증을 위해 AuthenticationService가 필요</li>
    </ul>
  </li>
  <li>
registerUser() : 테넌트는 초대를 통해서 <em>사용자 등록</em>을 허용한다.</li>
</ul>

<p><em>User의 스팩</em></p>

<ul>
  <li>사용자는 이름과 연락처를 비롯한 개인정보를 갖고 있다. : Person Entity 분리</li>
  <li>사용자의 개인정보는 사용자나 관리자에 의해 변경될 수 있다. : change?()
</li>
  <li>사용자의 보안 인증(비밀번호)은 변경될 수 있다. : changePassword()
</li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/RP2zIWH148JpUOeEDTWNE8xXG0mk4S6VlDrjpuNTRfdfHKGE30n44uCL50nz037IPnhl7Umx1svXpOQlcggQcaN5e5tRkBB16E6O65dd5KodfzXqv7qMJY85W_kijLvx3pSEe3F6sD84ZZJKl31qQRTN4ge1AY-G5tIOXPtTBQ8GXR4vC8j_y9wmOgbpFfVGejR2ThHqB4fm9ghIJY1ztwMFs_HvlthvIWyz_3ptzbgzzkdfBJs-v-v_ZeFscOyJHjzUTnl0xJn5iPd4RNOfVCvmEQemCdOVgcjZDoEkRFjV" alt="User 상세 모델링"></p>

<p>그림 5.8 User 상세 모델링</p>

역할과 책임

<p><strong>어떤 설계를 하더라도, 유비쿼터스 언어가 기술적 선호보다 항상 우위에 서도록 하자. DDD에서는 비즈니스 도메인 모델이 가장 중요하다.</strong></p>

생성

<p>고정자(Invariant:불변식)을 지킨다. &gt; 엔터티의 전체 수명주기에 걸쳐 트랜잭션적 일관성이 유지돼야 하는 상태</p>

<p>복잡한 엔터티 생성을 위해서 Factory를 사용한다.</p>

유효성 검사

<ul>
  <li>특성 : 불변?</li>
  <li>속성 : 가변?</li>
</ul>

<p>DBC(Design By Contract) : 계약의 의한 설계</p>

<ul>
  <li>Pre condition, Post condition, Invariant로 설명</li>
  <li>하지만 Java 등의 언어에서는 보호절로써 처리함 : 방어적 프로그램</li>
</ul>

<p><strong>유효성 체크의 책임 DB가 아니라 도메인이 져야한다.</strong></p>

<ul>
  <li>유효성 검사의 책임이 너무 커지면 도메인 모듈(패키지)내 Validator 클래스 분리한다.</li>
  <li>with 명세 패턴, 전략 패턴</li>
</ul>

<p><em>유효성 체크 책임 위치</em></p>

<ul>
  <li>엔터티</li>
  <li>엔터티에서 분리된 Validator로 위임</li>
  <li>도메인 서비스</li>
</ul>

변화 추적

<p>가장 실용적인 변경 추적 : 도메인 이벤트 + 이벤트 저장소 = 이벤트 소싱!</p>

<ul>
  <li>
<a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3jzp-2Bz4YkH-2FoIkuD5cRktoAxRvxKiRuhPDTWZ8UBUQVdb-2BkTcxwcuqqoekKXAipZyT-2FUoZU1dhtJ7vgJnxia9vKM5XvXmOpSN33w4YdRkx5CDzHD_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXux7mY3kcEdufXCFVoES8roufYm-2FjP3JVZ4rqHGSSylkF9PB8ZoIGHryfAvSGCjrAVw9IWxgQM9enDYFFbXR-2FKTMK51J4yzg0IUCEpM61-2FEVmTeLELrqp7uTGp0RoxQPDq4ggy5gOpKPqhicxnom7yyo9-2Ft6YpVqvWgGWo35RV-2BZLR6699Jg-2BIJbHzBHWsW-2BBOR2OwT-2BQpp0j9mROmZquqB1K1MkY4uYxUt1qFErghizA-3D-3D">Spring Data(Hibernate) envers</a>도 꽤 쓸만하다.</li>
</ul>

마무리

<ul>
  <li>식별자</li>
  <li>유비쿼터스 언어를 바탕으로 엔터티 모델링</li>
  <li>엔터티 구성, 유효성 검사, 변경 추적 등 구현</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuLaWHh-2FE-2BcJIputXz5LzMhD4AHZ-2B3DTqrOrwHmDm47ag-3D-3D_lg5_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXux7mY3kcEdufXCFVoES8roufYm-2FjP3JVZ4rqHGSSylkIh-2Brk3-2BhtvnKGjycdIRUJ-2Beexhz8olonClPMBruoQAeny5R1AEqGQYQfItbcwvjk5J8FsU8dXSAj3TSypIaJyY-2FGxi6cqCHYK3ThmHr1xLKH5xUX0HCVKxoi6-2B8U481Nek7VC8vHkBWWzIUVow7v8fuhEifhV8qnF-2FFqOiRJixz04PIcdBKZNIHf60BPKnkJA-3D-3D">IDDD 5장. 엔터티</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUTCGC_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXux7mY3kcEdufXCFVoES8roufYm-2FjP3JVZ4rqHGSSylkKDVLHCjCV-2BZoALjL87TgfvvYQMzW3b0CzMTskAyByWmGYuTIDaZbeWaeE3GR5ytrKgoDz1bfHXxOqMwOJ4BhqzxYO-2FjseCcbsZB17gPZVhMbk4gN3mdZEVFKWrM-2BZIu3kcMnRTaKiqcSwhJ4j8SyRp3wWz-2BWZThw4RSaSFNaFO052ZiL1G2QmciUQ9mPdvhfg-3D-3D">DevOOOOOOOOP</a> on May 10, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMP1QpIxIopd7ehxyjCK4MkIYdKnx2mi1ID88tZnORQI-2FRDLgPR2is1TD6-2FZ-2Bni-2BntsItkgcwiN8iD4JaaVAyDH9Vyk7w7ncsGR7Qr-2BWVRZaQ3Fsx-2Fl-2FgVB5zXBKkJmAYAbqWW7sW3-2FHcugOa6JesU5hd-2F8bVfISVQnb7H2MMhs1vZkV30RDiMdfZOl7jxBHoJeQ7LBcqtB25D-2FnZiM5I-2BgL-2Fn8Vx74-2BxyUoQ-2F6fD9ijBw-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 4장. 아키텍처</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003896.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3896</id>

    <published>2020-05-10T16:25:17Z</published>
    <updated>2020-05-10T16:25:17Z</updated>

    <summary> 실제 요구(도메인)가 아키텍처 스타일과 패턴의 사용을 유도해야 한다. 도메인이 기술 보다 먼저다. 성공한 CIO와의 인터뷰 Server-Client Architecture 계층형 아키텍처 DIP, QP, PSA, DDD-Lite 헥사고날 아키텍처 To Mobile, Cloud CQRS Materialized Views Event-Driven Architecture Pipeline + Filter Saga 패턴 Long-lived...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <blockquote>
  <p>실제 요구(도메인)가 아키텍처 스타일과 패턴의 사용을 유도해야 한다.</p>
</blockquote>

<ul>
  <li>도메인이 기술 보다 먼저다.</li>
</ul>

성공한 CIO와의 인터뷰

<ol>
  <li>Server-Client Architecture</li>
  <li>
<strong>계층형 아키텍처</strong>
    <ul>
      <li>DIP, QP, PSA, DDD-Lite</li>
    </ul>
  </li>
  <li>
<strong>헥사고날 아키텍처</strong>
    <ul>
      <li>To Mobile, Cloud</li>
    </ul>
  </li>
  <li>
<strong>CQRS</strong>
    <ul>
      <li>Materialized Views</li>
    </ul>
  </li>
  <li>Event-Driven Architecture
    <ul>
      <li>Pipeline + Filter</li>
    </ul>
  </li>
  <li>Saga 패턴
    <ul>
      <li>Long-lived transaction as a sequence of subtransactions.</li>
      <li>In a distributed system</li>
    </ul>
  </li>
  <li>이벤트 소싱
    <ul>
      <li>모든 변경을 추적 (ex: 보안 감사 등)</li>
    </ul>
  </li>
</ol>

<p><strong>이러한 아키텍처 덕분에 결국 회사에 돈이 된다</strong></p>

계층

<p><img src="https://i0.wp.com/www.ajlopez.com/images/articles/dddlayered.png" alt="DDD Layred Architecture"></p>

<p>그림 4.1 DDD가 적용된 전통적인 계층 아키텍처</p>

<p>[출처] https://ajlopez.wordpress.com/2008/09/12/layered-architecture-in-domain-driven-design/</p>

<ul>
  <li>도메인 모델과 비즈니스 로직을 도메인 계층에 격리</li>
  <li>하위 계층에만 의존 - <strong>아래에서 위쪽으로 직접 참조 불가</strong> (하지만 Observer 사용 가능)
    <ul>
      <li>느슨한 연결 : UI가 애플리케이션(바로 하위) 뿐만 아니라 도메인이나 인프라에도 의존 가능</li>
    </ul>
  </li>
</ul>

UI 계층

<ul>
  <li>View나 API 제공</li>
  <li>도메인 모델이 아닌 표현 모델(DTO)를 사용 추천</li>
</ul>

애플리케이션 계층

<p>UI로 부터 매개변수를 받아 리파지토리를 사용해 애그리게잇을 획득하고, 커맨드를 위임</p>

<ul>
  <li>보안과 트랜젝션 담당 (일반적으로 보안을 UI로 올리는 것 같음)</li>
  <li>도메인 로직 없으며 도메인 모델(애그리게잇, 도메인 서비스 등)에 위임</li>
  <li>도메인 모델에서 발행한 도메인 이벤트를 구독(subscribe)</li>
</ul>

<div><div><pre><span>@Transactionl</span>
<span>void</span> <span>commitBackLogItemToSpring</span><span>(</span>
        <span>String</span> <span>aTanantId</span><span>,</span> <span>String</span> <span>aBackLogItemId</span><span>,</span> <span>String</span> <span>aSprintId</span><span>)</span> <span>{</span>
    <span>// 재료(Aggregate) 준비</span>
    <span>BacklogItem</span> <span>backlogItem</span> <span>=</span> 
        <span>backlogItemRepository</span><span>.</span><span>backlogItemOfId</span><span>(</span><span>aTanantId</span><span>,</span> <span>aBacklogItemId</span><span>);</span>
    <span>Sprint</span> <span>sprint</span> <span>sprintRepository</span><span>.</span><span>sprintOfId</span><span>(</span><span>aSprintId</span><span>);</span>
    <span>// 커맨드 위임</span>
    <span>backlogItem</span><span>.</span><span>commitTo</span><span>(</span><span>sprint</span><span>);</span>
<span>}</span>
</pre></div></div>

DIP

<blockquote>
  <ul>
    <li>상위 수준의 모듈은 하위 수준 모듈에 의존해선 안된다. 둘 모두는 반드시 추상화에 의존해야 한다.</li>
    <li>추상화는 세부사항에 의존해선 안 된다. 세부사항은 추상화에 의존해야 한다.</li>
  </ul>
</blockquote>

<p><strong>하위 구현 컴포넌트가 상위 콤포넌트가 정의한 인터페이스에 의존해야한다.</strong></p>

<p>어라 그러다 보니 계층이 없어진다. <strong>여기에 대칭성을 더하면 어떻게 될까?</strong></p>

헥사고날 또는 포트와 어댑터

<p><img src="http://alistair.cockburn.us/get/2304" alt="Hexagonal Architecture"></p>

<p><em>헥사고날 아키텍처</em></p>

<p>[출처] http://alistair.cockburn.us/Hexagonal+architecture</p>

<p><img src="https://camo.githubusercontent.com/440658bfd34094b4b705c40ae0517e0b00a0becb/68747470733a2f2f7777772e6e67696e782e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031352f30352f47726170682d30312d65313433313937383039303733372e706e67" alt="Texi handling Hexagonal Architecture"></p>

<p><em>Texi handling Hexagonal Architecture</em></p>

<p>[출처] https://github.com/seongminwoo/study/blob/master/7-part_series_about_microservices.md</p>

헥사고날의 장점

<ul>
  <li>기능적 요구사항에 따라 애플리케이션 내부를 설계
    <ul>
      <li>UI, Infra는 그 다음이다.</li>
      <li>애플리케이션 내부가 캡슐화 된다.</li>
    </ul>
  </li>
  <li>Adapter를 통해 기술과 분리</li>
</ul>

서비스 지향(SOA)

<p><strong>중요한 것은</strong> 기술 보다 비즈니스(도메인) 가치가 우선해야 한다</p>

REST: 표현 상태 전송

<p><img src="https://martinfowler.com/articles/images/richardsonMaturityModel/overview.png" alt="The glory of REST"></p>

<p>[출처] https://martinfowler.com/articles/richardsonMaturityModel.html</p>

RESTful HTTP 서버의 주요 특징

<ol>
  <li>Resource : URI</li>
  <li>Verbs : GET, POST, PUT, DELETE, …</li>
  <li>Hypermedia : 연결된 리소스를 제공. 상호작용, 클라이언트 무상태</li>
</ol>

RESTful HTTP 클라이언트의 주요 특징

<p>Hypermedia를 바탕으로 상호 작용한다.</p>

REST와 DDD

<p><strong>도메인 모델을 RESTful로 바로 노출하는 것은 좋지 않다.</strong></p>

<ul>
  <li>도메인 모델의 변경이 API와 연결되기 때문에 변경에 취약해지며, 클라이언트와 호환성이 깨진다.</li>
</ul>

<p><strong>해결책</strong></p>

<ol>
  <li>도메인 모델 -&gt; 표현 모델을 조립 (추천)
    <ul>
      <li>Assembler + DTO (PoEAA)</li>
    </ul>
  </li>
  <li>각 상황 별 공유 도메인 모델 사용
    <ul>
      <li>공유커널</li>
    </ul>
  </li>
</ol>

왜 REST인가

<p>느슨함</p>

CQRS

<p>사용자가 필요로하는 데이터 뷰를 리파지토리로 쿼리하기란 어려울 수 있다.</p>

<p>CQRS = 객체 설계 원칙 + CQS</p>

<ol>
  <li>Command : 객체의 상태를 수정, Void 형</li>
  <li>Query : 값을 반환, 수정 X</li>
</ol>

<p><strong>구현</strong></p>

<ul>
  <li>애그리게잇은 오직 커맨드 메소드만 가지고 있음.(커맨드 모델)</li>
  <li>쿼리를 위한 뷰 전용 모델(쿼리 모델)을 생성</li>
</ul>

CQRS의 영역 살펴보기

<p><img src="https://docs.microsoft.com/ko-kr/azure/architecture/guide/architecture-styles/images/cqrs-logical.svg" alt="CQRS Architecture"></p>

<p>출처 : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3kTPkIwU0diAv9PlDMizOhBCLxsE9SUiYU0lLl4k5nSi6BijYl2pffq8ThcQq0liTFJfoOYnLDHBCwWbtj99xIgOrAS2gLL2t02U-2FRz-2Fdy7PGP63_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQbH4tTVloFuL4r5DBaIIRhUkk9fOeQecQ9D1ApLFB40tDhfpmaNVQFhSF-2Fu5xR9gW8o-2FMe8Wy2FWu5qfrNgkOoxrfYryJE0NGNvdgvHV-2FmRixLJJvhx29caPBfzE5a9kOOYyo-2FIMHafLJ82HcnHPRmSKJstu92aJQP5tzXfHYsrHE8zqBbVh5V4VoRunZ9lJnA-3D-3D">https://docs.microsoft.com/ko-kr/azure/architecture/guide/architecture-styles/cqrs</a>
참고 : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3kTPkIwU0diAv9PlDMizOhBCLxsE9SUiYU0lLl4k5nSi6BijYl2pffq8ThcQq0liTFJfoOYnLDHBCwWbtj99xIgOrAS2gLL2t02U-2FRz-2Fdy7PNQqT_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQdQMMYU4NvSPzg8Gh9CqCKKZc8y18y4rZNnLcu33oKsmCHF45ilAgrwmBKKNYrIaCpKoEm9QTrGPVrkrXsHCMv5RQwMLcwZghnLXa1EoM2TMG9X400u3j-2BnjL7V2USFxlXJKFv8VZvSBLhnJDULWk9bd0bSkoERpzFd297naFplnAJ0Bwu1zDTI9pebfDrt-2BYQ-3D-3D">https://docs.microsoft.com/ko-kr/azure/architecture/patterns/cqrs</a></p>

클라이언트와 쿼리 처리기

쿼리 모델(읽기 모델)

<ul>
  <li>필요한 수 만큼 뷰를 지원하기</li>
  <li>실용적으로 하라</li>
  <li>데이터베이스 테이블 뷰가 오버헤드의 원인이 되지 않을까?</li>
</ul>

클라이언트가 커맨트 처리를 주도한다.

<p>UI to Argument</p>

커맨드 처리기

<ul>
  <li>카테고리 스타일 : 1 class n methods</li>
  <li>전용 스타일 : 1 class 1 method</li>
</ul>

커맨드 모델(쓰기 모델)은 행동을 수행한다.

<div><div><pre><span>public</span> <span>void</span> <span>commitTo</span><span>(</span><span>Sprint</span> <span>aSprint</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>DomainEventPublisher</span>
        <span>.</span><span>instance</span><span>()</span>
        <span>.</span><span>publish</span><span>(</span><span>new</span> <span>BacklogItemCommitted</span><span>(</span>
            <span>this</span><span>.</span><span>tenant</span><span>(),</span>
            <span>this</span><span>.</span><span>backlogItemId</span><span>(),</span>
            <span>this</span><span>.</span><span>sprintId</span><span>()</span>
        <span>));</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>어떤 경우든 쿼리 모델을 업데이트시키기 위해선 도메인 이벤트를 게시해야 한다.</li>
</ul>

이벤트 구독자가 쿼리 모델을 업데이트 한다.

<ul>
  <li>동기도 가능하고 <strong>비동기</strong>도 가능하다.</li>
</ul>

결국은 일관성이 유지되는 쿼리 모델 다루기

<blockquote>
  <p>Eventually consistent</p>
</blockquote>

<p>지연되는 뷰 데이터 동기화를 해결해야한다.</p>

<ul>
  <li>낙관적 업데이트 기법!</li>
  <li>클라이언트에서 publish/subscribe 기법</li>
</ul>

<p><strong>결국은 동기화되는 지연시간이 문제</strong></p>

이벤트 주도 아키텍처(EDA)

<blockquote>
  <p>이벤트의 생산, 감지, 소비와 이벤트에 따른 응답 등을 촉진하는 소프트웨어 아키텍처</p>
</blockquote>

<p>From <strong>도메인 이벤트</strong></p>

파이프와 필터

<p>$ cat phone_number.txt | grep 303 | wc -1</p>

<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3rZaL67kNbh8lgTFZ9SV4lMOmgFwwhqRl7oq9njuG12sYoAwH5NqJZSlD-2B7MprlzLg-3D-3DHHSb_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQYlw3iZCMwTcQvvNzVoWAVmA7AWIuhDkoPye5Ir0qWA4Qth6XzfQIoUtiAd5I71AqX02Myp0Y51Qg2qMw-2BcnanI0u1gagxKlPyhbvG35Fk3A6ZRSxc0iECRlikYp6ag5oXmqNnAu3P3YBagUsmJWEtc0gxt-2FUoUwHFYL0G0f61cYkDIp3dASCjU9m0OWwoPIlQ-3D-3D">Spring Cloud Data Flow</a></li>
</ul>

<p><img src="http://7u2mak.com1.z0.glb.clouddn.com/pipe-filter.jpg" alt="필터를 처리하는 이벤트를 보냄으로써 파이프라인이 만들어진다."></p>

<p>그림 4.8 필터를 처리하는 이벤트를 보냄으로써 파이프라인이 만들어진다.</p>

<p>[출처] http://zhangyi.farbox.com/post/coding/understand-scala-stack</p>

<p>이는 가상의 예제이자 개념적 부분을 강조했을 뿐이다. 실제 엔터프라이즈에선 큰 문제를 좀 더 작은 단계로 나누기 위해 이 패턴을 사용하며, 좀 더 쉽게 분산 처리를 이해하고 관리하도록 해준다.
또한 여러 시스템이 오직 자신이 할 일(도메인)만을 걱정하게 되게 해주기도 한다.</p>

장기 실행 프로세스

<ol>
  <li>컴포지트</li>
  <li>애그리게잇 집합</li>
  <li>이벤트</li>
</ol>

<p>역시나 중요한 것은 <strong>결과적 일관성</strong>(Eventual Consistency)</p>

Saga Pattern

<p><strong>Events/Choreography</strong></p>

<p><img src="https://blog.couchbase.com/wp-content/uploads/2018/01/Screen-Shot-2018-01-09-at-6.13.39-PM.png" alt="Saga Sequence"></p>

<p><strong>Rollback</strong></p>

<p><img src="https://blog.couchbase.com/wp-content/uploads/2018/01/Screen-Shot-2018-01-09-at-6.36.17-PM.png" alt="Saga Rollback"></p>

<ul>
  <li>referecne : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3o1-2FM-2BMFyWH-2BkgDGKfhnruOLBkREXg3c3C3JkDd0GqnvENHe5V-2FrL11Z13NGVFEELGQZGc81k45qtXFRj0b5QQ0ObSqTFHG6O0jdXrC7Sg453w6edmmpikAxyRYHt9YFtg-3D-3D9Ttt_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQShs3DL7o9mQV2Gs0oC5Xk14hrRW4vHNnakrSlFEq01O-2BkGxZGUJV-2FXDsR1foMKsgdav76DeSMjZPwlzW0Qv5q-2BeTEU9yedbcSCLEZhlUJSDzEAJF0RmqaF9yhkujTIqnRtfhAjwewaR-2FUTdjfx676RSvaBuqYNx4RKt7FyWK4QIMxXfuhwW-2BUj1qYpiUbXb2w-3D-3D">https://blog.couchbase.com/saga-pattern-implement-business-transactions-using-microservices-part/</a>
</li>
</ul>

이벤트 소싱

<p>거의 완벽한 수준의 변경 추적</p>

<p><img src="https://docs.microsoft.com/ko-kr/azure/architecture/patterns/_images/event-sourcing-overview.png" alt="이벤트 소싱"></p>

<p>[출처] <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3kTPkIwU0diAv9PlDMizOhBCLxsE9SUiYU0lLl4k5nSi5ypBz9-2ByHMYQP5aanVAyys9WlMHGA1BUXJeR3-2BqlpNP67ASgMlOqoFObPE0XHiD2bH27_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQXMeWkSpB6TMsoGMJGTsLslR7QVe-2BCscfaUIhuqtHwDpRIQ-2FyPFPox2rFtwQ-2Br9ZUoYCoqsq5-2FmVPTQE6tlOziiD4e3f-2FDXQ84SeQk-2FHy5LLP7elSSLI6oHz7mQ6FNWWrEJ0KeJpK7caVkwpEW4pZkI1bcd6sCE5Ap75MsIQoMMzGq1L2ovXRv8ddYFaMMtSoQ-3D-3D">https://docs.microsoft.com/ko-kr/azure/architecture/patterns/event-sourcing</a></p>

<p>Replay : 이벤트소싱에서 이벤트를 되감아서 특정 버전 상태로 되돌리는 것</p>
<ul>
  <li>하지만 최신 버전 Replay는 병목의 원인</li>
  <li>이를 해결하기 위해서 최신 버전의 상태를 <em>Snapshot</em>으로 지정해서 최적화</li>
</ul>

데이터 패브릭과 그리드 기반 분산 컴퓨팅

<p>분산 캐시</p>

<p>ex) <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3lV3XwYW3WBrpiWjViA0ejg-3DSWjH_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQV-2B8Op3Cvd56WhXBkgrzNRihzUD1qoZz72pOEiKBDJJCg1lMIzP9mmoYvhmxB97irP4kd9w-2F-2BewVx1Y-2BH2d7XU1rUbdqoCThWYq3ZHXbqziwnJTQHvv4Z8iR5GWt4bgZdO5QzjbSqBir3SOwmym08bDCyP-2FFb4LMxZlAeCXcmQc6bSl8aAzHsS-2Fvw6hCb5RfVA-3D-3D">hazelcast</a></p>

데이터 복제

<ul>
  <li>캐시 master/slave</li>
  <li>복제를 통한 장애 극복
    <ul>
      <li>이벤트 유실 제거 (이벤트 publish/subscribe도 가능)</li>
    </ul>
  </li>
</ul>

이벤트 주도 패브릭과 도메인 이벤트

<p>For Domain Event</p>

지속적 쿼리

<p>For CQRS</p>

분산 처리

<p>For Saga 또는 배치 병렬 처리</p>

마무리

<ul>
  <li>Layerd Architecture &gt; DIP &gt; Hexagonal Architecture</li>
  <li>SOA, REST, 분산 컴퓨팅</li>
  <li>CQRS, Event Sourcing, pipe/filter, Saga</li>
</ul>


    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvfJw8VFlLT-2FdXhHCuHSQPlqFm2EpbGPkdMrH9HTvnEtQ-3D-3DJUsz_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQd0vvrCUSQJV6G-2FwY5yv4O1lRgv2DJe-2FtXF8XRUZqOR47PLJXUSWJCqCCP-2ByKZKGRUHpN07cJz1vspZW92bBlJPdrSZ6pxPwfim7NaGnY4MKjho-2FTgDBq168iL-2FW6BAHWpAZ8J31yeMGCsHV57S0nNNG1Mfz5pQL49Y6Qsb8XteFuMxptC5PgxY2lUpsH8uP8Q-3D-3D">IDDD 4장. 아키텍처</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcU52iz_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXstBJjAqqFQdhyr5f9w23c1JEj2OGLORkGXnxxQor9pQfAk9RDOCuazHBzaeMEs2cJ7bhnDauHs4XdENgx0YpPLyOwuhIzp-2BbeRsLM0x9ylJdMvdmt0dIxhX-2B7dFpSTXixey-2BBBsvZOb1EvZ4x6Qyl5Ddv22WwiKXPoK3NYT1sB4NZA4nwgPG1XvZiYVPF0BuWAFQG7DtGhSo1xN6B-2FQgKZW0500u6GeCP0dx-2F6bKgfDQ-3D-3D">DevOOOOOOOOP</a> on May 08, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMXyeGTnm8w1sDb0VtjjGPgyOf30nf1-2BeIjBSw-2FbMS1enC50LbeL7zTnMvZI4UODDXs2ZX-2FYyjntrQeifgkQJ7QiiqIacLahz8r3Rd-2FvIddOjFTIpyxiUeeYhUCOSBOEccEb-2Bq-2BD3GswoNdg46oK0F3XrNooukBBiv0bma-2F-2FP9bWgyF8mgtj2Zw4QgQv-2Fcy0g6P09VxasCtwzFcCA3SQAPaPbAsfmxShppuY7a7oNPjNg-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 2장. 도메인, 서브도메인, 바운디드 컨텍스트</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003895.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3895</id>

    <published>2020-05-10T16:25:17Z</published>
    <updated>2020-05-10T16:25:17Z</updated>

    <summary> 서브도메인과 바운디드 컨텍스트로 전략적으로 설계해보자. 큰그림 서브도메인과 바운디드 컨텍스트의 활용 온라인 쇼핑몰 도메인 전자상거래 시스템 : 상품 카탈로그, 주문, 송장, 배송 서브도메인 재고관리 시스템 : 재고관리 외부 예측 시스템 : ? 제품 카탈로그, 주문, 송장, 배송 모델 등을 하나로...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <p>서브도메인과 바운디드 컨텍스트로 전략적으로 설계해보자.</p>

큰그림

서브도메인과 바운디드 컨텍스트의 활용

<p><img src="https://s3.amazonaws.com/media-p.slid.es/uploads/dragoshont/images/145866/Snap_2013-11-08_at_11.17.34.png" alt="서브도메인과 바운디드 컨텍스트를 포함한 도메인"></p>

<p>온라인 쇼핑몰 도메인</p>
<ul>
  <li>전자상거래 시스템 : 상품 카탈로그, <strong>주문</strong>, 송장, 배송 서브도메인</li>
  <li>재고관리 시스템 : 재고관리</li>
  <li>외부 예측 시스템 : ?</li>
</ul>

<p><em>제품 카탈로그, 주문, 송장, 배송 모델 등을 하나로 엮어서 복잡도가 높아지며 부정적인 결과를 초래</em></p>

<p><strong>소프트웨어의 관심사를 도메인을 바탕으로 분명하게 분리시켜야 한다.</strong></p>

<p>상호 의존성을 갖기 때문에, 서브도메인으로 나누지 않는다면 변화가 계속됨에 따라 훨씬 <strong>큰 부담</strong>을 지게 된다.</p>

<p>일반적으로 하나의 바운디드 컨텍스트에 하나의 서브도메인이 있는 것이 좋다. : 재고관리는 좋아 보인다.</p>
<ul>
  <li>물론 DSL이 포함되어야 한다.</li>
  <li>같은 언어일지라도 개념은 전혀 다를 수 있다.</li>
</ul>

핵심 도메인에 집중하기

<p><img src="/images/2016/04/IDDD-2.2.jpg" alt="서브도메인과 바운디드 컨텍스트를 포함하는 추상적인 비즈니스 도메인"></p>

<ul>
  <li>핵심도메인 : 주문</li>
  <li>지원 서브도메인 : 배송, 상품, 송장</li>
  <li>범용 서브도메인 : 회원(인증과 권한)</li>
</ul>

<blockquote>
  <p>결국 도메인 전문가와 소통으로 정제하는 것이 중요하다.</p>
</blockquote>

왜 전략적 설계가 엄청나게 필수적인가

<blockquote>
  <p>협업 개념이 사용자 및 권한과 강한 결합을 가지는 것이 옳은가?</p>
</blockquote>

<ul>
  <li>협업 개념에서는 회원은 그저 <strong>작성자</strong>일 뿐이다.</li>
</ul>

<p><img src="http://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKhEpot8pqlDAr5usx_czVmzI0AlDlMywPxpQaS3igAs1QyNBk0gI4pEJanFLQX6adhJjERDh9Llvar0Dc9RpzkfSxXgaPNDtVDcmLGCWJVpMbylMCh51N65WcvfWIwIYN2de4j0t8Ck2Z5IGJSblpmFLHnX5OOiijLGXoFiHHQ5MueGGhKH8OYm3atA8JKl1HZy0000" alt="팀이 전략적 설계의 기초를 이해하지 못했고, 이는 공동 모델에서 개념들이 잘못 찢어지도록 했다. 점선 안의 문제가 되는 요소들이다."></p>

<p>그림 2.3 팀이 전략적 설계의 기초를 이해하지 못했고, 이는 공동 모델에서 개념들이 잘못 찢어지도록 했다. 점선 안의 문제가 되는 요소들이다.</p>

<p>협업 도구는 <strong>사용자의 역할에 집중해야지,</strong> 사용자가 누구며 수행권한이 부여된 행동이 무엇인지에 관심이 있어선 안 된다. 하지만 위에서는 뒤섞여 버렸다.</p>

<ul>
  <li>
<em>포럼</em>은 단지 토론을 게시하고 싶은 <em>작성자</em>만 있으면 된다.</li>
  <li>사용자와 권한은 협업 컨텍스트에서 독립돼야 한다.</li>
</ul>

<p>Big ball of mud : 거대한 진흙공 - 빈약한 도메인으로 가득찬 모노리식 애플리케이션</p>

<p><strong>이런 사용자와 권한 서브도메엔을 범용 서브도메인이라고 한다.</strong></p>

<p>이윽고 팀이 비협업 개념의 또 다른 집합을 모델링하는 상황이 오면, 핵심 도메인은 더욱 불확실해진다. 
풍부한 협업의 유비쿼터스 언어를 제대로 소스 코드에 반영하지 못한 채, 이를 은영준에 내포하고 있을 뿐인 모델을 만들고 말 수도 있다. 
팀은 비즈니스 도메인과 그에 따른 서브데메인은 물론이고, 반드시 그들이 개발하고 있는 바운디드 컨텍스트도 제대로 이해해야한다.
이를 통해 전략적 설계를 가로 막는 비열한 적인 거대한 진흙공의 더러운 물을 막을 수 있다.</p>

현실의 도메인과 서브도메인

문제점 공간과 해결책 공간

<p>도메인은 문제점 공간(problem space)과 해결책 공간(solution space)을 모두 갖고 있다.</p>

<ul>
  <li>문제점 공간 : 새로운 핵심 도메인을 만들기 위한 전체 도메인의 일부 &gt; <em>핵심 도메인과 서브 도메인의 조합</em>
</li>
  <li>해결책 공간 : 해결책을 소프트웨어로 구현 &gt; <em>바운디드 컨텍스트</em>
</li>
</ul>

<p><strong>서브 도메인을 1:1로 바운디드 컨텍스트로 묶는 것은 좋은 목표이다</strong> 하지만 항상 그렇지는 않다.</p>

<p><img src="https://s3.amazonaws.com/media-p.slid.es/uploads/dragoshont/images/145864/Snap_2013-11-08_at_11.12.05.png" alt="구매나 재고관리와 관련된 핵심 도메인과 다른 서브도메인."></p>

<p>그림 2.4 구매나 재고관리와 관련된 핵심 도메인과 다른 서브도메인. 이 관점은 특정 문제점 공간 분석을 위해 선택된 <em>서브도메인으로 제한되며 전체 도메인에 적용할 수는 없다.</em></p>

<ul>
  <li>최적 매입 컨텍스트 = 핵심 도메인</li>
  <li>구매 컨텍스트 + ERP 구매 모듈 = 구매 지원 서브 도메인</li>
  <li>재고 관리 컨텍스트 + ERP 재고 모듈 = 재고 관리 지원 서브 도메인</li>
  <li>매핑 컨텍스트 : 범용 서브 도메인</li>
</ul>

<p><em>최적 매입 컨텍스트를 개발하는 회사 입장에서의 이런 핵심 포인트</em>를 살펴봤음을 기억하자.
지리적 매핑 서비스는 문제점 공간에서 재고관리 서브도메인의 일부로 간주하지만, 해결책 공간에서 재고관리 컨텍스트가 아니다.
매핑 서비스가 해결책 공간에선 간단한 컴포넌트 기반 API로 제공됐다 하더라도, 이는 다른 바운디드 컨텍스트다.
<strong>재고 관리와 매핑의 유비쿼터스 언어는 상호 배타적이며, 이는 두 요소가 서로 다른 바운디드 컨텍스트라는 의미다.</strong>
재고 관리 컨텍스트가 외부 매핑 컨텍스트의 어떤 부분을 사용하는 상황에서, 데이터는 적어도 최소한의 <strong>변환</strong>을 거쳐야만 적절히 사용될 수 있다.</p>

<p>한편 <em>구독자를 위해 매핑 서비스를 개발</em>하고 제공하는 외부 비즈니스 조직의 관점에서 보면 <strong>매핑은 핵심 도메인</strong>이다.</p>

<p>전략적 이니셔티브 : KPI를 달성하기 위한 핵심적인 활동이나 계획</p>

바운디드 컨텍스트 이해하기

<blockquote>
  <p>바운디드 컨텍스트는 그 안에 도메인 모델이 존재하는 <strong>명시적 경계</strong></p>
</blockquote>

<ul>
  <li>바운디드 컨텍스는 명시적이고 언어적이다</li>
</ul>

<blockquote>
  <p>컨텍스트가 왕이다. in DDD</p>
</blockquote>

<p><strong>모델의 중앙화, 범용화는 Evil 이다.</strong> 컨텍스트 별로 모델은 다른 의미를 가진다.</p>

<p><img src="https://www.codeproject.com/KB/architecture/1158628/2.png" alt="두 바인디드 컨텍스트 속 어카운트 객체는 의미가 서로 완전 다르지만, 각 바운디드 컨텍스트 안에서 고려해야만 그 사실을 알 수 있다."></p>

<p>그림 2.5 두 바인디드 컨텍스트 속 어카운트 객체는 의미가 서로 완전 다르지만, 각 바운디드 컨텍스트 안에서 고려해야만 그 사실을 알 수 있다.</p>

<table>
  
    <tr>
      <td>컨텍스트</td>
      <td>어카운트 의미</td>
      <td>예</td>
    </tr>
    <tr>
      <td>은행</td>
      <td>계좌</td>
      <td>적금 계좌</td>
    </tr>
    <tr>
      <td>문학</td>
      <td>이야기</td>
      <td>A Personal Account of Mt. Everest Disaster</td>
    </tr>
  
</table>

<p>모든 것을 빠짐없이 포괄하는 모델을 생성하려 시도하는 함정에 빠지며, 어디서든 통용되는 유일한 의미를 가진 이름의 개념에 대해 전체 조직이 모두 동의하는 결과를 목표로 삼는다.
이런 모델링 접근법에는 구멍이 있다.</p>
<ol>
  <li>모든 이해관계자로부터 모든 개념이 하나의 순수하고 구분된 글로벌한 의미를 갖는 것에 대해 동의를 얻기란 거의 불가능하다.</li>
  <li>
모든 사람을 함께 모으는 것은 절대 불가능하다. : 이건 좀 아닌 것 같음.</li>
</ol>

<p>최상의 선택을 위해선 언제나 차이점은 존재한다는 사실을 직시하고 ,바운디드 컨텍스트를 통해 차이점이 명확하며 잘 이해하고 있는 <strong>도메인 모델을 각각 기술해야 한다.</strong></p>

<p>1 바운디드 컨텍스트 != 1 프로젝트 아티팩트(산출물)</p>

<p><img src="http://static.olivergierke.de/lectures/ddd-and-spring/images/bounded-context1.png" alt=""></p>

<ul>
  <li>주문은 카탈로그 컨텍스트와 주문 컨텍스트에서 다른 모델로 표현된다.</li>
  <li>고객은 등록, 계정, 배송 컨텍스트 별로 다른 모델로 표현된다.</li>
</ul>

모델 그 이상을 위해

<p>아래 항목들도 바운디드 컨텍스트 경계 안에 있다.</p>

<ul>
  <li>Application Service : 보안 트랜젝션 관리 : 퍼사드</li>
  <li>UI</li>
  <li>Api Client : API 통합</li>
</ul>

<p><strong>안티패턴</strong></p>

<ul>
  <li>Smart UI</li>
</ul>

바운디드 컨텍스트의 크기

<p>= <strong>유비쿼터스 언어를 표현하기 위해 필요한 크기</strong></p>

<blockquote>
  <p>딱 내가 원했던 만큼의 음표들이 있었습니다. 더도 덜도 아닌</p>
  <ul>
    <li>모짜르트</li>
  </ul>
</blockquote>

<p><strong>잘못된 크기의 바운디드 컨텍스트를 만들게 되는 이유?</strong></p>

<ol>
  <li>아키텍처적 영향을 기준으로 삼는 경우(플랫폼, 프레임워크, 컴포넌트, 인프라 등)</li>
  <li>개발자 리소스(또는 팀)를 작업을 분배하기 위해</li>
</ol>

기술적 컴포넌트로 정렬하기

<p>com.mycompany.optimalpuchasing : bounded context</p>

<ul>
  <li>
com.mycompany.optimalpuchasing.prsentation : ui</li>
  <li>
com.mycompany.optimalpuchasing.application : application</li>
  <li>
com.mycompany.optimalpuchasing.domain.model : domain</li>
  <li>
com.mycompany.optimalpuchasing.infrastructure : infra</li>
</ul>

샘플 컨텍스트

<p><img src="https://www.safaribooksonline.com/library/view/implementing-domain-driven-design/9780133039900/graphics/02fig07.jpg" alt="완전히 서브도메인과 정렬된 바운디드 컨텍스트 샘플의 평가 관점">
그림 2.7 완전히 서브도메인과 정렬된 바운디드 컨텍스트 샘플의 평가 관점</p>

<blockquote>
  <p>출처 : https://www.safaribooksonline.com/library/view/implementing-domain-driven-design/9780133039900/ch02lev1sec5.html</p>
</blockquote>

협업 컨텍스트

<p><img src="http://www.plantuml.com/plantuml/svg/06y0208pKI4rpEskR_L8tD163T1536Up3Wxw3lM78GYo-K9C3reSW2C8euDkghRDj8VT_n2GH8YG_wTWwwvXROr3K8tpf4UtKY6CEiYDWcBtXOobUU4gvHZdtVicv453I441Ai05rbqeFrTJm6khXvGpcl_cvHA7gJwknxhSJI_1DDKqnePg6aveE5RmywnOwdNKZespkdEvdOt3tpNZzx7-WZ-JRVRP0egnVLoaPg0xLZHGQNqViVf0f4mA0g7caeEOqCN5oMka5e44FZLCHqg4FtNNmBZm1g3ixHn7ShB855vKuCrxLx0q0" alt="협업 컨텍스트"></p>

<p><em>before</em></p>
<div><div><pre><span>public</span> <span>class</span> <span>Forum</span> <span>extends</span> <span>Entity</span> <span>{</span>
    <span>public</span> <span>Discussion</span> <span>startDiscussion</span><span>(...)</span> <span>{</span>
        <span>// repository 의존</span>
        <span>User</span> <span>user</span> <span>=</span> <span>userRepository</span><span>.</span><span>userFor</span><span>(</span><span>this</span><span>.</span><span>tenantId</span><span>(),</span> <span>aUsername</span><span>);</span>
        <span>// 보안 로직</span>
        <span>if</span> <span>(!</span><span>user</span><span>.</span><span>hasPermissionTo</span><span>(</span><span>Permission</span><span>.</span><span>Foru</span><span>.</span><span>StartDiscussion</span><span>))</span>
        <span>//...</span>
        <span>// 열차 충돌</span>
        <span>String</span> <span>authorName</span> <span>=</span> <span>user</span><span>.</span><span>person</span><span>().</span><span>name</span><span>().</span><span>asFormattedName</span><span>();</span>
        <span>//...</span>
        <span>return</span> <span>newDiscussion</span><span>;</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
<strong>협업 보다는 보안을 염두함</strong> in 협업 컨텍스트</li>
  <li>전술적 패턴(DDD-Lite)으로는 해결 불가능. <strong>전략적 설계 컨텍스트 맵!!</strong>
</li>
</ul>

<p><em>열차사고</em></p>

<ul>
  <li>usr.person().name().asFormattedName()</li>
  <li>
<a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3kmgDwfuuQRKt7HX5HnBbrLSH0SK8yVW30e70JkGB8bbeU-2Fb5-2F8Ka3tfx3L8cvrxeQ-3D-3DmMxG_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXs07ceOstFsSzsPRrNI37zS1JGJH62lPfw5-2Ba-2BtQ9ZUDl6RYeoyoEVLY2uum6Ay6JQCPUWAzkfyRCKxZVMOvq0pn3Ts-2BlsVKvR2iH0n0Y5WvPTH9nb3QILFRKLHz2PkQsTyRh9OgQYApC-2BqDUdHjMSr-2FEWdaTMigolfLYUXbI4XKuo-2BNrV92RF6RxGKEAHXnFqKmfW0Bh2DGLy5DM0WxRkB">디미터의 법칙</a> 위배</li>
</ul>

<p>결론적 해결책을 통해 <strong>추가적인 전략적 설계를 사용해, 재사용 가능한 모델을 별도의 바운디드 컨텍스트로 분리하고 적절히 통합할 수 있게 됐다</strong></p>

<p><em>after</em></p>
<div><div><pre><span>public</span> <span>class</span> <span>ForumService</span> <span>{</span>
    <span>@Transactional</span>
    <span>public</span> <span>Discussion</span> <span>startDiscussion</span><span>(...)</span> <span>{</span>
        <span>Author</span> <span>author</span> <span>=</span> <span>this</span><span>.</span><span>colloboratorSrvice</span><span>.</span><span>authorFrom</span><span>(</span><span>tenant</span><span>,</span> <span>anAuthorId</span><span>);</span>
        <span>Discussion</span> <span>new</span> <span>Discussion</span> <span>=</span> <span>forum</span><span>.</span><span>startDiscussionFor</span><span>(...);</span>
        <span>//...</span>
        <span>return</span> <span>newDiscussion</span><span>;</span>
    <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Forum</span> <span>extends</span> <span>Entity</span> <span>{</span>
    <span>public</span> <span>Discussion</span> <span>startDiscussionFor</span><span>(...)</span> <span>{</span>
        <span>//...</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>
User와 Permission의 의존을 제거하고 모델을 엄격히 협업에만 집중하게 함 Author
</li>
</ul>

식별자와 엑세스 컨텍스트

<p>사일로 효과 : 연통 배관 : 상호 협력을 하지 않고 중복이 생기고 각각 따로 놀게됨</p>

<p><img src="http://www.plantuml.com/plantuml/png/06ue20CGlxfS_eGLPi5zfFHuLTrCtBw540-3VAr-Km3wVW6zk3OJeuQ_QDTUTYiHAAe3v67gG1PSHySDSjOwACHbt4eGlpy5xb2n9g5rIqUAEPxEVTKWGo1nl-uEkZhTYzORdrHqvKH1MaOY3pLxX5UlM4lfvKkLGZBi7g1GDfqsgFGYDgekUAeAfBvwf_uDIA4QZYb1HfRbcBqLkJ4OXN9_i6wIE97oXRholfAzI2-O73AFTBTHuGZM6Wj2nvd-OjLMWxy5CauIwTsR-wMNKhiBX5x7G3aePycFe0G00" alt="식별자 컨텍스트"></p>

<ul>
  <li>위에서 지적된 것 처럼 식별자 컨텍스트를 분리하고 범용 지원 도메인으로써 활용</li>
</ul>

애자일 프로젝트 관리 컨텍스트

<p><img src="http://www.plantuml.com/plantuml/svg/06_8201GXoQowhI_rXtR4OhCPifp3VuCtYFZprxnqF-INLxMafe6DVj9iyUZKVHx6bxf1mSIGZgu2tiSDPE5lnFRWAnn5FZ6VEuSkog4K37yHsDC9ml9QLAN1pwVjL2-6xxwaHMhULx2I32Geli348AS_mPk0xkbgIreveL3HHacdInonOTLGbfPvqAm82Tsp6xaDG9q-qeE9JRiPF791SvnubXGRhKYZC2gUyzbLxbOAoHnK48IdJBaivjeybCjr8G-Jt12xbR7_H9bnOe2J3WNoawhfXZfZTGC0" alt="애자일 프로젝트 관리 컨텍스트"></p>

<ul>
  <li>DDD 전략적 설계를 바탕으로 애자일 프로젝트 컨텍스트를 분리</li>
</ul>

<blockquote>
  <p>컨텍스트는 각 팀에게 아주 구체적인 의미를 부여한다.</p>
</blockquote>

마무리

<ul>
  <li>도메인, 서브도메인, 바운디드 컨텍스트</li>
  <li>문제점 공간, 해결책 공간</li>
  <li>모델을 구분(User vs Author)</li>
  <li>바운디드 컨텍스트의 크기</li>
  <li>사스오베이션 팀의 바운디드 컨텍스트 정제</li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvu6FNP6eAUIG59wY2poFg4Z6UwNKrMjo41VqmBByYybBA-3D-3DOH-f_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXs07ceOstFsSzsPRrNI37zS1JGJH62lPfw5-2Ba-2BtQ9ZUDjCsB2n43YRFA1BD82wmwPY05FGlkDbYlukJE5Qw1m0RvicJqtpaBi0m7Kzz3-2FXaXv5lWS0uB3a7SIi2UqOhX1XrN0qs2G4N653HOJKQMy0TdA4JZisaz6AfWTuHWE3Vw7S-2BN3DZn1t4EDkwULCkZi5rflJ2AcTnic3PUupMnC42">IDDD 2장. 도메인, 서브도메인, 바운디드 컨텍스트</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUz7jJ_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXs07ceOstFsSzsPRrNI37zS1JGJH62lPfw5-2Ba-2BtQ9ZUDsUMcQekwlGn-2B96eV78-2B-2FshakfLVGYNS-2BsVdKkfx0pROcsx3PmR3Ji8i-2F8PC-2FqDO9hd1nIL4gDxITbF7wIEcguSBiwW8Cx3t4Ug07sfyK6HXUB2coOp5ZxUibMBoGVAf-2BVtMdZ5K9jqvtPyBdOVWD474uEWF9-2FOl6gw2AThOczGg">DevOOOOOOOOP</a> on April 28, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMO1Ilatpkm1XJjboFp0WPF7EC39t-2B6am1vhbu-2BVezkagcz2AaVPgQTfXh4eeEORl4re-2Bv7X6U2wlmNZUCjUEaTElUqXmryTcmC9-2BhkThlaGVFWczabIDfb4yrrDDnpG82qQf0zcmrWbjUA3-2F8xq5S8C85KO-2Bw9-2FDgaTSKSXgeX0t-2BdrnyS8Aam56DWTkKWkCZYwThK4YWDYp2SkV-2BGe26CZ" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>IDDD 1장. DDD를 시작하며</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003894.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3894</id>

    <published>2020-05-10T16:25:16Z</published>
    <updated>2020-05-10T16:25:16Z</updated>

    <summary> 설계는 단순히 어떻게 보이고 느껴지는가에 관한 것이 아니다. 설계는 어떻게 동장하는가에 관한 것이다. 스티브 잡스 DDD는 우리가 높은 품질의 소프트웨어 모델을 설계할 수 있도록 해준다. DDD는 전략적인 동시에 전술적(DDD-Lite)인 모델링 도구 나도 DDD를 할 수 있을까? 학습 곡선이 있다!!...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    <blockquote>
  <p>설계는 단순히 어떻게 보이고 느껴지는가에 관한 것이 아니다. 설계는 어떻게 동장하는가에 관한 것이다.</p>
  <ul>
    <li>스티브 잡스</li>
  </ul>
</blockquote>

<p>DDD는 우리가 높은 품질의 소프트웨어 모델을 설계할 수 있도록 해준다.</p>

<p>DDD는 전략적인 동시에 전술적(DDD-Lite)인 모델링 도구</p>

나도 DDD를 할 수 있을까?

<p>학습 곡선이 있다!!</p>

<p><strong>DDD의 가장 중심에 있는 원리</strong></p>
<ul>
  <li>토의, 경청, 이해, 발견, 비즈니스의 가치</li>
  <li>모든 지식을 중앙화하는 모든 것</li>
</ul>

<p>DDD는 <em>객체지향적 방법</em>으로 엔터프라이즈 애플리케이션을 해결하는 방법</p>

<p>DDD는 MSA를 지향한다. Monolithic은 지양한다.</p>

<p>시니어 개발자 : <strong>이 조직은 내가 생각했던 것보다 파괴적 진보에 관심이 없더군요. 뭐 상관 없어요 나는 포기하지 않겠어요.</strong></p>

<p>도메인 전문가 : <em>유비쿼터스 용어로 소통하자</em></p>

내가 왜 DDD를 해야할까?

<p>개발자 &lt;- <strong>유비쿼터스 언어</strong> -&gt; 도메인 전문가</p>

<p><strong>설계는 코드이며, 코드가 설계다. 설계는 어떻게 작동하는가다.</strong> - Uncle Bob도 비슷한 말을 함</p>

<p><strong>옳은 소프트웨어 개발 접근 방식에 투자한다는 생각</strong></p>

DDD가 해줄 수 있는 일

<ul>
  <li>도메인 전문가와 개발자는 가까운 거리에서 유비쿼터스 언어로 소통하면서 협업해야 한다.</li>
  <li>기술보다는 도메인 가치가 우선이다.</li>
</ul>

도메인의 복잡성과 씨름하기

<p><em>핵심 도메인과 서브 도메인</em></p>

<p>ex) 커머스 솔루션에서 핵심 도메인은 결제이며, 서브 도메인은 배송이다.</p>

<blockquote>
  <p>DDD를 통해서 복잡화하지 말고 단순화하라</p>
</blockquote>

<p><em>Anemic Domain Model</em> : 빈약한 도메인 모델. 속성만 표현하는 단순한 데이타 홀더. 보통 <em>트랜잭션 스크립트</em>와 연결된다.
<em>Rich Domain Model</em> : 풍부한 도메인 모델. DDD를 통해서 도메인을 표현한 풍부한 행위를 가지는 모델</p>

<p>과거에는 객체 관계형 임피던스 부조화 때문에 <em>Anemic Domain Model</em>을 많이 사용하게 되는데, 이제 ORM이 대중화 되어서 할만하다!!</p>

왜 무기력(Anemic)증이 일어나는가?

<ul>
  <li>절차적 사고방식의 익숙함</li>
  <li>단순한 샘플코드를 참고</li>
  <li>비주얼 베이직 탓 : 클릭하고 드래그 앤 드랍 하면 프로그램이 만들어짐 - 이건 좀 ….</li>
</ul>

<p>Getter, Setter의 자바빈을 숨기는 여러 방법이 있었지만, 대부분 개발자는 그러려고 하지 않았거나, 왜 그렇게 해야 하는지 이해조차 하지 못했다. <strong>온통 무기력증</strong>이다.</p>

<p>일반적인 행위로 모든 상황(도메인 지식)을 커버하려 한다. 이것은 안티 도메인 모델이 된다.
코드로 말하면 Setter들의 향연이 벌어진다. <strong>그저 데이터 홀더일 뿐</strong>이다. -&gt; 무기력증</p>

<p>뷰를 위한 모델은 Getter, Setter로 구성되는 것이 좋다.(DTO 패턴) <strong>하지만 도메인 모델은 아니다.</strong></p>

<p>p.67 p.69 코드를 보면서 반성하자.</p>

DDD는 어떻게 하는가?

<p><strong>유비쿼터스 언어</strong> : 반운디드 컨텍스트 내에서 공유된 언어. <strong>도메인 전문가화 개발자 모두에 의해 개발되어 공유된 언어.</strong> - 서로 많이 이야기 하자.</p>

<p>ex) 간호사가 독감 백신을 표준 용량으로 환자에게 투여한다. : nurse.administerFluVaccine(patient, vaccine);</p>

<ul>
  <li>도메인 모델링 - 소프트웨어는 계속 진화한다. 모델 설계를 관리하지 말고 언제나 버릴 수 있어야 한다. 결국 <strong>코드가 설계</strong>이다.</li>
  <li>유비쿼터스 언어 용어집 만들기</li>
  <li>도메인 정제 (결국 많은 이야기를 해야한다)</li>
</ul>

<p>p.75 샘플로 도메인적 표현을 가지는 모델링을 생각해보자</p>
<ul>
  <li>가독성이 좋아졌다.</li>
  <li>도메인의 표현이 보인다.</li>
  <li>그리고 클라이언트 입장에서 테스트</li>
</ul>

DDD를 사용하는 데서 오는 비즈니스 가치

<p>부제 : <em>여러분의 상사에게 DDD를 파는 방법</em></p>

<ol>
  <li>조직이 그 도메인에 유용한 모델을 얻는다.</li>
  <li>정교하게 정확하게 비즈니스를 정의하고 이해한다.</li>
  <li>도메인 전문가가 소프트웨어에 설계에 기여한다.</li>
  <li>사용자 경험이 개선된다.</li>
  <li>순수한 모델 주변에 명확한 경계가 생긴다.</li>
  <li>엔터프라이즈 아키텍처의 구성이 좋아진다.</li>
  <li>애자일하고, 반복적이고 지속적인 모델링이 사용된다.</li>
  <li>전략적인 동시에 전술적인 새로운 도구가 적용된다.</li>
</ol>

DDD 적용의 난관

<ul>
  <li>유비쿼터스 언어 만들기
    <ul>
      <li>도메인 전문가와 소통</li>
    </ul>
  </li>
  <li>개발자의 사고방식 전환 : 기술 보다는 도메인이 먼저다.
    <ul>
      <li>객체는 속성(데이터)이 중요한 것이 아니라 행동이 중요하다.</li>
    </ul>
  </li>
</ul>

<p><em>가장 중요한 것은 팀 내 문화와 DDD의 학습곡선 인 것 같다.</em></p>

<p>p.83을 보면 도메인 전문가와 친해지는 법이 나오는 게 진정 이런게 <em>TIP</em> 이다.</p>

<p><em>Example 백로그를 스프린트로 커밋한다.</em></p>

<p><em>Anemic Domain Model</em></p>
<div><div><pre><span>backlogItem</span><span>.</span><span>setSprintId</span><span>(</span><span>sprintId</span><span>);</span>
<span>backlogItem</span><span>.</span><span>setStatus</span><span>(</span><span>BacklogItemStatusType</span><span>.</span><span>COMMITED</span><span>);</span>
</pre></div></div>
<ul>
  <li>행위가 원자적이지 않으며, 데이터 의존적이며, 불변식이 깨질 수도 있다.</li>
</ul>

<p><em>Rich Domain Model</em></p>
<div><div><pre><span>backlogItem</span><span>.</span><span>commitTo</span><span>(</span><span>sprint</span><span>);</span>
</pre></div></div>
<ul>
  <li>도메인의 표현이 드러나고 원자적이며, 행동이 캡슐화 되어 있으며, 도메인 모델 밖으로 로직이 세어 나가지 않는다.</li>
</ul>

<p>위 상태에서 아래와 같은 추가사항이 생길 시 어떤 방식이 더 기민하게 반응할 수 있을까?</p>

<div><div><pre>만약 백로그 항목이 이미 다른 스프린트로 커밋됐다면, 먼저 언커밋 해야한다. 커밋이 완료되면 이해 당사자에 알려라(도메인 이벤트)
</pre></div></div>

도메인 모델의 합리화

<p>어짜피 대부분의 엔터프라이즈 웹애플리케이션에서는 도메인 모델이 좋은 선택이라고 본다.</p>

DDD는 무겁지 않다.

<p>with TDD. 클라이언트 입장에서 도메인 모델을 구현하는 것은 큰 도움이 된다.</p>

가상 + 약간의 현실

<p>협업툴!!</p>

<p>가상의 프로로젝트를 진행하는 것으로 이야기를 풀어보자</p>

사스오베이션, 그들의 제품과 DDD의 사용

<ul>
  <li>콜랍오베이션 : SNS</li>
  <li>프로젝트오베이션 : ITS</li>
</ul>

<p>DDD-Lite(전술)를 이용함. 즉 바운디드 컨텍스트(전략)는 무시함.</p>

마무리

<ul>
  <li>복잡성 극복</li>
  <li>트랜잭션 스크립트의 단점</li>
  <li>
<em>Rich Domain Model</em>이 좋다.</li>
  <li>DDD 약팔이</li>
</ul>


    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuhbtM3BKmbdZXeWzZADIcOAOE-2BKrNhSRkKk0jg-2FZVLyQ-3D-3Dtc43_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuDosMYFUsG-2FRREzT-2B733HRhZwQssRAQ0CHyp84h1aPmug-2BpdaAF0tYS9ARES3DSWEJfXgMt3mAGAjH9fVDPX4Y-2ByrC8yMYlyfOkVXcaiRdmJK2bwZSFsFAqxViGapjt9x9lwktgjUj-2B3B6yJBftEVXw7-2FF4x-2FJ6tBrlGCTujTGvs-2B-2B955xYvpXoBKJZE-2F76-2FXRGTltrcnrC1kTe6TSJbDB8cbeFdFd5iFpwDRYxOQkig-3D-3D">IDDD 1장. DDD를 시작하며</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUM_Q9_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuDosMYFUsG-2FRREzT-2B733HRhZwQssRAQ0CHyp84h1aPmgFi-2B0GZTXp4nJwbuxOz3aTstAjtHDMD-2F5a-2FX8RZYzoVvos6qzHT6TpDKxKlT2wAT3YadsIS8nNIWEnySa1iYMEA5ioS7G6sddsZW0t6EEwntfeNh6Ybfu4zgKR9GGexJsIFWv-2B4T3KM5xvOZ3uHZoNVR0qWMOvkATYE7tsiavZDCH9Tw7MtD1QNHb6jgLyIXA-3D-3D">DevOOOOOOOOP</a> on April 27, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMPelQV-2B8s6LOySaCDuE1xlzTtg-2FCtVF-2F2Y42bmBSkitl-2BtahQ8RH5bF3H-2BDA-2BYtJmrf3fZfBoDPszBHwFn0mWKvvo5zlVCVKfo-2BstrzJ8Jv6EUYVM4cxn02LXGg6N-2BuvpIeGsWpOUNpSGAhywWeB-2BovWdPd47-2FWE05zV6ajbergS411Z-2FdPE8tBs5x9Dj-2FQgTSsYgmIiB73ZemLCSTfSElpTxTIaIKz5JbBTCua5zfIrw-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

<entry>
    <title>상속의 위험성</title>
    <link rel="alternate" type="text/html" href="https://weblog.youre.space/imyaman/2020/05/003893.html" />
    <id>tag:weblog.youre.space,2020:/imyaman//12.3893</id>

    <published>2020-05-10T16:25:15Z</published>
    <updated>2020-05-10T16:25:15Z</updated>

    <summary> ToC 동기 사전지식 LSP Practice Summary 동기 어느 날이었습니다. 팀 내에서 상속에 대한 이야기를 하다가 주니어가 그럼 상속은 어떻게 써야하는지 궁금해 했습니다. 그런데 이 상속의 위험성을 설명하려고 하니, 말로만 하기에는 부족한 것 같고, 그렇다면 worst-case 코드를 보여줘야 하는데 시간이...</summary>
    <author>
        <name>hal9000</name>
        
    </author>
    
    
    <content type="html" xml:lang="en-us" xml:base="https://weblog.youre.space/imyaman/">
        <![CDATA[

  
    
  
  
      
    ToC

<ol>
  <li><a href="#%EB%8F%99%EA%B8%B0">동기</a></li>
  <li><a href="#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D">사전지식</a></li>
  <li><a href="#lsp">LSP</a></li>
  <li><a href="#practice">Practice</a></li>
  <li><a href="#summary">Summary</a></li>
</ol>

동기

<p>어느 날이었습니다. 팀 내에서 상속에 대한 이야기를 하다가 주니어가 그럼 상속은 어떻게 써야하는지 궁금해 했습니다.
그런데 이 상속의 위험성을 설명하려고 하니, 말로만 하기에는 부족한 것 같고, 그렇다면 worst-case 코드를 보여줘야 하는데 시간이 없었습니다.
그래서 상속의 위험성에 대한 소스코드와 그것을 설명하는 블로그 아티클을 작성해야겠다는 생각이 들었습니다.</p>

사전지식

<ul>
  <li>Java 언어를 기본으로 설명합니다.</li>
</ul>

가변과 불변

<ul>
  <li>객체지향은 가변(mutable)을 캡슐화(또는 관리)해서 복잡성을 제어합니다.</li>
  <li>하지만 근본적으로 가변은 부수효과(side-effect)를 동반합니다.</li>
  <li>그래서 가능하면 가변을 최소화 하는 것이 유리합니다.</li>
  <li>이를 해결하기 위해서 불변(immutable)을 이용하는 것도 좋은 방법입니다.</li>
</ul>

접근제어자

<ul>
  <li>
public : 모두 접근 가능</li>
  <li>
protected : 자식 클래스와 같은 패키지 상에서 접근 가능</li>
  <li>
default(package) : 같은 패키지 상에서 접근 가능</li>
  <li>
private : 클래스 내에서만 접근 가능</li>
</ul>

<blockquote>
  <p>public, protected는 열려 있으며, default, private는 닫혀 있다. - Joshua bloch</p>
</blockquote>

<ul>
  <li><strong>접근제어는 가능한 닫혀 있는 것이 좋습니다.</strong></li>
  <li>
public field는 캡슐화되지 않으므로 <strong>Evil</strong>으로 규정합니다.</li>
</ul>

불변식(불변조건)

<p>클래스 불변식(Class Invariant)은 해당 클래스의 오브젝트가 가지는 제약사항을 말합니다.
즉 불변식이 깨지면 해당 객체는 <em>유효하지 않다고 봐야하며</em>, 애플리케이션 내 클래스의 계약을 위배했으므로, <em>문제를 발생시킵니다.</em></p>

<p>예를 들어서 분수를 나타내는 클래스가 있다고 가정해 보겠습니다.</p>

<div><div><pre><span>class</span> <span>분수</span> <span>{</span>
    <span>public</span> <span>int</span> <span>분자</span><span>;</span>
    <span>public</span> <span>int</span> <span>분모</span><span>;</span>

    <span>@Override</span>
    <span>public</span> <span>String</span> <span>toString</span><span>()</span> <span>{</span>
        <span>return</span> <span>분자</span> <span>+</span> <span>"/"</span> <span>+</span> <span>분모</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>분수</span><span>Test</span> <span>{</span>
    <span>@Test</span>
    <span>public</span> <span>void</span> <span>test</span><span>분수</span><span>_invalid</span><span>()</span> <span>{</span>
        <span>분수</span> <span>분수객체</span> <span>=</span> <span>new</span> <span>분수</span><span>();</span>
        <span>분수객체</span><span>.</span><span>분자</span> <span>=</span> <span>1</span><span>;</span>
        <span>분수객체</span><span>.</span><span>분모</span> <span>=</span> <span>0</span><span>;</span>  <span>// !!! 분모는 0이 아니여야함 (불변식이 깨짐)</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<ul>
  <li>내부 필드가 public이기 때문에 캡슐화를 통해서 불변식을 강제할 수가 없습니다.</li>
  <li>불변식 제약사항을 강제하는 메소드를 재정의함으로써도 깨질 수도 있습니다.</li>
</ul>

LSP

<blockquote>
  <p>서브타입(sub-type)은 그것의 기반 타입(base-type)으로 치환 가능해야 한다.</p>
</blockquote>

<p>그냥 단순하게 기반 타입으로 치환만 된다는 것을 의미하지는 않습니다. 기반 타입의 행위들을 서브 타입의 행위들로 대치해도 문제가 없고, 불변식도 깨지지 않아야 함을 의미합니다.
LSP를 자체를 설명하기 보다는 LSP가 위배되는 상황을 통해서 역으로 LSP를 알아보겠습니다.</p>

<p>유명한 Rectangle(직사각형) - Square(정사각형) 예제를 통해서 이를 확인해 보겠습니다.</p>

<div><div><pre><span>class</span> <span>Rectangle</span> <span>{</span>
    <span>private</span> <span>int</span> <span>width</span><span>;</span>
    <span>private</span> <span>int</span> <span>height</span><span>;</span>

    <span>public</span> <span>void</span> <span>setWidth</span><span>(</span><span>int</span> <span>width</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>width</span> <span>=</span> <span>width</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>void</span> <span>setHeight</span><span>(</span><span>int</span> <span>height</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>height</span> <span>=</span> <span>height</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>final</span> <span>int</span> <span>getArea</span><span>()</span> <span>{</span>
        <span>return</span> <span>width</span> <span>*</span> <span>height</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>Square</span> <span>extends</span> <span>Rectangle</span> <span>{</span>
    <span>@Override</span>
    <span>public</span> <span>void</span> <span>setWidth</span><span>(</span><span>int</span> <span>width</span><span>)</span> <span>{</span>
        <span>super</span><span>.</span><span>setWidth</span><span>(</span><span>width</span><span>);</span>
        <span>super</span><span>.</span><span>setHeight</span><span>(</span><span>height</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>void</span> <span>setHeight</span><span>(</span><span>int</span> <span>height</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>setWidth</span><span>(</span><span>height</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuKhEIImkLWXAJIv9p4lFILMevb9GACzCASa0qXcfcUaP9K16SMf9E4XC0ooZ2H7n0CjgG1I1nD9JInoBKXCrDBbgeSO65vOc5gKgf5QKfEQbeDj2s52GGGv0dK1t0W00" alt=""></p>

<p>위 정도면 충분히 LSP 를 만족한다고 보입니다. 과연 그럴까요? 
먼저 Square 클래스의 불변식을 알아봅시다. 정사각형이기 때문에 길이와 높이가 같은 것이 불변식입니다.
Rectangle는 어떤 불변식을 가질까요? 길이와 높이가 무조건 같이 변경되면 직사각형의 불변식이 위배됩니다. - 두 타입 간 <em>충돌이 발생하는 느낌도 있습니다.</em></p>

<p><em>Rectangle 불변식이 깨지는 테스트</em></p>

<div><div><pre><span>@Test</span>
<span>public</span> <span>void</span> <span>testRectanbleInvariant</span><span>()</span> <span>{</span>
    <span>Rectangle</span> <span>rectangle</span> <span>=</span> <span>new</span> <span>Square</span><span>();</span>
    <span>rectangle</span><span>.</span><span>setWidth</span><span>(</span><span>10</span><span>);</span>
    <span>rectangle</span><span>.</span><span>setHeight</span><span>(</span><span>5</span><span>);</span>

    <span>// 과연 답이 50이 나오는가? 25가 나와서 테스트는 실패하고, LSP가 만족되지 않음을 의미한다.</span>
    <span>assertThat</span><span>(</span><span>rectangle</span><span>.</span><span>getArea</span><span>(),</span> <span>is</span><span>(</span><span>50</span><span>));</span>
<span>}</span>
</pre></div></div>

<p>즉, Square는 길이와 높이를 무조건 같이 변경하게 되지만, Rectangle는 길이와 높이가 같이 변경되면 예상치 못한 부수효과로 인해 불변식이 깨지게 됩니다.
Rectangle의 불변식이 깨지게 되어서 결국 LSP도 위배하게 됩니다. - 하지만 Square의 불변식은 유지됩니다.</p>

<blockquote>
  <p>물론 불변식이 깨진다고 해서 무조건 LSP가 위배되는 것은 아닙니다.</p>
</blockquote>

<blockquote>
  <p>위 상황에서 setWidth(int), setHeight(int)를 재정의 하지 않고 setLength(int)와 같은 메서드를 구현하는 방법도 존재하나 그런 경우에는 width, height가 각각 변경될 수 있으므로 Square의 불변식(width, height는 동시에 변경되어야함)이 깨질 수 있습니다.</p>
</blockquote>

Solution

<p>먼저 상속을 유지한 상태에서 해결 방안을 알아보겠습니다.</p>

<div><div><pre><span>class</span> <span>Retangle</span> <span>{</span>
    <span>private</span> <span>final</span> <span>int</span> <span>width</span><span>;</span>
    <span>private</span> <span>final</span> <span>int</span> <span>height</span><span>;</span>

    <span>public</span> <span>Rectangle</span><span>(</span><span>int</span> <span>width</span><span>,</span> <span>int</span> <span>height</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>width</span> <span>=</span> <span>width</span><span>;</span>
        <span>this</span><span>.</span><span>height</span> <span>=</span> <span>height</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>final</span> <span>int</span> <span>getArea</span><span>()</span> <span>{</span>
        <span>return</span> <span>width</span> <span>*</span> <span>height</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>Square</span> <span>extends</span> <span>Rectangle</span> <span>{</span>
    <span>public</span> <span>Square</span><span>(</span><span>int</span> <span>length</span><span>)</span> <span>{</span>
        <span>super</span><span>(</span><span>length</span><span>,</span> <span>length</span><span>);</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuKhEIImkLWXAJIv9p4lFILMevb9GACzCASa0qXcfcUaP9K16K2f4LWCiemELq0JAfAUME1Qb9cfeSjL2ZGekB4qiIbL8hIX9pKj1CnaggP6JcfTUaW7Ium1K17G60000" alt=""></p>

<p>부수효과는 가변메서드(Setter)에서 발생합니다. 그럼 애초에 원인이 되는 가변을 모두 제거해서 위와 같이 <strong>불변(Immutable)을 통해서 문제를 해결</strong>할 수 있습니다.</p>

Another Solution

<p>다른 방법을 알아볼까요?
애초에 이 애플리케이션 세계에서 사각형과 정사각형은 상속구조가 어울리지 않는 것 같습니다.</p>

<div><div><pre><span>interface</span> <span>Shape</span> <span>{</span>
    <span>int</span> <span>getArea</span><span>();</span>
<span>}</span>

<span>final</span> <span>class</span> <span>Rectangle</span> <span>implements</span> <span>Shape</span> <span>{</span>
    <span>private</span> <span>final</span> <span>int</span> <span>width</span><span>;</span>
    <span>private</span> <span>final</span> <span>int</span> <span>height</span><span>;</span>

    <span>public</span> <span>Rectangle</span><span>(</span><span>int</span> <span>width</span><span>,</span> <span>int</span> <span>height</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>width</span> <span>=</span> <span>width</span><span>;</span>
        <span>this</span><span>.</span><span>height</span> <span>=</span> <span>height</span><span>;</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>int</span> <span>getArea</span><span>()</span> <span>{</span>
        <span>return</span> <span>width</span> <span>*</span> <span>height</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>final</span> <span>class</span> <span>Square</span> <span>implements</span> <span>Shape</span> <span>{</span>
    <span>private</span> <span>Rectangle</span> <span>target</span><span>;</span>

    <span>public</span> <span>Square</span><span>(</span><span>int</span> <span>length</span><span>)</span> <span>{</span>
        <span>setLength</span><span>();</span>
    <span>}</span>

    <span>public</span> <span>void</span> <span>setLength</span><span>(</span><span>int</span> <span>length</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>target</span> <span>=</span> <span>new</span> <span>Rectangle</span><span>(</span><span>length</span><span>,</span> <span>length</span><span>);</span>
    <span>}</span>

    <span>@Override</span>
    <span>public</span> <span>int</span> <span>getArea</span><span>()</span> <span>{</span>
        <span>return</span> <span>target</span><span>.</span><span>getArea</span><span>();</span>
    <span>}</span>
<span>}</span>
</pre></div></div>

<p><img src="http://www.plantuml.com/plantuml/png/TKyn3i8m3Dpz2eyjWWzqAZiJVO5fZoHI4fN45GFgtudQGbcOBD-TxyvjLaaw1KykAj9TUd1dPGI_YDb0pmbIrJHJxoLdlg9NYSQ3NHWz0gBcduEd6zIMQU6CLUAYN-NLmXmtOlVh7fEaFsQbcO4sQ-JDWtYJLnxHgAqBaA6NPVbYC-qTJuTFGBEvKOiub7VV" alt=""></p>

<p>상속 보다는 합성(Composition) 원칙에 입각해서 위와 같이 수정하는 것도 한 방법입니다.</p>

<ul>
  <li><em>실제로 중요한 것은 넓이를 구하는 행위이지 사각형이냐, 정사각형이냐는 그 다음 문제입니다.</em></li>
  <li>또한 합성을 이용하면 Setter(‘setLength’)가 있더라도 불변식이 깨지는 부수효과가 발생하지 않습니다.</li>
</ul>

Practice

<p>아래 다양한 예시를 통해서 더 안전한 상속을 구현하는 방법을 알아보겠습니다.</p>

메서드 재정의

<p>메서드가 재정의 불가능하게 final로 닫는 것이 좋습니다.</p>

Bad

<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPvHCafVq2ZNRUeQQ0W9AR0NIKqmxA5Hnr0TOnmY24-2BuayqBp_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBKE0VaHY0jbdWwSeUF92Lq6zFvT8QAdzfTSjPszs-2BNjuMppNqK5sNJ4Q4YTPLqWikJhagj-2FXJor-2BUda9wYeaZmq-2BDaL-2BaKW1jZNJt0Qy6mn4pGxlBgOEhwa8MgD0ieJJ8Lcw2K09Eh52BVBY7XCp4116hoCODx-2FNnGNUPCm6DAwIxMKVJJcE0Sw17GZDIvl8HA-3D-3D">BadSuperObject.java</a></li>
</ul>

Good
<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPvoahze4Sk-2BW6nKkNg-2BOGFfWKp3T-2BZ44d-2FDSsO-2BHe6nIPq-2FrUo-2FeJe2aHXtOwRoumw-3D-3DbgQF_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBM0D5lxKeuBLg0rgd2d4eymuXkJgp5G8dSWdiGwlouKLLTvcjdt35hjKguMXnE3w01b-2Bb1TacP7cwSxNSa9TMFPI921qu4-2FnP92tX357ckmuh-2Bq1K4C-2BP56GXO8nfu0fLlt-2BmahzSOSk0jU-2FjNDYabRGqKFSJS0nhnkuEpqtptIhRx-2BOHj5Uy4B6xWYS2oyccQ-3D-3D">GoodSuperObject.java</a></li>
</ul>

Support 타입

<p>상속을 단순 코드 재사용으로 사용하는 경우(추상 메서드가 없는 경우)에는 합성(Composition)을 사용하는 것이 좋습니다.</p>

Bad

<ul>
  <li>base : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPox-2BGTcaafDeJVNXQnZ7MLU7cyl5Xrk6oGl-2B5ojCaTNHiNud_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBB1QPgkPLqR-2BALUKooKCESGSVCjcmUpMHPWhyelkc8izr23lDacGbm-2BVmjqcrToT-2FjqJmv8f1aFgvkoFGFojrpG9ZylTKgINczlaqiKPzfu45WLXfutCpoco7Fgwlx5rme-2F7lI62udjI8tfEcyEbtStr2ZyKKH3pJ1lOthXgQbYEzgAa5i9i0OYRb8vKtoUEFg-3D-3D">ProcessSupport.java</a>
</li>
  <li>sub : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPulyrGD-2FbvAa0O21iacF99oKr6KroTJBWNctHqoQ4v2fbQn2_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBML9I5xdPY09NtoiCgRbhSSL3f9SltkiWBy9m2IHU7Enx42Xl2Gq5tp-2FC1dHx9rr-2F83-2BXPv3gNRBvpQEEwM48-2BRZDtBladRWSVCSe6LWeHcNZF60B81WQ9Dci9G3brOO9Hp8jmTTxfauTnk8DM-2FECJ6Ou0tWvWv3HcylrZArCb6PfJmv9gooTrnzSoszr-2B6QwA-3D-3D">BadMainProcess.java</a>
</li>
</ul>

Good

<ul>
  <li>helper : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPox-2BGTcaafDeJVNXQnZ7MLXkx6cYBHqJXAxsvrpwqZoSbTIc_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBObGyNjU7RjkvHDNaf2h3pyKm4ZZlR8mVFyU1UZfBT7bkAtKTRGYjdUpbPVMx35tAs3sk-2FZogevZzUAL1VbwlQWEIR-2BNPLjFP1PeWej-2FBkXhyQ2syjHvye-2B72ic5aMXVoExtPxH0Wn1fbuVvWQEteS6K2v-2BMEY-2BAjOt01j5BnXLoyMFvRMdzhjkVVeFB-2FSYHCQ-3D-3D">ProcessHelper.java</a>
</li>
  <li>client : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPnCh3xqGTLXHrX2-2FS9OHue-2BydhL92iskcSd-2FDBrwXvaYtKD2_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBG881c6AbT3-2FPymXct2DHhMWDs06gQZXFjSxOKN1D7glqmnooQ7o1I0fEvdDDytoUm0Iya44ccwUD7AapbBakK0UQYhixdulkNJfIGisSl05eV7DzqOdrnbW9yZNQFfBta49HKvEwnaX7G4IxaY1XJqUnGA8utaACgluwLnJv-2FH15TRttLiyllwa4ffyoiH5gw-3D-3D">GoodMainProcess.java</a>
</li>
</ul>

Template

<p>템플릿 메소드 패턴의 경우 아래와 같은 코드로 정형화 하는 것이 좋습니다. - 이것은 상속을 이용한 Good Practice 중 하나입니다.</p>

<ul>
  <li>템플릿 패턴은 변하는 부분과 변하지 않는 부분의 관심사 분리가 중요합니다.</li>
  <li>변하는 부분은 다형성을 위해 열어두고 변하지 않는 부분은 불변 템플릿(final)으로 만듭니다.</li>
</ul>

<p><em>Good Sample 중 일부 코드</em></p>
<div><div><pre><span>public</span> <span>abstract</span> <span>class</span> <span>AbstractSafePrefixContentHolder</span> <span>implements</span> <span>ContentHolder</span> <span>{</span>
    <span>// 가능한 필드는 닫고 불변화 시킨다. 접근이 필요할 때만 점진적으로 연다.</span>
    <span>private</span> <span>final</span> <span>String</span> <span>content</span><span>;</span>

    <span>public</span> <span>AbstractSafePrefixContentHolder</span><span>(</span><span>String</span> <span>content</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>content</span> <span>=</span> <span>Objects</span><span>.</span><span>requireNonNull</span><span>(</span><span>content</span><span>);</span> <span>// 여기에서 제약조건을 추가할 수 있다. : 선행조건으로 불변식 강제</span>
    <span>}</span>

    <span>@Override</span>   <span>// 템플릿 : 재정의 불가능하게 final</span>
    <span>public</span> <span>final</span> <span>String</span> <span>getContent</span><span>()</span> <span>{</span>
        <span>return</span> <span>getPrefix</span><span>()</span> <span>+</span> <span>content</span><span>;</span>
    <span>}</span>

    <span>// 다형성으로써 추상 메서드만 오픈시킨다.</span>
    <span>abstract</span> <span>protected</span> <span>String</span> <span>getPrefix</span><span>();</span>
<span>}</span>
</pre></div></div>

Bad

<ul>
  <li>base : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPrRU-2FQOUwbn7dlEkRPCtU7EHpUjE9LOTtOtrpAdrNhiRk-2BpNnO6KuYMCdSC71McW6Q-3D-3DwSCx_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBLFLLRjqTbfD8gg8qBd7v6h6oKH10lvrZveM-2B9-2BuieXGEfrLe20Q6TZ3glVQI-2FjbTc-2F2peq-2FrhCK7VnXim7O8rHeLNU4D8GeSMm2WBouISY3hNK6t0PAaAYmxn0Q2PWTqiGop7WdbFFEzXA-2Fy-2Ff5R11g1tOB5UU3grzFcnHv-2BPOVVdEHQFGaCWfNKzuPQcoAWw-3D-3D">AbstractPrefixContentHolder.java</a>
</li>
  <li>sub : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPpMre2YJaNZd-2BAveQxvmpcTHa6evXWUvbMn1vwwrt4nFmkKaINsHrW3HL3sB4ebEKA-3D-3DN6Lw_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBPHjnq05b-2FSlpk4VGSME651b2ARzWJZSF5Q1P59C-2FDRQwG3P19n2lvYdnvImenFWx5RDCNq9YP9DJkMn7MX7qcLDW1rtq8HnYb8TmYZ8NYZq3nUIdqzQ6vgii2dHGCAs53KUnHtwrFclaGXVhKP1HkbcIraEChR1qmR0gZJIfAWdDJqRAPY2xsCTg0IrwnwHKA-3D-3D">BadContentHolder.java</a>
</li>
</ul>

Good

<ul>
  <li>base : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPrRU-2FQOUwbn7dlEkRPCtU7EOtWHu2AlBkjk-2FKZ-2Bj6XJqRja1yC-2BzvbPrbc5lgJ0Tc5rrbp8BYMCPMhB909rvY8Y-3DS9bO_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBBoZ38H-2BagLyYFOviFzzBI3sCX-2FVAls07-2FHRtTJsYJyEtTftsrEqtvz4M63ubeGdVhCVXcgGvepKD7V8QXBdfVP-2B-2FZXwmTTxlrDBonO8w7oSqtFfC4yxb32iST5YrNZ-2FmwzCf-2F9v9tEsg-2Bue0lPlYcmps2F5MEF-2BpvBkeFBQN7yMQOV3-2BKT3uMm67DcYTobzFw-3D-3D">AbstractSafePrefixContentHolder.java</a>
</li>
  <li>sub : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlIap8JmeCEm5OqvRUCN68o1hpujs6rnGhaWg0UGrEH-2Fs4fZV5wEdL90fkocxtNKT5cRWdDactdAnjr0ScrhwGPrw24uBadkhOymQTlmSodOSAqvH4lqPhNC-2FQapce8n4TRfqO-2B2ivybjmE06XkO7Qnw-3D-3Dbuww_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBFBNOa8cUX1D9FEYNXYeGLCpc-2FU38HnlH-2BLy5tbtA-2B-2B7-2Fr-2B3qlQ-2FLhmeI870ZAUruq3lqbQ-2B3OjwPxydASMVL4o0EiKvR6wcLoE1ECiYXlYLn6KpcoDlRNEah0Osdlr8l-2BLeqkBIvaVaRJi-2BjTJrEQWNnvAXHnkZdeFWyKFELTb96BazShpIHpFwF8-2BbBLDonA-3D-3D">GoodContentHolder.java</a>
</li>
</ul>

Summary

<ul>
  <li>불변식을 지킵니다.</li>
  <li>접근제어는 가능한 닫습니다 : field는 private로</li>
  <li>가능한 변경을 최소화 합니다 : final
</li>
  <li>불변을 이용하거나, 인터페이스를 통한 합성으로 변경해 봅니다.</li>
</ul>

예외

<ul>
  <li>하지만 모든 경우에서 위 원칙을 지키는 것은 힘들수도 있습니다.</li>
  <li>상속의 위험성을 모두 파악한 상태에서 문서(javadoc)를 통해서 제약사항을 명시해서 언어로써 강제하는 것이 아니라 프로그래머가 스스로 제약사항을 지키게 하는 것도 한 방법입니다.
    <ul>
      <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuG8dReyQHZquMVz2fKAEVGNUMSdLOfk174POISLsUAtPwhW7EZCQaAINtn2qfPOdxBRPxhD7Fa5LYv41sOlaLB9NfF2-2F8CgWvPqm676C9QiZlXF-2BrakpxhEnVnYwyunMNvkYkTebvQbB1OFcONYZnBUI-2BxiXoHtQgyi12wZCWsU1arSOp2Cex9WRc3T1PQLeUaltCXbx9rdFe1yJ9mYYeO-2FxJDwShGW3tVrCMTynEMaX17Te98y2WCMUj40gWWG4dB6Li-2BINiJ7mpXPvo6jdRdElB8kdhpUJDcCTBDzhSosT6UWTyEtIHVvOFrvrcC2Uj4ASdPXdRpue-2FMEfk-2FzOMKm9TxQ3PZJujGjyk9tTijCjwdDij0W6a4cpEsFfqw1-2FGLRkP7CG3AXy726KuLvKb-2Bz0qZmffqfKSYLA-2FcE1vgMw-3D-3DOYqf_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBCrSWCnp1eNlAoXNMzuK7lz4iqX0inOGq2Hw-2BiMHwh16udVXwr3G7ksXu7-2Fhzx4pMD3onAReo-2Bde3Sf5R3KWHaXLt-2FNQ9yAO4-2Bsk9fUDRPj52FKeF8HeiK-2Bk7YWLKtone16q7QcVWU-2F-2BhmOPbLx5dBvtZsGYxIiu5dV7X-2BHqR7lyVUmLjs3BVk8Iq37uioRTxA-3D-3D">effective-java2-chapter04#rule-17—계승을-위한-설계와-문서를-갖추거나-그럴-수-없다면-계승을-금지하라</a></li>
    </ul>
  </li>
  <li>그리고 특정 도메인(ex:환경설정)에서는 위 상속의 위험성을 무시할 수도 있습니다.</li>
</ul>

Reference

<p>github : <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3mfvpQ-2BNT7XkGSm-2FPKUVgRSTrnvqBAFWUxwBNYReVEDlu2qfvSyUhnhn4EtvcAbhVw-3D-3D4HXQ_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBLkQ3cwO2dorym5NBP6-2B2dlpzIOn3BAtPdGEjdp38Uk8Pm4bZi1kHJZdAgoJthRGVmbUjl6yLKJ5DzudNqq8F8qQjvxN6i7RzqrJsFVubGvII3rKmcBFaqVR8y7isLLozyr8f1ItshQ90MJTRKH4OWGbCvUYQIvwM0VnthVe1EVrbsuNpJ-2B-2FI-2BjO4F7P2-2FDM3Q-3D-3D">https://github.com/redutan/dangers-of-inheritance/</a></p>

<ul>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuG8dReyQHZquMVz2fKAEVGNUMSdLOfk174POISLsUAtLzWkOlxiNZro4AhF66DQDk-3DH3_U_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBJ9Y-2FNYU4mj3gnkVyG2XVBd7VAitpdfQfWbBEkq4l5aX39h8ceDXMbPA61RxtW6wZtipIkYGWMYcluOIfJX1pLUAGIrdjHIAIy49J4RgTSCsW-2FLn0VRyVAcy2mWvAtm2JXX7eWZKxOpvzs4ElFePh6ejRM9m2KhcB4JwRx-2FYY1p7P5fM-2FbtuEk5AMM2BVLZheg-3D-3D">http://redutan.github.io/2016/02/26/effective-java2-chapter04</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvuzByN6gciCGGZiVr0cV5uBMjq4qC7qaXVh3Mk6Jzh4cgNnKNzmE0ERzST2kJRk2Z0-3D65wV_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBKdwmM9oVSXvEXLk1cW1erbWV0ugBnj9Sx-2FZZs6hGwVRSpR-2FISbFLeUFLBWpBEaUXTxSy1w7D7JyO4eRNl-2FqfOrh21z0s5LpAzx7S9r8rlCUmhYHH2dipF4oLrMvMXiB3dPlrDNMA1pa-2BzJ3xFsuXKPmXh5yPqMri0rESi1ucJmAyhmMXKscA-2F7TDZGVgdVgIQ-3D-3D">http://redutan.github.io/2017/06/10/clean-software-part02-2</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3kmgDwfuuQRKt7HX5HnBbrJIUigA2icjt4zK-2FeS9WFBL8NLk5WsPphpSzwK71K3DKQ-3D-3D6UGK_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBInNHHfOZf8bXsJposd1NwEJ-2BrN4iIN2t91e-2Bu2Ahc6xYl6Blm2nKtGnRBX-2F4QpXUDCQ2K5aDy2hle-2Bq9033JIcCPXMonlv6Bcfg-2FdOF5ERq-2BmSBvleW5IJDTBRyzXczz3Vj9O9UGOIyxvesH3UnTugZNH9BTwM5dY02Nu0uZjDHMtJw0nENp9u3fKFdwJ0VRQ-3D-3D">https://en.wikipedia.org/wiki/Class_invariant</a></li>
  <li><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ocOamlfi77b-2F8VFS2XYE3q-2BnI2JvGpGa2GFG-2F986XVRXImY6EPmQVKlBLzZUYviuXVoeFHPPnwENo8i87vVtRMxajZJ9u-2B26ycXLUWOX-2BqZqcPUy1vFV-2FnrNdZNNII0axEodjGrC-2FRBcjcroIHtH97ZXNZ7JP1cOX0TseAO-2FMrc-3DoTtD_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBMIKsA8MHPZY6YrgyTlUAk24HokOaqCx0Hv8BQpQcbizQ9mFTqfVAVMF4yhTL2826YQRdKnYNF5eOd9HavPNr5ahtyOHdfyOKumAA8tZzuwk237QINSWrf8utQ2VvJiVMDwyJmLkSYjaKku5va13QzXK7x8FqnH3vydbh92H7FAJ-2BnU7rYxIyk9OGdVWKt-2Fk0g-3D-3D">https://ko.wikipedia.org/wiki/리스코프_치환_원칙</a></li>
</ul>

    <p><a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvDbFChje1eZmMNQ4-2B6lWqRsqhgNVDPiklEFlsq2ZPkNW0s4RHekDT1Qnu0r9OY3Yg-3Dtq1F_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBBrpUCw8l4-2FIvc-2BPNIllivtWxX9od3hgLZZeGXE5QvkUx1uek-2FsrqmYLTGl94ZmUXfW5U7yyXBqHGMBgzf1f-2B33-2F7C15WmXP8RddIPJUt0DMGPxRWCVyZiM9BhYgF9vtsTzPX10hehIg0SoBGhTk1k-2Bl5assXTx1JJTsaOU1-2F6B8SYNYgs9a2JqbO0UFxsh6jA-3D-3D">상속의 위험성</a> was originally published by MJ at <a href="https://u2109659.ct.sendgrid.net/ls/click?upn=ZAq1pAP0VzkeAz11YnKryt4BYFVDBFhXcTsI2IcTQvvsNBNYnRXmInA7E20V1hcUETfZ_36V6FUE0kTxFnhSWw7o3GQWEe8aLnTkfbNhUO297vXuFd9rHJ3OKCl-2B1A3Na9h5T9AyqnixEd9vtWiqRPOiiBGNYWIr8Rghe8tMvVSRVXAeGgtRp1QimoiAlg-2BSSPkpY6rp1oGzXEkJV-2Fg8e2oElFBTjp5VbPaE2ZYLa5D9ylNQCqzz-2FDGocyCJ84CDHo4Bu9bOO4HKieL8XTflxhJFwLAnKCAEJ-2FWTrzIGNzUp4MyBQMOd0Iaot-2FoFK1C1-2F1WJrI0dKh2Gj-2BFzhL7okMtgUTw-3D-3D">DevOOOOOOOOP</a> on April 21, 2018.</p>
  
  <img src="https://u2109659.ct.sendgrid.net/wf/open?upn=cJLOC9d7r8t51HUVjv2NkHnAh-2BqQdgMVWdxi0cfrbMMEHqy7EnoaH9UXHeO-2FI1omUNCl0Ze3cYTAuiVBYNKEdO8y-2BdLhoYXV0jFbOxmnoHyrcu1PwXRDoF6uAp7mXHucRSNNCiHhJGQeB3m3z99qqGxhv1G7jPzwHP9biBekqHe02D5pRaLwQZeDqe8qzcZ0t656pMNowvTQf36-2ByCcBJc9SSIrGxUnFLIs2Wk-2FuC8Axg-2FVWCKGlY9jqRUyABL6IrL5SHc7UDIpry5aApHOCOw-3D-3D" alt="" width="1" height="1" />
]]>
        
    </content>
</entry>

</feed>
